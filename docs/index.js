(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))o(a);new MutationObserver(a=>{for(const s of a)if(s.type==="childList")for(const c of s.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&o(c)}).observe(document,{childList:!0,subtree:!0});function n(a){const s={};return a.integrity&&(s.integrity=a.integrity),a.referrerPolicy&&(s.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?s.credentials="include":a.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(a){if(a.ep)return;a.ep=!0;const s=n(a);fetch(a.href,s)}})();const Fe=""+new URL("service-worker.js",import.meta.url).href;window.navigator.serviceWorker.register(Fe).catch(console.error);let Y;ie(),document.addEventListener("visibilitychange",()=>{document.hidden?He():ie()});async function ie(){var e,t;Y=await((t=(e=navigator.wakeLock)==null?void 0:e.request)==null?void 0:t.call(e,"screen"))}async function He(){Y&&(await Y.release(),Y=void 0)}const w={width:30,height:24};function ee(e){return e%2===0}function We(e,t,n){return e>=t&&e<=n}function Ye(e,t=0,n=e.length){return e[K(n,t)]}function K(e,t=0){return Math.trunc(Math.random()*(e-t)+t)}function ye(e){return Object.freeze(Object.assign(Object.create(null),e))}function Ke(e){e.preventDefault()}function he(e){e.forEach(t=>{t.neighbors=Qe(t,e,w)})}function Qe({q:e,r:t,s:n,x:o,y:a},s,c){const i=[{q:1,r:0,s:-1},{q:1,r:-1,s:0},{q:0,r:1,s:-1},{q:0,r:-1,s:1},{q:-1,r:0,s:1},{q:-1,r:1,s:0}].map(u=>s.find(y=>y.q===e+u.q&&y.r===t+u.r&&y.s===n+u.s)).filter(Boolean);return o===0&&(i.push(s.find(u=>a===u.y&&u.x===c.width-1)),ee(a)&&i.push(...[a<c.height-1?s.find(u=>a+1===u.y&&u.x===c.width-1):null,a>0?s.find(u=>a-1===u.y&&u.x===c.width-1):null].filter(Boolean))),o===c.width-1&&(i.push(s.find(u=>a===u.y&&u.x===0)),ee(a)||i.push(...[a<c.height-1?s.find(u=>a+1===u.y&&u.x===0):null,a>0?s.find(u=>a-1===u.y&&u.x===0):null].filter(Boolean))),i}const h={freezing:"freezing",cold:"cold",temperate:"temperate",warm:"warm",hot:"hot"};function ve(e){e.forEach(t=>{const n=Math.random(),o=-1,a=We(n,.3,.7)?0:1*(-1*+(n<.3)),s=(c=>c<0?0:c>w.height-1?w.height-1:c)(t.y+a+o);t.temperature=Ve(s)})}function Ve(e){switch(e){case 0:case 1:case w.height-2:case w.height-1:return h.freezing;case 2:case 3:case w.height-4:case w.height-3:return h.cold;case 4:case 5:case w.height-6:case w.height-5:return h.temperate;case 6:case 7:case 8:case w.height-9:case w.height-8:case w.height-7:return h.warm;default:return h.hot}}function Ge(e){switch(e){case h.hot:return h.warm;case h.warm:return h.temperate;case h.temperate:return h.cold;default:return h.freezing}}function Xe(e){switch(e){case h.freezing:return h.cold;case h.cold:return h.temperate;case h.temperate:return h.warm;default:return h.hot}}const ue=new Set([0,1,2,w.height-1,w.height-2,w.height-3]);function ge(e){const o=e.length/2.5;let a=0;for(;a<o;){const s=K(13,4),c={x:K(w.width),y:K(w.height-3,3)},l=e.find(({x:y,y:g})=>y===c.x&&g===c.y),i=new Set(l.neighbors.filter(({y})=>!ue.has(y))),u=new Set;a+=s,de(l),u.add(l);for(let y=0;y<s;y+=1){const g=Ye([...i]);de(g),u.add(g),i.delete(g),g.neighbors.filter(m=>!u.has(m)).filter(({y:m})=>!ue.has(m)).forEach(m=>i.add(m))}}e.filter(s=>s.elevation>0).forEach(s=>{const c=s.neighbors.filter(i=>i.elevation>0).length;if(c>=3)return;const l=Math.random();(c===2&&l>.7||c===1&&l<.7)&&Ze(s)})}function de(e){e.elevation+=1,e.elevation>1&&(e.temperature=Ge(e.temperature))}function Ze(e){e.elevation=Math.max(0,e.elevation-1),e.elevation>0&&(e.temperature=Xe(e.temperature))}const _={arid:"arid",dry:"dry",moderate:"moderate",moist:"moist",wet:"wet"};function je(e){switch(e){case _.arid:return _.dry;case _.dry:return _.moderate;case _.moderate:return _.moist;default:return _.wet}}function we(e){e.filter(t=>t.elevation>0).forEach(t=>{t.neighbors.filter(({biome:n})=>n===d.sea).forEach(()=>{t.humidity=je(t.humidity)})})}const r=ye({people:"people",gold:"gold",cloth:"cloth",wood:"wood",stone:"stone",iron:"iron",food:"food",alcohol:"alcohol"}),et=ye({[r.people]:5,[r.gold]:5,[r.cloth]:25,[r.wood]:25,[r.stone]:25,[r.iron]:0,[r.food]:50,[r.alcohol]:5});function J(e,t=1){const n={[r.people]:0,[r.gold]:0,[r.cloth]:0,[r.wood]:0,[r.stone]:0,[r.iron]:0,[r.food]:0,[r.alcohol]:0};let o=0;return e.forEach(a=>{o+=a.resources.people,Object.entries(a.biome.resource_production).forEach(([s,c])=>{n[s]+=c}),[...a.structures.entries()].forEach(([s,c])=>{s.output.forEach(({resource_name:l,amount:i})=>{n[l]+=i*c})});for(let s=0;s<Math.floor(a.resources.people/2);s+=1){const c=Math.random();c<.3?n[r.people]+=2:c<.8&&(n[r.people]+=1)}}),n[r.gold]=o*t,n}const d={sea:new L("sea",{[r.food]:1}),mountain:new L("mountain",{[r.wood]:2,[r.stone]:5,[r.food]:3}),high_mountain:new L("high_mountain",{[r.stone]:5}),ice:new L("ice",{[r.food]:2}),tundra:new L("tundra",{[r.cloth]:1,[r.wood]:2,[r.stone]:1,[r.food]:5}),grassland:new L("grassland",{[r.cloth]:3,[r.wood]:2,[r.stone]:2,[r.food]:5}),savanna:new L("savanna",{[r.cloth]:5,[r.wood]:5,[r.stone]:3,[r.food]:6}),boreal_forest:new L("boreal_forest",{[r.cloth]:4,[r.wood]:10,[r.stone]:3,[r.food]:5}),forest:new L("forest",{[r.cloth]:2,[r.wood]:10,[r.stone]:2,[r.food]:5}),tropical_rainforest:new L("tropical_rainforest",{[r.cloth]:3,[r.wood]:7,[r.stone]:1,[r.food]:5}),cold_swamp:new L("cold_swamp",{[r.cloth]:1,[r.wood]:2,[r.stone]:1,[r.food]:2}),swamp:new L("swamp",{[r.cloth]:1,[r.wood]:1,[r.stone]:0,[r.food]:3}),tropical_swamp:new L("tropical_swamp",{[r.cloth]:1,[r.wood]:3,[r.stone]:1,[r.food]:3}),desert:new L("desert",{[r.cloth]:1,[r.wood]:0,[r.stone]:2,[r.food]:1}),extreme_desert:new L("extreme_desert",{[r.cloth]:0,[r.wood]:0,[r.stone]:1,[r.food]:0})},tt={[h.freezing]:{[_.arid]:d.tundra,[_.dry]:d.tundra,[_.moderate]:d.tundra,[_.moist]:d.boreal_forest,[_.wet]:d.boreal_forest},[h.cold]:{[_.arid]:d.tundra,[_.dry]:d.tundra,[_.moderate]:d.boreal_forest,[_.moist]:d.boreal_forest,[_.wet]:d.boreal_forest},[h.temperate]:{[_.arid]:d.tundra,[_.dry]:d.forest,[_.moderate]:d.forest,[_.moist]:d.forest,[_.wet]:d.swamp},[h.warm]:{[_.arid]:d.desert,[_.dry]:d.grassland,[_.moderate]:d.savanna,[_.moist]:d.forest,[_.wet]:d.tropical_swamp},[h.hot]:{[_.arid]:d.extreme_desert,[_.dry]:d.desert,[_.moderate]:d.grassland,[_.moist]:d.savanna,[_.wet]:d.tropical_rainforest}};function L(e="",t={},n=1,o=1){return{name:e,resource_production:Object.assign({[r.gold]:0,[r.cloth]:0,[r.wood]:0,[r.stone]:0,[r.iron]:0,[r.food]:0,[r.alcohol]:0},t),movement_speed:n,pleasantness:o}}function be(e){e.forEach(t=>{t.biome=rt(t)})}function Ee(e){e.filter(({elevation:t})=>t===0).forEach(t=>{t.biome=nt(t)})}function nt(e,t=w.height){const n=Math.random();return[0,t-1].includes(e.y)?n<=.1?d.sea:d.ice:[1,t-2].includes(e.y)?n<=.75?d.sea:d.ice:[2,t-3].includes(e.y)?n<=.9?d.sea:d.ice:d.sea}function rt(e){return e.biome?e.biome:e.elevation>1?e.elevation>2?d.high_mountain:d.mountain:tt[e.temperature][e.humidity]}const ot=document.getElementById("add-player-btn"),te=document.getElementById("board"),ne=document.getElementById("bottom-bar"),D=document.getElementById("cell-info"),st=document.getElementById("cell-debug-info"),P=document.getElementById("cell-production-forecast"),at=document.getElementById("toggle-coord-system-btn"),_e=document.getElementById("config-game-form"),re=document.getElementById("defs"),Se=document.getElementById("end-turn-btn"),V=document.getElementById("general-info"),Q=document.getElementById("overall-production-forecast"),Le=document.getElementById("phase-label"),F=document.getElementsByClassName("player-config"),Z=document.getElementById("player-name"),$e=document.getElementById("player-setup"),ct=document.getElementById("reroll-map-btn"),lt=document.getElementById("side-bar");document.getElementById("round-info");const T=document.getElementById("season-of-move-select"),oe=document.getElementById("selection-highlight"),it=document.getElementById("start-game-form"),N=document.getElementById("start-game-overlay"),qe=document.getElementById("movement-arrows"),I=document.getElementById("movement-config"),G=I.querySelector('[name="troop-strength"]'),ke=I.querySelector('[name="troop-strength-value"]'),ut=I.querySelector('[name="min-troop-strength-value"]'),dt=I.querySelector('[name="max-troop-strength-value"]'),X=I.querySelector('[name="settle-cell-toggle"]'),_t=re.querySelector(".cell-wrapper"),mt=re.querySelector(".movement-indicator"),pt=document.createElementNS("http://www.w3.org/2000/svg","path"),ft=re.querySelector(".player-border"),yt=document.getElementById("player-config-tmpl").content,ht=document.getElementById("structure-builder-tmpl").content,se={tent:z("Tent",[v(r.wood,1),v(r.cloth,3)],[],0,{on(e){e.housing_capacity+=5},off(e){e.housing_capacity-=5}},[]),textile_factory:z("Textile Factory",[v(r.wood,15),v(r.stone,15)],[v(r.cloth,5)]),lumber_mill:z("Lumber Mill",[v(r.wood,15),v(r.stone,15)],[v(r.wood,5)]),quarry:z("Quarry",[v(r.wood,15),v(r.stone,15)],[v(r.stone,5)]),forge:z("Forge",[v(r.wood,5),v(r.stone,5)],[v(r.iron,1)]),farm:z("Farm",[v(r.wood,5),v(r.stone,5)],[v(r.food,5)]),distillery:z("Distillery",[v(r.wood,5),v(r.stone,5)],[v(r.alcohol,1)])};function z(e="Pretty Structure",t=[v(r.wood,5)],n=[v(r.wood,1)],o=1,a={on(i){i.foo+=5},off(i){i.foo-=5}},s=[d.swamp],c=[v(r.wood,1)],l=1){return{display_name:e,construction_cost:t,space_requirement:l,unsupported_biomes:s,effects:a,output:n,input:c,required_workers:o}}function v(e=r.wood,t=1){return{resource_name:e,amount:t}}function Oe(e,t,n,o,a,s,c){const l=vt(e,t,n,o,a,s,c),i=l.querySelector(".population-size");let u=null,y=-1,g=0;return{cx:e,cy:t,x:n,y:o,q:a,r:s,s:c,neighbors:[],cell:l,elevation:0,humidity:_.arid,temperature:h.freezing,structures:new Map(Object.values(se).map(m=>[m,0])),resources:{get[r.people](){return g},set[r.people](m){g=m,i.textContent=g>0?g:""},[r.gold]:0,[r.cloth]:0,[r.wood]:0,[r.stone]:0,[r.iron]:0,[r.food]:0,[r.alcohol]:0},get biome(){return u},set biome(m){u!==null&&l.classList.remove(u.name),m!==null&&l.classList.add(m.name),u=m},get owner_id(){return y},set owner_id(m){y=m,m!==-1&&(l.dataset.owner_id=m)},developable_land:10}}function vt(e,t,n,o,a,s,c){const l=_t.cloneNode(!0);return l.setAttribute("transform",`translate(${e}, ${t})`),l.querySelector(".q-coord").textContent=a,l.querySelector(".r-coord").textContent=s,l.querySelector(".s-coord").textContent=c,l.querySelector(".offset-coords").textContent=`${n}, ${o}`,te.prepend(l),l}function Ie(e){const t=[...e.values()];return t.forEach(n=>Object.assign(n,{biome:null,elevation:0,humidity:_.arid,temperature:h.freezing,resources:Object.keys(n.resources).reduce((o,a)=>(o[a]=0,o),n.resources),owner_id:-1})),ve(t),ge(t),Ee(t),we(t),be(t),e}function gt(e,t){const n=e.map(({cx:o,cy:a,x:s,y:c,q:l,r:i,s:u,biome_name:y,elevation:g,humidity:m,temperature:M,owner_id:p,resources:R})=>{const A=Oe(o,a,s,c,l,i,u);return Object.assign(A,{biome:d[y],elevation:g,humidity:m,temperature:M,owner_id:p}),Object.entries(R).forEach(([Je,De])=>{A.resources[Je]=De}),A});return he(n),Ce(n,t)}function wt(e,t){const n=bt(e);return he(n),ve(n),ge(n),Ee(n),we(n),be(n),Ce(n,t)}function Ce(e,t){return e.reduce((n,o)=>(n.set(o.cell,o),n),t)}function bt({height:e,width:t}){const n=[];for(let o=0;o<e;o+=1){const a=+!ee(o);for(let s=0;s<t;s+=1){const c=s-(o-(o&1))/2;n.push(Oe(s*6+a*3,o*4.5,s,o,c,o,-c-o))}}return n}const Be=.5,C=Be*.5;function Me(e,t,n){const o=[];e.reduce((s,c)=>{const l=c.neighbors.filter(p=>!e.includes(p)),i=Et(c),u=St(c),y=kt(c),g=$t(c),m=qt(c),M=Lt(c);return l.find(p=>p.r===c.r&&p.s===c.s+1)&&s.push(`M${g}L${M}`),l.find(p=>p.q===c.q&&p.s===c.s+1)&&s.push(`M${M}L${i}`),l.find(p=>p.s===c.s&&p.r===c.r-1)&&s.push(`M${i}L${m}`),l.find(p=>p.r===c.r&&p.s===c.s-1)&&s.push(`M${m}L${y}`),l.find(p=>p.q===c.q&&p.s===c.s-1)&&s.push(`M${y}L${u}`),l.find(p=>p.s===c.s&&p.r===c.r+1)&&s.push(`M${u}L${g}`),s},o);const a=pt.cloneNode(!0);a.setAttribute("d",o.join("")),a.setAttribute("stroke",t),a.setAttribute("stroke-width",Be),n.append(a)}function Et(e){return`${e.cx+3} ${e.cy+C}`}function St(e){return`${e.cx+3} ${e.cy+6-C}`}function Lt(e){return`${e.cx+C} ${e.cy+1.5+C*.5}`}function $t(e){return`${e.cx+C} ${e.cy+4.5-C*.5}`}function qt(e){return`${e.cx+6-C} ${e.cy+1.5+C*.5}`}function kt(e){return`${e.cx+6-C} ${e.cy+4.5-C*.5}`}const Ot={human:"human",ai:"ai"};function Ne(e){const t=yt.cloneNode(!0);Object.assign(t.querySelector(".player-name-input"),{name:`player-${e}-name`,value:`Player ${e}`}),t.querySelectorAll(".player-type-select-radio").forEach(n=>{n.name=`player-${e}-type`}),$e.append(t)}function ae(e,t="Player Name",n=Ot.ai){const o=[],a=ft.cloneNode(!0);return document.getElementById("player-borders").append(a),{name:t,type:n,tax_rate:1,get resources(){return o.reduce((s,{resources:c})=>(Object.entries(c).forEach(([l,i])=>{s[l]+=i}),s),{[r.people]:0,[r.gold]:0,[r.cloth]:0,[r.wood]:0,[r.stone]:0,[r.iron]:0,[r.food]:0,[r.alcohol]:0})},border_path_container:a,get cells(){return o},set cells(s){o.push(...s),Me(o,`var(--player-${e+1})`,a)},encampments:new Map,destroy(){o.length=0,a.remove()}}}function ze(e,t){Q.querySelector("ul").replaceChildren(...ce(e)),Q.querySelector("input").value=t,Q.classList.remove("hidden")}function It(e,t){P.querySelector("ul").replaceChildren(...ce(e)),P.querySelector("fieldset").replaceChildren(...t),P.classList.remove("hidden")}function Ct(e,{wood:t,stone:n,cloth:o,food:a}){const s=Object.values(se).filter(c=>!c.unsupported_biomes.includes(e.biome)).map(({display_name:c})=>`<li>${c}</li>`).join("");D.innerHTML=`
        <h2>Cell Info</h2>
        <div>Biome: ${e.biome.name}</div>
        <div>Movement modifier: ${e.biome.movement_speed}</div>
        <div>Pleasantness: ${e.biome.pleasantness}</div>
        ...
        <h3>Production</h3>
        <div>Wood: ${t}</div>
        <div>Stone: ${n}</div>
        <div>Cloth: ${o}</div>
        <div>Food: ${a}</div>
        <h3>Supported structures</h3>
        <ul>${s}</ul>
    `,D.classList.remove("hidden")}function ce(e){return Object.entries(e).map(([t,n])=>Object.assign(document.createElement("li"),{textContent:`${t}: ${n}`}))}function Bt(e){return Object.entries(se).filter(([,t])=>!t.unsupported_biomes.includes(e.biome)).map(([t,n])=>{const o=ht.cloneNode(!0).lastElementChild,a=o.querySelector(".label-text"),s=o.querySelector(".structure-count");return o.dataset.structure_name=t,a.textContent=`${n.display_name}: `,s.textContent=e.structures.get(n),o.addEventListener("click",({target:c})=>{const l=c.closest("button");if(l===null)return;const i=l.classList.contains("construct-structure-btn"),u=n.construction_cost;let y=e.structures.get(n);if(i){if(e.developable_land<n.space_requirement||u.some(({resource_name:m,amount:M})=>M>f.active_player.resources[m]))return;y+=1,u.forEach(({resource_name:m,amount:M})=>{let p=M;for(const R of f.active_player.cells){const A=R.resources[m];if(A<p){p-=A,R.resources[m]=0;continue}else R.resources[m]-=p,p=0;if(p===0)break}}),e.developable_land-=n.space_requirement}else{if(y===0)return;y-=1,u.forEach(({resource_name:g,amount:m})=>{e.resources[g]+=m}),e.developable_land+=n.space_requirement}e.structures.set(n,y),s.textContent=y,P.querySelector("ul").replaceChildren(...ce(J([e],f.active_player.tax_rate))),f.update_resource_display()}),o})}function Mt(e){return({target:t})=>{const n=Number(t.value);t.name==="tax_rate"&&(e.active_player.tax_rate=n)}}const k=[],xe="wargame-planned-moves";function Nt(){localStorage.setItem(xe,JSON.stringify(k.map(({player_id:e,origin:t,target:n,units:o,season:a})=>({player_id:e,origin:{cx:t.cx,cy:t.cy},target:{cx:n.cx,cy:n.cy},units:o,season:a}))))}function zt(e){const t=JSON.parse(localStorage.getItem(xe)),n=[...e.board.values()];k.push(...t.map(({player_id:o,origin:a,target:s,units:c,season:l})=>Ae(o,n.find(({cx:i,cy:u})=>i===a.cx&&u===a.cy),n.find(({cx:i,cy:u})=>i===s.cx&&u===s.cy),c,l)))}function Ae(e,t,n,o,a,s){const c=xt(t,n,o);return{player_id:e,origin:t,target:n,season:a,units:o,type:s,arrow:c}}function xt(e,t,n){const a={x:e.cx+3,y:e.cy+3},s={x:t.cx+3,y:t.cy+3},c=`M${a.x} ${a.y}A 3 3 0 0 0 ${s.x} ${s.y}`,l=mt.cloneNode(!0),i=l.lastElementChild.lastElementChild;return l.firstElementChild.setAttribute("d",c),i.setAttribute("path",c),i.textContent=n,qe.append(l),l}function Pe(){k.length=0,qe.replaceChildren()}const le=new Map,Re="wargame-board";function At(){localStorage.setItem(Re,JSON.stringify([...le.values()].map(({cx:e,cy:t,x:n,y:o,q:a,r:s,s:c,biome:{name:l},elevation:i,humidity:u,temperature:y,owner_id:g,resources:m})=>({cx:e,cy:t,x:n,y:o,q:a,r:s,s:c,biome_name:l,elevation:i,humidity:u,temperature:y,owner_id:g,resources:m}))))}function Pt(e){const t=JSON.parse(localStorage.getItem(Re));gt(t,le),e.players.forEach((n,o)=>{n.cells=[...e.board.values()].filter(a=>a.owner_id===o)})}let x=null;function Rt(e){e.owner_id===-1&&e.biome!==d.sea?(x=e,Me([...e.neighbors,e],"white",oe),V.classList.add("hidden"),Ct(e,e.biome.resource_production)):(D.classList.add("hidden"),V.classList.remove("hidden"))}function Tt(e){x!==null&&(Object.entries(et).forEach(([t,n])=>{x.resources[t]=n}),x.owner_id=e.current_player_id,e.active_player.cells=[x],x.cell.classList.remove("clicked"),x=null)}function Ut(e,t){e.owner_id===t.current_player_id?(Q.classList.add("hidden"),It(J([e],t.active_player.tax_rate),Bt(e))):(P.classList.add("hidden"),ze(J(t.active_player.cells,t.active_player.tax_rate),t.active_player.tax_rate))}const E={spring:"spring",summer:"summer",autumn:"autumn",winter:"winter"};function Jt(e){switch(e){case E.spring:return E.summer;case E.summer:return E.autumn;case E.autumn:return E.winter}}function H(e,t){return!(e===t||e===E.winter||e===E.summer&&t===E.spring||e===E.autumn&&t!==E.winter)}let b=null,B=null;function Dt(e,t){if(b===null){Wt(e,t);return}if(e.cell.classList.remove("clicked"),b===e){b=null;return}if(!e.neighbors.includes(b))return;B=e;const n=k.find(({player_id:c,origin:l,target:i})=>c===t.current_player_id&&l===b&&i===B),o=b.owner_id===t.current_player_id,a=B.owner_id===t.current_player_id,s={settle_cell:!1,season:E.spring};if(Object.values(E).forEach(c=>{T.querySelector(`input[value="${c}"]`).disabled=!1}),T.inert=!1,X.inert=a,n?Ft(n,t,o,s):Ht(t,o,s),s.max_value<=0){B=null;return}T.querySelector(`input[value="${s.season}"]`).checked=!0,Object.assign(G,{value:s.current_value,min:s.min_value,max:s.max_value}),ke.value=s.current_value,ut.value=s.min_value,dt.value=s.max_value,X.checked=s.settle_cell,I.showModal()}function Ft(e,t,n,o){const a=k.filter(({player_id:s})=>s===t.current_player_id);o.settle_cell=e.type==="settle",o.current_value=e.units,o.season=e.season,o.min_value=a.filter(({season:s,origin:c})=>H(e.season,s)&&e.target===c).reduce((s,{season:c,origin:l,units:i})=>(U(a,l,c,l.owner_id===t.current_player_id?l.resources[r.people]:0)-e.units<i&&(s+=i),s),0),T.inert=!0,X.inert=!0,n?o.max_value=U(a,b,o.season,b.resources[r.people])-1+o.current_value:o.max_value=U(a,b,o.season)-Number(o.settle_cell)+o.current_value}function Ht(e,t,n){const o=k.filter(({player_id:a})=>a===e.current_player_id);if(n.current_value=0,n.min_value=0,t)n.max_value=U(o,b,n.season,b.resources[r.people])-1;else{const a=o.filter(({target:c})=>c===b).reduce((c,{season:l})=>((c===""||H(l,c))&&(c=l),c),""),s=!!o.find(({target:c,type:l,season:i})=>c===b&&i===a&&l==="settle");if(a===E.winter){B=null;return}Object.values(E).filter(c=>c===a||H(c,a)).forEach(c=>{T.querySelector(`input[value="${c}"]`).disabled=!0}),n.season=Jt(a),n.max_value=U(o,b,n.season)-Number(s)}}function Wt(e,t){const n=k.filter(({player_id:l})=>l===t.current_player_id),o=e.owner_id===t.current_player_id&&e.resources[r.people]>1,a=n.find(({origin:l})=>l===e),s=n.find(({target:l,season:i})=>l===e&&i!=="winter"),c=t.active_player.encampments.has(e);o||a||s||c?b=e:e.cell.classList.remove("clicked")}function U(e,t,n,o=0){return e.filter(({origin:a,target:s,season:c})=>(a===t||s===t)&&(c===n||H(c,n))).reduce((a,s)=>(t===s.target?a+=s.units:a-=s.units,a),o)}function Yt(e){return()=>{const t=I.querySelector('[name="season-of-move"]:checked').value,n=Number(G.value),o=X.checked,a=k.findIndex(({player_id:s,origin:c,target:l})=>s===e.current_player_id&&c===b&&l===B);if(Number.isNaN(n)||n<=0){if(b=null,B=null,a>-1){const[{arrow:s}]=k.splice(a,1);s.remove()}return}if(a>-1){const s=k[a];s.units=n,s.arrow.lastElementChild.lastElementChild.textContent=n}else k.push(Ae(e.current_player_id,b,B,n,t,o?"settle":"unspecified"));b=null,B=null}}const S={land_grab:W("land_grab","Pick your origin","Confirm choice",Rt),development:W("development","Distribute your wealth",void 0,Ut),movement_planning:W("movement_planning","Make your moves",void 0,Dt),movement_execution:W("movement_execution","","Next Move")};function Kt(e){return()=>{if(e.current_phase===S.land_grab.name)Tt(e);else if(e.current_phase===S.movement_execution.name){const{value:t,done:n}=e.moves.next();if(console.log(t),!n)return}e.next_turn()}}function W(e="round_phase",t="",n="End turn",o=(a,s)=>{}){return{name:e,call_to_action:t,end_turn_btn_label:n,handle_click_on_cell:o}}function*Qt(){for(const e in E){const{moves_in_this_season:t,moves_so_far:n}=k.reduce((o,a)=>(e===a.season?o.moves_in_this_season.push(a):H(a.season,e)&&o.moves_so_far.push(a),o),{moves_in_this_season:[],moves_so_far:[]});n.forEach(({arrow:o})=>o.removeAttribute("style")),Le.textContent=`Move(s) in ${e}`;for(const o of t)o.arrow.style.display="initial",yield o}}const q=[];let j=0,O=S.land_grab.name,$=0,Te=null,me;const f={board:le,get moves(){return me},get round(){return j},set round(e){j=e},get active_player(){return q[$]},get players(){return q},set players(e){q.push(...e)},get current_player_id(){return $},set current_player_id(e){$=e},get current_player_total_production(){return Te},clear_players(){q.forEach(e=>e.destroy()),q.length=0},get current_phase(){return O},set current_phase(e){O=e},update_resource_display:Ue,next_turn(){oe.replaceChildren(),$===q.length-1?($=0,O=(()=>{switch(O){case S.development.name:return Pe(),S.movement_planning.name;case S.movement_planning.name:return me=Qt(),$=q.length-1,S.movement_execution.name;default:return j+=1,S.development.name}})()):$+=1,pe()},run:pe};function pe(){Se.textContent=S[O].end_turn_btn_label,Le.textContent=S[O].call_to_action,Z.classList.remove("hidden"),Z.textContent=q[$].name,document.body.dataset.current_phase=S[O].name,document.documentElement.style.setProperty("--active-player-color",`var(--player-${$+1}`),ne.classList.add("content-hidden"),O===S.land_grab.name?(D.classList.add("hidden"),V.classList.remove("hidden")):O===S.development.name?(D.classList.add("hidden"),V.classList.add("hidden"),Te=J(q[$].cells,q[$].tax_rate),P.classList.add("hidden"),ze(J(q[$].cells,q[$].tax_rate),q[$].tax_rate),ne.classList.remove("content-hidden"),Ue()):O===S.movement_execution.name&&Z.classList.add("hidden")}function Ue(){ne.replaceChildren(...Object.entries(q[$].resources).map(([e,t])=>Object.assign(document.createElement("div"),{textContent:`${e}: ${t}`})))}const fe="wargame-savegame";function Vt(){if(f.players.length===0){localStorage.removeItem(fe);return}localStorage.setItem(fe,JSON.stringify({round:f.round,current_phase:f.current_phase,current_player_id:f.current_player_id,players:f.players.map(({name:e,type:t})=>({name:e,type:t}))}))}function Gt(e,t){const n=JSON.parse(t);Object.assign(e,{round:n.round,current_phase:n.current_phase,current_player_id:n.current_player_id,players:n.players.map(({name:o,type:a},s)=>ae(s,o,a))})}window.addEventListener("DOMContentLoaded",()=>{const e=localStorage.getItem("wargame-savegame"),t=e!==null;N.dataset.priorSave=t,N.showModal(),t?(Gt(f,e),Pt(f)):wt(w,f.board),zt(f)},{once:!0});document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&(Vt(),At(),Nt())});document.addEventListener("submit",Ke);G.addEventListener("input",()=>{ke.value=G.value});it.addEventListener("submit",e=>{e.submitter.id==="continue-btn"?N.dataset.priorSave==="true"&&N.close():e.submitter.id==="new-game-btn"&&(N.dataset.priorSave==="true"&&(Object.assign(f,{round:0,current_phase:S.land_grab.name,current_player_id:0}),Ie(f.board),f.clear_players(),Pe()),Array.from({length:2},(t,n)=>Ne(n+1)),N.classList.add("game-config"))});N.addEventListener("close",()=>{f.players.length===0&&(f.players=Array.from({length:2},(e,t)=>ae(t,`Player ${t+1}`,"human"))),f.run()});ct.addEventListener("click",()=>Ie(f.board));Se.addEventListener("click",Kt(f));_e.addEventListener("submit",()=>{const e=new Set,t=[..._e.querySelectorAll(".player-name-input")];if(t.reduce((n,{value:o})=>(n[o]=o in n?n[o]+1:1,n[o]>1&&e.add(o),n),{}),e.size>0){t.forEach(n=>{e.has(n.value)&&n.classList.add("invalid")});return}f.players=Array.from(F,(n,o)=>{const a=n.querySelector(".player-name-input").value,s=n.querySelector(".player-type-select-radio:checked").value;return ae(o,a,s)}),N.close()});ot.addEventListener("click",()=>{F.length!==5&&Ne(F.length+1)});$e.addEventListener("click",({target:e})=>{e.closest(".delete-player-btn")&&F.length!==2&&(e.closest(".player-config").remove(),[...F].forEach((t,n)=>{n=n+1,Object.assign(t.querySelector(".player-name-input"),{name:`player-${n}-name`,value:`Player ${n}`}),t.querySelectorAll(".player-type-select-radio").forEach(o=>{o.name=`player-${n}-type`})}))});te.addEventListener("click",({target:e})=>{const t=e.closest(".cell-wrapper");if(!t)return;const n=te.querySelector(".clicked"),o=f.board.get(t);n&&(n.classList.remove("clicked"),oe.replaceChildren()),n!==t&&t.classList.add("clicked"),Xt(o),S[f.current_phase].handle_click_on_cell(o,f)});lt.addEventListener("input",Mt(f));I.addEventListener("close",Yt(f));I.addEventListener("submit",()=>I.close());document.querySelector("h1").addEventListener("dblclick",()=>document.body.classList.toggle("debug"));at.addEventListener("click",()=>document.body.classList.toggle("use-offset-coords"));function Xt(e){st.textContent=JSON.stringify(e,(t,n)=>t==="neighbors"?void 0:n,4)}
