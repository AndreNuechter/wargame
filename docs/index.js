(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))o(a);new MutationObserver(a=>{for(const n of a)if(n.type==="childList")for(const s of n.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&o(s)}).observe(document,{childList:!0,subtree:!0});function r(a){const n={};return a.integrity&&(n.integrity=a.integrity),a.referrerPolicy&&(n.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?n.credentials="include":a.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function o(a){if(a.ep)return;a.ep=!0;const n=r(a);fetch(a.href,n)}})();const V=""+new URL("service-worker.js",import.meta.url).href;window.navigator.serviceWorker.register(V).catch(console.error);let $;async function Q(){var e,t;$=await((t=(e=navigator.wakeLock)==null?void 0:e.request)==null?void 0:t.call(e,"screen"))}async function X(){$&&(await $.release(),$=void 0)}const A={request:Q,release:X},g={width:30,height:24};function q(e){return e%2===0}function Z(e,t,r){return e>=t&&e<=r}function ee(e,t=0,r=e.length){return e[k(r,t)]}function k(e,t=0){return Math.trunc(Math.random()*(e-t)+t)}function O(e){e.forEach(t=>{t.neighbors=te(t,e,g)})}function te({q:e,r:t,s:r,x:o,y:a},n,s){const _=[{q:1,r:0,s:-1},{q:1,r:-1,s:0},{q:0,r:1,s:-1},{q:0,r:-1,s:1},{q:-1,r:0,s:1},{q:-1,r:1,s:0}].map(i=>n.find(m=>m.q===e+i.q&&m.r===t+i.r&&m.s===r+i.s)).filter(Boolean);return o===0&&(_.push(n.find(i=>a===i.y&&i.x===s.width-1)),q(a)&&_.push(...[a<s.height-1?n.find(i=>a+1===i.y&&i.x===s.width-1):null,a>0?n.find(i=>a-1===i.y&&i.x===s.width-1):null].filter(Boolean))),o===s.width-1&&(_.push(n.find(i=>a===i.y&&i.x===0)),q(a)||_.push(...[a<s.height-1?n.find(i=>a+1===i.y&&i.x===0):null,a>0?n.find(i=>a-1===i.y&&i.x===0):null].filter(Boolean))),_}const p={freezing:"freezing",cold:"cold",temperate:"temperate",warm:"warm",hot:"hot"};function C(e){e.forEach(t=>{const r=Math.random(),o=-1,a=Z(r,.3,.7)?0:1*(-1*+(r<.3)),n=(s=>s<0?0:s>g.height-1?g.height-1:s)(t.y+a+o);t.temperature=re(n)})}function re(e){switch(e){case 0:case 1:case g.height-2:case g.height-1:return p.freezing;case 2:case 3:case g.height-4:case g.height-3:return p.cold;case 4:case 5:case g.height-6:case g.height-5:return p.temperate;case 6:case 7:case 8:case g.height-9:case g.height-8:case g.height-7:return p.warm;default:return p.hot}}function ne(e){switch(e){case p.hot:return p.warm;case p.warm:return p.temperate;case p.temperate:return p.cold;default:return p.freezing}}function ae(e){switch(e){case p.freezing:return p.cold;case p.cold:return p.temperate;case p.temperate:return p.warm;default:return p.hot}}const I=new Set([0,1,2,g.height-1,g.height-2,g.height-3]);function z(e){const o=e.length/2.5;let a=0;for(;a<o;){const n=k(13,4),s={x:k(g.width),y:k(g.height-3,3)},u=e.find(({x:m,y:h})=>m===s.x&&h===s.y),_=new Set(u.neighbors.filter(({y:m})=>!I.has(m))),i=new Set;a+=n,N(u),i.add(u);for(let m=0;m<n;m+=1){const h=ee([..._]);N(h),i.add(h),_.delete(h),h.neighbors.filter(d=>!i.has(d)).filter(({y:d})=>!I.has(d)).forEach(d=>_.add(d))}}e.filter(n=>n.elevation>0).forEach(n=>{const s=n.neighbors.filter(_=>_.elevation>0).length;if(s>=3)return;const u=Math.random();(s===2&&u>.7||s===1&&u<.7)&&oe(n)})}function N(e){e.elevation+=1,e.elevation>1&&(e.temperature=ne(e.temperature))}function oe(e){e.elevation=Math.max(0,e.elevation-1),e.elevation>0&&(e.temperature=ae(e.temperature))}const l={arid:"arid",dry:"dry",moderate:"moderate",moist:"moist",wet:"wet"};function se(e){switch(e){case l.arid:return l.dry;case l.dry:return l.moderate;case l.moderate:return l.moist;default:return l.wet}}function P(e){e.filter(t=>t.elevation>0).forEach(t=>{t.neighbors.filter(({biome:r})=>r===c.sea.name).forEach(()=>{t.humidity=se(t.humidity)})})}const c={sea:new y("sea"),mountain:new y("mountain"),high_mountain:new y("high_mountain"),ice:new y("ice"),tundra:new y("tundra"),grassland:new y("grassland"),savanna:new y("savanna"),boreal_forest:new y("boreal_forest"),forest:new y("forest"),tropical_rainforest:new y("tropical_rainforest"),cold_swamp:new y("cold_swamp"),swamp:new y("swamp"),tropical_swamp:new y("tropical_swamp"),desert:new y("desert"),extreme_desert:new y("extreme_desert")},ie={[p.freezing]:{[l.arid]:c.tundra.name,[l.dry]:c.tundra.name,[l.moderate]:c.tundra.name,[l.moist]:c.boreal_forest.name,[l.wet]:c.boreal_forest.name},[p.cold]:{[l.arid]:c.tundra.name,[l.dry]:c.tundra.name,[l.moderate]:c.boreal_forest.name,[l.moist]:c.boreal_forest.name,[l.wet]:c.boreal_forest.name},[p.temperate]:{[l.arid]:c.tundra.name,[l.dry]:c.forest.name,[l.moderate]:c.forest.name,[l.moist]:c.forest.name,[l.wet]:c.swamp.name},[p.warm]:{[l.arid]:c.desert.name,[l.dry]:c.grassland.name,[l.moderate]:c.savanna.name,[l.moist]:c.forest.name,[l.wet]:c.tropical_swamp.name},[p.hot]:{[l.arid]:c.extreme_desert.name,[l.dry]:c.desert.name,[l.moderate]:c.grassland.name,[l.moist]:c.savanna.name,[l.wet]:c.tropical_rainforest.name}};function y(e="",t=0,r={wood:[1,5],stone:[1,5],food:[1,5]}){return{name:e,movement_resistance:t,resource_production:r}}function j(e){e.forEach(t=>{t.biome=le(t)})}function D(e){e.filter(({elevation:t})=>t===0).forEach(t=>{t.biome=ce(t)})}function ce(e,t=g.height){const r=Math.random();return[0,t-1].includes(e.y)?r<=.1?c.sea.name:c.ice.name:[1,t-2].includes(e.y)?r<=.75?c.sea.name:c.ice.name:[2,t-3].includes(e.y)?r<=.9?c.sea.name:c.ice.name:c.sea.name}function le(e){return e.biome?e.biome:e.elevation>1?e.elevation>2?c.high_mountain.name:c.mountain.name:ie[e.temperature][e.humidity]}const R=document.createElement("style");R.textContent=Object.values(c).map(e=>`[data-biome="${e.name}"] {
        fill: var(--${e.name});
    }`).join(`
`);document.body.append(R);const de=document.getElementById("add-player-btn"),E=document.getElementById("board"),ue=document.getElementById("cell-info"),me=document.getElementById("toggle-coord-system-btn"),B=document.getElementById("config-game-form"),T=document.getElementById("end-turn-btn"),L=document.getElementsByClassName("player-config"),U=document.getElementById("player-setup"),fe=document.getElementById("reroll-map-btn");document.getElementById("round-info");const M=document.getElementById("selection-highlight"),pe=document.getElementById("start-game-form"),b=document.getElementById("start-game-overlay"),_e=(()=>{const e=document.createElementNS("http://www.w3.org/2000/svg","use"),t=document.createElementNS("http://www.w3.org/2000/svg","g");return e.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href","#outer-hex"),e.classList.add("outer-cell"),t.classList.add("cell"),t.append(e),t})(),ge=(()=>{const e=document.createElementNS("http://www.w3.org/2000/svg","g");return e.classList.add("player-border"),e})(),he=document.getElementById("player-config-tmpl").content;function x(e,t,r,o,a,n,s){const u=ye(e,t,r,o,a,n,s);let _="",i=-1;return{cx:e,cy:t,x:r,y:o,q:a,r:n,s,neighbors:[],cell:u,elevation:0,humidity:l.arid,temperature:p.freezing,get biome(){return _},set biome(m){_=m,u.dataset.biome=m},get owner_id(){return i},set owner_id(m){if(m!==void 0){if(i=m,m===-1){u.firstChild.classList.remove("owned");return}u.dataset.owner_id=m,u.firstChild.classList.add("owned")}}}}function ye(e,t,r,o,a,n,s){const u=_e.cloneNode(!0);u.setAttribute("transform",`translate(${e}, ${t})`);const _=document.createElementNS("http://www.w3.org/2000/svg","g"),i=document.createElementNS("http://www.w3.org/2000/svg","text"),m=document.createElementNS("http://www.w3.org/2000/svg","text"),h=document.createElementNS("http://www.w3.org/2000/svg","text"),d=document.createElementNS("http://www.w3.org/2000/svg","text");return i.textContent=a,m.textContent=n,h.textContent=s,d.textContent=`${r}, ${o}`,i.setAttribute("transform","translate(1.5, 2)"),m.setAttribute("transform","translate(4.5, 3.5)"),h.setAttribute("transform","translate(2, 5)"),d.setAttribute("transform","translate(1.5, 3.5)"),_.classList.add("cell-coord"),i.classList.add("cube-coord"),m.classList.add("cube-coord"),h.classList.add("cube-coord"),d.classList.add("offset-coord"),_.append(i,m,h,d),u.append(_),E.prepend(u),u}function W(e){const t=[...e.values()];return t.forEach(r=>Object.assign(r,{biome:"",elevation:0,humidity:l.arid,temperature:p.freezing,owner_id:-1})),C(t),z(t),D(t),P(t),j(t),e}function we(e,t){const r=e.map(({cx:o,cy:a,x:n,y:s,q:u,r:_,s:i,biome:m,elevation:h,humidity:d,temperature:G,owner_id:K})=>Object.assign(x(o,a,n,s,u,_,i),{biome:m,elevation:h,humidity:d,temperature:G,owner_id:K}));return O(r),Y(r,t)}function be(e,t){const r=ve(e);return O(r),C(r),z(r),D(r),P(r),j(r),Y(r,t)}function Y(e,t){return e.reduce((r,o)=>(r.set(o.cell,o),r),t)}function ve({height:e,width:t}){const r=[];for(let o=0;o<e;o+=1){const a=+!q(o);for(let n=0;n<t;n+=1){const s=n-(o-(o&1))/2;r.push(x(n*6+a*3,o*4.5,n,o,s,o,-s-o))}}return r}function H(e,t,r){const o=[];e.reduce((n,s)=>{const u=s.neighbors.filter(d=>!e.includes(d)),_=Ee(s),i=Le(s),m=qe(s),h=$e(s);return u.find(d=>d.r===s.r&&d.s===s.s+1)&&n.push(`M${h} v-3`),u.find(d=>d.r===s.r&&d.s===s.s-1)&&n.push(`M${m} v-3`),u.find(d=>d.q===s.q&&d.s===s.s+1)&&n.push(`M${_} L${Se(s)}`),u.find(d=>d.q===s.q&&d.s===s.s-1)&&n.push(`M${i} L${m}`),u.find(d=>d.s===s.s&&d.r===s.r-1)&&n.push(`M${_} L${ke(s)}`),u.find(d=>d.s===s.s&&d.r===s.r+1)&&n.push(`M${i} L${h}`),n},o);const a=document.createElementNS("http://www.w3.org/2000/svg","path");a.setAttribute("d",o.join("")),a.setAttribute("stroke",t),a.setAttribute("stroke-width","0.3"),r.append(a)}function Ee(e){return`${e.cx+3} ${e.cy}`}function Le(e){return`${e.cx+3} ${e.cy+6}`}function Se(e){return`${e.cx} ${e.cy+1.5}`}function $e(e){return`${e.cx} ${e.cy+4.5}`}function ke(e){return`${e.cx+6} ${e.cy+1.5}`}function qe(e){return`${e.cx+6} ${e.cy+4.5}`}const Ie={human:"human",ai:"ai"};function J(e){const t=he.cloneNode(!0);Object.assign(t.querySelector(".player-name-input"),{name:`player-${e}-name`,value:`Player ${e}`}),t.querySelectorAll(".player-type-select-radio").forEach(r=>{r.name=`player-${e}-type`}),U.append(t)}function F(e,t=Ie.ai,r){const o=[],a=ge.cloneNode(!0);return E.append(a),{name:e,color:r,type:t,border_path_container:a,get cells(){return o},set cells(n){o.push(...n),H(o,r,a)},destroy(){o.length=0,a.remove()}}}const w={land_grab:S("land_grab","Pick your origin","Confirm choice"),development:S("development","Distribute your wealth"),movement_planning:S("movement_planning","Make your moves"),movement_execution:S("movement_execution","See what you have done")};function S(e,t=e,r="End turn"){return{name:e,call_to_action:t,end_turn_btn_label:r}}const f=(()=>{const e=[];let t=0,r=w.land_grab.name,o=0;function a(){T.textContent=w[r].end_turn_btn_label,document.getElementById("phase-label").textContent=w[r].call_to_action,document.getElementById("player-name").textContent=e[o].name}return{board:new Map,get round(){return t},set round(n){t=n},get players(){return e},set players(n){e.push(...n)},get current_player_id(){return o},set current_player_id(n){o=n},clear_players(){e.forEach(n=>n.destroy()),e.length=0},get current_phase(){return r},set current_phase(n){r=n},next_turn(){o===e.length-1?(o=0,r=(()=>{switch(r){case w.development.name:return w.movement_planning.name;case w.movement_planning.name:return w.movement_execution.name;default:return t+=1,w.development.name}})()):o+=1,a()},run:a}})();function Ne(e,t){const r=JSON.parse(t);Object.assign(e,{round:r.round,current_phase:r.current_phase,current_player_id:r.current_player_id,players:r.players.map(({name:o,type:a,color:n})=>F(o,a,n)),board:we(r.board,e.board)}),e.players.forEach((o,a)=>{o.cells=[...e.board.values()].filter(n=>n.owner_id===a)})}let v=null;window.addEventListener("DOMContentLoaded",()=>{const e=localStorage.getItem("wargame-savegame"),t=e!==null;b.dataset.priorSave=t,b.showModal(),A.request(),t?Ne(f,e):f.board=be(g,f.board)},{once:!0});window.addEventListener("beforeunload",()=>{if(A.release(),f.players.length===0){localStorage.removeItem("wargame-savegame");return}localStorage.setItem("wargame-savegame",JSON.stringify({round:f.round,current_phase:f.current_phase,current_player_id:f.current_player_id,players:f.players.map(({name:e,type:t,color:r})=>({name:e,type:t,color:r})),board:[...f.board.values()].map(({cx:e,cy:t,x:r,y:o,q:a,r:n,s,biome:u,elevation:_,humidity:i,temperature:m,owner_id:h})=>({cx:e,cy:t,x:r,y:o,q:a,r:n,s,biome:u,elevation:_,humidity:i,temperature:m,owner_id:h}))}))});pe.addEventListener("submit",e=>{if(e.preventDefault(),e.submitter.id==="new-game-btn")b.dataset.priorSave==="true"&&(Object.assign(f,{round:0,current_phase:w.land_grab.name,current_player_id:0}),f.board=W(f.board),f.clear_players()),Array.from({length:2},(t,r)=>J(r+1)),b.classList.add("game-config");else{if(b.dataset.priorSave==="false")return;f.run(),b.close()}});fe.addEventListener("click",()=>{f.board=W(f.board)});T.addEventListener("click",()=>{if(f.current_phase===w.land_grab.name){if(v===null)return;f.board.get(v).owner_id=f.current_player_id,f.players[f.current_player_id].cells=[f.board.get(v)],v=null}f.next_turn()});B.addEventListener("submit",e=>{e.preventDefault();const t=new Set,r=[...B.querySelectorAll(".player-name-input")];if(r.reduce((a,{value:n})=>(a[n]=n in a?a[n]+1:1,a[n]>1&&t.add(n),a),{}),t.size!==0){r.forEach(a=>{t.has(a.value)&&a.classList.add("invalid")});return}const o=["tomato","rebeccapurple","gold","aquamarine","hotpink"];f.players=Array.from(L,(a,n)=>{const s=a.querySelector(".player-name-input").value,u=a.querySelector(".player-type-select-radio:checked").value;return F(s,u,o[n])}),f.run(),b.close()});de.addEventListener("click",()=>{L.length!==5&&J(L.length+1)});U.addEventListener("click",({target:e})=>{e.closest(".delete-player-btn")&&L.length!==2&&(e.closest(".player-config").remove(),[...L].forEach((t,r)=>{r=r+1,Object.assign(t.querySelector(".player-name-input"),{name:`player-${r}-name`,value:`Player ${r}`}),t.querySelectorAll(".player-type-select-radio").forEach(o=>{o.name=`player-${r}-type`})}))});b.addEventListener("cancel",e=>e.preventDefault());E.addEventListener("click",({target:e})=>{const t=e.closest(".cell");if(!t)return;const r=E.querySelector(".clicked"),o=f.board.get(t);if(!(r&&(r.classList.remove("clicked"),M.replaceChildren(),v=null,r===t))){if(t.classList.add("clicked"),H([...o.neighbors,o],"white",M),f.current_phase===w.land_grab.name){if(o.owner_id!==-1||o.biome===c.sea.name)return;v=t}else if(f.current_phase===w.development.name&&o.owner_id!==f.current_player_id)return}});E.addEventListener("pointerover",({target:e})=>{const t=e.closest(".cell");if(!t)return;const r=f.board.get(t);ue.textContent=`
        biome: ${r.biome},
        temperature: ${r.temperature},
        humidity: ${r.humidity},
        elevation: ${r.elevation}
    `});me.addEventListener("click",()=>{document.body.classList.toggle("use-offset-coords")});
