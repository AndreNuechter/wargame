(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const n of o)if(n.type==="childList")for(const c of n.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&s(c)}).observe(document,{childList:!0,subtree:!0});function r(o){const n={};return o.integrity&&(n.integrity=o.integrity),o.referrerPolicy&&(n.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?n.credentials="include":o.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(o){if(o.ep)return;o.ep=!0;const n=r(o);fetch(o.href,n)}})();const ne=""+new URL("service-worker.js",import.meta.url).href;window.navigator.serviceWorker.register(ne).catch(console.error);let O;async function oe(){var e,t;O=await((t=(e=navigator.wakeLock)==null?void 0:e.request)==null?void 0:t.call(e,"screen"))}async function ae(){O&&(await O.release(),O=void 0)}const U={request:oe,release:ae},h={width:30,height:24};function M(e){return e%2===0}function se(e,t,r){return e>=t&&e<=r}function ce(e,t=0,r=e.length){return e[N(r,t)]}function N(e,t=0){return Math.trunc(Math.random()*(e-t)+t)}function D(e){e.forEach(t=>{t.neighbors=ie(t,e,h)})}function ie({q:e,r:t,s:r,x:s,y:o},n,c){const f=[{q:1,r:0,s:-1},{q:1,r:-1,s:0},{q:0,r:1,s:-1},{q:0,r:-1,s:1},{q:-1,r:0,s:1},{q:-1,r:1,s:0}].map(i=>n.find(p=>p.q===e+i.q&&p.r===t+i.r&&p.s===r+i.s)).filter(Boolean);return s===0&&(f.push(n.find(i=>o===i.y&&i.x===c.width-1)),M(o)&&f.push(...[o<c.height-1?n.find(i=>o+1===i.y&&i.x===c.width-1):null,o>0?n.find(i=>o-1===i.y&&i.x===c.width-1):null].filter(Boolean))),s===c.width-1&&(f.push(n.find(i=>o===i.y&&i.x===0)),M(o)||f.push(...[o<c.height-1?n.find(i=>o+1===i.y&&i.x===0):null,o>0?n.find(i=>o-1===i.y&&i.x===0):null].filter(Boolean))),f}const _={freezing:"freezing",cold:"cold",temperate:"temperate",warm:"warm",hot:"hot"};function T(e){e.forEach(t=>{const r=Math.random(),s=-1,o=se(r,.3,.7)?0:1*(-1*+(r<.3)),n=(c=>c<0?0:c>h.height-1?h.height-1:c)(t.y+o+s);t.temperature=le(n)})}function le(e){switch(e){case 0:case 1:case h.height-2:case h.height-1:return _.freezing;case 2:case 3:case h.height-4:case h.height-3:return _.cold;case 4:case 5:case h.height-6:case h.height-5:return _.temperate;case 6:case 7:case 8:case h.height-9:case h.height-8:case h.height-7:return _.warm;default:return _.hot}}function de(e){switch(e){case _.hot:return _.warm;case _.warm:return _.temperate;case _.temperate:return _.cold;default:return _.freezing}}function ue(e){switch(e){case _.freezing:return _.cold;case _.cold:return _.temperate;case _.temperate:return _.warm;default:return _.hot}}const A=new Set([0,1,2,h.height-1,h.height-2,h.height-3]);function J(e){const s=e.length/2.5;let o=0;for(;o<s;){const n=N(13,4),c={x:N(h.width),y:N(h.height-3,3)},m=e.find(({x:p,y})=>p===c.x&&y===c.y),f=new Set(m.neighbors.filter(({y:p})=>!A.has(p))),i=new Set;o+=n,j(m),i.add(m);for(let p=0;p<n;p+=1){const y=ce([...f]);j(y),i.add(y),f.delete(y),y.neighbors.filter(w=>!i.has(w)).filter(({y:w})=>!A.has(w)).forEach(w=>f.add(w))}}e.filter(n=>n.elevation>0).forEach(n=>{const c=n.neighbors.filter(f=>f.elevation>0).length;if(c>=3)return;const m=Math.random();(c===2&&m>.7||c===1&&m<.7)&&me(n)})}function j(e){e.elevation+=1,e.elevation>1&&(e.temperature=de(e.temperature))}function me(e){e.elevation=Math.max(0,e.elevation-1),e.elevation>0&&(e.temperature=ue(e.temperature))}const u={arid:"arid",dry:"dry",moderate:"moderate",moist:"moist",wet:"wet"};function pe(e){switch(e){case u.arid:return u.dry;case u.dry:return u.moderate;case u.moderate:return u.moist;default:return u.wet}}function W(e){e.filter(t=>t.elevation>0).forEach(t=>{t.neighbors.filter(({biome:r})=>r===l.sea).forEach(()=>{t.humidity=pe(t.humidity)})})}const a={people:"people",gold:"gold",cloth:"cloth",wood:"wood",stone:"stone",iron:"iron",food:"food",alcohol:"alcohol"},l={sea:new b("sea",{[a.food]:1}),mountain:new b("mountain",{[a.wood]:2,[a.stone]:5,[a.food]:3}),high_mountain:new b("high_mountain",{[a.stone]:5}),ice:new b("ice",{[a.food]:2}),tundra:new b("tundra",{[a.cloth]:1,[a.wood]:2,[a.stone]:1,[a.food]:5}),grassland:new b("grassland",{[a.cloth]:3,[a.wood]:2,[a.stone]:2,[a.food]:5}),savanna:new b("savanna",{[a.cloth]:5,[a.wood]:5,[a.stone]:3,[a.food]:6}),boreal_forest:new b("boreal_forest",{[a.cloth]:4,[a.wood]:10,[a.stone]:3,[a.food]:5}),forest:new b("forest",{[a.cloth]:2,[a.wood]:10,[a.stone]:2,[a.food]:5}),tropical_rainforest:new b("tropical_rainforest",{[a.cloth]:3,[a.wood]:7,[a.stone]:1,[a.food]:5}),cold_swamp:new b("cold_swamp",{[a.cloth]:1,[a.wood]:2,[a.stone]:1,[a.food]:2}),swamp:new b("swamp",{[a.cloth]:1,[a.wood]:1,[a.stone]:0,[a.food]:3}),tropical_swamp:new b("tropical_swamp",{[a.cloth]:1,[a.wood]:3,[a.stone]:1,[a.food]:3}),desert:new b("desert",{[a.cloth]:1,[a.wood]:0,[a.stone]:2,[a.food]:1}),extreme_desert:new b("extreme_desert",{[a.cloth]:0,[a.wood]:0,[a.stone]:1,[a.food]:0})},fe={[_.freezing]:{[u.arid]:l.tundra,[u.dry]:l.tundra,[u.moderate]:l.tundra,[u.moist]:l.boreal_forest,[u.wet]:l.boreal_forest},[_.cold]:{[u.arid]:l.tundra,[u.dry]:l.tundra,[u.moderate]:l.boreal_forest,[u.moist]:l.boreal_forest,[u.wet]:l.boreal_forest},[_.temperate]:{[u.arid]:l.tundra,[u.dry]:l.forest,[u.moderate]:l.forest,[u.moist]:l.forest,[u.wet]:l.swamp},[_.warm]:{[u.arid]:l.desert,[u.dry]:l.grassland,[u.moderate]:l.savanna,[u.moist]:l.forest,[u.wet]:l.tropical_swamp},[_.hot]:{[u.arid]:l.extreme_desert,[u.dry]:l.desert,[u.moderate]:l.grassland,[u.moist]:l.savanna,[u.wet]:l.tropical_rainforest}};function b(e="",t={},r=1,s=1){return{name:e,resource_production:Object.assign({[a.gold]:0,[a.cloth]:0,[a.wood]:0,[a.stone]:0,[a.iron]:0,[a.food]:0,[a.alcohol]:0},t),movement_speed:r,pleasantness:s}}function Y(e){e.forEach(t=>{t.biome=ge(t)})}function H(e){e.filter(({elevation:t})=>t===0).forEach(t=>{t.biome=_e(t)})}function _e(e,t=h.height){const r=Math.random();return[0,t-1].includes(e.y)?r<=.1?l.sea:l.ice:[1,t-2].includes(e.y)?r<=.75?l.sea:l.ice:[2,t-3].includes(e.y)?r<=.9?l.sea:l.ice:l.sea}function ge(e){return e.biome?e.biome:e.elevation>1?e.elevation>2?l.high_mountain:l.mountain:fe[e.temperature][e.humidity]}const F=document.createElement("style");F.textContent=Object.keys(l).map(e=>`[data-biome="${e}"] {
        fill: var(--${e});
    }`).join(`
`);document.body.append(F);const he=document.getElementById("add-player-btn"),C=document.getElementById("board"),x=document.getElementById("bottom-bar");document.getElementById("cell-info");const ye=document.getElementById("toggle-coord-system-btn"),z=document.getElementById("config-game-form"),G=document.getElementById("end-turn-btn"),we=document.getElementById("phase-label"),k=document.getElementsByClassName("player-config"),be=document.getElementById("player-name"),K=document.getElementById("player-setup"),ve=document.getElementById("reroll-map-btn");document.getElementById("round-info");const P=document.getElementById("selection-highlight"),Ee=document.getElementById("start-game-form"),L=document.getElementById("start-game-overlay"),Se=(()=>{const e=document.createElementNS("http://www.w3.org/2000/svg","use"),t=document.createElementNS("http://www.w3.org/2000/svg","g");return e.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href","#outer-hex"),e.classList.add("outer-cell"),t.classList.add("cell"),t.append(e),t})(),Le=(()=>{const e=document.createElementNS("http://www.w3.org/2000/svg","g");return e.classList.add("player-border"),e})(),$e=document.getElementById("player-config-tmpl").content;function V(e,t,r,s,o,n,c){const m=ke(e,t,r,s,o,n,c);let f=null,i=-1;return{cx:e,cy:t,x:r,y:s,q:o,r:n,s:c,neighbors:[],cell:m,elevation:0,humidity:u.arid,temperature:_.freezing,population:0,structures:{},resources:{},get biome(){return f||""},set biome(p){f=p,p&&(m.dataset.biome=f.name)},get owner_id(){return i},set owner_id(p){p!==void 0&&(i=p,p!==-1&&(m.dataset.owner_id=p))}}}function ke(e,t,r,s,o,n,c){const m=Se.cloneNode(!0);m.setAttribute("transform",`translate(${e}, ${t})`);const f=document.createElementNS("http://www.w3.org/2000/svg","g"),i=document.createElementNS("http://www.w3.org/2000/svg","text"),p=document.createElementNS("http://www.w3.org/2000/svg","text"),y=document.createElementNS("http://www.w3.org/2000/svg","text"),w=document.createElementNS("http://www.w3.org/2000/svg","text");return i.textContent=o,p.textContent=n,y.textContent=c,w.textContent=`${r}, ${s}`,i.setAttribute("transform","translate(1.5, 2)"),p.setAttribute("transform","translate(4.5, 3.5)"),y.setAttribute("transform","translate(2, 5)"),w.setAttribute("transform","translate(1.5, 3.5)"),f.classList.add("cell-coord"),i.classList.add("cube-coord"),p.classList.add("cube-coord"),y.classList.add("cube-coord"),w.classList.add("offset-coord"),f.append(i,p,y,w),m.append(f),C.prepend(m),m}function Q(e){const t=[...e.values()];return t.forEach(r=>Object.assign(r,{biome:null,elevation:0,humidity:u.arid,temperature:_.freezing,owner_id:-1})),T(t),J(t),H(t),W(t),Y(t),e}function qe(e,t){const r=e.map(({cx:s,cy:o,x:n,y:c,q:m,r:f,s:i,biome_name:p,elevation:y,humidity:w,temperature:q,owner_id:g})=>Object.assign(V(s,o,n,c,m,f,i),{biome:l[p],elevation:y,humidity:w,temperature:q,owner_id:g}));return D(r),X(r,t)}function Ie(e,t){const r=Be(e);return D(r),T(r),J(r),H(r),W(r),Y(r),X(r,t)}function X(e,t){return e.reduce((r,s)=>(r.set(s.cell,s),r),t)}function Be({height:e,width:t}){const r=[];for(let s=0;s<e;s+=1){const o=+!M(s);for(let n=0;n<t;n+=1){const c=n-(s-(s&1))/2;r.push(V(n*6+o*3,s*4.5,n,s,c,s,-c-s))}}return r}const Oe={simple_housing:S([I(a.wood,1),I(a.cloth,1)],e=>{e.housing_capacity+=5}),textile_factory:S([I(a.wood,5),I(a.stone,5)],e=>{}),lumber_mill:S(),quarry:S(),mine:S(),forge:S(),farm:S(),distillery:S()};function S(e=[],t=()=>{},r=[],s=[],o=1){return{resource_cost:e,unsupported_biomes:r,effects:t,output:s,required_workers:o}}function I(e,t){return{resource_name:e,amount:t}}const Z=.5,E=Z*.5;function ee(e,t,r){const s=[];e.reduce((n,c)=>{const m=c.neighbors.filter(g=>!e.includes(g)),f=Ne(c),i=Ce(c),p=je(c),y=Me(c),w=Ae(c),q=xe(c);return m.find(g=>g.r===c.r&&g.s===c.s+1)&&n.push(`M${y}L${q}`),m.find(g=>g.q===c.q&&g.s===c.s+1)&&n.push(`M${q}L${f}`),m.find(g=>g.s===c.s&&g.r===c.r-1)&&n.push(`M${f}L${w}`),m.find(g=>g.r===c.r&&g.s===c.s-1)&&n.push(`M${w}L${p}`),m.find(g=>g.q===c.q&&g.s===c.s-1)&&n.push(`M${p}L${i}`),m.find(g=>g.s===c.s&&g.r===c.r+1)&&n.push(`M${i}L${y}`),n},s);const o=document.createElementNS("http://www.w3.org/2000/svg","path");o.setAttribute("d",s.join("")),o.setAttribute("stroke",t),o.setAttribute("stroke-width",Z),r.append(o)}function Ne(e){return`${e.cx+3} ${e.cy+E}`}function Ce(e){return`${e.cx+3} ${e.cy+6-E}`}function xe(e){return`${e.cx+E} ${e.cy+1.5+E*.5}`}function Me(e){return`${e.cx+E} ${e.cy+4.5-E*.5}`}function Ae(e){return`${e.cx+6-E} ${e.cy+1.5+E*.5}`}function je(e){return`${e.cx+6-E} ${e.cy+4.5-E*.5}`}const ze={human:"human",ai:"ai"};function te(e){const t=$e.cloneNode(!0);Object.assign(t.querySelector(".player-name-input"),{name:`player-${e}-name`,value:`Player ${e}`}),t.querySelectorAll(".player-type-select-radio").forEach(r=>{r.name=`player-${e}-type`}),K.append(t)}function re(e,t=ze.ai,r){const s=[],o=Le.cloneNode(!0);return C.append(o),{name:e,color:r,type:t,resources:{[a.people]:5,[a.gold]:5,[a.cloth]:25,[a.wood]:25,[a.stone]:25,[a.iron]:0,[a.food]:50,[a.alcohol]:5},border_path_container:o,get cells(){return s},set cells(n){s.push(...n),ee(s,r,o)},destroy(){s.length=0,o.remove()}}}function R(e,t=1){const r={[a.people]:0,[a.gold]:0,[a.cloth]:0,[a.wood]:0,[a.stone]:0,[a.iron]:0,[a.food]:0,[a.alcohol]:0};let s=0;return e.forEach(o=>{s+=o.population,Object.entries(o.biome.resource_production).forEach(([n,c])=>{r[n]+=c}),Object.entries(o.structures).forEach(([n,c])=>{Object.entries(Oe[n].output).forEach(([m,f])=>{r[m]+=f*c})});for(let n=0;n<Math.floor(o.population/2);n+=1){const c=Math.random();c<.3?r[a.people]+=2:c<.8&&(r[a.people]+=1)}}),r[a.gold]=s*t,r}const v={land_grab:B("land_grab","Pick your origin","Confirm choice"),development:B("development","Distribute your wealth"),movement_planning:B("movement_planning","Make your moves"),movement_execution:B("movement_execution","See what you have done")};function B(e,t=e,r="End turn"){return{name:e,call_to_action:t,end_turn_btn_label:r}}const d=(()=>{const e=[];let t=0,r=v.land_grab.name,s=0;function o(){G.textContent=v[r].end_turn_btn_label,we.textContent=v[r].call_to_action,be.textContent=e[s].name,r===v.development.name?(x.classList.remove("content-hidden"),Object.entries(e[s].resources).forEach(([n,c])=>{try{x.querySelector(`[data-resource-name="${n}"]`).textContent=`${n}: ${c}`}catch{console.log("who cares rn?")}})):x.classList.add("content-hidden")}return{board:new Map,get round(){return t},set round(n){t=n},get players(){return e},set players(n){e.push(...n)},get current_player_id(){return s},set current_player_id(n){s=n},clear_players(){e.forEach(n=>n.destroy()),e.length=0},get current_phase(){return r},set current_phase(n){r=n},next_turn(){s===e.length-1?(s=0,r=(()=>{switch(r){case v.development.name:return v.movement_planning.name;case v.movement_planning.name:return v.movement_execution.name;default:return t+=1,v.development.name}})()):s+=1,o()},run:o}})();function Pe(e,t){const r=JSON.parse(t);Object.assign(e,{round:r.round,current_phase:r.current_phase,current_player_id:r.current_player_id,players:r.players.map(({name:s,type:o,color:n})=>re(s,o,n)),board:qe(r.board,e.board)}),e.players.forEach((s,o)=>{s.cells=[...e.board.values()].filter(n=>n.owner_id===o)})}let $=null;window.addEventListener("DOMContentLoaded",()=>{const e=localStorage.getItem("wargame-savegame"),t=e!==null;L.dataset.priorSave=t,L.showModal(),U.request(),t?Pe(d,e):d.board=Ie(h,d.board)},{once:!0});window.addEventListener("beforeunload",()=>{if(U.release(),d.players.length===0){localStorage.removeItem("wargame-savegame");return}localStorage.setItem("wargame-savegame",JSON.stringify({round:d.round,current_phase:d.current_phase,current_player_id:d.current_player_id,players:d.players.map(({name:e,type:t,color:r})=>({name:e,type:t,color:r})),board:[...d.board.values()].map(({cx:e,cy:t,x:r,y:s,q:o,r:n,s:c,biome:{name:m},elevation:f,humidity:i,temperature:p,owner_id:y})=>({cx:e,cy:t,x:r,y:s,q:o,r:n,s:c,biome_name:m,elevation:f,humidity:i,temperature:p,owner_id:y}))}))});Ee.addEventListener("submit",e=>{if(e.preventDefault(),e.submitter.id==="new-game-btn")L.dataset.priorSave==="true"&&(Object.assign(d,{round:0,current_phase:v.land_grab.name,current_player_id:0}),d.board=Q(d.board),d.clear_players()),Array.from({length:2},(t,r)=>te(r+1)),L.classList.add("game-config");else{if(L.dataset.priorSave==="false")return;d.run(),L.close()}});ve.addEventListener("click",()=>{d.board=Q(d.board)});G.addEventListener("click",()=>{if(d.current_phase===v.land_grab.name){if($===null)return;d.board.get($).owner_id=d.current_player_id,d.players[d.current_player_id].cells=[d.board.get($)],$=null}d.next_turn()});z.addEventListener("submit",e=>{e.preventDefault();const t=new Set,r=[...z.querySelectorAll(".player-name-input")];if(r.reduce((o,{value:n})=>(o[n]=n in o?o[n]+1:1,o[n]>1&&t.add(n),o),{}),t.size!==0){r.forEach(o=>{t.has(o.value)&&o.classList.add("invalid")});return}const s=["tomato","rebeccapurple","gold","aquamarine","hotpink"];d.players=Array.from(k,(o,n)=>{const c=o.querySelector(".player-name-input").value,m=o.querySelector(".player-type-select-radio:checked").value;return re(c,m,s[n])}),d.run(),L.close()});he.addEventListener("click",()=>{k.length!==5&&te(k.length+1)});K.addEventListener("click",({target:e})=>{e.closest(".delete-player-btn")&&k.length!==2&&(e.closest(".player-config").remove(),[...k].forEach((t,r)=>{r=r+1,Object.assign(t.querySelector(".player-name-input"),{name:`player-${r}-name`,value:`Player ${r}`}),t.querySelectorAll(".player-type-select-radio").forEach(s=>{s.name=`player-${r}-type`})}))});L.addEventListener("cancel",e=>e.preventDefault());function Re({biome:{name:e},temperature:t,humidity:r,elevation:s}){const o=document.getElementById("biome-name").querySelector(".value-text"),n=document.getElementById("temperature").querySelector(".value-text"),c=document.getElementById("humidity").querySelector(".value-text"),m=document.getElementById("elevation").querySelector(".value-text");o.textContent=e,n.textContent=t,c.textContent=r,m.textContent=s}C.addEventListener("click",({target:e})=>{const t=e.closest(".cell");if(!t)return;const r=C.querySelector(".clicked"),s=d.board.get(t);if(r&&(r.classList.remove("clicked"),P.replaceChildren(),$=null,r===t))return;Re(s);const o=document.getElementById("cell-production-forecast"),n=document.getElementById("cell-production-forecast");d.current_phase===v.land_grab.name?s.owner_id===-1&&s.biome!==l.sea&&($=t,t.classList.add("clicked"),ee([...s.neighbors,s],"white",P)):d.current_phase===v.development.name&&(s.owner_id!==d.current_player_id?(n.textContent="",o.textContent=`In total you will gain ${JSON.stringify(R(d.players[d.current_player_id].cells,d.players[d.current_player_id].tax_rate))} next round`):(o.textContent="",n.textContent=`expect ${JSON.stringify(R([s],d.players[d.current_player_id].tax_rate))} from this cell next round`))});ye.addEventListener("click",()=>{document.body.classList.toggle("use-offset-coords")});
