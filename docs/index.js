(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))r(a);new MutationObserver(a=>{for(const o of a)if(o.type==="childList")for(const s of o.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&r(s)}).observe(document,{childList:!0,subtree:!0});function n(a){const o={};return a.integrity&&(o.integrity=a.integrity),a.referrerPolicy&&(o.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?o.credentials="include":a.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function r(a){if(a.ep)return;a.ep=!0;const o=n(a);fetch(a.href,o)}})();const et=""+new URL("service-worker.js",import.meta.url).href;window.navigator.serviceWorker.register(et).catch(console.error);let oe;qe(),document.addEventListener("visibilitychange",()=>{document.hidden?tt():qe()});async function qe(){var e,t;oe=await((t=(e=navigator.wakeLock)==null?void 0:e.request)==null?void 0:t.call(e,"screen"))}async function tt(){oe&&(await oe.release(),oe=void 0)}const nt=document.getElementById("add-player-btn"),M=document.getElementById("board"),G=document.getElementById("board-size-select"),Ce=document.getElementById("bottom-bar"),ee=document.getElementById("cell-info"),D=document.getElementById("cell-production-forecast"),rt=document.getElementById("config-game-form"),fe=document.getElementById("defs"),X=document.getElementById("end-turn-btn"),ae=document.getElementById("general-info"),se=document.getElementById("total-production-forecast"),Me=document.getElementById("phase-label"),Y=document.getElementsByClassName("player-config"),Oe=document.getElementById("player-name"),Ne=document.getElementById("player-setup"),ot=document.getElementById("reroll-map-btn"),st=document.getElementById("side-bar");document.getElementById("round-info");const j=document.getElementById("season-of-move-select"),ye=document.getElementById("selection-highlight"),at=document.getElementById("start-game-form"),C=document.getElementById("main-overlay"),Ae=document.getElementById("movement-arrows"),P=document.getElementById("movement-config"),ie=P.querySelector('[name="troop-strength"]'),Pe=P.querySelector('[name="troop-strength-value"]'),it=P.querySelector('[name="min-troop-strength-value"]'),ct=P.querySelector('[name="max-troop-strength-value"]'),ce=P.querySelector('[name="settle-cell-toggle"]'),lt=document.getElementById("player-borders"),ut=document.getElementById("encampments"),Re=document.getElementById("burger-menu-btn"),dt=document.getElementById("zoom-btns");function _e(e){return e%2===0}function _t(e,t,n){return e>=t&&e<=n}function Ue(e,t=0,n=e.length){return e[F(n,t)]}function F(e,t=0){return Math.trunc(Math.random()*(e-t)+t)}function ue(e){return Object.freeze(Object.assign(Object.create(null),e))}function ge(e){return Object.entries(e).map(([t,n])=>Object.assign(document.createElement("li"),{textContent:`${t}: ${n}`}))}function pt(e){return Object.seal(Object.assign(Object.create(null),e))}function mt({x:e,y:t}){const n=document.createElementNS("http://www.w3.org/2000/svg","circle");return n.setAttribute("cx",e.toString()),n.setAttribute("cy",t.toString()),n.setAttribute("r","0.5"),M.append(n),n}const N={board:"wargame-board",board_dimensions:"wargame-board-dimensions",game:"wargame-savegame",move_queue:"wargame-planned-moves",players:"wargame-players"},v=pt({width:0,height:0}),H={s:{width:30,height:24,cell_count:720,viewBox:"0 0 185 110"},m:{width:60,height:48,cell_count:2880,viewBox:"0 0 370 220"},l:{width:90,height:72,cell_count:6480,viewBox:"0 0 740 440"}};function Te({width:e,height:t}){return{width:e,height:t}}function ft({board:e},t){return()=>{const n=G.value;Object.assign(v,Te(H[n])),M.setAttribute("viewBox",H[n].viewBox),t(e,v)}}function yt(){const e=JSON.parse(localStorage.getItem(N.board_dimensions));if(e===null){const t=G.value;Object.assign(v,Te(H[t]))}else Object.assign(v,e),G.value=Object.keys(H).find(t=>H[t].width===v.width);M.setAttribute("viewBox",H[G.value].viewBox)}function gt(){localStorage.setItem(N.board_dimensions,JSON.stringify(v))}const c=ue({people:"people",gold:"gold",wood:"wood",stone:"stone",iron:"iron",food:"food",alcohol:"alcohol",coal:"coal"});function te(e,t=1){const n={[c.gold]:0,[c.wood]:0,[c.stone]:0,[c.iron]:0,[c.food]:0,[c.alcohol]:0,[c.coal]:0},{total_population:r,total_required_workers:a}=[...e].reduce((l,i)=>(l.total_population+=i.resources[c.people],l.total_required_workers+=[...i.structures.entries()].reduce((u,[d,f])=>u+d.required_workers*f,0),l),{total_population:0,total_required_workers:0}),o=Math.min(1,r/a);let s=!1;return e.forEach(l=>{Object.entries(Je(l)).forEach(([i,u])=>{n[i]+=u}),Object.entries(l.biome.resource_production).forEach(([i,u])=>{n[i]+=u}),[...l.structures.entries()].forEach(([i,u])=>{s=u>0,i.output.forEach(({resource_name:d,amount:f})=>{n[d]+=Math.trunc(f*u*o)})})}),s&&(n[c.gold]=r*t),n}function Je(e){return e.neighbors.filter(({owner_id:t})=>t===-1).reduce((t,n)=>(t[n.biome.neighbor_gather_bonus]+=1,t),{[c.wood]:0,[c.stone]:0,[c.food]:0})}function ht(e){let t=0;if(e.resources.people===1)Math.random()<.05&&(t=1);else{const n=Math.trunc(e.resources.people/2);for(let r=0;r<n;r+=1){const a=Math.random();a<.1?t+=2:a<.5&&(t+=1)}}e.resources[c.people]+=t}function vt(e){e.forEach(({cells:t,encampments:n,tax_rate:r})=>{const{total_population:a,total_required_workers:o}=[...t].reduce((i,u)=>(i.total_population+=u.resources[c.people],i.total_required_workers+=[...u.structures.entries()].reduce((d,[f,y])=>d+f.required_workers*y,0),i),{total_population:0,total_required_workers:0}),s=Math.min(1,a/o);let l=[...n.values()].reduce((i,u)=>i+u,a);t.forEach(i=>{Object.entries(i.biome.resource_production).forEach(([u,d])=>{i.resources[u]+=d}),[...i.structures.entries()].forEach(([u,d])=>u.output.forEach(({resource_name:f,amount:y})=>{i.resources[f]+=Math.trunc(y*d*s)})),i.resources[c.gold]+=i.resources[c.people]*r,l>0&&(l>=i.resources[c.food]?(l-=i.resources[c.food],i.resources[c.food]=0):(i.resources[c.food]-=l,l=0)),ht(i)})})}const b=ue({freezing:"freezing",cold:"cold",temperate:"temperate",warm:"warm",hot:"hot"});function wt(e){e.forEach(t=>{const n=Math.random(),r=-1,a=_t(n,.3,.7)?0:1*(-1*+(n<.3)),o=(s=>s<0?0:s>v.height-1?v.height-1:s)(t.y+a+r);t.temperature=Et(o)})}function bt(e){switch(e){case b.hot:return b.warm;case b.warm:return b.temperate;case b.temperate:return b.cold;default:return b.freezing}}function Et(e){switch(e){case 0:case 1:case v.height-2:case v.height-1:return b.freezing;case 2:case 3:case v.height-4:case v.height-3:return b.cold;case 4:case 5:case v.height-6:case v.height-5:return b.temperate;case 6:case 7:case 8:case v.height-9:case v.height-8:case v.height-7:return b.warm;default:return b.hot}}function St(e){switch(e){case b.freezing:return b.cold;case b.cold:return b.temperate;case b.temperate:return b.warm;default:return b.hot}}const g=ue({arid:"arid",dry:"dry",moderate:"moderate",moist:"moist",wet:"wet"});function kt(e){e.filter(t=>t.elevation>0).forEach(t=>{t.neighbors.filter(n=>n.elevation===0).forEach(n=>{n.cell.classList.add("shore"),t.humidity=Lt(t.humidity)})})}function Lt(e){switch(e){case g.arid:return g.dry;case g.dry:return g.moderate;case g.moderate:return g.moist;default:return g.wet}}const m={sea:$("sea",{[c.food]:1}),mountain:$("mountain",{[c.wood]:2,[c.stone]:5,[c.food]:3}),high_mountain:$("high_mountain",{[c.stone]:5}),ice:$("ice",{[c.food]:2}),tundra:$("tundra",{[c.wood]:2,[c.stone]:1,[c.food]:5}),grassland:$("grassland",{[c.wood]:2,[c.stone]:2,[c.food]:5}),savanna:$("savanna",{[c.wood]:5,[c.stone]:3,[c.food]:6}),boreal_forest:$("boreal_forest",{[c.wood]:10,[c.stone]:3,[c.food]:5}),forest:$("forest",{[c.wood]:10,[c.stone]:2,[c.food]:5}),tropical_rainforest:$("tropical_rainforest",{[c.wood]:7,[c.stone]:1,[c.food]:5}),cold_swamp:$("cold_swamp",{[c.wood]:2,[c.stone]:1,[c.food]:2}),swamp:$("swamp",{[c.wood]:1,[c.stone]:0,[c.food]:3}),tropical_swamp:$("tropical_swamp",{[c.wood]:3,[c.stone]:1,[c.food]:3}),desert:$("desert",{[c.wood]:0,[c.stone]:2,[c.food]:1}),extreme_desert:$("extreme_desert",{[c.wood]:0,[c.stone]:1,[c.food]:0})},qt={[b.freezing]:{[g.arid]:m.tundra,[g.dry]:m.tundra,[g.moderate]:m.tundra,[g.moist]:m.boreal_forest,[g.wet]:m.boreal_forest},[b.cold]:{[g.arid]:m.tundra,[g.dry]:m.tundra,[g.moderate]:m.boreal_forest,[g.moist]:m.boreal_forest,[g.wet]:m.boreal_forest},[b.temperate]:{[g.arid]:m.tundra,[g.dry]:m.forest,[g.moderate]:m.forest,[g.moist]:m.forest,[g.wet]:m.swamp},[b.warm]:{[g.arid]:m.desert,[g.dry]:m.grassland,[g.moderate]:m.savanna,[g.moist]:m.forest,[g.wet]:m.tropical_swamp},[b.hot]:{[g.arid]:m.extreme_desert,[g.dry]:m.desert,[g.moderate]:m.grassland,[g.moist]:m.savanna,[g.wet]:m.tropical_rainforest}};function Ot(e){e.forEach(t=>{t.biome||(t.biome=t.elevation>1?t.elevation>2?m.high_mountain:m.mountain:qt[t.temperature][t.humidity])})}function $(e="sea",t={}){let n=0;const r=Object.entries(t).reduce((a,[o,s])=>(n<s&&(n=s,a=o),a),"");return{name:e,display_name:e.replace(/_/g," ").toUpperCase(),resource_production:Object.assign({[c.wood]:0,[c.stone]:0,[c.food]:0},t),neighbor_gather_bonus:r}}function xt(e){e.filter(({elevation:t})=>t===0).forEach(t=>{t.biome=$t(t)})}function $t(e,t=v.height){const n=Math.random();return[0,t-1].includes(e.y)?n<=.1?m.sea:m.ice:[1,t-2].includes(e.y)?n<=.75?m.sea:m.ice:[2,t-3].includes(e.y)?n<=.9?m.sea:m.ice:m.sea}const xe=new Set([0,1,2,v.height-1,v.height-2,v.height-3]);function $e(e){e.elevation+=1,e.elevation>1&&(e.temperature=bt(e.temperature))}function It(e){const r=e.length/2.5;let a=0;for(;a<r;){const o=F(13,4),s={x:F(v.width),y:F(v.height-3,3)},l=e.find(({x:d,y:f})=>d===s.x&&f===s.y),i=new Set(l.neighbors.filter(({y:d})=>!xe.has(d))),u=new Set;a+=o,$e(l),u.add(l);for(let d=0;d<o;d+=1){const f=Ue([...i]);$e(f),u.add(f),i.delete(f),f.neighbors.filter(y=>!u.has(y)).filter(({y})=>!xe.has(y)).forEach(y=>i.add(y))}}e.filter(o=>o.elevation>0).forEach(o=>{const s=o.neighbors.filter(i=>i.elevation>0).length;if(s>=3)return;const l=Math.random();(s===2&&l>.7||s===1&&l<.7)&&zt(o)})}function zt(e){e.elevation=Math.max(0,e.elevation-1),e.elevation>0&&(e.temperature=St(e.temperature))}const Bt=[{q:1,r:0,s:-1},{q:1,r:-1,s:0},{q:0,r:1,s:-1},{q:0,r:-1,s:1},{q:-1,r:0,s:1},{q:-1,r:1,s:0}];function He(e=[]){e.forEach(t=>{t.neighbors=Ct(t,e,v)})}function Ct({q:e,r:t,s:n,x:r,y:a},o,s){const l=Bt.map(i=>o.find(u=>u.q===e+i.q&&u.r===t+i.r&&u.s===n+i.s)).filter(Boolean);return r===0&&(l.push(o.find(i=>a===i.y&&i.x===s.width-1)),_e(a)&&l.push(...[a<s.height-1?o.find(i=>a+1===i.y&&i.x===s.width-1):null,a>0?o.find(i=>a-1===i.y&&i.x===s.width-1):null].filter(Boolean))),r===s.width-1&&(l.push(o.find(i=>a===i.y&&i.x===0)),_e(a)||l.push(...[a<s.height-1?o.find(i=>a+1===i.y&&i.x===0):null,a>0?o.find(i=>a-1===i.y&&i.x===0):null].filter(Boolean))),l}const Mt=fe.querySelector(".cell-wrapper"),Nt=fe.querySelector(".movement-indicator"),Ie=fe.querySelector(".player-border"),At=document.getElementById("player-config-tmpl").content,Pt=document.getElementById("structure-builder-tmpl").content,he={house:R("House",[k(c.wood,1)],[],0,{on(e){e.housing_capacity+=5},off(e){e.housing_capacity-=5}},new Set),lumber_mill:R("Lumber Mill",[k(c.wood,15),k(c.stone,15)],[k(c.wood,5)]),quarry:R("Quarry",[k(c.wood,15),k(c.stone,15)],[k(c.stone,5)]),mine:R("Mine",[k(c.wood,5),k(c.stone,5)],[k(c.coal,5)]),forge:R("Forge",[k(c.wood,5),k(c.stone,5)],[k(c.iron,1)]),farm:R("Farm",[k(c.wood,5),k(c.stone,5)],[k(c.food,5)]),distillery:R("Distillery",[k(c.wood,5),k(c.stone,5)],[k(c.alcohol,1)])};function R(e="Pretty Structure",t=[k(c.wood,5)],n=[k(c.wood,1)],r=1,a={on(i){i.foo+=5},off(i){i.foo-=5}},o=new Set([m.swamp]),s=[k(c.wood,1)],l=1){return{display_name:e,construction_cost:t,space_requirement:l,unsupported_biomes:o,effects:a,output:n,input:s,required_workers:r}}function k(e=c.wood,t=1){return{resource_name:e,amount:t}}const T=.4,E=T*.5,ne=6,ve=ne*.5,De=ve*.5,Fe=ne*.75;function Z(e,t,{color:n="white",stroked_outline:r=!1}={}){if(e.size===0)return;const a=[...e].reduce((o,s)=>{const l=s.neighbors.filter(L=>!e.has(L)),i=l.some(L=>L.r===s.r&&L.s===s.s+1),u=l.some(L=>L.q===s.q&&L.s===s.s+1),d=l.some(L=>L.s===s.s&&L.r===s.r-1),f=l.some(L=>L.r===s.r&&L.s===s.s-1),y=l.some(L=>L.q===s.q&&L.s===s.s-1),_=l.some(L=>L.s===s.s&&L.r===s.r+1),p=Jt(s,i,_),O=Wt(s,u,i),x=Dt(s,u,d),Q=Ft(s,f,d),ke=Ht(s,y,f),Le=Tt(s,_,y);return i&&o.push([p,O]),u&&o.push([O,x]),d&&o.push([x,Q]),f&&o.push([Q,ke]),y&&o.push([ke,Le]),_&&o.push([Le,p]),o},[]);t.setAttribute("d",Rt(Ut(a))),t.setAttribute("stroke",n),r&&t.setAttribute("stroke-dasharray","1")}function Rt(e){return`M${e.map(({x:n,y:r})=>`${n} ${r}`).join("L")}Z`}function Ut(e){const t=e.reduce((s,l)=>{for(const i of l){const u=de(i);s.has(u)?s.get(u).push(l):s.set(u,[l])}return s},new Map),n=new Set,r=[],[a]=e;let o=a[1];for(r.push(a[0]),n.add(a);n.size<e.length;){const s=de(o),l=t.get(s).find(i=>!n.has(i));if(!l){const i=mt(o);console.log("no next_edge! region couldnt be finished",o,t,i);break}r.push(o),n.add(l),o=de(l[0])===s?l[1]:l[0]}return r}function de({x:e,y:t}){return`${e} ${t}`}function K(e,t){return{x:e,y:t}}function Tt(e,t,n){if(!t&&!n)return;const r=K(e.cx+ve,e.cy+ne);return t?n?r.y-=T:(r.x+=E,r.y-=E):(r.x-=E,r.y-=E),r}function Jt(e,t,n){if(!t&&!n)return;const r=K(e.cx,e.cy+Fe);return t?n?(r.x+=T,r.y-=E):(r.x+=E,r.y+=E):r.y-=E,r}function Ht(e,t,n){if(!t&&!n)return;const r=K(e.cx+ne,e.cy+Fe);return t?(n&&(r.x-=T),r.y-=E):(r.x-=E,r.y+=E),r}function Dt(e,t,n){if(!t&&!n)return;const r=K(e.cx+ve,e.cy);return n?t?r.y+=T:(r.x-=E,r.y+=E):(r.x+=E,r.y+=E),r}function Ft(e,t,n){if(!t&&!n)return;const r=K(e.cx+ne,e.cy+De);return t?n?(r.x-=T,r.y+=E):(r.x-=E,r.y-=E):r.y+=E,r}function Wt(e,t,n){if(!t&&!n)return;const r=K(e.cx,e.cy+De);return t?(n&&(r.x+=T),r.y+=E):(r.x+=E,r.y-=E),r}let J=null;function Yt(e){e.has_owner||e.biome===m.sea?(e.cell.classList.remove("clicked"),ee.classList.add("hidden"),ae.classList.remove("hidden")):(J=e,Z(new Set([...e.neighbors,e]),ye),ae.classList.add("hidden"),Qt(e))}function Kt(e){if(J===null)return!1;const t=e.active_player,n=te(t.cells,t.tax_rate);return t.add_cell(J),Object.assign(J.resources,{...n,people:5}),J.cell.classList.remove("clicked"),J=null,!0}function Qt(e){const{wood:t,stone:n,food:r}=e.biome.resource_production,a=Object.values(he).filter(s=>!s.unsupported_biomes.has(e.biome)).map(({display_name:s})=>`<li>${s}</li>`).join(""),o=Je(e);ee.innerHTML=`
        <h2>Cell Info</h2>
        <ul>
            <li>Biome: ${e.biome.display_name}</li>
            <li>Elevation: ${Vt(e.elevation).toLocaleUpperCase()}</li>
            <li>Temperature: ${e.temperature.toLocaleUpperCase()}</li>
            <li>Humidity: ${e.humidity.toLocaleUpperCase()}</li>
            <li>Size: ${e.developable_land}</li>
            <li>Land suitable for food production: TBD</li>
            <li>Biome related info like pleasantness...</li>
        </ul>
        <h3>Resource production</h3>
        <table>
            <tbody>
                <tr>
                    <td>Wood</td>
                    <td>${t} * ${e.developable_land} + ${o[c.wood]}</td>
                    <td>= ${t*e.developable_land+o[c.wood]}</td>
                </tr>
                <tr>
                    <td>Stone</td>
                    <td>${n} * ${e.developable_land} + ${o[c.stone]}</td>
                    <td>= ${n*e.developable_land+o[c.stone]}</td>
                </tr>
                <tr>
                    <td>Food</td>
                    <td>${r} * ${e.developable_land} + ${o[c.food]}</td>
                    <td>= ${r*e.developable_land+o[c.food]}</td>
                </tr>
            </tbody>
        </table>
        <h3>Supported structures</h3>
        <ul>${a}</ul>
    `,ee.classList.remove("hidden")}function Vt(e){switch(e){case 0:return"sea level";case 1:return"ground level";case 2:return"mountainous";default:return"alpine"}}function Zt(e,t){return Object.entries(he).filter(([,n])=>!n.unsupported_biomes.has(e.biome)).map(([n,r])=>{const a=Pt.cloneNode(!0).lastElementChild,o=a.querySelector(".label-text"),s=a.querySelector(".structure-count");return a.dataset.structure_name=n,o.textContent=`${r.display_name}: `,s.textContent=e.structures.get(r).toString(),a.addEventListener("click",({target:l})=>{if(!(l instanceof Element))return;const i=l.closest("button");if(i===null)return;const u=i.classList.contains("construct-structure-btn"),d=r.construction_cost;let f=e.structures.get(r);if(u){if(e.developable_land<r.space_requirement||d.some(({resource_name:_,amount:p})=>p>t.active_player.resources[_]))return;f+=1,d.forEach(({resource_name:_,amount:p})=>{let O=p;for(const x of t.active_player.cells){const Q=x.resources[_];if(Q<O){O-=Q,x.resources[_]=0;continue}else x.resources[_]-=O,O=0;if(O===0)break}}),e.developable_land-=r.space_requirement}else{if(f===0)return;f-=1,d.forEach(({resource_name:y,amount:_})=>{e.resources[y]+=_}),e.developable_land+=r.space_requirement}e.structures.set(r,f),s.textContent=f.toString(),D.querySelector("ul").replaceChildren(...ge(te(new Set([e]),t.active_player.tax_rate))),t.update_resource_display()}),a})}function We(e,t){se.querySelector("ul").replaceChildren(...ge(e)),se.querySelector("input").value=t.toString(),se.classList.remove("hidden")}function Gt(e,t){e.owner_id===t.current_player_id?(se.classList.add("hidden"),Xt(te(new Set([e]),t.active_player.tax_rate),Zt(e,t))):(D.classList.add("hidden"),We(te(t.active_player.cells,t.active_player.tax_rate),t.active_player.tax_rate))}function Xt(e,t){D.querySelector("ul").replaceChildren(...ge(e)),D.querySelector("fieldset").replaceChildren(...t),D.classList.remove("hidden")}const I=[];function jt(){I.length=0,Ae.replaceChildren()}function en(e,t,n,r){const o={x:e.cx+3,y:e.cy+3},s={x:t.cx+3,y:t.cy+3},l=`M${o.x} ${o.y}A 3 3 0 0 0 ${s.x} ${s.y}`,i=Nt.cloneNode(!0),u=i.lastElementChild.lastElementChild;return i.firstElementChild.setAttribute("d",l),i.dataset.owner_id=r.toString(),u.setAttribute("path",l),u.textContent=n.toString(),Ae.append(i),i}function Ye(e,t,n,r,a,o="unspecified"){const s=en(t,n,r,e);let l=r;return{player_id:e,origin:t,target:n,season:a,get units(){return l},set units(i){l=i,s.lastElementChild.lastElementChild.textContent=i.toString()},type:o,arrow:s}}function tn(e){const t=JSON.parse(localStorage.getItem(N.move_queue)),n=[...e.board.values()];I.push(...t.map(({player_id:r,origin:a,target:o,units:s,season:l})=>Ye(r,n.find(({cx:i,cy:u})=>i===a.cx&&u===a.cy),n.find(({cx:i,cy:u})=>i===o.cx&&u===o.cy),s,l)))}function nn(){localStorage.setItem(N.move_queue,JSON.stringify(I.map(({player_id:e,origin:t,target:n,units:r,season:a})=>({player_id:e,origin:{cx:t.cx,cy:t.cy},target:{cx:n.cx,cy:n.cy},units:r,season:a}))))}const q=ue({spring:"spring",summer:"summer",autumn:"autumn",winter:"winter"});function rn(e){switch(e){case q.spring:return q.summer;case q.summer:return q.autumn;case q.autumn:return q.winter;default:return q.spring}}function le(e,t){return!(e===t||e===q.winter||e===q.summer&&t===q.spring||e===q.autumn&&t!==q.winter)}let S=null,A=null;function on(e,t){if(S===null){cn(e,t);return}if(e.cell.classList.remove("clicked"),S===e){S=null;return}if(!e.neighbors.includes(S))return;A=e;const n=I.find(({player_id:s,origin:l,target:i})=>s===t.current_player_id&&l===S&&i===A),r=S.owner_id===t.current_player_id,a=A.owner_id===t.current_player_id,o={settle_cell:!1,season:q.spring};if(Object.values(q).forEach(s=>{j.querySelector(`input[value="${s}"]`).disabled=!1}),j.inert=!1,ce.inert=a||A.biome===m.sea,n?sn(n,t,r,o):an(t,r,o),o.max_value<=0){A=null;return}j.querySelector(`input[value="${o.season}"]`).checked=!0,Object.assign(ie,{value:o.current_value,min:o.min_value,max:o.max_value}),Pe.value=o.current_value.toString(),it.value=o.min_value.toString(),ct.value=o.max_value.toString(),ce.checked=o.settle_cell,P.showModal()}function sn(e,t,n,r){const a=I.filter(({player_id:o})=>o===t.current_player_id);r.settle_cell=e.type==="settle",r.current_value=e.units,r.season=e.season,r.min_value=a.filter(({season:o,origin:s})=>le(e.season,o)&&e.target===s).reduce((o,{season:s,origin:l,units:i})=>(W(a,l,s,l.owner_id===t.current_player_id?l.resources[c.people]:0)-e.units<i&&(o+=i),o),0),j.inert=!0,ce.inert=!0,n?r.max_value=W(a,S,r.season,S.resources[c.people])-1+r.current_value:r.max_value=W(a,S,r.season,t.active_player.get_encampment(S)||0)-Number(r.settle_cell)+r.current_value}function an(e,t,n){const r=I.filter(({player_id:a})=>a===e.current_player_id);if(n.current_value=0,n.min_value=0,t)n.max_value=W(r,S,n.season,S.resources[c.people])-1;else{const a=r.filter(({target:o})=>o===S);if(a.length>0){const o=a.reduce((l,{season:i})=>(le(i,l)&&(l=i),l),q.winter),s=r.some(({target:l,type:i,season:u})=>l===S&&u===o&&i==="settle");if(o===q.winter){A=null;return}Object.values(q).filter(l=>l===o||le(l,o)).forEach(l=>{j.querySelector(`input[value="${l}"]`).disabled=!0}),n.season=rn(o),n.max_value=W(r,S,n.season,e.active_player.get_encampment(S)||0)-Number(s);return}n.season=q.spring,n.max_value=W(r,S,n.season,e.active_player.get_encampment(S)||0)}}function cn(e,t){const n=I.filter(({player_id:l})=>l===t.current_player_id),r=e.owner_id===t.current_player_id&&e.resources[c.people]>1,a=n.find(({origin:l})=>l===e),o=n.find(({target:l,season:i})=>l===e&&i!=="winter"),s=t.active_player.encampments.has(e);r||a||o||s?S=e:e.cell.classList.remove("clicked")}function W(e,t,n,r=0){return e.filter(({origin:a,target:o,season:s})=>(a===t||o===t)&&(s===n||le(s,n))).reduce((a,o)=>(t===o.target?a+=o.units:a-=o.units,a),r)}function ln(e){return()=>{const t=P.querySelector('[name="season-of-move"]:checked').value,n=Number(ie.value),r=ce.checked,a=I.findIndex(({player_id:o,origin:s,target:l})=>o===e.current_player_id&&s===S&&l===A);if(Number.isNaN(n)||n<=0){if(S=null,A=null,a>-1){const[{arrow:o}]=I.splice(a,1);o.remove()}return}if(a>-1){const o=I[a];o.units=n}else I.push(Ye(e.current_player_id,S,A,n,t,r?"settle":"unspecified"));S=null,A=null}}const w={land_grab:V("land_grab","Pick your origin","Confirm choice",Yt),development:V("development","Pick one of your cells and develop it",void 0,Gt),movement_planning:V("movement_planning","Make your moves",void 0,on),movement_execution:V("movement_execution","","Start Movement Phase"),game_over:V("game_over","","Pick your origin")};function un(e){return()=>{if(!(e.current_phase===w.land_grab.name&&!Kt(e))){if(e.current_phase===w.movement_execution.name){const{done:t}=e.moves.next();if(!t)return}e.next_turn()}}}function V(e="round_phase",t="",n="End turn",r=(a,o)=>{}){return{name:e,call_to_action:t,end_turn_btn_label:n,handle_click_on_cell:r}}function Ke(e,t,n,r,a,o,s){const l=dn(e,t),i=l.querySelector(".population-size"),u=new Proxy({[c.people]:0,[c.gold]:0,[c.wood]:0,[c.stone]:0,[c.iron]:0,[c.food]:0,[c.alcohol]:0,[c.coal]:0},{set(p,O,x){return p[O]=x,O===c.people&&(i.textContent=x>0?x.toString():""),!0}});let d=null,f=b.freezing,y=-1,_=10;return{cx:e,cy:t,x:n,y:r,q:a,r:o,s,get has_owner(){return y!==-1},neighbors:[],cell:l,elevation:0,humidity:g.arid,get temperature(){return f},set temperature(p){f=p,l.dataset.temperature=p},structures:new Map(Object.values(he).map(p=>[p,0])),pop_size_display:i,resources:u,get biome(){return d},set biome(p){d!==null&&l.classList.remove(d.name),p!==null&&l.classList.add(p.name),p===m.sea&&(_=0),d=p},get owner_id(){return y},set owner_id(p){y=p,l.dataset.owner_id=p===-1?"":p.toString()},get developable_land(){return _},set developable_land(p){_=p}}}function dn(e,t){const n=Mt.cloneNode(!0);return n.setAttribute("transform",`translate(${e}, ${t})`),M.prepend(n),n}function _n(e){return({target:t})=>{if(!(t instanceof Element))return;const n=t.closest(".cell-wrapper");if(n===null)return;const r=M.querySelector(".clicked"),a=e.board.get(n);r&&(r.classList.remove("clicked"),ye.replaceChildren()),r!==n&&n.classList.add("clicked"),w[e.current_phase].handle_click_on_cell(a,e)}}const we=6,pn=we*.5,mn=we*.75;function Qe(e,t){e.forEach(n=>{t.set(n.cell,n)})}function fn({height:e,width:t}){const n=[];for(let r=0;r<e;r+=1){const a=+!_e(r);for(let o=0;o<t;o+=1){const s=o-(r-(r&1))*.5;n.push(Ke(o*we+a*pn,r*mn,o,r,s,r,-s-r))}}return n}function Ve(e,t){const n=fn(t);He(n),wt(n),It(n),xt(n),kt(n),Ot(n),Qe(n,e)}function yn(e=[],t){const n=e.map(({cx:r,cy:a,x:o,y:s,q:l,r:i,s:u,biome_name:d,elevation:f,humidity:y,temperature:_,owner_id:p,resources:O})=>{const x=Ke(r,a,o,s,l,i,u);return Object.assign(x,{biome:m[d],elevation:f,humidity:y,resources:Object.assign(x.resources,O),temperature:_,owner_id:p})});He(n),n.filter(r=>r.elevation===0&&r.neighbors.some(a=>a.elevation>0)).forEach(r=>r.cell.classList.add("shore")),Qe(n,t)}function be(e,t){e.clear(),M.replaceChildren(M.lastElementChild),Ve(e,t)}const Ee=new Map;function gn(){localStorage.setItem(N.board,JSON.stringify([...Ee.values()].map(({cx:e,cy:t,x:n,y:r,q:a,r:o,s,biome:{name:l},elevation:i,humidity:u,temperature:d,owner_id:f,resources:y})=>({cx:e,cy:t,x:n,y:r,q:a,r:o,s,biome_name:l,elevation:i,humidity:u,temperature:d,owner_id:f,resources:y}))))}function hn(){const e=JSON.parse(localStorage.getItem(N.board));yn(e,Ee)}const vn={ai:"ai"},z=[],wn=2,bn=5;function En(){Y.length!==bn&&Ze(Y.length+1)}function pe(e){if(!z.some(r=>r.name===e))return e;const n=/^(?<name>.+)_(?<id>\d+)$/.exec(e);return pe(n===null?`${e}_2`:`${n.groups.name}_${(Number(n.groups.id)||0)+1}`)}function Sn({target:e}){!(e instanceof Element)||e.closest(".delete-player-btn")===null||Y.length===wn||(e.closest(".player-config").remove(),[...Y].forEach((t,n)=>{n=n+1,Object.assign(t.querySelector(".player-name-input"),{name:`player-${n}-name`,value:`Player ${n}`}),t.querySelectorAll(".player-type-select-radio").forEach(r=>{r.name=`player-${n}-type`})}))}function Se(e,t="Player Name",n=vn.ai,r=[],a=[]){const o=new Set(r),s=Ie.cloneNode(!0),l=Ie.cloneNode(!0),i=new Map,d=`var(--player-${e+1})`;lt.append(s),ut.append(l),Z(o,s,{color:d}),a.forEach(([_,p])=>f(_,p));function f(_,p){if(i.set(_,p),_.cell.classList.contains("contested"))return;if(_.has_owner){_.cell.classList.add("contested");return}const O=z.find(x=>x.id!==e&&x.encampments.has(_));if(O){_.cell.classList.add("contested"),_.pop_size_display.textContent="",O.outline_encampments();return}y(),_.pop_size_display.textContent=p.toString()}function y(){Z(new Set([...i.keys()].filter(({cell:_})=>!_.classList.contains("contested"))),l,{color:d,stroked_outline:!0})}return{id:e,name:pe(t),type:n,tax_rate:1,get resources(){return[...o].reduce((_,{resources:p})=>(Object.entries(p).forEach(([O,x])=>{_[O]+=x}),_),{[c.people]:0,[c.gold]:0,[c.wood]:0,[c.stone]:0,[c.iron]:0,[c.food]:0,[c.alcohol]:0,[c.coal]:0})},border_path_container:s,get cells(){return o},add_cell(_){_.owner_id=e,o.add(_),Z(o,s,{color:d})},delete_cell(_){o.delete(_),_.owner_id=-1,Z(o,s,{color:d})},get encampments(){return i},get_encampment(_){return i.get(_)},add_encampment:f,delete_encampment(_){i.delete(_),y(),_.owner_id===-1&&z.every(p=>!p.encampments.has(_))&&(_.pop_size_display.textContent="")},outline_encampments:y,destroy(){o.clear(),i.clear(),s.remove(),l.remove()}}}function Ze(e){const t=At.cloneNode(!0);Object.assign(t.querySelector(".player-name-input"),{name:`player-${e}-name`,value:`Player ${e}`}),t.querySelectorAll(".player-type-select-radio").forEach(n=>{n.name=`player-${e}-type`}),Ne.append(t)}function kn(e){const t=JSON.parse(localStorage.getItem(N.players)),n=[...e.board.values()];z.push(...t.map(({name:r,type:a,encampments:o},s)=>Se(s,r,a,n.filter(l=>l.owner_id===s),o.map(({cx:l,cy:i,units:u})=>[n.find(d=>d.cx===l&&d.cy===i),u]))))}function Ln(){localStorage.setItem(N.players,JSON.stringify(z.map(({name:e,type:t,encampments:n})=>({name:e,type:t,encampments:[...n.entries()].map(([{cx:r,cy:a},o])=>({cx:r,cy:a,units:o}))}))))}function*qn(e){var t;for(const n in q){const r=I.filter(s=>n===s.season).filter(s=>{const l=xn(s,e);return l||ze(s,I),l});if(r.length===0)continue;const a=new Set,o=new Map;Me.textContent=`Move(s) in ${n}`,X.textContent="Show next move";for(const s of r)s.origin.cell.classList.add("clicked"),s.arrow.style.display="initial",a.add(s.target),yield"init_move",s.type==="settle"&&o.set(s.target,o.has(s.target)?o.get(s.target).add(s.player_id):new Set([s.player_id])),On(s,e),ze(s,I),s.origin.cell.classList.remove("clicked");X.textContent="Make these moves",yield"moves_laid_out";for(const s of a){const l=$n(s,e.players);if(l.length===1){const{player_id:i,unit_count:u}=l[0];(t=o.get(s))!=null&&t.has(i)&&Ge(e.players[i],s,u);continue}X.textContent="Start battle",yield"battle_awaits",In(s,l,e.players,o.get(s))}}}function Ge(e,t,n){e.delete_encampment(t),e.add_cell(t),t.resources[c.people]=n}function On(e,t){if(e.player_id===e.origin.owner_id)e.origin.resources[c.people]-=e.units;else{const n=t.players[e.player_id],r=n.get_encampment(e.origin)-e.units;r===0?n.delete_encampment(e.origin):n.add_encampment(e.origin,r)}if(e.player_id===e.target.owner_id)e.target.resources[c.people]+=e.units;else{const n=t.players[e.player_id],r=(n.get_encampment(e.target)||0)+e.units;n.add_encampment(e.target,r)}}function xn(e,t){const n=e.origin.owner_id===e.player_id?e.origin.resources[c.people]-1:t.players[e.player_id].encampments.get(e.origin);return e.units<=n}function ze(e,t){const n=t.findIndex(r=>r===e);n<0||(t[n].arrow.remove(),t.splice(n,1))}function $n(e,t){return t.reduce((n,r,a)=>(r.encampments.has(e)?n.push({player_id:a,unit_count:r.encampments.get(e)}):a===e.owner_id&&n.push({player_id:e.owner_id,unit_count:e.resources[c.people],is_owner:!0}),n),[])}function In(e,t,n,r){for(;t.length>1;){const l=[],i=new Set;t.forEach((u,d)=>{const f=new Set([d]);let y;t.forEach((_,p)=>{f.has(p)||(f.add(p),y=F(y===void 0?u.unit_count:u.unit_count-y),l.push({target_id:p,attack_strength:y}))})});for(const{target_id:u,attack_strength:d}of l)t[u].unit_count-=d,t[u].unit_count<=0&&i.add(u);if(i.size===t.length){i.forEach(u=>n[t[u].player_id].delete_encampment(e)),t=[Object.assign(Ue(t),{unit_count:1})];break}[...i].sort((u,d)=>d-u).forEach(u=>{n[t[u].player_id].delete_encampment(e),t.splice(u,1)})}e.cell.classList.remove("contested");const{player_id:a,unit_count:o}=t[0],s=n[a];if(e.owner_id===a){e.resources[c.people]=o;return}e.has_owner&&(n[e.owner_id].delete_cell(e),e.resources[c.people]=0),r!=null&&r.has(a)?Ge(s,e,o):s.add_encampment(e,o)}let re=0,B=w.land_grab.name,U=0,me=null,Xe;const h={board:Ee,get moves(){return Xe},get round(){return re},set round(e){re=e},get active_player(){return z[U]},get players(){return z},set players(e){z.push(...e)},get current_player_id(){return U},set current_player_id(e){U=e},get current_player_total_production(){return me},clear_players(){z.forEach(e=>e.destroy()),z.length=0},get current_phase(){return B},set current_phase(e){B=e},update_resource_display:je,next_turn(){if(ye.setAttribute("d",""),U<z.length-1)U+=1;else if(U=0,B=Nn(),B===w.development.name){if(re>0){const e=An();if(vt(z),e!==null){B=w.game_over.name,document.body.dataset.current_phase=w.game_over.name,document.getElementById("winner-name").textContent=e.name,C.showModal(),Re.click();return}}re+=1}Be()},run:Be};function Be(){switch(X.textContent=w[B].end_turn_btn_label,Me.textContent=w[B].call_to_action,Oe.classList.toggle("hidden",B===w.movement_execution.name),Ce.classList.toggle("content-hidden",B!==w.development.name),document.body.dataset.current_phase=w[B].name,document.documentElement.style.setProperty("--active-player-color",`var(--player-${U+1}`),Oe.textContent=h.active_player.name,B){case w.land_grab.name:ee.classList.add("hidden"),ae.classList.remove("hidden");break;case w.development.name:me=te(h.active_player.cells,h.active_player.tax_rate),We(me,h.active_player.tax_rate),je(),D.classList.add("hidden"),ee.classList.add("hidden"),ae.classList.add("hidden");break;case w.movement_execution.name:Xe=qn(h)}}function zn(e){const{round:t,current_phase:n,current_player_id:r}=JSON.parse(e);Object.assign(h,{round:t,current_phase:n,current_player_id:r})}function Bn(){const e=localStorage.getItem(N.game),t=e!==null;C.dataset.gameIsRunning=t.toString(),yt(),t?(zn(e),hn(),kn(h),tn(h),h.run()):(Ve(h.board,v),C.showModal())}function Cn(){document.visibilityState==="hidden"&&(h.players.length===0||h.current_phase===w.game_over.name?Mn():(Pn(),Ln(),nn(),gn(),gt()))}function Mn(){Object.values(N).forEach(e=>localStorage.removeItem(e))}function Nn(){switch(B){case w.development.name:return w.movement_planning.name;case w.movement_planning.name:return w.movement_execution.name;case w.movement_execution.name:default:return w.development.name}}function An(){const e=z.filter(({cells:t,encampments:n})=>n.size>0||t.size>0);return e.length===1?e[0]:null}function Pn(){localStorage.setItem(N.game,JSON.stringify({round:h.round,current_phase:h.current_phase,current_player_id:h.current_player_id}))}function je(){Ce.replaceChildren(...Object.entries(h.active_player.resources).map(([e,t])=>Object.assign(document.createElement("div"),{title:e,innerHTML:`<svg class="icon"><use href="#${e}"></use></svg>
                        <span>${t}</span>`})))}function Rn({target:e}){if(!(e instanceof Element))return;const t=e.closest("button");if(t===null)return;const n=Number(M.dataset.zoom_level);if(t.id==="zoom-in"){if(n===1)return;M.dataset.zoom_level=(n+1).toString()}else{if(n===-1)return;M.dataset.zoom_level=(n-1).toString()}}function Un(){h.players.length===0&&(h.players=Array.from({length:2},(e,t)=>Se(t,`Player ${t+1}`,"human"))),C.classList.remove("game-config"),h.run()}function Tn({submitter:e}){if(e.id==="continue-btn"){if(C.dataset.gameIsRunning!=="true")return;C.close();return}if(e.id==="new-game-btn"){if(C.dataset.gameIsRunning==="true"||h.current_phase===w.game_over.name){Object.assign(h,{round:0,current_phase:w.land_grab.name,current_player_id:0}),be(h.board,v),jt(),h.clear_players();for(const t of[...Y])t.remove()}Array.from({length:2},(t,n)=>Ze(n+1)),C.classList.add("game-config")}}function Jn(){C.dataset.gameIsRunning=(h.current_phase!==w.game_over.name&&h.players.length>0).toString(),C.showModal()}function Hn(){Array.from(Y,(e,t)=>{const n=e.querySelector(".player-name-input").value,r=e.querySelector(".player-type-select-radio:checked").value;h.players.push(Se(t,n,r))}),C.close()}window.addEventListener("DOMContentLoaded",Bn,{once:!0});document.addEventListener("visibilitychange",Cn);document.addEventListener("submit",e=>e.preventDefault());dt.addEventListener("click",Rn);G.addEventListener("change",ft(h,be));ie.addEventListener("input",()=>{Pe.value=ie.value});Re.addEventListener("click",Jn);at.addEventListener("submit",Tn);rt.addEventListener("submit",Hn);C.addEventListener("close",Un);ot.addEventListener("click",()=>be(h.board,v));nt.addEventListener("click",En);X.addEventListener("click",un(h));Ne.addEventListener("click",Sn);M.addEventListener("click",_n(h));st.addEventListener("input",({target:e})=>{e instanceof HTMLInputElement&&e.name==="tax_rate"&&(h.active_player.tax_rate=Number(e.value))});P.addEventListener("close",ln(h));P.addEventListener("submit",()=>P.close());
