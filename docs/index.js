(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))a(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const r of s.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&a(r)}).observe(document,{childList:!0,subtree:!0});function n(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerPolicy&&(s.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?s.credentials="include":i.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function a(i){if(i.ep)return;i.ep=!0;const s=n(i);fetch(i.href,s)}})();const Ye=""+new URL("service-worker.js",import.meta.url).href;window.navigator.serviceWorker.register(Ye).catch(console.error);let G;fe(),document.addEventListener("visibilitychange",()=>{document.hidden?je():fe()});async function fe(){var e,t;G=await((t=(e=navigator.wakeLock)==null?void 0:e.request)==null?void 0:t.call(e,"screen"))}async function je(){G&&(await G.release(),G=void 0)}const S={width:30,height:24};function oe(e){return e%2===0}function Ke(e,t,n){return e>=t&&e<=n}function be(e,t=0,n=e.length){return e[T(n,t)]}function T(e,t=0){return Math.trunc(Math.random()*(e-t)+t)}function ie(e){return Object.freeze(Object.assign(Object.create(null),e))}function Qe(e){e.preventDefault()}function Ee(e){e.forEach(t=>{t.neighbors=Ve(t,e,S)})}function Ve({q:e,r:t,s:n,x:a,y:i},s,r){const l=[{q:1,r:0,s:-1},{q:1,r:-1,s:0},{q:0,r:1,s:-1},{q:0,r:-1,s:1},{q:-1,r:0,s:1},{q:-1,r:1,s:0}].map(u=>s.find(d=>d.q===e+u.q&&d.r===t+u.r&&d.s===n+u.s)).filter(Boolean);return a===0&&(l.push(s.find(u=>i===u.y&&u.x===r.width-1)),oe(i)&&l.push(...[i<r.height-1?s.find(u=>i+1===u.y&&u.x===r.width-1):null,i>0?s.find(u=>i-1===u.y&&u.x===r.width-1):null].filter(Boolean))),a===r.width-1&&(l.push(s.find(u=>i===u.y&&u.x===0)),oe(i)||l.push(...[i<r.height-1?s.find(u=>i+1===u.y&&u.x===0):null,i>0?s.find(u=>i-1===u.y&&u.x===0):null].filter(Boolean))),l}const w={freezing:"freezing",cold:"cold",temperate:"temperate",warm:"warm",hot:"hot"};function Se(e){e.forEach(t=>{const n=Math.random(),a=-1,i=Ke(n,.3,.7)?0:1*(-1*+(n<.3)),s=(r=>r<0?0:r>S.height-1?S.height-1:r)(t.y+i+a);t.temperature=Ge(s)})}function Ge(e){switch(e){case 0:case 1:case S.height-2:case S.height-1:return w.freezing;case 2:case 3:case S.height-4:case S.height-3:return w.cold;case 4:case 5:case S.height-6:case S.height-5:return w.temperate;case 6:case 7:case 8:case S.height-9:case S.height-8:case S.height-7:return w.warm;default:return w.hot}}function Xe(e){switch(e){case w.hot:return w.warm;case w.warm:return w.temperate;case w.temperate:return w.cold;default:return w.freezing}}function Ze(e){switch(e){case w.freezing:return w.cold;case w.cold:return w.temperate;case w.temperate:return w.warm;default:return w.hot}}const ye=new Set([0,1,2,S.height-1,S.height-2,S.height-3]);function Le(e){const a=e.length/2.5;let i=0;for(;i<a;){const s=T(13,4),r={x:T(S.width),y:T(S.height-3,3)},c=e.find(({x:d,y:h})=>d===r.x&&h===r.y),l=new Set(c.neighbors.filter(({y:d})=>!ye.has(d))),u=new Set;i+=s,ge(c),u.add(c);for(let d=0;d<s;d+=1){const h=be([...l]);ge(h),u.add(h),l.delete(h),h.neighbors.filter(_=>!u.has(_)).filter(({y:_})=>!ye.has(_)).forEach(_=>l.add(_))}}e.filter(s=>s.elevation>0).forEach(s=>{const r=s.neighbors.filter(l=>l.elevation>0).length;if(r>=3)return;const c=Math.random();(r===2&&c>.7||r===1&&c<.7)&&et(s)})}function ge(e){e.elevation+=1,e.elevation>1&&(e.temperature=Xe(e.temperature))}function et(e){e.elevation=Math.max(0,e.elevation-1),e.elevation>0&&(e.temperature=Ze(e.temperature))}const g={arid:"arid",dry:"dry",moderate:"moderate",moist:"moist",wet:"wet"};function tt(e){switch(e){case g.arid:return g.dry;case g.dry:return g.moderate;case g.moderate:return g.moist;default:return g.wet}}function ke(e){e.filter(t=>t.elevation>0).forEach(t=>{t.neighbors.filter(({biome:n})=>n===p.sea).forEach(()=>{t.humidity=tt(t.humidity)})})}const o=ie({people:"people",gold:"gold",cloth:"cloth",wood:"wood",stone:"stone",iron:"iron",food:"food",alcohol:"alcohol",coal:"coal"}),nt=ie({[o.people]:5,[o.gold]:5,[o.cloth]:25,[o.wood]:25,[o.stone]:25,[o.iron]:0,[o.food]:50,[o.alcohol]:5,[o.coal]:5});function rt(e){e.forEach(({cells:t,encampments:n,tax_rate:a})=>{const{total_population:i,total_required_workers:s}=[...t].reduce((l,u)=>(l.total_population+=u.resources[o.people],l.total_required_workers+=[...u.structures.entries()].reduce((d,[h,_])=>d+h.required_workers*_,0),l),{total_population:0,total_required_workers:0}),r=Math.min(1,i/s);let c=[...n.values()].reduce((l,u)=>l+u,i);t.forEach(l=>{Object.entries(l.biome.resource_production).forEach(([u,d])=>{l.resources[u]+=d}),[...l.structures.entries()].forEach(([u,d])=>u.output.forEach(({resource_name:h,amount:_})=>{l.resources[h]+=Math.trunc(_*d*r)})),l.resources[o.gold]+=l.resources[o.people]*a,c>0&&(c>=l.resources[o.food]?(c-=l.resources[o.food],l.resources[o.food]=0):(l.resources[o.food]-=c,c=0)),ot(l)})})}function ot(e){let t=0;if(e.resources.people===1)Math.random()<.05&&(t=1);else{const n=Math.trunc(e.resources.people/2);for(let a=0;a<n;a+=1){const i=Math.random();i<.1?t+=2:i<.5&&(t+=1)}}e.resources[o.people]+=t}function K(e,t=1){const n={[o.gold]:0,[o.cloth]:0,[o.wood]:0,[o.stone]:0,[o.iron]:0,[o.food]:0,[o.alcohol]:0,[o.coal]:0};let a=0;return e.forEach(i=>{a+=i.resources.people,Object.entries(i.biome.resource_production).forEach(([s,r])=>{n[s]+=r}),[...i.structures.entries()].forEach(([s,r])=>{s.output.forEach(({resource_name:c,amount:l})=>{n[c]+=l*r})})}),n[o.gold]=a*t,n}const p={sea:k("sea",{[o.food]:1}),mountain:k("mountain",{[o.wood]:2,[o.stone]:5,[o.food]:3}),high_mountain:k("high_mountain",{[o.stone]:5}),ice:k("ice",{[o.food]:2}),tundra:k("tundra",{[o.cloth]:1,[o.wood]:2,[o.stone]:1,[o.food]:5}),grassland:k("grassland",{[o.cloth]:3,[o.wood]:2,[o.stone]:2,[o.food]:5}),savanna:k("savanna",{[o.cloth]:5,[o.wood]:5,[o.stone]:3,[o.food]:6}),boreal_forest:k("boreal_forest",{[o.cloth]:4,[o.wood]:10,[o.stone]:3,[o.food]:5}),forest:k("forest",{[o.cloth]:2,[o.wood]:10,[o.stone]:2,[o.food]:5}),tropical_rainforest:k("tropical_rainforest",{[o.cloth]:3,[o.wood]:7,[o.stone]:1,[o.food]:5}),cold_swamp:k("cold_swamp",{[o.cloth]:1,[o.wood]:2,[o.stone]:1,[o.food]:2}),swamp:k("swamp",{[o.cloth]:1,[o.wood]:1,[o.stone]:0,[o.food]:3}),tropical_swamp:k("tropical_swamp",{[o.cloth]:1,[o.wood]:3,[o.stone]:1,[o.food]:3}),desert:k("desert",{[o.cloth]:1,[o.wood]:0,[o.stone]:2,[o.food]:1}),extreme_desert:k("extreme_desert",{[o.cloth]:0,[o.wood]:0,[o.stone]:1,[o.food]:0})},st={[w.freezing]:{[g.arid]:p.tundra,[g.dry]:p.tundra,[g.moderate]:p.tundra,[g.moist]:p.boreal_forest,[g.wet]:p.boreal_forest},[w.cold]:{[g.arid]:p.tundra,[g.dry]:p.tundra,[g.moderate]:p.boreal_forest,[g.moist]:p.boreal_forest,[g.wet]:p.boreal_forest},[w.temperate]:{[g.arid]:p.tundra,[g.dry]:p.forest,[g.moderate]:p.forest,[g.moist]:p.forest,[g.wet]:p.swamp},[w.warm]:{[g.arid]:p.desert,[g.dry]:p.grassland,[g.moderate]:p.savanna,[g.moist]:p.forest,[g.wet]:p.tropical_swamp},[w.hot]:{[g.arid]:p.extreme_desert,[g.dry]:p.desert,[g.moderate]:p.grassland,[g.moist]:p.savanna,[g.wet]:p.tropical_rainforest}};function k(e="sea",t={}){return{name:e,resource_production:Object.assign({[o.gold]:0,[o.cloth]:0,[o.wood]:0,[o.stone]:0,[o.iron]:0,[o.food]:0,[o.alcohol]:0},t)}}function $e(e){e.forEach(t=>{t.biome=it(t)})}function qe(e){e.filter(({elevation:t})=>t===0).forEach(t=>{t.biome=at(t)})}function at(e,t=S.height){const n=Math.random();return[0,t-1].includes(e.y)?n<=.1?p.sea:p.ice:[1,t-2].includes(e.y)?n<=.75?p.sea:p.ice:[2,t-3].includes(e.y)?n<=.9?p.sea:p.ice:p.sea}function it(e){return e.biome?e.biome:e.elevation>1?e.elevation>2?p.high_mountain:p.mountain:st[e.temperature][e.humidity]}const ct=document.getElementById("add-player-btn"),J=document.getElementById("board"),se=document.getElementById("bottom-bar"),Q=document.getElementById("cell-info"),lt=document.getElementById("cell-debug-info"),U=document.getElementById("cell-production-forecast"),ut=document.getElementById("toggle-coord-system-btn"),dt=document.getElementById("config-game-form"),ce=document.getElementById("defs"),W=document.getElementById("end-turn-btn"),Z=document.getElementById("general-info"),X=document.getElementById("overall-production-forecast"),Ie=document.getElementById("phase-label"),D=document.getElementsByClassName("player-config"),re=document.getElementById("player-name"),Oe=document.getElementById("player-setup"),_t=document.getElementById("reroll-map-btn"),mt=document.getElementById("side-bar");document.getElementById("round-info");const Y=document.getElementById("season-of-move-select"),le=document.getElementById("selection-highlight"),pt=document.getElementById("start-game-form"),C=document.getElementById("main-overlay"),Ce=document.getElementById("movement-arrows"),B=document.getElementById("movement-config"),ee=B.querySelector('[name="troop-strength"]'),ze=B.querySelector('[name="troop-strength-value"]'),ft=B.querySelector('[name="min-troop-strength-value"]'),yt=B.querySelector('[name="max-troop-strength-value"]'),te=B.querySelector('[name="settle-cell-toggle"]'),gt=document.getElementById("player-borders"),ht=document.getElementById("encampments"),Me=document.getElementById("burger-menu-btn"),vt=ce.querySelector(".cell-wrapper"),wt=ce.querySelector(".movement-indicator"),he=ce.querySelector(".player-border"),bt=document.getElementById("player-config-tmpl").content,Et=document.getElementById("structure-builder-tmpl").content,ue={tent:P("Tent",[v(o.wood,1),v(o.cloth,3)],[],0,{on(e){e.housing_capacity+=5},off(e){e.housing_capacity-=5}},[]),textile_factory:P("Textile Factory",[v(o.wood,15),v(o.stone,15)],[v(o.cloth,5)],5),lumber_mill:P("Lumber Mill",[v(o.wood,15),v(o.stone,15)],[v(o.wood,5)]),quarry:P("Quarry",[v(o.wood,15),v(o.stone,15)],[v(o.stone,5)]),mine:P("Mine",[v(o.wood,5),v(o.stone,5)],[v(o.coal,5)]),forge:P("Forge",[v(o.wood,5),v(o.stone,5)],[v(o.iron,1)]),farm:P("Farm",[v(o.wood,5),v(o.stone,5)],[v(o.food,5)]),distillery:P("Distillery",[v(o.wood,5),v(o.stone,5)],[v(o.alcohol,1)])};function P(e="Pretty Structure",t=[v(o.wood,5)],n=[v(o.wood,1)],a=1,i={on(l){l.foo+=5},off(l){l.foo-=5}},s=[p.swamp],r=[v(o.wood,1)],c=1){return{display_name:e,construction_cost:t,space_requirement:c,unsupported_biomes:s,effects:i,output:n,input:r,required_workers:a}}function v(e=o.wood,t=1){return{resource_name:e,amount:t}}function Be(e,t,n,a,i,s,r){const c=St(e,t,n,a,i,s,r),l=c.querySelector(".population-size");let u=null,d=-1,h=0;return{cx:e,cy:t,x:n,y:a,q:i,r:s,s:r,get has_owner(){return d!==-1},neighbors:[],cell:c,elevation:0,humidity:g.arid,temperature:w.freezing,structures:new Map(Object.values(ue).map(_=>[_,0])),pop_size_display:l,resources:{get[o.people](){return h},set[o.people](_){h=_,l.textContent=h>0?h.toString():""},[o.gold]:0,[o.cloth]:0,[o.wood]:0,[o.stone]:0,[o.iron]:0,[o.food]:0,[o.alcohol]:0},get biome(){return u},set biome(_){u!==null&&c.classList.remove(u.name),_!==null&&c.classList.add(_.name),u=_},get owner_id(){return d},set owner_id(_){d=_,c.dataset.owner_id=_===-1?"":_.toString()},developable_land:10}}function St(e,t,n,a,i,s,r){const c=vt.cloneNode(!0);return c.setAttribute("transform",`translate(${e}, ${t})`),c.querySelector(".q-coord").textContent=i,c.querySelector(".r-coord").textContent=s,c.querySelector(".s-coord").textContent=r,c.querySelector(".offset-coords").textContent=`${n}, ${a}`,J.prepend(c),c}function xe(e){const t=[...e.values()];return t.forEach(n=>Object.assign(n,{biome:null,elevation:0,humidity:g.arid,temperature:w.freezing,resources:Object.keys(n.resources).reduce((a,i)=>(a[i]=0,a),n.resources),owner_id:-1})),Se(t),Le(t),qe(t),ke(t),$e(t),e}function Lt(e,t){const n=e.map(({cx:a,cy:i,x:s,y:r,q:c,r:l,s:u,biome_name:d,elevation:h,humidity:_,temperature:f,owner_id:m,resources:z})=>{const O=Be(a,i,s,r,c,l,u);return Object.assign(O,{biome:p[d],elevation:h,humidity:_,temperature:f,owner_id:m}),Object.entries(z).forEach(([He,We])=>{O.resources[He]=We}),O});Ee(n),Ne(n,t)}function kt(e,t){const n=It(e);Ee(n),Se(n),Le(n),qe(n),ke(n),$e(n),Ne(n,t)}function Ne(e,t){e.forEach(n=>{t.set(n.cell,n)})}const de=6,$t=de*.5,qt=de*.75;function It({height:e,width:t}){const n=[];for(let a=0;a<e;a+=1){const i=+!oe(a);for(let s=0;s<t;s+=1){const r=s-(a-(a&1))*.5;n.push(Be(s*de+i*$t,a*qt,s,a,r,a,-r-a))}}return n}const Pe=.5,x=Pe*.5;function H(e,t,{color:n="white",stroked_outline:a=!1}={}){const i=[];return[...e].reduce((s,r)=>{const c=r.neighbors.filter(m=>!e.has(m)),l=Ot(r),u=Ct(r),d=xt(r),h=Mt(r),_=Bt(r),f=zt(r);return c.find(m=>m.r===r.r&&m.s===r.s+1)&&s.push(`M${h}L${f}`),c.find(m=>m.q===r.q&&m.s===r.s+1)&&s.push(`M${f}L${l}`),c.find(m=>m.s===r.s&&m.r===r.r-1)&&s.push(`M${l}L${_}`),c.find(m=>m.r===r.r&&m.s===r.s-1)&&s.push(`M${_}L${d}`),c.find(m=>m.q===r.q&&m.s===r.s-1)&&s.push(`M${d}L${u}`),c.find(m=>m.s===r.s&&m.r===r.r+1)&&s.push(`M${u}L${h}`),s},i),t.setAttribute("d",i.join("")),t.setAttribute("stroke-width",Pe.toString()),t.setAttribute("stroke",n),a&&t.setAttribute("stroke-dasharray","1"),t}function Ot(e){return`${e.cx+3} ${e.cy+x}`}function Ct(e){return`${e.cx+3} ${e.cy+6-x}`}function zt(e){return`${e.cx+x} ${e.cy+1.5+x*.5}`}function Mt(e){return`${e.cx+x} ${e.cy+4.5-x*.5}`}function Bt(e){return`${e.cx+6-x} ${e.cy+1.5+x*.5}`}function xt(e){return`${e.cx+6-x} ${e.cy+4.5-x*.5}`}const N={game:"wargame-savegame",board:"wargame-board",players:"wargame-players",move_queue:"wargame-planned-moves"},Nt={human:"human",ai:"ai"},q=[];function Pt(){localStorage.setItem(N.players,JSON.stringify(q.map(({name:e,type:t,encampments:n})=>({name:e,type:t,encampments:[...n.entries()].map(([{cx:a,cy:i},s])=>({cx:a,cy:i,units:s}))}))))}function At(e){const t=JSON.parse(localStorage.getItem(N.players)),n=[...e.board.values()];q.push(...t.map(({name:a,type:i,encampments:s},r)=>_e(r,a,i,n.filter(c=>c.owner_id===r),s.map(({cx:c,cy:l,units:u})=>[n.find(d=>d.cx===c&&d.cy===l),u]))))}function Ae(e){const t=bt.cloneNode(!0);Object.assign(t.querySelector(".player-name-input"),{name:`player-${e}-name`,value:`Player ${e}`}),t.querySelectorAll(".player-type-select-radio").forEach(n=>{n.name=`player-${e}-type`}),Oe.append(t)}function _e(e,t="Player Name",n=Nt.ai,a=[],i=[]){const s=new Set(a),r=he.cloneNode(!0),c=he.cloneNode(!0),l=new Map,d=`var(--player-${e+1})`;gt.append(r),ht.append(c),H(s,r,{color:d}),i.forEach(([f,m])=>h(f,m));function h(f,m){if(l.set(f,m),f.cell.classList.contains("contested"))return;if(f.has_owner){f.cell.classList.add("contested");return}const z=q.find(O=>O.id!==e&&O.encampments.has(f));if(z){f.cell.classList.add("contested"),f.pop_size_display.textContent="",z.outline_encampments();return}_(),f.pop_size_display.textContent=m.toString()}function _(){H(new Set([...l.keys()].filter(({cell:f})=>!f.classList.contains("contested"))),c,{color:d,stroked_outline:!0})}return{id:e,name:ae(t),type:n,tax_rate:1,get resources(){return[...s].reduce((f,{resources:m})=>(Object.entries(m).forEach(([z,O])=>{f[z]+=O}),f),{[o.people]:0,[o.gold]:0,[o.cloth]:0,[o.wood]:0,[o.stone]:0,[o.iron]:0,[o.food]:0,[o.alcohol]:0,[o.coal]:0})},border_path_container:r,get cells(){return s},add_cell(f){f.owner_id=e,s.add(f),H(s,r,{color:d})},delete_cell(f){s.delete(f),f.owner_id=-1,H(s,r,{color:d})},get encampments(){return l},get_encampment(f){return l.get(f)},add_encampment:h,delete_encampment(f){l.delete(f),_(),f.owner_id===-1&&q.every(m=>!m.encampments.has(f))&&(f.pop_size_display.textContent="")},outline_encampments:_,destroy(){s.clear(),l.clear(),r.remove(),c.remove()}}}function ae(e){if(!q.some(a=>a.name===e))return e;const n=/^(?<name>.+)_(?<id>\d+)$/.exec(e);return ae(n===null?`${e}_2`:`${n.groups.name}_${(Number(n.groups.id)||0)+1}`)}function Re(e,t){X.querySelector("ul").replaceChildren(...me(e)),X.querySelector("input").value=t,X.classList.remove("hidden")}function Rt(e,t){U.querySelector("ul").replaceChildren(...me(e)),U.querySelector("fieldset").replaceChildren(...t),U.classList.remove("hidden")}function Tt(e,{wood:t,stone:n,cloth:a,food:i}){const s=Object.values(ue).filter(r=>!r.unsupported_biomes.includes(e.biome)).map(({display_name:r})=>`<li>${r}</li>`).join("");Q.innerHTML=`
        <h2>Cell Info</h2>
        <div>Biome: ${e.biome.name}</div>
        <div>Movement modifier: ${e.biome.movement_speed}</div>
        <div>Pleasantness: ${e.biome.pleasantness}</div>
        ...
        <h3>Production</h3>
        <div>Wood: ${t}</div>
        <div>Stone: ${n}</div>
        <div>Cloth: ${a}</div>
        <div>Food: ${i}</div>
        <h3>Supported structures</h3>
        <ul>${s}</ul>
    `,Q.classList.remove("hidden")}function me(e){return Object.entries(e).map(([t,n])=>Object.assign(document.createElement("li"),{textContent:`${t}: ${n}`}))}function Jt(e){return Object.entries(ue).filter(([,t])=>!t.unsupported_biomes.includes(e.biome)).map(([t,n])=>{const a=Et.cloneNode(!0).lastElementChild,i=a.querySelector(".label-text"),s=a.querySelector(".structure-count");return a.dataset.structure_name=t,i.textContent=`${n.display_name}: `,s.textContent=e.structures.get(n),a.addEventListener("click",({target:r})=>{const c=r.closest("button");if(c===null)return;const l=c.classList.contains("construct-structure-btn"),u=n.construction_cost;let d=e.structures.get(n);if(l){if(e.developable_land<n.space_requirement||u.some(({resource_name:_,amount:f})=>f>y.active_player.resources[_]))return;d+=1,u.forEach(({resource_name:_,amount:f})=>{let m=f;for(const z of y.active_player.cells){const O=z.resources[_];if(O<m){m-=O,z.resources[_]=0;continue}else z.resources[_]-=m,m=0;if(m===0)break}}),e.developable_land-=n.space_requirement}else{if(d===0)return;d-=1,u.forEach(({resource_name:h,amount:_})=>{e.resources[h]+=_}),e.developable_land+=n.space_requirement}e.structures.set(n,d),s.textContent=d,U.querySelector("ul").replaceChildren(...me(K([e],y.active_player.tax_rate))),y.update_resource_display()}),a})}function Ut(e){return({target:t})=>{t.name==="tax_rate"&&(e.active_player.tax_rate=Number(t.value))}}const pe=new Map;function Dt(){localStorage.setItem(N.board,JSON.stringify([...pe.values()].map(({cx:e,cy:t,x:n,y:a,q:i,r:s,s:r,biome:{name:c},elevation:l,humidity:u,temperature:d,owner_id:h,resources:_})=>({cx:e,cy:t,x:n,y:a,q:i,r:s,s:r,biome_name:c,elevation:l,humidity:u,temperature:d,owner_id:h,resources:_}))))}function Ft(){const e=JSON.parse(localStorage.getItem(N.board));Lt(e,pe)}let R=null;function Ht(e){!e.has_owner&&e.biome!==p.sea?(R=e,H(new Set([...e.neighbors,e]),le),Z.classList.add("hidden"),Tt(e,e.biome.resource_production)):(Q.classList.add("hidden"),Z.classList.remove("hidden"))}function Wt(e){return R===null?!1:(Object.entries(nt).forEach(([t,n])=>{R.resources[t]=n}),e.active_player.add_cell(R),R.cell.classList.remove("clicked"),R=null,!0)}function Yt(e,t){e.owner_id===t.current_player_id?(X.classList.add("hidden"),Rt(K([e],t.active_player.tax_rate),Jt(e))):(U.classList.add("hidden"),Re(K(t.active_player.cells,t.active_player.tax_rate),t.active_player.tax_rate))}const $=[];function jt(){localStorage.setItem(N.move_queue,JSON.stringify($.map(({player_id:e,origin:t,target:n,units:a,season:i})=>({player_id:e,origin:{cx:t.cx,cy:t.cy},target:{cx:n.cx,cy:n.cy},units:a,season:i}))))}function Kt(e){const t=JSON.parse(localStorage.getItem(N.move_queue)),n=[...e.board.values()];$.push(...t.map(({player_id:a,origin:i,target:s,units:r,season:c})=>Te(a,n.find(({cx:l,cy:u})=>l===i.cx&&u===i.cy),n.find(({cx:l,cy:u})=>l===s.cx&&u===s.cy),r,c)))}function Te(e,t,n,a,i,s="unspecified"){const r=Qt(t,n,a,e);let c=a;return{player_id:e,origin:t,target:n,season:i,get units(){return c},set units(l){c=l,r.lastElementChild.lastElementChild.textContent=l.toString()},type:s,arrow:r}}function Qt(e,t,n,a){const s={x:e.cx+3,y:e.cy+3},r={x:t.cx+3,y:t.cy+3},c=`M${s.x} ${s.y}A 3 3 0 0 0 ${r.x} ${r.y}`,l=wt.cloneNode(!0),u=l.lastElementChild.lastElementChild;return l.firstElementChild.setAttribute("d",c),l.dataset.owner_id=a,u.setAttribute("path",c),u.textContent=n,Ce.append(l),l}function Vt(){$.length=0,Ce.replaceChildren()}const L=ie({spring:"spring",summer:"summer",autumn:"autumn",winter:"winter"});function Gt(e){switch(e){case L.spring:return L.summer;case L.summer:return L.autumn;case L.autumn:return L.winter;default:return L.spring}}function ne(e,t){return!(e===t||e===L.winter||e===L.summer&&t===L.spring||e===L.autumn&&t!==L.winter)}let E=null,M=null;function Xt(e,t){if(E===null){tn(e,t);return}if(e.cell.classList.remove("clicked"),E===e){E=null;return}if(!e.neighbors.includes(E))return;M=e;const n=$.find(({player_id:r,origin:c,target:l})=>r===t.current_player_id&&c===E&&l===M),a=E.owner_id===t.current_player_id,i=M.owner_id===t.current_player_id,s={settle_cell:!1,season:L.spring};if(Object.values(L).forEach(r=>{Y.querySelector(`input[value="${r}"]`).disabled=!1}),Y.inert=!1,te.inert=i||M.biome===p.sea,n?Zt(n,t,a,s):en(t,a,s),s.max_value<=0){M=null;return}Y.querySelector(`input[value="${s.season}"]`).checked=!0,Object.assign(ee,{value:s.current_value,min:s.min_value,max:s.max_value}),ze.value=s.current_value,ft.value=s.min_value,yt.value=s.max_value,te.checked=s.settle_cell,B.showModal()}function Zt(e,t,n,a){const i=$.filter(({player_id:s})=>s===t.current_player_id);a.settle_cell=e.type==="settle",a.current_value=e.units,a.season=e.season,a.min_value=i.filter(({season:s,origin:r})=>ne(e.season,s)&&e.target===r).reduce((s,{season:r,origin:c,units:l})=>(j(i,c,r,c.owner_id===t.current_player_id?c.resources[o.people]:0)-e.units<l&&(s+=l),s),0),Y.inert=!0,te.inert=!0,n?a.max_value=j(i,E,a.season,E.resources[o.people])-1+a.current_value:a.max_value=j(i,E,a.season,t.active_player.get_encampment(E)||0)-Number(a.settle_cell)+a.current_value}function en(e,t,n){const a=$.filter(({player_id:i})=>i===e.current_player_id);if(n.current_value=0,n.min_value=0,t)n.max_value=j(a,E,n.season,E.resources[o.people])-1;else{const i=a.filter(({target:r})=>r===E).reduce((r,{season:c})=>((r===""||ne(c,r))&&(r=c),r),""),s=!!a.find(({target:r,type:c,season:l})=>r===E&&l===i&&c==="settle");if(i===L.winter){M=null;return}i!==""&&Object.values(L).filter(r=>r===i||ne(r,i)).forEach(r=>{Y.querySelector(`input[value="${r}"]`).disabled=!0}),n.season=Gt(i),n.max_value=j(a,E,n.season,e.active_player.get_encampment(E)||0)-Number(s)}}function tn(e,t){const n=$.filter(({player_id:c})=>c===t.current_player_id),a=e.owner_id===t.current_player_id&&e.resources[o.people]>1,i=n.find(({origin:c})=>c===e),s=n.find(({target:c,season:l})=>c===e&&l!=="winter"),r=t.active_player.encampments.has(e);a||i||s||r?E=e:e.cell.classList.remove("clicked")}function j(e,t,n,a=0){return e.filter(({origin:i,target:s,season:r})=>(i===t||s===t)&&(r===n||ne(r,n))).reduce((i,s)=>(t===s.target?i+=s.units:i-=s.units,i),a)}function nn(e){return()=>{const t=B.querySelector('[name="season-of-move"]:checked').value,n=Number(ee.value),a=te.checked,i=$.findIndex(({player_id:s,origin:r,target:c})=>s===e.current_player_id&&r===E&&c===M);if(Number.isNaN(n)||n<=0){if(E=null,M=null,i>-1){const[{arrow:s}]=$.splice(i,1);s.remove()}return}if(i>-1){const s=$[i];s.units=n}else $.push(Te(e.current_player_id,E,M,n,t,a?"settle":"unspecified"));E=null,M=null}}const b={land_grab:F("land_grab","Pick your origin","Confirm choice",Ht),development:F("development","Pick one of your cells and develop it",void 0,Yt),movement_planning:F("movement_planning","Make your moves",void 0,Xt),movement_execution:F("movement_execution","","Start Movement Phase"),game_over:F("game_over","","Pick your origin")};function rn(e){return()=>{if(!(e.current_phase===b.land_grab.name&&!Wt(e))){if(e.current_phase===b.movement_execution.name){const{done:t}=e.moves.next();if(!t)return}e.next_turn()}}}function F(e="round_phase",t="",n="End turn",a=(i,s)=>{}){return{name:e,call_to_action:t,end_turn_btn_label:n,handle_click_on_cell:a}}function*on(e){var t;for(const n in L){const a=$.filter(r=>n===r.season).filter(r=>{const c=an(r,e);return c||ve(r,$),c});if(a.length===0)continue;const i=new Set,s=new Map;Ie.textContent=`Move(s) in ${n}`,W.textContent="Show next move";for(const r of a)r.origin.cell.classList.add("clicked"),r.arrow.style.display="initial",i.add(r.target),yield"init_move",r.type==="settle"&&s.set(r.target,s.has(r.target)?s.get(r.target).add(r.player_id):new Set([r.player_id])),sn(r,e),ve(r,$),r.origin.cell.classList.remove("clicked");W.textContent="Make these moves",yield"moves_laid_out";for(const r of i){const c=cn(r,e.players);if(c.length===1){const{player_id:l,units:u}=c[0];(t=s.get(r))!=null&&t.has(l)&&Je(e.players[l],r,u);continue}W.textContent="Start battle",yield"battle_awaits",ln(r,c,e.players,s.get(r))}}}function Je(e,t,n){e.delete_encampment(t),e.add_cell(t),t.resources[o.people]=n}function sn(e,t){if(e.player_id===e.origin.owner_id)e.origin.resources[o.people]-=e.units;else{const n=t.players[e.player_id],a=n.get_encampment(e.origin)-e.units;a===0?n.delete_encampment(e.origin):n.add_encampment(e.origin,a)}if(e.player_id===e.target.owner_id)e.target.resources[o.people]+=e.units;else{const n=t.players[e.player_id],a=(n.get_encampment(e.target)||0)+e.units;n.add_encampment(e.target,a)}}function an(e={},t){const n=e.origin.owner_id===e.player_id?e.origin.resources[o.people]-1:t.players[e.player_id].encampments.get(e.origin);return e.units<=n}function ve(e,t=[]){const n=t.findIndex(a=>a===e);n<0||(t[n].arrow.remove(),t.splice(n,1))}function cn(e,t){return t.reduce((n,a,i)=>(a.encampments.has(e)?n.push({player_id:i,units:a.encampments.get(e)}):i===e.owner_id&&n.push({player_id:e.owner_id,units:e.resources[o.people],is_owner:!0}),n),[])}function ln(e,t,n,a){for(;t.length>1;){const c=[],l=new Set;t.forEach((u,d)=>{const h=new Set([d]);let _;t.forEach((f,m)=>{h.has(m)||(h.add(m),_=T(_===void 0?u.units:u.units-_),c.push({target_id:m,attack_strength:_}))})});for(const{target_id:u,attack_strength:d}of c)t[u].units-=d,t[u].units<=0&&l.add(u);if(l.size===t.length){l.forEach(u=>n[t[u].player_id].delete_encampment(e)),t=[Object.assign(be(t),{units:1})];break}[...l].sort((u,d)=>d-u).forEach(u=>{n[t[u].player_id].delete_encampment(e),t.splice(u,1)})}e.cell.classList.remove("contested");const{player_id:i,units:s}=t[0],r=n[i];if(e.owner_id===i){e.resources[o.people]=s;return}e.has_owner&&(n[e.owner_id].delete_cell(e),e.resources[o.people]=0),a!=null&&a.has(i)?Je(r,e,s):r.add_encampment(e,s)}let V=0,I=b.land_grab.name,A=0,Ue=null,De;const y={board:pe,get moves(){return De},get round(){return V},set round(e){V=e},get active_player(){return q[A]},get players(){return q},set players(e){q.push(...e)},get current_player_id(){return A},set current_player_id(e){A=e},get current_player_total_production(){return Ue},clear_players(){q.forEach(e=>e.destroy()),q.length=0},get current_phase(){return I},set current_phase(e){I=e},update_resource_display:Fe,next_turn(){if(le.setAttribute("d",""),A===q.length-1){if(A=0,I=un(),I===b.development.name){if(V>0){const e=dn();if(e!==null){I=b.game_over.name,alert(`The World is Yours ${e.name}`),document.body.dataset.current_phase=b.game_over.name,Me.click();return}rt(q)}V+=1}}else A+=1;we()},run:we};function un(){switch(I){case b.development.name:return b.movement_planning.name;case b.movement_planning.name:return b.movement_execution.name;default:case b.movement_execution.name:return b.development.name}}function dn(){const e=q.filter(({cells:t,encampments:n})=>n.size>0||t.size>0);return e.length===1?e[0]:null}function we(){W.textContent=b[I].end_turn_btn_label,Ie.textContent=b[I].call_to_action,re.classList.remove("hidden"),re.textContent=y.active_player.name,document.body.dataset.current_phase=b[I].name,document.documentElement.style.setProperty("--active-player-color",`var(--player-${A+1}`),se.classList.add("content-hidden"),I===b.land_grab.name?(Q.classList.add("hidden"),Z.classList.remove("hidden")):I===b.development.name?(Q.classList.add("hidden"),Z.classList.add("hidden"),Ue=K(y.active_player.cells,y.active_player.tax_rate),U.classList.add("hidden"),Re(K(y.active_player.cells,y.active_player.tax_rate),y.active_player.tax_rate),se.classList.remove("content-hidden"),Fe()):I===b.movement_execution.name&&(De=on(y),re.classList.add("hidden"))}function Fe(){se.replaceChildren(...Object.entries(y.active_player.resources).map(([e,t])=>Object.assign(document.createElement("div"),{title:e,innerHTML:`<svg class="icon"><use href="#${e}"></use></svg>
                        <span>${t}</span>`})))}function _n(){localStorage.setItem(N.game,JSON.stringify({round:y.round,current_phase:y.current_phase,current_player_id:y.current_player_id}))}function mn(e,t){const{round:n,current_phase:a,current_player_id:i}=JSON.parse(t);Object.assign(e,{round:n,current_phase:a,current_player_id:i})}function pn(){Object.values(N).forEach(e=>localStorage.removeItem(e))}const fn=2,yn=5;window.addEventListener("DOMContentLoaded",()=>{const e=localStorage.getItem(N.game),t=e!==null;t?(mn(y,e),Ft(),At(y),Kt(y)):kt(S,y.board),C.dataset.gameIsRunning=t.toString(),C.showModal()},{once:!0});document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&(y.players.length===0||y.current_phase===b.game_over.name?pn():(_n(),Dt(),Pt(),jt()))});document.addEventListener("submit",Qe);ee.addEventListener("input",()=>{ze.value=ee.value});Me.addEventListener("click",()=>{C.dataset.gameIsRunning=(y.current_phase!==b.game_over.name&&y.players.length>0).toString(),C.showModal()});pt.addEventListener("submit",({submitter:e})=>{if(e.id==="continue-btn")C.dataset.gameIsRunning==="true"&&C.close();else if(e.id==="new-game-btn"){if(C.dataset.gameIsRunning==="true"||y.current_phase===b.game_over.name){Object.assign(y,{round:0,current_phase:b.land_grab.name,current_player_id:0}),xe(y.board),Vt(),y.clear_players();for(const t of[...D])t.remove()}Array.from({length:2},(t,n)=>Ae(n+1)),C.classList.add("game-config")}});dt.addEventListener("submit",()=>{let e=0;for(const t of D){const n=t.querySelector(".player-name-input").value,a=t.querySelector(".player-type-select-radio:checked").value;y.players.push(_e(e,n,a)),e+=1}C.close()});C.addEventListener("close",()=>{y.players.length===0&&(y.players=Array.from({length:2},(e,t)=>_e(t,`Player ${t+1}`,"human"))),C.classList.remove("game-config"),y.run()});_t.addEventListener("click",()=>xe(y.board));ct.addEventListener("click",()=>{D.length!==yn&&Ae(D.length+1)});W.addEventListener("click",rn(y));Oe.addEventListener("click",({target:e})=>{e.closest(".delete-player-btn")!==null&&D.length!==fn&&(e.closest(".player-config").remove(),[...D].forEach((t,n)=>{n=n+1,Object.assign(t.querySelector(".player-name-input"),{name:`player-${n}-name`,value:`Player ${n}`}),t.querySelectorAll(".player-type-select-radio").forEach(a=>{a.name=`player-${n}-type`})}))});J.addEventListener("click",({target:e})=>{const t=e.closest(".cell-wrapper");if(!t)return;const n=J.querySelector(".clicked"),a=y.board.get(t);n&&(n.classList.remove("clicked"),le.replaceChildren()),n!==t&&t.classList.add("clicked"),gn(a),b[y.current_phase].handle_click_on_cell(a,y)});document.getElementById("zoom-btns").addEventListener("click",({target:e})=>{const t=e.closest("button");if(t===null)return;const n=Number(J.dataset.zoom_level);if(t.id==="zoom-in"){if(n===3)return;J.dataset.zoom_level=(n+1).toString()}else{if(n===-1)return;J.dataset.zoom_level=(n-1).toString()}});mt.addEventListener("input",Ut(y));B.addEventListener("close",nn(y));B.addEventListener("submit",()=>B.close());document.querySelector("h1").addEventListener("dblclick",()=>document.body.classList.toggle("debug"));ut.addEventListener("click",()=>document.body.classList.toggle("use-offset-coords"));function gn(e){lt.textContent=JSON.stringify(e,(t,n)=>t==="neighbors"?void 0:n,4)}
