(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))a(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const r of o.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&a(r)}).observe(document,{childList:!0,subtree:!0});function n(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function a(i){if(i.ep)return;i.ep=!0;const o=n(i);fetch(i.href,o)}})();const Qe=""+new URL("service-worker.js",import.meta.url).href;window.navigator.serviceWorker.register(Qe).catch(console.error);let Q;_e(),document.addEventListener("visibilitychange",()=>{document.hidden?Ve():_e()});async function _e(){var e,t;Q=await((t=(e=navigator.wakeLock)==null?void 0:e.request)==null?void 0:t.call(e,"screen"))}async function Ve(){Q&&(await Q.release(),Q=void 0)}const E={width:30,height:24};function ne(e){return e%2===0}function je(e,t,n){return e>=t&&e<=n}function we(e,t=0,n=e.length){return e[J(n,t)]}function J(e,t=0){return Math.trunc(Math.random()*(e-t)+t)}function se(e){return Object.freeze(Object.assign(Object.create(null),e))}function Ge(e){e.preventDefault()}function be(e){e.forEach(t=>{t.neighbors=Xe(t,e,E)})}function Xe({q:e,r:t,s:n,x:a,y:i},o,r){const l=[{q:1,r:0,s:-1},{q:1,r:-1,s:0},{q:0,r:1,s:-1},{q:0,r:-1,s:1},{q:-1,r:0,s:1},{q:-1,r:1,s:0}].map(u=>o.find(d=>d.q===e+u.q&&d.r===t+u.r&&d.s===n+u.s)).filter(Boolean);return a===0&&(l.push(o.find(u=>i===u.y&&u.x===r.width-1)),ne(i)&&l.push(...[i<r.height-1?o.find(u=>i+1===u.y&&u.x===r.width-1):null,i>0?o.find(u=>i-1===u.y&&u.x===r.width-1):null].filter(Boolean))),a===r.width-1&&(l.push(o.find(u=>i===u.y&&u.x===0)),ne(i)||l.push(...[i<r.height-1?o.find(u=>i+1===u.y&&u.x===0):null,i>0?o.find(u=>i-1===u.y&&u.x===0):null].filter(Boolean))),l}const v={freezing:"freezing",cold:"cold",temperate:"temperate",warm:"warm",hot:"hot"};function Ee(e){e.forEach(t=>{const n=Math.random(),a=-1,i=je(n,.3,.7)?0:1*(-1*+(n<.3)),o=(r=>r<0?0:r>E.height-1?E.height-1:r)(t.y+i+a);t.temperature=Ze(o)})}function Ze(e){switch(e){case 0:case 1:case E.height-2:case E.height-1:return v.freezing;case 2:case 3:case E.height-4:case E.height-3:return v.cold;case 4:case 5:case E.height-6:case E.height-5:return v.temperate;case 6:case 7:case 8:case E.height-9:case E.height-8:case E.height-7:return v.warm;default:return v.hot}}function et(e){switch(e){case v.hot:return v.warm;case v.warm:return v.temperate;case v.temperate:return v.cold;default:return v.freezing}}function tt(e){switch(e){case v.freezing:return v.cold;case v.cold:return v.temperate;case v.temperate:return v.warm;default:return v.hot}}const pe=new Set([0,1,2,E.height-1,E.height-2,E.height-3]);function Se(e){const a=e.length/2.5;let i=0;for(;i<a;){const o=J(13,4),r={x:J(E.width),y:J(E.height-3,3)},c=e.find(({x:d,y:h})=>d===r.x&&h===r.y),l=new Set(c.neighbors.filter(({y:d})=>!pe.has(d))),u=new Set;i+=o,me(c),u.add(c);for(let d=0;d<o;d+=1){const h=we([...l]);me(h),u.add(h),l.delete(h),h.neighbors.filter(_=>!u.has(_)).filter(({y:_})=>!pe.has(_)).forEach(_=>l.add(_))}}e.filter(o=>o.elevation>0).forEach(o=>{const r=o.neighbors.filter(l=>l.elevation>0).length;if(r>=3)return;const c=Math.random();(r===2&&c>.7||r===1&&c<.7)&&nt(o)})}function me(e){e.elevation+=1,e.elevation>1&&(e.temperature=et(e.temperature))}function nt(e){e.elevation=Math.max(0,e.elevation-1),e.elevation>0&&(e.temperature=tt(e.temperature))}const y={arid:"arid",dry:"dry",moderate:"moderate",moist:"moist",wet:"wet"};function rt(e){switch(e){case y.arid:return y.dry;case y.dry:return y.moderate;case y.moderate:return y.moist;default:return y.wet}}function Le(e){e.filter(t=>t.elevation>0).forEach(t=>{t.neighbors.filter(({biome:n})=>n===f.sea).forEach(()=>{t.humidity=rt(t.humidity)})})}const s=se({people:"people",gold:"gold",cloth:"cloth",wood:"wood",stone:"stone",iron:"iron",food:"food",alcohol:"alcohol"}),ot=se({[s.people]:5,[s.gold]:5,[s.cloth]:25,[s.wood]:25,[s.stone]:25,[s.iron]:0,[s.food]:50,[s.alcohol]:5});function st(e){e.forEach(({cells:t,encampments:n,tax_rate:a})=>{const{total_population:i,total_required_workers:o}=[...t].reduce((l,u)=>(l.total_population+=u.resources[s.people],l.total_required_workers+=[...u.structures.entries()].reduce((d,[h,_])=>d+h.required_workers*_,0),l),{total_population:0,total_required_workers:0}),r=Math.min(1,i/o);let c=[...n.values()].reduce((l,u)=>l+u,i);t.forEach(l=>{Object.entries(l.biome.resource_production).forEach(([u,d])=>{l.resources[u]+=d}),[...l.structures.entries()].forEach(([u,d])=>u.output.forEach(({resource_name:h,amount:_})=>{l.resources[h]+=Math.trunc(_*d*r)})),l.resources[s.gold]+=l.resources[s.people]*a,c>0&&(c>=l.resources[s.food]?(c-=l.resources[s.food],l.resources[s.food]=0):(l.resources[s.food]-=c,c=0)),at(l)})})}function at(e){for(let t=0;t<Math.floor(e.resources.people/2);t+=1){const n=Math.random();n<.3?e.resources[s.people]+=2:n<.8&&(e.resources[s.people]+=1)}}function H(e,t=1){const n={[s.gold]:0,[s.cloth]:0,[s.wood]:0,[s.stone]:0,[s.iron]:0,[s.food]:0,[s.alcohol]:0};let a=0;return e.forEach(i=>{a+=i.resources.people,Object.entries(i.biome.resource_production).forEach(([o,r])=>{n[o]+=r}),[...i.structures.entries()].forEach(([o,r])=>{o.output.forEach(({resource_name:c,amount:l})=>{n[c]+=l*r})})}),n[s.gold]=a*t,n}const f={sea:$("sea",{[s.food]:1}),mountain:$("mountain",{[s.wood]:2,[s.stone]:5,[s.food]:3}),high_mountain:$("high_mountain",{[s.stone]:5}),ice:$("ice",{[s.food]:2}),tundra:$("tundra",{[s.cloth]:1,[s.wood]:2,[s.stone]:1,[s.food]:5}),grassland:$("grassland",{[s.cloth]:3,[s.wood]:2,[s.stone]:2,[s.food]:5}),savanna:$("savanna",{[s.cloth]:5,[s.wood]:5,[s.stone]:3,[s.food]:6}),boreal_forest:$("boreal_forest",{[s.cloth]:4,[s.wood]:10,[s.stone]:3,[s.food]:5}),forest:$("forest",{[s.cloth]:2,[s.wood]:10,[s.stone]:2,[s.food]:5}),tropical_rainforest:$("tropical_rainforest",{[s.cloth]:3,[s.wood]:7,[s.stone]:1,[s.food]:5}),cold_swamp:$("cold_swamp",{[s.cloth]:1,[s.wood]:2,[s.stone]:1,[s.food]:2}),swamp:$("swamp",{[s.cloth]:1,[s.wood]:1,[s.stone]:0,[s.food]:3}),tropical_swamp:$("tropical_swamp",{[s.cloth]:1,[s.wood]:3,[s.stone]:1,[s.food]:3}),desert:$("desert",{[s.cloth]:1,[s.wood]:0,[s.stone]:2,[s.food]:1}),extreme_desert:$("extreme_desert",{[s.cloth]:0,[s.wood]:0,[s.stone]:1,[s.food]:0})},it={[v.freezing]:{[y.arid]:f.tundra,[y.dry]:f.tundra,[y.moderate]:f.tundra,[y.moist]:f.boreal_forest,[y.wet]:f.boreal_forest},[v.cold]:{[y.arid]:f.tundra,[y.dry]:f.tundra,[y.moderate]:f.boreal_forest,[y.moist]:f.boreal_forest,[y.wet]:f.boreal_forest},[v.temperate]:{[y.arid]:f.tundra,[y.dry]:f.forest,[y.moderate]:f.forest,[y.moist]:f.forest,[y.wet]:f.swamp},[v.warm]:{[y.arid]:f.desert,[y.dry]:f.grassland,[y.moderate]:f.savanna,[y.moist]:f.forest,[y.wet]:f.tropical_swamp},[v.hot]:{[y.arid]:f.extreme_desert,[y.dry]:f.desert,[y.moderate]:f.grassland,[y.moist]:f.savanna,[y.wet]:f.tropical_rainforest}};function $(e="",t={}){return{name:e,resource_production:Object.assign({[s.gold]:0,[s.cloth]:0,[s.wood]:0,[s.stone]:0,[s.iron]:0,[s.food]:0,[s.alcohol]:0},t)}}function ke(e){e.forEach(t=>{t.biome=lt(t)})}function $e(e){e.filter(({elevation:t})=>t===0).forEach(t=>{t.biome=ct(t)})}function ct(e,t=E.height){const n=Math.random();return[0,t-1].includes(e.y)?n<=.1?f.sea:f.ice:[1,t-2].includes(e.y)?n<=.75?f.sea:f.ice:[2,t-3].includes(e.y)?n<=.9?f.sea:f.ice:f.sea}function lt(e){return e.biome?e.biome:e.elevation>1?e.elevation>2?f.high_mountain:f.mountain:it[e.temperature][e.humidity]}const ut=document.getElementById("add-player-btn"),re=document.getElementById("board"),oe=document.getElementById("bottom-bar"),W=document.getElementById("cell-info"),dt=document.getElementById("cell-debug-info"),R=document.getElementById("cell-production-forecast"),_t=document.getElementById("toggle-coord-system-btn"),fe=document.getElementById("config-game-form"),ae=document.getElementById("defs"),U=document.getElementById("end-turn-btn"),j=document.getElementById("general-info"),V=document.getElementById("overall-production-forecast"),qe=document.getElementById("phase-label"),Y=document.getElementsByClassName("player-config"),te=document.getElementById("player-name"),Oe=document.getElementById("player-setup"),pt=document.getElementById("reroll-map-btn"),mt=document.getElementById("side-bar");document.getElementById("round-info");const D=document.getElementById("season-of-move-select"),ie=document.getElementById("selection-highlight"),ft=document.getElementById("start-game-form"),z=document.getElementById("start-game-overlay"),Ie=document.getElementById("movement-arrows"),M=document.getElementById("movement-config"),G=M.querySelector('[name="troop-strength"]'),Ce=M.querySelector('[name="troop-strength-value"]'),yt=M.querySelector('[name="min-troop-strength-value"]'),ht=M.querySelector('[name="max-troop-strength-value"]'),X=M.querySelector('[name="settle-cell-toggle"]'),gt=document.getElementById("player-borders"),vt=document.getElementById("encampments"),wt=ae.querySelector(".cell-wrapper"),bt=ae.querySelector(".movement-indicator"),ye=ae.querySelector(".player-border"),Et=document.getElementById("player-config-tmpl").content,St=document.getElementById("structure-builder-tmpl").content,ce={tent:A("Tent",[w(s.wood,1),w(s.cloth,3)],[],0,{on(e){e.housing_capacity+=5},off(e){e.housing_capacity-=5}},[]),textile_factory:A("Textile Factory",[w(s.wood,15),w(s.stone,15)],[w(s.cloth,5)]),lumber_mill:A("Lumber Mill",[w(s.wood,15),w(s.stone,15)],[w(s.wood,5)]),quarry:A("Quarry",[w(s.wood,15),w(s.stone,15)],[w(s.stone,5)]),forge:A("Forge",[w(s.wood,5),w(s.stone,5)],[w(s.iron,1)]),farm:A("Farm",[w(s.wood,5),w(s.stone,5)],[w(s.food,5)]),distillery:A("Distillery",[w(s.wood,5),w(s.stone,5)],[w(s.alcohol,1)])};function A(e="Pretty Structure",t=[w(s.wood,5)],n=[w(s.wood,1)],a=1,i={on(l){l.foo+=5},off(l){l.foo-=5}},o=[f.swamp],r=[w(s.wood,1)],c=1){return{display_name:e,construction_cost:t,space_requirement:c,unsupported_biomes:o,effects:i,output:n,input:r,required_workers:a}}function w(e=s.wood,t=1){return{resource_name:e,amount:t}}function Be(e,t,n,a,i,o,r){const c=Lt(e,t,n,a,i,o,r),l=c.querySelector(".population-size");let u=null,d=-1,h=0;return{cx:e,cy:t,x:n,y:a,q:i,r:o,s:r,get has_owner(){return d!==-1},neighbors:[],cell:c,elevation:0,humidity:y.arid,temperature:v.freezing,structures:new Map(Object.values(ce).map(_=>[_,0])),pop_size_display:l,resources:{get[s.people](){return h},set[s.people](_){h=_,l.textContent=h>0?h.toString():""},[s.gold]:0,[s.cloth]:0,[s.wood]:0,[s.stone]:0,[s.iron]:0,[s.food]:0,[s.alcohol]:0},get biome(){return u},set biome(_){u!==null&&c.classList.remove(u.name),_!==null&&c.classList.add(_.name),u=_},get owner_id(){return d},set owner_id(_){d=_,_!==-1&&(c.dataset.owner_id=_.toString())},developable_land:10}}function Lt(e,t,n,a,i,o,r){const c=wt.cloneNode(!0);return c.setAttribute("transform",`translate(${e}, ${t})`),c.querySelector(".q-coord").textContent=i,c.querySelector(".r-coord").textContent=o,c.querySelector(".s-coord").textContent=r,c.querySelector(".offset-coords").textContent=`${n}, ${a}`,re.prepend(c),c}function Me(e){const t=[...e.values()];return t.forEach(n=>Object.assign(n,{biome:null,elevation:0,humidity:y.arid,temperature:v.freezing,resources:Object.keys(n.resources).reduce((a,i)=>(a[i]=0,a),n.resources),owner_id:-1})),Ee(t),Se(t),$e(t),Le(t),ke(t),e}function kt(e,t){const n=e.map(({cx:a,cy:i,x:o,y:r,q:c,r:l,s:u,biome_name:d,elevation:h,humidity:_,temperature:m,owner_id:p,resources:C})=>{const I=Be(a,i,o,r,c,l,u);return Object.assign(I,{biome:f[d],elevation:h,humidity:_,temperature:m,owner_id:p}),Object.entries(C).forEach(([Ye,Ke])=>{I.resources[Ye]=Ke}),I});return be(n),xe(n,t)}function $t(e,t){const n=qt(e);return be(n),Ee(n),Se(n),$e(n),Le(n),ke(n),xe(n,t)}function xe(e,t){return e.reduce((n,a)=>(n.set(a.cell,a),n),t)}function qt({height:e,width:t}){const n=[];for(let a=0;a<e;a+=1){const i=+!ne(a);for(let o=0;o<t;o+=1){const r=o-(a-(a&1))/2;n.push(Be(o*6+i*3,a*4.5,o,a,r,a,-r-a))}}return n}const Ne=.5,x=Ne*.5;function T(e,t,{color:n="white",stroked_outline:a=!1}={}){const i=[];return[...e].reduce((o,r)=>{const c=r.neighbors.filter(p=>!e.has(p)),l=Ot(r),u=It(r),d=xt(r),h=Bt(r),_=Mt(r),m=Ct(r);return c.find(p=>p.r===r.r&&p.s===r.s+1)&&o.push(`M${h}L${m}`),c.find(p=>p.q===r.q&&p.s===r.s+1)&&o.push(`M${m}L${l}`),c.find(p=>p.s===r.s&&p.r===r.r-1)&&o.push(`M${l}L${_}`),c.find(p=>p.r===r.r&&p.s===r.s-1)&&o.push(`M${_}L${d}`),c.find(p=>p.q===r.q&&p.s===r.s-1)&&o.push(`M${d}L${u}`),c.find(p=>p.s===r.s&&p.r===r.r+1)&&o.push(`M${u}L${h}`),o},i),t.setAttribute("d",i.join("")),t.setAttribute("stroke-width",Ne.toString()),t.setAttribute("stroke",n),a&&t.setAttribute("stroke-dasharray","1"),t}function Ot(e){return`${e.cx+3} ${e.cy+x}`}function It(e){return`${e.cx+3} ${e.cy+6-x}`}function Ct(e){return`${e.cx+x} ${e.cy+1.5+x*.5}`}function Bt(e){return`${e.cx+x} ${e.cy+4.5-x*.5}`}function Mt(e){return`${e.cx+6-x} ${e.cy+1.5+x*.5}`}function xt(e){return`${e.cx+6-x} ${e.cy+4.5-x*.5}`}const Nt={human:"human",ai:"ai"},S=[],ze="wargame-players";function zt(){localStorage.setItem(ze,JSON.stringify(S.map(({name:e,type:t,encampments:n})=>({name:e,type:t,encampments:[...n.entries()].map(([{cx:a,cy:i},o])=>({cx:a,cy:i,units:o}))}))))}function At(e){const t=JSON.parse(localStorage.getItem(ze)),n=[...e.board.values()];S.push(...t.map(({name:a,type:i,encampments:o},r)=>le(r,a,i,n.filter(c=>c.owner_id===r),o.map(({cx:c,cy:l,units:u})=>[n.find(d=>d.cx===c&&d.cy===l),u]))))}function Ae(e){const t=Et.cloneNode(!0);Object.assign(t.querySelector(".player-name-input"),{name:`player-${e}-name`,value:`Player ${e}`}),t.querySelectorAll(".player-type-select-radio").forEach(n=>{n.name=`player-${e}-type`}),Oe.append(t)}function le(e,t="Player Name",n=Nt.ai,a=[],i=[]){const o=new Set(a),r=ye.cloneNode(!0),c=ye.cloneNode(!0),l=new Map,d=`var(--player-${e+1})`;gt.append(r),vt.append(c),T(o,r,{color:d}),i.forEach(([m,p])=>h(m,p));function h(m,p){if(l.set(m,p),m.cell.classList.contains("contested"))return;if(m.has_owner){m.cell.classList.add("contested");return}const C=S.find(I=>I.id!==e&&I.encampments.has(m));if(C){m.cell.classList.add("contested"),m.pop_size_display.textContent="",C.outline_encampments();return}_(),m.pop_size_display.textContent=p.toString()}function _(){T(new Set([...l.keys()].filter(({cell:m})=>!m.classList.contains("contested"))),c,{color:d,stroked_outline:!0})}return{id:e,name:t,type:n,tax_rate:1,get resources(){return[...o].reduce((m,{resources:p})=>(Object.entries(p).forEach(([C,I])=>{m[C]+=I}),m),{[s.people]:0,[s.gold]:0,[s.cloth]:0,[s.wood]:0,[s.stone]:0,[s.iron]:0,[s.food]:0,[s.alcohol]:0})},border_path_container:r,get cells(){return o},add_cell(m){m.owner_id=e,o.add(m),T(o,r,{color:d})},delete_cell(m){o.delete(m),m.owner_id=-1,T(o,r,{color:d})},get encampments(){return l},get_encampment(m){return l.get(m)},add_encampment:h,delete_encampment(m){l.delete(m),_(),m.owner_id===-1&&S.every(p=>!p.encampments.has(m))&&(m.pop_size_display.textContent="")},outline_encampments:_,destroy(){o.clear(),l.clear(),r.remove(),c.remove()}}}function Pe(e,t){V.querySelector("ul").replaceChildren(...ue(e)),V.querySelector("input").value=t,V.classList.remove("hidden")}function Pt(e,t){R.querySelector("ul").replaceChildren(...ue(e)),R.querySelector("fieldset").replaceChildren(...t),R.classList.remove("hidden")}function Jt(e,{wood:t,stone:n,cloth:a,food:i}){const o=Object.values(ce).filter(r=>!r.unsupported_biomes.includes(e.biome)).map(({display_name:r})=>`<li>${r}</li>`).join("");W.innerHTML=`
        <h2>Cell Info</h2>
        <div>Biome: ${e.biome.name}</div>
        <div>Movement modifier: ${e.biome.movement_speed}</div>
        <div>Pleasantness: ${e.biome.pleasantness}</div>
        ...
        <h3>Production</h3>
        <div>Wood: ${t}</div>
        <div>Stone: ${n}</div>
        <div>Cloth: ${a}</div>
        <div>Food: ${i}</div>
        <h3>Supported structures</h3>
        <ul>${o}</ul>
    `,W.classList.remove("hidden")}function ue(e){return Object.entries(e).map(([t,n])=>Object.assign(document.createElement("li"),{textContent:`${t}: ${n}`}))}function Rt(e){return Object.entries(ce).filter(([,t])=>!t.unsupported_biomes.includes(e.biome)).map(([t,n])=>{const a=St.cloneNode(!0).lastElementChild,i=a.querySelector(".label-text"),o=a.querySelector(".structure-count");return a.dataset.structure_name=t,i.textContent=`${n.display_name}: `,o.textContent=e.structures.get(n),a.addEventListener("click",({target:r})=>{const c=r.closest("button");if(c===null)return;const l=c.classList.contains("construct-structure-btn"),u=n.construction_cost;let d=e.structures.get(n);if(l){if(e.developable_land<n.space_requirement||u.some(({resource_name:_,amount:m})=>m>g.active_player.resources[_]))return;d+=1,u.forEach(({resource_name:_,amount:m})=>{let p=m;for(const C of g.active_player.cells){const I=C.resources[_];if(I<p){p-=I,C.resources[_]=0;continue}else C.resources[_]-=p,p=0;if(p===0)break}}),e.developable_land-=n.space_requirement}else{if(d===0)return;d-=1,u.forEach(({resource_name:h,amount:_})=>{e.resources[h]+=_}),e.developable_land+=n.space_requirement}e.structures.set(n,d),o.textContent=d,R.querySelector("ul").replaceChildren(...ue(H([e],g.active_player.tax_rate))),g.update_resource_display()}),a})}function Tt(e){return({target:t})=>{const n=Number(t.value);t.name==="tax_rate"&&(e.active_player.tax_rate=n)}}const O=[],Je="wargame-planned-moves";function Ut(){localStorage.setItem(Je,JSON.stringify(O.map(({player_id:e,origin:t,target:n,units:a,season:i})=>({player_id:e,origin:{cx:t.cx,cy:t.cy},target:{cx:n.cx,cy:n.cy},units:a,season:i}))))}function Dt(e){const t=JSON.parse(localStorage.getItem(Je)),n=[...e.board.values()];O.push(...t.map(({player_id:a,origin:i,target:o,units:r,season:c})=>Re(a,n.find(({cx:l,cy:u})=>l===i.cx&&u===i.cy),n.find(({cx:l,cy:u})=>l===o.cx&&u===o.cy),r,c)))}function Re(e,t,n,a,i,o="unspecified"){const r=Ft(t,n,a);return{player_id:e,origin:t,target:n,season:i,units:a,type:o,arrow:r}}function Ft(e,t,n){const i={x:e.cx+3,y:e.cy+3},o={x:t.cx+3,y:t.cy+3},r=`M${i.x} ${i.y}A 3 3 0 0 0 ${o.x} ${o.y}`,c=bt.cloneNode(!0),l=c.lastElementChild.lastElementChild;return c.firstElementChild.setAttribute("d",r),l.setAttribute("path",r),l.textContent=n,Ie.append(c),c}function Te(){O.length=0,Ie.replaceChildren()}const de=new Map,Ue="wargame-board";function Ht(){localStorage.setItem(Ue,JSON.stringify([...de.values()].map(({cx:e,cy:t,x:n,y:a,q:i,r:o,s:r,biome:{name:c},elevation:l,humidity:u,temperature:d,owner_id:h,resources:_})=>({cx:e,cy:t,x:n,y:a,q:i,r:o,s:r,biome_name:c,elevation:l,humidity:u,temperature:d,owner_id:h,resources:_}))))}function Wt(){const e=JSON.parse(localStorage.getItem(Ue));kt(e,de)}let P=null;function Yt(e){!e.has_owner&&e.biome!==f.sea?(P=e,T(new Set([...e.neighbors,e]),ie),j.classList.add("hidden"),Jt(e,e.biome.resource_production)):(W.classList.add("hidden"),j.classList.remove("hidden"))}function Kt(e){P!==null&&(Object.entries(ot).forEach(([t,n])=>{P.resources[t]=n}),e.active_player.add_cell(P),P.cell.classList.remove("clicked"),P=null)}function Qt(e,t){e.owner_id===t.current_player_id?(V.classList.add("hidden"),Pt(H([e],t.active_player.tax_rate),Rt(e))):(R.classList.add("hidden"),Pe(H(t.active_player.cells,t.active_player.tax_rate),t.active_player.tax_rate))}const L=se({spring:"spring",summer:"summer",autumn:"autumn",winter:"winter"});function Vt(e){switch(e){case L.spring:return L.summer;case L.summer:return L.autumn;case L.autumn:return L.winter;default:return L.spring}}function Z(e,t){return!(e===t||e===L.winter||e===L.summer&&t===L.spring||e===L.autumn&&t!==L.winter)}let b=null,N=null;function jt(e,t){if(b===null){Zt(e,t);return}if(e.cell.classList.remove("clicked"),b===e){b=null;return}if(!e.neighbors.includes(b))return;N=e;const n=O.find(({player_id:r,origin:c,target:l})=>r===t.current_player_id&&c===b&&l===N),a=b.owner_id===t.current_player_id,i=N.owner_id===t.current_player_id,o={settle_cell:!1,season:L.spring};if(Object.values(L).forEach(r=>{D.querySelector(`input[value="${r}"]`).disabled=!1}),D.inert=!1,X.inert=i,n?Gt(n,t,a,o):Xt(t,a,o),o.max_value<=0){N=null;return}D.querySelector(`input[value="${o.season}"]`).checked=!0,Object.assign(G,{value:o.current_value,min:o.min_value,max:o.max_value}),Ce.value=o.current_value,yt.value=o.min_value,ht.value=o.max_value,X.checked=o.settle_cell,M.showModal()}function Gt(e,t,n,a){const i=O.filter(({player_id:o})=>o===t.current_player_id);a.settle_cell=e.type==="settle",a.current_value=e.units,a.season=e.season,a.min_value=i.filter(({season:o,origin:r})=>Z(e.season,o)&&e.target===r).reduce((o,{season:r,origin:c,units:l})=>(F(i,c,r,c.owner_id===t.current_player_id?c.resources[s.people]:0)-e.units<l&&(o+=l),o),0),D.inert=!0,X.inert=!0,n?a.max_value=F(i,b,a.season,b.resources[s.people])-1+a.current_value:a.max_value=F(i,b,a.season)-Number(a.settle_cell)+a.current_value}function Xt(e,t,n){const a=O.filter(({player_id:i})=>i===e.current_player_id);if(n.current_value=0,n.min_value=0,t)n.max_value=F(a,b,n.season,b.resources[s.people])-1;else{const i=a.filter(({target:r})=>r===b).reduce((r,{season:c})=>((r===""||Z(c,r))&&(r=c),r),""),o=!!a.find(({target:r,type:c,season:l})=>r===b&&l===i&&c==="settle");if(i===L.winter){N=null;return}i!==""&&Object.values(L).filter(r=>r===i||Z(r,i)).forEach(r=>{D.querySelector(`input[value="${r}"]`).disabled=!0}),n.season=Vt(i),n.max_value=F(a,b,n.season,e.active_player.get_encampment(b)||0)-Number(o)}}function Zt(e,t){const n=O.filter(({player_id:c})=>c===t.current_player_id),a=e.owner_id===t.current_player_id&&e.resources[s.people]>1,i=n.find(({origin:c})=>c===e),o=n.find(({target:c,season:l})=>c===e&&l!=="winter"),r=t.active_player.encampments.has(e);a||i||o||r?b=e:e.cell.classList.remove("clicked")}function F(e,t,n,a=0){return e.filter(({origin:i,target:o,season:r})=>(i===t||o===t)&&(r===n||Z(r,n))).reduce((i,o)=>(t===o.target?i+=o.units:i-=o.units,i),a)}function en(e){return()=>{const t=M.querySelector('[name="season-of-move"]:checked').value,n=Number(G.value),a=X.checked,i=O.findIndex(({player_id:o,origin:r,target:c})=>o===e.current_player_id&&r===b&&c===N);if(Number.isNaN(n)||n<=0){if(b=null,N=null,i>-1){const[{arrow:o}]=O.splice(i,1);o.remove()}return}if(i>-1){const o=O[i];o.units=n,o.arrow.lastElementChild.lastElementChild.textContent=n.toString()}else O.push(Re(e.current_player_id,b,N,n,t,a?"settle":"unspecified"));b=null,N=null}}const k={land_grab:K("land_grab","Pick your origin","Confirm choice",Yt),development:K("development","Distribute your wealth",void 0,Qt),movement_planning:K("movement_planning","Make your moves",void 0,jt),movement_execution:K("movement_execution","","Start Movement Phase")};function tn(e){return()=>{if(e.current_phase===k.land_grab.name)Kt(e);else if(e.current_phase===k.movement_execution.name){const{done:t}=e.moves.next();if(!t)return}e.next_turn()}}function K(e="round_phase",t="",n="End turn",a=(i,o)=>{}){return{name:e,call_to_action:t,end_turn_btn_label:n,handle_click_on_cell:a}}function*nn(e){var t;for(const n in L){const a=O.filter(r=>n===r.season).filter(r=>{const c=on(r,e);return c||he(r,O),c});if(a.length===0)continue;const i=new Set,o=new Map;qe.textContent=`Move(s) in ${n}`,U.textContent="Show next move";for(const r of a)r.origin.cell.classList.add("clicked"),r.arrow.style.display="initial",i.add(r.target),yield"init_move",r.type==="settle"&&o.set(r.target,o.has(r.target)?o.get(r.target).add(r.player_id):new Set([r.player_id])),rn(r,e),he(r,O),r.origin.cell.classList.remove("clicked");U.textContent="Make these moves",yield"moves_laid_out";for(const r of i){const c=sn(r,e.players);if(c.length===1){const{player_id:l,units:u}=c.at(-1);(t=o.get(r))!=null&&t.has(l)&&De(e.players[l],r,u);continue}U.textContent="Start battle",yield"battle_awaits",an(r,c,e.players,o.get(r))}}}function De(e,t,n){e.delete_encampment(t),e.add_cell(t),t.resources[s.people]=n}function rn(e,t){if(e.player_id===e.origin.owner_id)e.origin.resources[s.people]-=e.units;else{const n=t.players[e.player_id],a=n.get_encampment(e.origin)-e.units;a===0?n.delete_encampment(e.origin):n.add_encampment(e.origin,a)}if(e.player_id===e.target.owner_id)e.target.resources[s.people]+=e.units;else{const n=t.players[e.player_id],a=(n.get_encampment(e.target)||0)+e.units;n.add_encampment(e.target,a)}}function on(e={},t){const n=e.origin.owner_id===e.player_id?e.origin.resources[s.people]-1:t.players[e.player_id].encampments.get(e.origin);return e.units<=n}function he(e,t=[]){const n=t.findIndex(a=>a===e);n<0||(t[n].arrow.remove(),t.splice(n,1))}function sn(e,t){return t.reduce((n,a,i)=>(a.encampments.has(e)?n.push({player_id:i,units:a.encampments.get(e)}):i===e.owner_id&&n.push({player_id:e.owner_id,units:e.resources[s.people],is_owner:!0}),n),[])}function an(e,t,n,a){for(;t.length>1;){const c=[],l=new Set;t.forEach((u,d)=>{const h=new Set([d]);let _;t.forEach((m,p)=>{h.has(p)||(h.add(p),_=J(_===void 0?u.units:u.units-_),c.push({target_id:p,attack_strength:_}))})});for(const{target_id:u,attack_strength:d}of c)t[u].units-=d,t[u].units<=0&&l.add(u);if(l.size===t.length){l.forEach(u=>n[t[u].player_id].delete_encampment(e)),t=[Object.assign(we(t),{units:1})];break}[...l].sort((u,d)=>d-u).forEach(u=>{n[t[u].player_id].delete_encampment(e),t.splice(u,1)})}e.cell.classList.remove("contested");const{player_id:i,units:o}=t[0],r=n[i];if(e.owner_id===i){e.resources[s.people]=o;return}e.has_owner&&(n[e.owner_id].delete_cell(e),e.resources[s.people]=0),a!=null&&a.has(i)?De(r,e,o):r.add_encampment(e,o)}let ee=0,B=k.land_grab.name,q=0,Fe=null,He;const g={board:de,get moves(){return He},get round(){return ee},set round(e){ee=e},get active_player(){return S[q]},get players(){return S},set players(e){S.push(...e)},get current_player_id(){return q},set current_player_id(e){q=e},get current_player_total_production(){return Fe},clear_players(){S.forEach(e=>e.destroy()),S.length=0},get current_phase(){return B},set current_phase(e){B=e},update_resource_display:We,next_turn(){ie.setAttribute("d",""),q===S.length-1?(q=0,B=cn()):q+=1,ge()},run:ge};function cn(){switch(B){case k.development.name:return Te(),k.movement_planning.name;case k.movement_planning.name:return q=S.length-1,k.movement_execution.name;default:case k.movement_execution.name:return ee>0&&st(S),ee+=1,k.development.name}}function ge(){U.textContent=k[B].end_turn_btn_label,qe.textContent=k[B].call_to_action,te.classList.remove("hidden"),te.textContent=S[q].name,document.body.dataset.current_phase=k[B].name,document.documentElement.style.setProperty("--active-player-color",`var(--player-${q+1}`),oe.classList.add("content-hidden"),B===k.land_grab.name?(W.classList.add("hidden"),j.classList.remove("hidden")):B===k.development.name?(W.classList.add("hidden"),j.classList.add("hidden"),Fe=H(S[q].cells,S[q].tax_rate),R.classList.add("hidden"),Pe(H(S[q].cells,S[q].tax_rate),S[q].tax_rate),oe.classList.remove("content-hidden"),We()):B===k.movement_execution.name&&(He=nn(g),te.classList.add("hidden"))}function We(){oe.replaceChildren(...Object.entries(S[q].resources).map(([e,t])=>Object.assign(document.createElement("div"),{textContent:`${e}: ${t}`})))}const ve="wargame-savegame";function ln(){if(g.players.length===0){localStorage.removeItem(ve);return}localStorage.setItem(ve,JSON.stringify({round:g.round,current_phase:g.current_phase,current_player_id:g.current_player_id}))}function un(e,t){const{round:n,current_phase:a,current_player_id:i}=JSON.parse(t);Object.assign(e,{round:n,current_phase:a,current_player_id:i})}window.addEventListener("DOMContentLoaded",()=>{const e=localStorage.getItem("wargame-savegame"),t=e!==null;z.dataset.priorSave=t.toString(),z.showModal(),t?(un(g,e),Wt(),At(g)):$t(E,g.board),Dt(g)},{once:!0});document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&(ln(),Ht(),zt(),Ut())});document.addEventListener("submit",Ge);G.addEventListener("input",()=>{Ce.value=G.value});ft.addEventListener("submit",e=>{e.submitter.id==="continue-btn"?z.dataset.priorSave==="true"&&z.close():e.submitter.id==="new-game-btn"&&(z.dataset.priorSave==="true"&&(Object.assign(g,{round:0,current_phase:k.land_grab.name,current_player_id:0}),Me(g.board),g.clear_players(),Te()),Array.from({length:2},(t,n)=>Ae(n+1)),z.classList.add("game-config"))});z.addEventListener("close",()=>{g.players.length===0&&(g.players=Array.from({length:2},(e,t)=>le(t,`Player ${t+1}`,"human"))),g.run()});pt.addEventListener("click",()=>Me(g.board));U.addEventListener("click",tn(g));fe.addEventListener("submit",()=>{const e=new Set,t=[...fe.querySelectorAll(".player-name-input")];if(t.reduce((n,{value:a})=>(n[a]=a in n?n[a]+1:1,n[a]>1&&e.add(a),n),{}),e.size>0){t.forEach(n=>{e.has(n.value)&&n.classList.add("invalid")});return}g.players=Array.from(Y,(n,a)=>{const i=n.querySelector(".player-name-input").value,o=n.querySelector(".player-type-select-radio:checked").value;return le(a,i,o)}),z.close()});ut.addEventListener("click",()=>{Y.length!==5&&Ae(Y.length+1)});Oe.addEventListener("click",({target:e})=>{e.closest(".delete-player-btn")&&Y.length!==2&&(e.closest(".player-config").remove(),[...Y].forEach((t,n)=>{n=n+1,Object.assign(t.querySelector(".player-name-input"),{name:`player-${n}-name`,value:`Player ${n}`}),t.querySelectorAll(".player-type-select-radio").forEach(a=>{a.name=`player-${n}-type`})}))});re.addEventListener("click",({target:e})=>{const t=e.closest(".cell-wrapper");if(!t)return;const n=re.querySelector(".clicked"),a=g.board.get(t);n&&(n.classList.remove("clicked"),ie.replaceChildren()),n!==t&&t.classList.add("clicked"),dn(a),k[g.current_phase].handle_click_on_cell(a,g)});mt.addEventListener("input",Tt(g));M.addEventListener("close",en(g));M.addEventListener("submit",()=>M.close());document.querySelector("h1").addEventListener("dblclick",()=>document.body.classList.toggle("debug"));_t.addEventListener("click",()=>document.body.classList.toggle("use-offset-coords"));function dn(e){dt.textContent=JSON.stringify(e,(t,n)=>t==="neighbors"?void 0:n,4)}
