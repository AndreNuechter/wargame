(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))a(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const o of s.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&a(o)}).observe(document,{childList:!0,subtree:!0});function n(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerPolicy&&(s.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?s.credentials="include":i.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function a(i){if(i.ep)return;i.ep=!0;const s=n(i);fetch(i.href,s)}})();const Fe=""+new URL("service-worker.js",import.meta.url).href;window.navigator.serviceWorker.register(Fe).catch(console.error);let Z;we(),document.addEventListener("visibilitychange",()=>{document.hidden?He():we()});async function we(){var e,t;Z=await((t=(e=navigator.wakeLock)==null?void 0:e.request)==null?void 0:t.call(e,"screen"))}async function He(){Z&&(await Z.release(),Z=void 0)}const We=document.getElementById("add-player-btn"),x=document.getElementById("board"),W=document.getElementById("board-size-select"),ie=document.getElementById("bottom-bar"),V=document.getElementById("cell-info"),J=document.getElementById("cell-production-forecast"),Ye=document.getElementById("config-game-form"),de=document.getElementById("defs"),Y=document.getElementById("end-turn-btn"),te=document.getElementById("general-info"),ee=document.getElementById("total-production-forecast"),$e=document.getElementById("phase-label"),D=document.getElementsByClassName("player-config"),ae=document.getElementById("player-name"),qe=document.getElementById("player-setup"),Ke=document.getElementById("reroll-map-btn"),Qe=document.getElementById("side-bar");document.getElementById("round-info");const K=document.getElementById("season-of-move-select"),_e=document.getElementById("selection-highlight"),Ve=document.getElementById("start-game-form"),O=document.getElementById("main-overlay"),Ie=document.getElementById("movement-arrows"),N=document.getElementById("movement-config"),ne=N.querySelector('[name="troop-strength"]'),Oe=N.querySelector('[name="troop-strength-value"]'),Ge=N.querySelector('[name="min-troop-strength-value"]'),Xe=N.querySelector('[name="max-troop-strength-value"]'),re=N.querySelector('[name="settle-cell-toggle"]'),Ze=document.getElementById("player-borders"),et=document.getElementById("encampments"),ze=document.getElementById("burger-menu-btn"),tt=document.getElementById("zoom-btns");function ce(e){return e%2===0}function nt(e,t,n){return e>=t&&e<=n}function Be(e,t=0,n=e.length){return e[U(n,t)]}function U(e,t=0){return Math.trunc(Math.random()*(e-t)+t)}function G(e){return Object.freeze(Object.assign(Object.create(null),e))}function me(e){return Object.entries(e).map(([t,n])=>Object.assign(document.createElement("li"),{textContent:`${t}: ${n}`}))}function rt(e){return Object.seal(Object.assign(Object.create(null),e))}function ot(e){e.preventDefault()}const B={board:"wargame-board",board_dimensions:"wargame-board-dimensions",game:"wargame-savegame",move_queue:"wargame-planned-moves",players:"wargame-players"},v=rt({width:0,height:0}),j={s:{width:30,height:24,cell_count:720,viewBox:"0 0 185 110"},m:{width:60,height:48,cell_count:2880,viewBox:"0 0 370 220"},l:{width:90,height:72,cell_count:6480,viewBox:"0 0 740 440"}};function Me({width:e,height:t}){return{width:e,height:t}}function st({board:e},t){return()=>{const n=W.value;Object.assign(v,Me(j[n])),x.setAttribute("viewBox",j[n].viewBox),t(e,v)}}function at(){const e=JSON.parse(localStorage.getItem(B.board_dimensions));if(e===null){const t=W.value;Object.assign(v,Me(j[t]))}else Object.assign(v,e),W.value=Object.keys(j).find(t=>j[t].width===v.width);x.setAttribute("viewBox",j[W.value].viewBox)}function it(){localStorage.setItem(B.board_dimensions,v)}const r=G({people:"people",gold:"gold",cloth:"cloth",wood:"wood",stone:"stone",iron:"iron",food:"food",alcohol:"alcohol",coal:"coal"}),ct=G({[r.people]:5,[r.gold]:5,[r.cloth]:25,[r.wood]:25,[r.stone]:25,[r.iron]:0,[r.food]:50,[r.alcohol]:5,[r.coal]:5});function oe(e,t=1){const n={[r.gold]:0,[r.cloth]:0,[r.wood]:0,[r.stone]:0,[r.iron]:0,[r.food]:0,[r.alcohol]:0,[r.coal]:0};let a=0;return e.forEach(i=>{a+=i.resources.people,Object.entries(i.biome.resource_production).forEach(([s,o])=>{n[s]+=o}),[...i.structures.entries()].forEach(([s,o])=>{s.output.forEach(({resource_name:l,amount:c})=>{n[l]+=c*o})})}),n[r.gold]=a*t,n}function lt(e){let t=0;if(e.resources.people===1)Math.random()<.05&&(t=1);else{const n=Math.trunc(e.resources.people/2);for(let a=0;a<n;a+=1){const i=Math.random();i<.1?t+=2:i<.5&&(t+=1)}}e.resources[r.people]+=t}function ut(e){e.forEach(({cells:t,encampments:n,tax_rate:a})=>{const{total_population:i,total_required_workers:s}=[...t].reduce((c,u)=>(c.total_population+=u.resources[r.people],c.total_required_workers+=[...u.structures.entries()].reduce((_,[h,m])=>_+h.required_workers*m,0),c),{total_population:0,total_required_workers:0}),o=Math.min(1,i/s);let l=[...n.values()].reduce((c,u)=>c+u,i);t.forEach(c=>{Object.entries(c.biome.resource_production).forEach(([u,_])=>{c.resources[u]+=_}),[...c.structures.entries()].forEach(([u,_])=>u.output.forEach(({resource_name:h,amount:m})=>{c.resources[h]+=Math.trunc(m*_*o)})),c.resources[r.gold]+=c.resources[r.people]*a,l>0&&(l>=c.resources[r.food]?(l-=c.resources[r.food],c.resources[r.food]=0):(c.resources[r.food]-=l,l=0)),lt(c)})})}const b=G({freezing:"freezing",cold:"cold",temperate:"temperate",warm:"warm",hot:"hot"});function dt(e){e.forEach(t=>{const n=Math.random(),a=-1,i=nt(n,.3,.7)?0:1*(-1*+(n<.3)),s=(o=>o<0?0:o>v.height-1?v.height-1:o)(t.y+i+a);t.temperature=mt(s)})}function _t(e){switch(e){case b.hot:return b.warm;case b.warm:return b.temperate;case b.temperate:return b.cold;default:return b.freezing}}function mt(e){switch(e){case 0:case 1:case v.height-2:case v.height-1:return b.freezing;case 2:case 3:case v.height-4:case v.height-3:return b.cold;case 4:case 5:case v.height-6:case v.height-5:return b.temperate;case 6:case 7:case 8:case v.height-9:case v.height-8:case v.height-7:return b.warm;default:return b.hot}}function pt(e){switch(e){case b.freezing:return b.cold;case b.cold:return b.temperate;case b.temperate:return b.warm;default:return b.hot}}const y=G({arid:"arid",dry:"dry",moderate:"moderate",moist:"moist",wet:"wet"});function ft(e){e.filter(t=>t.elevation>0).forEach(t=>{t.neighbors.filter(n=>n.elevation===0).forEach(n=>{n.cell.classList.add("shore"),t.humidity=ht(t.humidity)})})}function ht(e){switch(e){case y.arid:return y.dry;case y.dry:return y.moderate;case y.moderate:return y.moist;default:return y.wet}}const f={sea:k("sea",{[r.food]:1}),mountain:k("mountain",{[r.wood]:2,[r.stone]:5,[r.food]:3}),high_mountain:k("high_mountain",{[r.stone]:5}),ice:k("ice",{[r.food]:2}),tundra:k("tundra",{[r.cloth]:1,[r.wood]:2,[r.stone]:1,[r.food]:5}),grassland:k("grassland",{[r.cloth]:3,[r.wood]:2,[r.stone]:2,[r.food]:5}),savanna:k("savanna",{[r.cloth]:5,[r.wood]:5,[r.stone]:3,[r.food]:6}),boreal_forest:k("boreal_forest",{[r.cloth]:4,[r.wood]:10,[r.stone]:3,[r.food]:5}),forest:k("forest",{[r.cloth]:2,[r.wood]:10,[r.stone]:2,[r.food]:5}),tropical_rainforest:k("tropical_rainforest",{[r.cloth]:3,[r.wood]:7,[r.stone]:1,[r.food]:5}),cold_swamp:k("cold_swamp",{[r.cloth]:1,[r.wood]:2,[r.stone]:1,[r.food]:2}),swamp:k("swamp",{[r.cloth]:1,[r.wood]:1,[r.stone]:0,[r.food]:3}),tropical_swamp:k("tropical_swamp",{[r.cloth]:1,[r.wood]:3,[r.stone]:1,[r.food]:3}),desert:k("desert",{[r.cloth]:1,[r.wood]:0,[r.stone]:2,[r.food]:1}),extreme_desert:k("extreme_desert",{[r.cloth]:0,[r.wood]:0,[r.stone]:1,[r.food]:0})},yt={[b.freezing]:{[y.arid]:f.tundra,[y.dry]:f.tundra,[y.moderate]:f.tundra,[y.moist]:f.boreal_forest,[y.wet]:f.boreal_forest},[b.cold]:{[y.arid]:f.tundra,[y.dry]:f.tundra,[y.moderate]:f.boreal_forest,[y.moist]:f.boreal_forest,[y.wet]:f.boreal_forest},[b.temperate]:{[y.arid]:f.tundra,[y.dry]:f.forest,[y.moderate]:f.forest,[y.moist]:f.forest,[y.wet]:f.swamp},[b.warm]:{[y.arid]:f.desert,[y.dry]:f.grassland,[y.moderate]:f.savanna,[y.moist]:f.forest,[y.wet]:f.tropical_swamp},[b.hot]:{[y.arid]:f.extreme_desert,[y.dry]:f.desert,[y.moderate]:f.grassland,[y.moist]:f.savanna,[y.wet]:f.tropical_rainforest}};function gt(e){e.forEach(t=>{t.biome||(t.biome=t.elevation>1?t.elevation>2?f.high_mountain:f.mountain:yt[t.temperature][t.humidity])})}function k(e="sea",t={}){return{name:e,resource_production:Object.assign({[r.gold]:0,[r.cloth]:0,[r.wood]:0,[r.stone]:0,[r.iron]:0,[r.food]:0,[r.alcohol]:0},t)}}function vt(e){e.filter(({elevation:t})=>t===0).forEach(t=>{t.biome=wt(t)})}function wt(e,t=v.height){const n=Math.random();return[0,t-1].includes(e.y)?n<=.1?f.sea:f.ice:[1,t-2].includes(e.y)?n<=.75?f.sea:f.ice:[2,t-3].includes(e.y)?n<=.9?f.sea:f.ice:f.sea}const be=new Set([0,1,2,v.height-1,v.height-2,v.height-3]);function Ee(e){e.elevation+=1,e.elevation>1&&(e.temperature=_t(e.temperature))}function bt(e){const a=e.length/2.5;let i=0;for(;i<a;){const s=U(13,4),o={x:U(v.width),y:U(v.height-3,3)},l=e.find(({x:_,y:h})=>_===o.x&&h===o.y),c=new Set(l.neighbors.filter(({y:_})=>!be.has(_))),u=new Set;i+=s,Ee(l),u.add(l);for(let _=0;_<s;_+=1){const h=Be([...c]);Ee(h),u.add(h),c.delete(h),h.neighbors.filter(m=>!u.has(m)).filter(({y:m})=>!be.has(m)).forEach(m=>c.add(m))}}e.filter(s=>s.elevation>0).forEach(s=>{const o=s.neighbors.filter(c=>c.elevation>0).length;if(o>=3)return;const l=Math.random();(o===2&&l>.7||o===1&&l<.7)&&Et(s)})}function Et(e){e.elevation=Math.max(0,e.elevation-1),e.elevation>0&&(e.temperature=pt(e.temperature))}const St=[{q:1,r:0,s:-1},{q:1,r:-1,s:0},{q:0,r:1,s:-1},{q:0,r:-1,s:1},{q:-1,r:0,s:1},{q:-1,r:1,s:0}];function Ce(e=[]){e.forEach(t=>{t.neighbors=Lt(t,e,v)})}function Lt({q:e,r:t,s:n,x:a,y:i},s,o){const l=St.map(c=>s.find(u=>u.q===e+c.q&&u.r===t+c.r&&u.s===n+c.s)).filter(Boolean);return a===0&&(l.push(s.find(c=>i===c.y&&c.x===o.width-1)),ce(i)&&l.push(...[i<o.height-1?s.find(c=>i+1===c.y&&c.x===o.width-1):null,i>0?s.find(c=>i-1===c.y&&c.x===o.width-1):null].filter(Boolean))),a===o.width-1&&(l.push(s.find(c=>i===c.y&&c.x===0)),ce(i)||l.push(...[i<o.height-1?s.find(c=>i+1===c.y&&c.x===0):null,i>0?s.find(c=>i-1===c.y&&c.x===0):null].filter(Boolean))),l}const kt=de.querySelector(".cell-wrapper"),$t=de.querySelector(".movement-indicator"),Se=de.querySelector(".player-border"),qt=document.getElementById("player-config-tmpl").content,It=document.getElementById("structure-builder-tmpl").content,pe={tent:P("Tent",[w(r.wood,1),w(r.cloth,3)],[],0,{on(e){e.housing_capacity+=5},off(e){e.housing_capacity-=5}},new Set),textile_factory:P("Textile Factory",[w(r.wood,15),w(r.stone,15)],[w(r.cloth,5)],5),lumber_mill:P("Lumber Mill",[w(r.wood,15),w(r.stone,15)],[w(r.wood,5)]),quarry:P("Quarry",[w(r.wood,15),w(r.stone,15)],[w(r.stone,5)]),mine:P("Mine",[w(r.wood,5),w(r.stone,5)],[w(r.coal,5)]),forge:P("Forge",[w(r.wood,5),w(r.stone,5)],[w(r.iron,1)]),farm:P("Farm",[w(r.wood,5),w(r.stone,5)],[w(r.food,5)]),distillery:P("Distillery",[w(r.wood,5),w(r.stone,5)],[w(r.alcohol,1)])};function P(e="Pretty Structure",t=[w(r.wood,5)],n=[w(r.wood,1)],a=1,i={on(c){c.foo+=5},off(c){c.foo-=5}},s=new Set([f.swamp]),o=[w(r.wood,1)],l=1){return{display_name:e,construction_cost:t,space_requirement:l,unsupported_biomes:s,effects:i,output:n,input:o,required_workers:a}}function w(e=r.wood,t=1){return{resource_name:e,amount:t}}const xe=.5,A=xe*.5;function H(e,t,{color:n="white",stroked_outline:a=!1}={}){const i=[];return[...e].reduce((s,o)=>{const l=o.neighbors.filter(p=>!e.has(p)),c=Ot(o),u=zt(o),_=xt(o),h=Mt(o),m=Ct(o),d=Bt(o);return l.find(p=>p.r===o.r&&p.s===o.s+1)&&s.push(`M${h}L${d}`),l.find(p=>p.q===o.q&&p.s===o.s+1)&&s.push(`M${d}L${c}`),l.find(p=>p.s===o.s&&p.r===o.r-1)&&s.push(`M${c}L${m}`),l.find(p=>p.r===o.r&&p.s===o.s-1)&&s.push(`M${m}L${_}`),l.find(p=>p.q===o.q&&p.s===o.s-1)&&s.push(`M${_}L${u}`),l.find(p=>p.s===o.s&&p.r===o.r+1)&&s.push(`M${u}L${h}`),s},i),t.setAttribute("d",i.join("")),t.setAttribute("stroke-width",xe.toString()),t.setAttribute("stroke",n),a&&t.setAttribute("stroke-dasharray","1"),t}function Ot(e){return`${e.cx+3} ${e.cy+A}`}function zt(e){return`${e.cx+3} ${e.cy+6-A}`}function Bt(e){return`${e.cx+A} ${e.cy+1.5+A*.5}`}function Mt(e){return`${e.cx+A} ${e.cy+4.5-A*.5}`}function Ct(e){return`${e.cx+6-A} ${e.cy+1.5+A*.5}`}function xt(e){return`${e.cx+6-A} ${e.cy+4.5-A*.5}`}let T=null;function Nt(e){!e.has_owner&&e.biome!==f.sea?(T=e,H(new Set([...e.neighbors,e]),_e),te.classList.add("hidden"),Pt(e,e.biome.resource_production)):(V.classList.add("hidden"),te.classList.remove("hidden"))}function At(e){return T===null?!1:(Object.entries(ct).forEach(([t,n])=>{T.resources[t]=n}),e.active_player.add_cell(T),T.cell.classList.remove("clicked"),T=null,!0)}function Pt(e,{wood:t,stone:n,cloth:a,food:i}){const s=Object.values(pe).filter(o=>!o.unsupported_biomes.has(e.biome)).map(({display_name:o})=>`<li>${o}</li>`).join("");V.innerHTML=`
        <h2>Cell Info</h2>
        <ul>
            <li>Biome: ${e.biome.name}</li>
            <li>Movement modifier: ${e.biome.movement_speed}</li>
            <li>Pleasantness: ${e.biome.pleasantness}</li>
            <li>...</li>
        </ul>
        <h3>Production</h3>
        <ul>
            <li>Wood: ${t}</li>
            <li>Stone: ${n}</li>
            <li>Cloth: ${a}</li>
            <li>Food: ${i}</li>
        </ul>
        <h3>Supported structures</h3>
        <ul>${s}</ul>
    `,V.classList.remove("hidden")}function Rt(e,t){return Object.entries(pe).filter(([,n])=>!n.unsupported_biomes.has(e.biome)).map(([n,a])=>{const i=It.cloneNode(!0).lastElementChild,s=i.querySelector(".label-text"),o=i.querySelector(".structure-count");return i.dataset.structure_name=n,s.textContent=`${a.display_name}: `,o.textContent=e.structures.get(a),i.addEventListener("click",({target:l})=>{if(!(l instanceof Element))return;const c=l.closest("button");if(c===null)return;const u=c.classList.contains("construct-structure-btn"),_=a.construction_cost;let h=e.structures.get(a);if(u){if(e.developable_land<a.space_requirement||_.some(({resource_name:d,amount:p})=>p>t.active_player.resources[d]))return;h+=1,_.forEach(({resource_name:d,amount:p})=>{let I=p;for(const z of t.active_player.cells){const ve=z.resources[d];if(ve<I){I-=ve,z.resources[d]=0;continue}else z.resources[d]-=I,I=0;if(I===0)break}}),e.developable_land-=a.space_requirement}else{if(h===0)return;h-=1,_.forEach(({resource_name:m,amount:d})=>{e.resources[m]+=d}),e.developable_land+=a.space_requirement}e.structures.set(a,h),o.textContent=h,J.querySelector("ul").replaceChildren(...me(oe([e],t.active_player.tax_rate))),t.update_resource_display()}),i})}function Ne(e,t){ee.querySelector("ul").replaceChildren(...me(e)),ee.querySelector("input").value=t,ee.classList.remove("hidden")}function Tt(e,t){e.owner_id===t.current_player_id?(ee.classList.add("hidden"),jt(oe([e],t.active_player.tax_rate),Rt(e,t))):(J.classList.add("hidden"),Ne(oe(t.active_player.cells,t.active_player.tax_rate),t.active_player.tax_rate))}function jt(e,t){J.querySelector("ul").replaceChildren(...me(e)),J.querySelector("fieldset").replaceChildren(...t),J.classList.remove("hidden")}const $=[];function Jt(){$.length=0,Ie.replaceChildren()}function Ut(e,t,n,a){const s={x:e.cx+3,y:e.cy+3},o={x:t.cx+3,y:t.cy+3},l=`M${s.x} ${s.y}A 3 3 0 0 0 ${o.x} ${o.y}`,c=$t.cloneNode(!0),u=c.lastElementChild.lastElementChild;return c.firstElementChild.setAttribute("d",l),c.dataset.owner_id=a,u.setAttribute("path",l),u.textContent=n,Ie.append(c),c}function Ae(e,t,n,a,i,s="unspecified"){const o=Ut(t,n,a,e);let l=a;return{player_id:e,origin:t,target:n,season:i,get units(){return l},set units(c){l=c,o.lastElementChild.lastElementChild.textContent=c.toString()},type:s,arrow:o}}function Dt(e){const t=JSON.parse(localStorage.getItem(B.move_queue)),n=[...e.board.values()];$.push(...t.map(({player_id:a,origin:i,target:s,units:o,season:l})=>Ae(a,n.find(({cx:c,cy:u})=>c===i.cx&&u===i.cy),n.find(({cx:c,cy:u})=>c===s.cx&&u===s.cy),o,l)))}function Ft(){localStorage.setItem(B.move_queue,JSON.stringify($.map(({player_id:e,origin:t,target:n,units:a,season:i})=>({player_id:e,origin:{cx:t.cx,cy:t.cy},target:{cx:n.cx,cy:n.cy},units:a,season:i}))))}const L=G({spring:"spring",summer:"summer",autumn:"autumn",winter:"winter"});function Ht(e){switch(e){case L.spring:return L.summer;case L.summer:return L.autumn;case L.autumn:return L.winter;default:return L.spring}}function se(e,t){return!(e===t||e===L.winter||e===L.summer&&t===L.spring||e===L.autumn&&t!==L.winter)}let S=null,M=null;function Wt(e,t){if(S===null){Qt(e,t);return}if(e.cell.classList.remove("clicked"),S===e){S=null;return}if(!e.neighbors.includes(S))return;M=e;const n=$.find(({player_id:o,origin:l,target:c})=>o===t.current_player_id&&l===S&&c===M),a=S.owner_id===t.current_player_id,i=M.owner_id===t.current_player_id,s={settle_cell:!1,season:L.spring};if(Object.values(L).forEach(o=>{K.querySelector(`input[value="${o}"]`).disabled=!1}),K.inert=!1,re.inert=i||M.biome===f.sea,n?Yt(n,t,a,s):Kt(t,a,s),s.max_value<=0){M=null;return}K.querySelector(`input[value="${s.season}"]`).checked=!0,Object.assign(ne,{value:s.current_value,min:s.min_value,max:s.max_value}),Oe.value=s.current_value,Ge.value=s.min_value,Xe.value=s.max_value,re.checked=s.settle_cell,N.showModal()}function Yt(e,t,n,a){const i=$.filter(({player_id:s})=>s===t.current_player_id);a.settle_cell=e.type==="settle",a.current_value=e.units,a.season=e.season,a.min_value=i.filter(({season:s,origin:o})=>se(e.season,s)&&e.target===o).reduce((s,{season:o,origin:l,units:c})=>(Q(i,l,o,l.owner_id===t.current_player_id?l.resources[r.people]:0)-e.units<c&&(s+=c),s),0),K.inert=!0,re.inert=!0,n?a.max_value=Q(i,S,a.season,S.resources[r.people])-1+a.current_value:a.max_value=Q(i,S,a.season,t.active_player.get_encampment(S)||0)-Number(a.settle_cell)+a.current_value}function Kt(e,t,n){const a=$.filter(({player_id:i})=>i===e.current_player_id);if(n.current_value=0,n.min_value=0,t)n.max_value=Q(a,S,n.season,S.resources[r.people])-1;else{const i=a.filter(({target:o})=>o===S).reduce((o,{season:l})=>((o===""||se(l,o))&&(o=l),o),""),s=!!a.find(({target:o,type:l,season:c})=>o===S&&c===i&&l==="settle");if(i===L.winter){M=null;return}i!==""&&Object.values(L).filter(o=>o===i||se(o,i)).forEach(o=>{K.querySelector(`input[value="${o}"]`).disabled=!0}),n.season=Ht(i),n.max_value=Q(a,S,n.season,e.active_player.get_encampment(S)||0)-Number(s)}}function Qt(e,t){const n=$.filter(({player_id:l})=>l===t.current_player_id),a=e.owner_id===t.current_player_id&&e.resources[r.people]>1,i=n.find(({origin:l})=>l===e),s=n.find(({target:l,season:c})=>l===e&&c!=="winter"),o=t.active_player.encampments.has(e);a||i||s||o?S=e:e.cell.classList.remove("clicked")}function Q(e,t,n,a=0){return e.filter(({origin:i,target:s,season:o})=>(i===t||s===t)&&(o===n||se(o,n))).reduce((i,s)=>(t===s.target?i+=s.units:i-=s.units,i),a)}function Vt(e){return()=>{const t=N.querySelector('[name="season-of-move"]:checked').value,n=Number(ne.value),a=re.checked,i=$.findIndex(({player_id:s,origin:o,target:l})=>s===e.current_player_id&&o===S&&l===M);if(Number.isNaN(n)||n<=0){if(S=null,M=null,i>-1){const[{arrow:s}]=$.splice(i,1);s.remove()}return}if(i>-1){const s=$[i];s.units=n}else $.push(Ae(e.current_player_id,S,M,n,t,a?"settle":"unspecified"));S=null,M=null}}const E={land_grab:F("land_grab","Pick your origin","Confirm choice",Nt),development:F("development","Pick one of your cells and develop it",void 0,Tt),movement_planning:F("movement_planning","Make your moves",void 0,Wt),movement_execution:F("movement_execution","","Start Movement Phase"),game_over:F("game_over","","Pick your origin")};function Gt(e){return()=>{if(!(e.current_phase===E.land_grab.name&&!At(e))){if(e.current_phase===E.movement_execution.name){const{done:t}=e.moves.next();if(!t)return}e.next_turn()}}}function F(e="round_phase",t="",n="End turn",a=(i,s)=>{}){return{name:e,call_to_action:t,end_turn_btn_label:n,handle_click_on_cell:a}}function Pe(e,t,n,a,i,s,o){const l=Xt(e,t),c=l.querySelector(".population-size");let u=null,_=-1,h=0;return{cx:e,cy:t,x:n,y:a,q:i,r:s,s:o,get has_owner(){return _!==-1},neighbors:[],cell:l,elevation:0,humidity:y.arid,temperature:b.freezing,structures:new Map(Object.values(pe).map(m=>[m,0])),pop_size_display:c,resources:{get[r.people](){return h},set[r.people](m){h=m,c.textContent=h>0?h.toString():""},[r.gold]:0,[r.cloth]:0,[r.wood]:0,[r.stone]:0,[r.iron]:0,[r.food]:0,[r.alcohol]:0,[r.coal]:0},get biome(){return u},set biome(m){u!==null&&l.classList.remove(u.name),m!==null&&l.classList.add(m.name),u=m},get owner_id(){return _},set owner_id(m){_=m,l.dataset.owner_id=m===-1?"":m.toString()},developable_land:10}}function Xt(e,t){const n=kt.cloneNode(!0);return n.setAttribute("transform",`translate(${e}, ${t})`),x.prepend(n),n}function Zt(e){return({target:t})=>{if(!(t instanceof Element))return;const n=t.closest(".cell-wrapper");if(n===null)return;const a=x.querySelector(".clicked"),i=e.board.get(n);a&&(a.classList.remove("clicked"),_e.replaceChildren()),a!==n&&n.classList.add("clicked"),E[e.current_phase].handle_click_on_cell(i,e)}}const fe=6,en=fe*.5,tn=fe*.75;function Re(e,t){e.forEach(n=>{t.set(n.cell,n)})}function nn({height:e,width:t}){const n=[];for(let a=0;a<e;a+=1){const i=+!ce(a);for(let s=0;s<t;s+=1){const o=s-(a-(a&1))*.5;n.push(Pe(s*fe+i*en,a*tn,s,a,o,a,-o-a))}}return n}function Te(e,t){const n=nn(t);Ce(n),dt(n),bt(n),vt(n),ft(n),gt(n),Re(n,e)}function rn(e=[],t){const n=e.map(({cx:a,cy:i,x:s,y:o,q:l,r:c,s:u,biome_name:_,elevation:h,humidity:m,temperature:d,owner_id:p,resources:I})=>{const z=Pe(a,i,s,o,l,c,u);return Object.assign(z,{biome:f[_],elevation:h,humidity:m,resources:Object.assign(z.resources,I),temperature:d,owner_id:p})});Ce(n),n.filter(a=>a.elevation===0&&a.neighbors.some(i=>i.elevation>0)).forEach(a=>a.cell.classList.add("shore")),Re(n,t)}function he(e,t){e.clear(),x.replaceChildren(x.lastElementChild),Te(e,t)}const ye=new Map;function on(){localStorage.setItem(B.board,JSON.stringify([...ye.values()].map(({cx:e,cy:t,x:n,y:a,q:i,r:s,s:o,biome:{name:l},elevation:c,humidity:u,temperature:_,owner_id:h,resources:m})=>({cx:e,cy:t,x:n,y:a,q:i,r:s,s:o,biome_name:l,elevation:c,humidity:u,temperature:_,owner_id:h,resources:m}))))}function sn(){const e=JSON.parse(localStorage.getItem(B.board));rn(e,ye)}const an={ai:"ai"},q=[],cn=2,ln=5;function un(){D.length!==ln&&je(D.length+1)}function le(e){if(!q.some(a=>a.name===e))return e;const n=/^(?<name>.+)_(?<id>\d+)$/.exec(e);return le(n===null?`${e}_2`:`${n.groups.name}_${(Number(n.groups.id)||0)+1}`)}function dn({target:e}){!(e instanceof Element)||e.closest(".delete-player-btn")===null||D.length===cn||(e.closest(".player-config").remove(),[...D].forEach((t,n)=>{n=n+1,Object.assign(t.querySelector(".player-name-input"),{name:`player-${n}-name`,value:`Player ${n}`}),t.querySelectorAll(".player-type-select-radio").forEach(a=>{a.name=`player-${n}-type`})}))}function ge(e,t="Player Name",n=an.ai,a=[],i=[]){const s=new Set(a),o=Se.cloneNode(!0),l=Se.cloneNode(!0),c=new Map,_=`var(--player-${e+1})`;Ze.append(o),et.append(l),H(s,o,{color:_}),i.forEach(([d,p])=>h(d,p));function h(d,p){if(c.set(d,p),d.cell.classList.contains("contested"))return;if(d.has_owner){d.cell.classList.add("contested");return}const I=q.find(z=>z.id!==e&&z.encampments.has(d));if(I){d.cell.classList.add("contested"),d.pop_size_display.textContent="",I.outline_encampments();return}m(),d.pop_size_display.textContent=p.toString()}function m(){H(new Set([...c.keys()].filter(({cell:d})=>!d.classList.contains("contested"))),l,{color:_,stroked_outline:!0})}return{id:e,name:le(t),type:n,tax_rate:1,get resources(){return[...s].reduce((d,{resources:p})=>(Object.entries(p).forEach(([I,z])=>{d[I]+=z}),d),{[r.people]:0,[r.gold]:0,[r.cloth]:0,[r.wood]:0,[r.stone]:0,[r.iron]:0,[r.food]:0,[r.alcohol]:0,[r.coal]:0})},border_path_container:o,get cells(){return s},add_cell(d){d.owner_id=e,s.add(d),H(s,o,{color:_})},delete_cell(d){s.delete(d),d.owner_id=-1,H(s,o,{color:_})},get encampments(){return c},get_encampment(d){return c.get(d)},add_encampment:h,delete_encampment(d){c.delete(d),m(),d.owner_id===-1&&q.every(p=>!p.encampments.has(d))&&(d.pop_size_display.textContent="")},outline_encampments:m,destroy(){s.clear(),c.clear(),o.remove(),l.remove()}}}function je(e){const t=qt.cloneNode(!0);Object.assign(t.querySelector(".player-name-input"),{name:`player-${e}-name`,value:`Player ${e}`}),t.querySelectorAll(".player-type-select-radio").forEach(n=>{n.name=`player-${e}-type`}),qe.append(t)}function _n(e){const t=JSON.parse(localStorage.getItem(B.players)),n=[...e.board.values()];q.push(...t.map(({name:a,type:i,encampments:s},o)=>ge(o,a,i,n.filter(l=>l.owner_id===o),s.map(({cx:l,cy:c,units:u})=>[n.find(_=>_.cx===l&&_.cy===c),u]))))}function mn(){localStorage.setItem(B.players,JSON.stringify(q.map(({name:e,type:t,encampments:n})=>({name:e,type:t,encampments:[...n.entries()].map(([{cx:a,cy:i},s])=>({cx:a,cy:i,units:s}))}))))}function*pn(e){var t;for(const n in L){const a=$.filter(o=>n===o.season).filter(o=>{const l=hn(o,e);return l||Le(o,$),l});if(a.length===0)continue;const i=new Set,s=new Map;$e.textContent=`Move(s) in ${n}`,Y.textContent="Show next move";for(const o of a)o.origin.cell.classList.add("clicked"),o.arrow.style.display="initial",i.add(o.target),yield"init_move",o.type==="settle"&&s.set(o.target,s.has(o.target)?s.get(o.target).add(o.player_id):new Set([o.player_id])),fn(o,e),Le(o,$),o.origin.cell.classList.remove("clicked");Y.textContent="Make these moves",yield"moves_laid_out";for(const o of i){const l=yn(o,e.players);if(l.length===1){const{player_id:c,units:u}=l[0];(t=s.get(o))!=null&&t.has(c)&&Je(e.players[c],o,u);continue}Y.textContent="Start battle",yield"battle_awaits",gn(o,l,e.players,s.get(o))}}}function Je(e,t,n){e.delete_encampment(t),e.add_cell(t),t.resources[r.people]=n}function fn(e,t){if(e.player_id===e.origin.owner_id)e.origin.resources[r.people]-=e.units;else{const n=t.players[e.player_id],a=n.get_encampment(e.origin)-e.units;a===0?n.delete_encampment(e.origin):n.add_encampment(e.origin,a)}if(e.player_id===e.target.owner_id)e.target.resources[r.people]+=e.units;else{const n=t.players[e.player_id],a=(n.get_encampment(e.target)||0)+e.units;n.add_encampment(e.target,a)}}function hn(e={},t){const n=e.origin.owner_id===e.player_id?e.origin.resources[r.people]-1:t.players[e.player_id].encampments.get(e.origin);return e.units<=n}function Le(e,t=[]){const n=t.findIndex(a=>a===e);n<0||(t[n].arrow.remove(),t.splice(n,1))}function yn(e,t){return t.reduce((n,a,i)=>(a.encampments.has(e)?n.push({player_id:i,units:a.encampments.get(e)}):i===e.owner_id&&n.push({player_id:e.owner_id,units:e.resources[r.people],is_owner:!0}),n),[])}function gn(e,t,n,a){for(;t.length>1;){const l=[],c=new Set;t.forEach((u,_)=>{const h=new Set([_]);let m;t.forEach((d,p)=>{h.has(p)||(h.add(p),m=U(m===void 0?u.units:u.units-m),l.push({target_id:p,attack_strength:m}))})});for(const{target_id:u,attack_strength:_}of l)t[u].units-=_,t[u].units<=0&&c.add(u);if(c.size===t.length){c.forEach(u=>n[t[u].player_id].delete_encampment(e)),t=[Object.assign(Be(t),{units:1})];break}[...c].sort((u,_)=>_-u).forEach(u=>{n[t[u].player_id].delete_encampment(e),t.splice(u,1)})}e.cell.classList.remove("contested");const{player_id:i,units:s}=t[0],o=n[i];if(e.owner_id===i){e.resources[r.people]=s;return}e.has_owner&&(n[e.owner_id].delete_cell(e),e.resources[r.people]=0),a!=null&&a.has(i)?Je(o,e,s):o.add_encampment(e,s)}let X=0,C=E.land_grab.name,R=0,ue=null,Ue;const g={board:ye,get moves(){return Ue},get round(){return X},set round(e){X=e},get active_player(){return q[R]},get players(){return q},set players(e){q.push(...e)},get current_player_id(){return R},set current_player_id(e){R=e},get current_player_total_production(){return ue},clear_players(){q.forEach(e=>e.destroy()),q.length=0},get current_phase(){return C},set current_phase(e){C=e},update_resource_display:De,next_turn(){if(_e.setAttribute("d",""),R===q.length-1){if(R=0,C=Sn(),C===E.development.name){if(X>0){const e=Ln();if(e===null){ut(q);return}C=E.game_over.name,document.body.dataset.current_phase=E.game_over.name,document.getElementById("winner-name").textContent=e.name,O.showModal(),ze.click()}X+=1}}else R+=1;ke()},run:ke};function ke(){switch(Y.textContent=E[C].end_turn_btn_label,$e.textContent=E[C].call_to_action,ae.classList.remove("hidden"),ae.textContent=g.active_player.name,document.body.dataset.current_phase=E[C].name,document.documentElement.style.setProperty("--active-player-color",`var(--player-${R+1}`),ie.classList.add("content-hidden"),C){case E.land_grab.name:V.classList.add("hidden"),te.classList.remove("hidden");break;case E.development.name:ue=oe(g.active_player.cells,g.active_player.tax_rate),Ne(ue,g.active_player.tax_rate),De(),J.classList.add("hidden"),V.classList.add("hidden"),te.classList.add("hidden"),ie.classList.remove("content-hidden");break;case E.movement_execution.name:Ue=pn(g),ae.classList.add("hidden")}}function vn(e){const{round:t,current_phase:n,current_player_id:a}=JSON.parse(e);Object.assign(g,{round:t,current_phase:n,current_player_id:a})}function wn(){const e=localStorage.getItem(B.game),t=e!==null;O.dataset.gameIsRunning=t.toString(),at(),t?(vn(e),sn(),_n(g),Dt(g),g.run()):(Te(g.board,v),O.showModal())}function bn(){document.visibilityState==="hidden"&&(g.players.length===0||g.current_phase===E.game_over.name?En():(kn(),mn(),Ft(),on(),it()))}function En(){Object.values(B).forEach(e=>localStorage.removeItem(e))}function Sn(){switch(C){case E.development.name:return E.movement_planning.name;case E.movement_planning.name:return E.movement_execution.name;default:case E.movement_execution.name:return E.development.name}}function Ln(){const e=q.filter(({cells:t,encampments:n})=>n.size>0||t.size>0);return e.length===1?e[0]:null}function kn(){localStorage.setItem(B.game,JSON.stringify({round:g.round,current_phase:g.current_phase,current_player_id:g.current_player_id}))}function De(){ie.replaceChildren(...Object.entries(g.active_player.resources).map(([e,t])=>Object.assign(document.createElement("div"),{title:e,innerHTML:`<svg class="icon"><use href="#${e}"></use></svg>
                        <span>${t}</span>`})))}function $n({target:e}){if(!(e instanceof Element))return;const t=e.closest("button");if(t===null)return;const n=Number(x.dataset.zoom_level);if(t.id==="zoom-in"){if(n===3)return;x.dataset.zoom_level=(n+1).toString()}else{if(n===-1)return;x.dataset.zoom_level=(n-1).toString()}}function qn(){g.players.length===0&&(g.players=Array.from({length:2},(e,t)=>ge(t,`Player ${t+1}`,"human"))),O.classList.remove("game-config"),g.run()}function In({submitter:e}){if(e.id==="continue-btn"){if(O.dataset.gameIsRunning!=="true")return;O.close();return}if(e.id==="new-game-btn"){if(O.dataset.gameIsRunning==="true"||g.current_phase===E.game_over.name){Object.assign(g,{round:0,current_phase:E.land_grab.name,current_player_id:0}),he(g.board,v),Jt(),g.clear_players();for(const t of[...D])t.remove()}Array.from({length:2},(t,n)=>je(n+1)),O.classList.add("game-config")}}function On(){O.dataset.gameIsRunning=(g.current_phase!==E.game_over.name&&g.players.length>0).toString(),O.showModal()}function zn(){Array.from(D,(e,t)=>{const n=e.querySelector(".player-name-input").value,a=e.querySelector(".player-type-select-radio:checked").value;g.players.push(ge(t,n,a))}),O.close()}window.addEventListener("DOMContentLoaded",wn,{once:!0});document.addEventListener("visibilitychange",bn);document.addEventListener("submit",ot);tt.addEventListener("click",$n);W.addEventListener("change",st(g,he));ne.addEventListener("input",()=>{Oe.value=ne.value});ze.addEventListener("click",On);Ve.addEventListener("submit",In);Ye.addEventListener("submit",zn);O.addEventListener("close",qn);Ke.addEventListener("click",()=>he(g.board,v));We.addEventListener("click",un);Y.addEventListener("click",Gt(g));qe.addEventListener("click",dn);x.addEventListener("click",Zt(g));Qe.addEventListener("input",({target:e})=>{e instanceof HTMLInputElement&&e.name==="tax_rate"&&(g.active_player.tax_rate=Number(e.value))});N.addEventListener("close",Vt(g));N.addEventListener("submit",()=>N.close());
