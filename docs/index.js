(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const c of a.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&o(c)}).observe(document,{childList:!0,subtree:!0});function r(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerPolicy&&(a.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?a.credentials="include":s.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function o(s){if(s.ep)return;s.ep=!0;const a=r(s);fetch(s.href,a)}})();const Oe=""+new URL("service-worker.js",import.meta.url).href;window.navigator.serviceWorker.register(Oe).catch(console.error);let F;x(),document.addEventListener("visibilitychange",()=>{document.hidden?Be():x()});async function x(){var e,t;F=await((t=(e=navigator.wakeLock)==null?void 0:e.request)==null?void 0:t.call(e,"screen"))}async function Be(){F&&(await F.release(),F=void 0)}const w={width:30,height:24};function K(e){return e%2===0}function Ce(e,t,r){return e>=t&&e<=r}function Me(e,t=0,r=e.length){return e[J(r,t)]}function J(e,t=0){return Math.trunc(Math.random()*(e-t)+t)}function oe(e){return Object.freeze(Object.assign(Object.create(null),e))}function ae(e){e.preventDefault()}function se(e){e.forEach(t=>{t.neighbors=Ne(t,e,w)})}function Ne({q:e,r:t,s:r,x:o,y:s},a,c){const u=[{q:1,r:0,s:-1},{q:1,r:-1,s:0},{q:0,r:1,s:-1},{q:0,r:-1,s:1},{q:-1,r:0,s:1},{q:-1,r:1,s:0}].map(i=>a.find(y=>y.q===e+i.q&&y.r===t+i.r&&y.s===r+i.s)).filter(Boolean);return o===0&&(u.push(a.find(i=>s===i.y&&i.x===c.width-1)),K(s)&&u.push(...[s<c.height-1?a.find(i=>s+1===i.y&&i.x===c.width-1):null,s>0?a.find(i=>s-1===i.y&&i.x===c.width-1):null].filter(Boolean))),o===c.width-1&&(u.push(a.find(i=>s===i.y&&i.x===0)),K(s)||u.push(...[s<c.height-1?a.find(i=>s+1===i.y&&i.x===0):null,s>0?a.find(i=>s-1===i.y&&i.x===0):null].filter(Boolean))),u}const h={freezing:"freezing",cold:"cold",temperate:"temperate",warm:"warm",hot:"hot"};function ce(e){e.forEach(t=>{const r=Math.random(),o=-1,s=Ce(r,.3,.7)?0:1*(-1*+(r<.3)),a=(c=>c<0?0:c>w.height-1?w.height-1:c)(t.y+s+o);t.temperature=ze(a)})}function ze(e){switch(e){case 0:case 1:case w.height-2:case w.height-1:return h.freezing;case 2:case 3:case w.height-4:case w.height-3:return h.cold;case 4:case 5:case w.height-6:case w.height-5:return h.temperate;case 6:case 7:case 8:case w.height-9:case w.height-8:case w.height-7:return h.warm;default:return h.hot}}function Ae(e){switch(e){case h.hot:return h.warm;case h.warm:return h.temperate;case h.temperate:return h.cold;default:return h.freezing}}function Pe(e){switch(e){case h.freezing:return h.cold;case h.cold:return h.temperate;case h.temperate:return h.warm;default:return h.hot}}const ee=new Set([0,1,2,w.height-1,w.height-2,w.height-3]);function ie(e){const o=e.length/2.5;let s=0;for(;s<o;){const a=J(13,4),c={x:J(w.width),y:J(w.height-3,3)},l=e.find(({x:y,y:v})=>y===c.x&&v===c.y),u=new Set(l.neighbors.filter(({y})=>!ee.has(y))),i=new Set;s+=a,te(l),i.add(l);for(let y=0;y<a;y+=1){const v=Me([...u]);te(v),i.add(v),u.delete(v),v.neighbors.filter(p=>!i.has(p)).filter(({y:p})=>!ee.has(p)).forEach(p=>u.add(p))}}e.filter(a=>a.elevation>0).forEach(a=>{const c=a.neighbors.filter(u=>u.elevation>0).length;if(c>=3)return;const l=Math.random();(c===2&&l>.7||c===1&&l<.7)&&Re(a)})}function te(e){e.elevation+=1,e.elevation>1&&(e.temperature=Ae(e.temperature))}function Re(e){e.elevation=Math.max(0,e.elevation-1),e.elevation>0&&(e.temperature=Pe(e.temperature))}const m={arid:"arid",dry:"dry",moderate:"moderate",moist:"moist",wet:"wet"};function Te(e){switch(e){case m.arid:return m.dry;case m.dry:return m.moderate;case m.moderate:return m.moist;default:return m.wet}}function le(e){e.filter(t=>t.elevation>0).forEach(t=>{t.neighbors.filter(({biome:r})=>r===d.sea).forEach(()=>{t.humidity=Te(t.humidity)})})}const n=oe({people:"people",gold:"gold",cloth:"cloth",wood:"wood",stone:"stone",iron:"iron",food:"food",alcohol:"alcohol"}),Ue=oe({[n.people]:5,[n.gold]:5,[n.cloth]:25,[n.wood]:25,[n.stone]:25,[n.iron]:0,[n.food]:50,[n.alcohol]:5});function P(e,t=1){const r={[n.people]:0,[n.gold]:0,[n.cloth]:0,[n.wood]:0,[n.stone]:0,[n.iron]:0,[n.food]:0,[n.alcohol]:0};let o=0;return e.forEach(s=>{o+=s.resources.people,Object.entries(s.biome.resource_production).forEach(([a,c])=>{r[a]+=c}),[...s.structures.entries()].forEach(([a,c])=>{a.output.forEach(({resource_name:l,amount:u})=>{r[l]+=u*c})});for(let a=0;a<Math.floor(s.resources.people/2);a+=1){const c=Math.random();c<.3?r[n.people]+=2:c<.8&&(r[n.people]+=1)}}),r[n.gold]=o*t,r}const d={sea:new E("sea",{[n.food]:1}),mountain:new E("mountain",{[n.wood]:2,[n.stone]:5,[n.food]:3}),high_mountain:new E("high_mountain",{[n.stone]:5}),ice:new E("ice",{[n.food]:2}),tundra:new E("tundra",{[n.cloth]:1,[n.wood]:2,[n.stone]:1,[n.food]:5}),grassland:new E("grassland",{[n.cloth]:3,[n.wood]:2,[n.stone]:2,[n.food]:5}),savanna:new E("savanna",{[n.cloth]:5,[n.wood]:5,[n.stone]:3,[n.food]:6}),boreal_forest:new E("boreal_forest",{[n.cloth]:4,[n.wood]:10,[n.stone]:3,[n.food]:5}),forest:new E("forest",{[n.cloth]:2,[n.wood]:10,[n.stone]:2,[n.food]:5}),tropical_rainforest:new E("tropical_rainforest",{[n.cloth]:3,[n.wood]:7,[n.stone]:1,[n.food]:5}),cold_swamp:new E("cold_swamp",{[n.cloth]:1,[n.wood]:2,[n.stone]:1,[n.food]:2}),swamp:new E("swamp",{[n.cloth]:1,[n.wood]:1,[n.stone]:0,[n.food]:3}),tropical_swamp:new E("tropical_swamp",{[n.cloth]:1,[n.wood]:3,[n.stone]:1,[n.food]:3}),desert:new E("desert",{[n.cloth]:1,[n.wood]:0,[n.stone]:2,[n.food]:1}),extreme_desert:new E("extreme_desert",{[n.cloth]:0,[n.wood]:0,[n.stone]:1,[n.food]:0})},De={[h.freezing]:{[m.arid]:d.tundra,[m.dry]:d.tundra,[m.moderate]:d.tundra,[m.moist]:d.boreal_forest,[m.wet]:d.boreal_forest},[h.cold]:{[m.arid]:d.tundra,[m.dry]:d.tundra,[m.moderate]:d.boreal_forest,[m.moist]:d.boreal_forest,[m.wet]:d.boreal_forest},[h.temperate]:{[m.arid]:d.tundra,[m.dry]:d.forest,[m.moderate]:d.forest,[m.moist]:d.forest,[m.wet]:d.swamp},[h.warm]:{[m.arid]:d.desert,[m.dry]:d.grassland,[m.moderate]:d.savanna,[m.moist]:d.forest,[m.wet]:d.tropical_swamp},[h.hot]:{[m.arid]:d.extreme_desert,[m.dry]:d.desert,[m.moderate]:d.grassland,[m.moist]:d.savanna,[m.wet]:d.tropical_rainforest}};function E(e="",t={},r=1,o=1){return{name:e,resource_production:Object.assign({[n.gold]:0,[n.cloth]:0,[n.wood]:0,[n.stone]:0,[n.iron]:0,[n.food]:0,[n.alcohol]:0},t),movement_speed:r,pleasantness:o}}function de(e){e.forEach(t=>{t.biome=Je(t)})}function ue(e){e.filter(({elevation:t})=>t===0).forEach(t=>{t.biome=Fe(t)})}function Fe(e,t=w.height){const r=Math.random();return[0,t-1].includes(e.y)?r<=.1?d.sea:d.ice:[1,t-2].includes(e.y)?r<=.75?d.sea:d.ice:[2,t-3].includes(e.y)?r<=.9?d.sea:d.ice:d.sea}function Je(e){return e.biome?e.biome:e.elevation>1?e.elevation>2?d.high_mountain:d.mountain:De[e.temperature][e.humidity]}const He=document.getElementById("add-player-btn"),Q=document.getElementById("board"),V=document.getElementById("bottom-bar"),R=document.getElementById("cell-info"),We=document.getElementById("cell-debug-info"),z=document.getElementById("cell-production-forecast"),Ye=document.getElementById("toggle-coord-system-btn"),re=document.getElementById("config-game-form"),me=document.getElementById("defs"),pe=document.getElementById("end-turn-btn"),W=document.getElementById("general-info"),H=document.getElementById("overall-production-forecast"),Ke=document.getElementById("phase-label"),T=document.getElementsByClassName("player-config"),Qe=document.getElementById("player-name"),fe=document.getElementById("player-setup"),Ve=document.getElementById("reroll-map-btn"),Ge=document.getElementById("side-bar");document.getElementById("round-info");const G=document.getElementById("selection-highlight"),Xe=document.getElementById("start-game-form"),k=document.getElementById("start-game-overlay"),_e=document.getElementById("movement-arrows"),U=document.getElementById("troop-select"),Ze=U.querySelector("input"),je=me.querySelector(".cell-wrapper"),ye=document.createElementNS("http://www.w3.org/2000/svg","path"),xe=me.querySelector(".player-border"),et=document.getElementById("player-config-tmpl").content,tt=document.getElementById("structure-builder-tmpl").content,X={tent:C("Tent",[g(n.wood,1),g(n.cloth,3)],[],0,{on(e){e.housing_capacity+=5},off(e){e.housing_capacity-=5}},[]),textile_factory:C("Textile Factory",[g(n.wood,15),g(n.stone,15)],[g(n.cloth,5)]),lumber_mill:C("Lumber Mill",[g(n.wood,15),g(n.stone,15)],[g(n.wood,5)]),quarry:C("Quarry",[g(n.wood,15),g(n.stone,15)],[g(n.stone,5)]),forge:C("Forge",[g(n.wood,5),g(n.stone,5)],[g(n.iron,1)]),farm:C("Farm",[g(n.wood,5),g(n.stone,5)],[g(n.food,5)]),distillery:C("Distillery",[g(n.wood,5),g(n.stone,5)],[g(n.alcohol,1)])};function C(e="Pretty Structure",t=[g(n.wood,5)],r=[g(n.wood,1)],o=1,s={on(u){u.foo+=5},off(u){u.foo-=5}},a=[d.swamp],c=[g(n.wood,1)],l=1){return{display_name:e,construction_cost:t,space_requirement:l,unsupported_biomes:a,effects:s,output:r,input:c,required_workers:o}}function g(e=n.wood,t=1){return{resource_name:e,amount:t}}function he(e,t,r,o,s,a,c){const l=rt(e,t,r,o,s,a,c),u=l.querySelector(".population-size");let i=null,y=-1,v=0;return{cx:e,cy:t,x:r,y:o,q:s,r:a,s:c,neighbors:[],cell:l,elevation:0,humidity:m.arid,temperature:h.freezing,structures:new Map(Object.values(X).map(p=>[p,0])),resources:{get[n.people](){return v},set[n.people](p){v=p,u.textContent=v>0?v:""},[n.gold]:0,[n.cloth]:0,[n.wood]:0,[n.stone]:0,[n.iron]:0,[n.food]:0,[n.alcohol]:0},get biome(){return i},set biome(p){i!==null&&l.classList.remove(i.name),p!==null&&l.classList.add(p.name),i=p},get owner_id(){return y},set owner_id(p){y=p,p!==-1&&(l.dataset.owner_id=p)},developable_land:0}}function rt(e,t,r,o,s,a,c){const l=je.cloneNode(!0);return l.setAttribute("transform",`translate(${e}, ${t})`),l.querySelector(".q-coord").textContent=s,l.querySelector(".r-coord").textContent=a,l.querySelector(".s-coord").textContent=c,l.querySelector(".offset-coords").textContent=`${r}, ${o}`,Q.prepend(l),l}function ge(e){const t=[...e.values()];return t.forEach(r=>Object.assign(r,{biome:null,elevation:0,humidity:m.arid,temperature:h.freezing,resources:Object.keys(r.resources).reduce((o,s)=>(o[s]=0,o),r.resources),owner_id:-1})),ce(t),ie(t),ue(t),le(t),de(t),e}function nt(e,t){const r=e.map(({cx:o,cy:s,x:a,y:c,q:l,r:u,s:i,biome_name:y,elevation:v,humidity:p,temperature:B,owner_id:_,resources:A})=>{const M=he(o,s,a,c,l,u,i);return Object.assign(M,{biome:d[y],elevation:v,humidity:p,temperature:B,owner_id:_}),Object.entries(A).forEach(([ke,Ie])=>{M.resources[ke]=Ie}),M});return se(r),ve(r,t)}function ot(e,t){const r=at(e);return se(r),ce(r),ie(r),ue(r),le(r),de(r),ve(r,t)}function ve(e,t){return e.reduce((r,o)=>(r.set(o.cell,o),r),t)}function at({height:e,width:t}){const r=[];for(let o=0;o<e;o+=1){const s=+!K(o);for(let a=0;a<t;a+=1){const c=a-(o-(o&1))/2;r.push(he(a*6+s*3,o*4.5,a,o,c,o,-c-o))}}return r}const we=.5,I=we*.5;function be(e,t,r){const o=[];e.reduce((a,c)=>{const l=c.neighbors.filter(_=>!e.includes(_)),u=st(c),i=ct(c),y=ut(c),v=lt(c),p=dt(c),B=it(c);return l.find(_=>_.r===c.r&&_.s===c.s+1)&&a.push(`M${v}L${B}`),l.find(_=>_.q===c.q&&_.s===c.s+1)&&a.push(`M${B}L${u}`),l.find(_=>_.s===c.s&&_.r===c.r-1)&&a.push(`M${u}L${p}`),l.find(_=>_.r===c.r&&_.s===c.s-1)&&a.push(`M${p}L${y}`),l.find(_=>_.q===c.q&&_.s===c.s-1)&&a.push(`M${y}L${i}`),l.find(_=>_.s===c.s&&_.r===c.r+1)&&a.push(`M${i}L${v}`),a},o);const s=ye.cloneNode(!0);s.setAttribute("d",o.join("")),s.setAttribute("stroke",t),s.setAttribute("stroke-width",we),r.append(s)}function st(e){return`${e.cx+3} ${e.cy+I}`}function ct(e){return`${e.cx+3} ${e.cy+6-I}`}function it(e){return`${e.cx+I} ${e.cy+1.5+I*.5}`}function lt(e){return`${e.cx+I} ${e.cy+4.5-I*.5}`}function dt(e){return`${e.cx+6-I} ${e.cy+1.5+I*.5}`}function ut(e){return`${e.cx+6-I} ${e.cy+4.5-I*.5}`}const mt={human:"human",ai:"ai"};function Ee(e){const t=et.cloneNode(!0);Object.assign(t.querySelector(".player-name-input"),{name:`player-${e}-name`,value:`Player ${e}`}),t.querySelectorAll(".player-type-select-radio").forEach(r=>{r.name=`player-${e}-type`}),fe.append(t)}function Z(e,t="Player Name",r=mt.ai){const o=[],s=xe.cloneNode(!0);return document.getElementById("player-borders").append(s),{name:t,type:r,get resources(){return o.reduce((a,{resources:c})=>(Object.entries(c).forEach(([l,u])=>{a[l]+=u}),a),{[n.people]:0,[n.gold]:0,[n.cloth]:0,[n.wood]:0,[n.stone]:0,[n.iron]:0,[n.food]:0,[n.alcohol]:0})},border_path_container:s,get cells(){return o},set cells(a){o.push(...a),be(o,`var(--player-${e+1})`,s)},destroy(){o.length=0,s.remove()}}}function Le(e,t){H.querySelector("ul").replaceChildren(...j(e)),H.querySelector("input").value=t,H.classList.remove("hidden")}function pt(e,t){z.querySelector("ul").replaceChildren(...j(e)),z.querySelector("fieldset").replaceChildren(...t),z.classList.remove("hidden")}function ft(e,{wood:t,stone:r,cloth:o,food:s}){const a=Object.values(X).filter(c=>!c.unsupported_biomes.includes(e.biome)).map(({display_name:c})=>`<li>${c}</li>`).join("");R.innerHTML=`
        <h2>Cell Info</h2>
        <div>Biome: ${e.biome.name}</div>
        <div>Movement modifier: ${e.biome.movement_speed}</div>
        <div>Pleasantness: ${e.biome.pleasantness}</div>
        ...
        <h3>Production</h3>
        <div>Wood: ${t}</div>
        <div>Stone: ${r}</div>
        <div>Cloth: ${o}</div>
        <div>Food: ${s}</div>
        <h3>Supported structures</h3>
        <ul>${a}</ul>
    `,R.classList.remove("hidden")}function j(e){return Object.entries(e).map(([t,r])=>Object.assign(document.createElement("li"),{textContent:`${t}: ${r}`}))}function _t(e){return Object.entries(X).filter(([,t])=>!t.unsupported_biomes.includes(e.biome)).map(([t,r])=>{const o=tt.cloneNode(!0).lastElementChild,s=o.querySelector(".label-text"),a=o.querySelector(".structure-count");return o.dataset.structure_name=t,s.textContent=`${r.display_name}: `,a.textContent=e.structures.get(r),o.addEventListener("click",({target:c})=>{const l=c.closest("button");if(l===null)return;const u=l.classList.contains("construct-structure-btn"),i=r.construction_cost;let y=e.structures.get(r);if(u){if(e.developable_land<r.space_requirement||i.some(({resource_name:p,amount:B})=>B>f.active_player.resources[p]))return;y+=1,i.forEach(({resource_name:p,amount:B})=>{let _=B;for(const A of f.active_player.cells){const M=A.resources[p];if(M<_){_-=M,A.resources[p]=0;continue}else A.resources[p]-=_,_=0;if(_===0)break}}),e.developable_land-=r.space_requirement}else{if(y===0)return;y-=1,i.forEach(({resource_name:v,amount:p})=>{e.resources[v]+=p}),e.developable_land+=r.space_requirement}e.structures.set(r,y),a.textContent=y,z.querySelector("ul").replaceChildren(...j(P([e],f.active_player.tax_rate))),f.update_resource_display()}),o})}function yt(e){return({target:t})=>{const r=Number(t.value);t.name==="tax_rate"&&(e.active_player.tax_rate=r)}}const q=[];document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&localStorage.setItem("wargame-planned-moves",JSON.stringify(q.map(e=>e.map(({origin:t,target:r,units:o})=>({origin:{cx:t.cx,cy:t.cy},target:{cx:r.cx,cy:r.cy},units:o})))))});let b=null,N=null;const $={land_grab:D("land_grab","Pick your origin","Confirm choice",e=>{e.owner_id===-1&&e.biome!==d.sea?(b=e,be([...e.neighbors,e],"white",G),W.classList.add("hidden"),ft(e,e.biome.resource_production)):(R.classList.add("hidden"),W.classList.remove("hidden"))}),development:D("development","Distribute your wealth",void 0,(e,t)=>{e.owner_id===t.current_player_id?(b=e,H.classList.add("hidden"),pt(P([e],t.active_player.tax_rate),_t(e))):(z.classList.add("hidden"),Le(P(t.active_player.cells,t.active_player.tax_rate),t.active_player.tax_rate))}),movement_planning:D("movement_planning","Make your moves",void 0,(e,t)=>{if(b===null){const r=q[t.current_player_id].find(({target:o})=>o===e);e.owner_id===t.current_player_id&&e.resources[n.people]>1||(r==null?void 0:r.units)>1?b=e:e.cell.classList.remove("clicked");return}if(b===e){b=null;return}e.neighbors.includes(b)&&(N=e,U.showModal())}),movement_execution:D("movement_execution","See what you have done")};function ht(e){return()=>{const t=Number(Ze.value),r=q[e.current_player_id].findIndex(({origin:o,target:s})=>o===b&&s===N);if(N.cell.classList.remove("clicked"),Number.isNaN(t)||t===0){if(b=null,N=null,r>-1){const[{arrow:o}]=q[e.current_player_id].splice(r,1);o.remove()}return}if(r>-1)q[e.current_player_id][r].units=t;else{const o={origin:b,target:N,units:t},s=Se(o);o.arrow=s,b=null,N=null,q[e.current_player_id].push(o)}}}function Se({origin:e,target:t,units:r}){const o=ye.cloneNode(!0);return o.setAttribute("d",`M${e.cx+3} ${e.cy+3}L${t.cx+3} ${t.cy+3}`),o.setAttribute("stroke","white"),o.setAttribute("marker-end","url(#arrow)"),_e.append(o),o}function gt(e){return()=>{if(e.current_phase===$.land_grab.name){if(b===null)return;Object.entries(Ue).forEach(([t,r])=>{b.resources[t]=r}),b.owner_id=e.current_player_id,e.active_player.cells=[b],b.cell.classList.remove("clicked"),b=null}e.next_turn()}}function D(e="round_phase",t=e,r="End turn",o=(s,a)=>{}){return{name:e,call_to_action:t,end_turn_btn_label:r,handle_click_on_cell:o}}const L=[];let Y=0,O=$.land_grab.name,S=0,$e=null;const f={board:new Map,get round(){return Y},set round(e){Y=e},get active_player(){return L[S]},get players(){return L},set players(e){L.push(...e)},get current_player_id(){return S},set current_player_id(e){S=e},get current_player_total_production(){return $e},clear_players(){L.forEach(e=>e.destroy()),L.length=0},get current_phase(){return O},set current_phase(e){O=e},update_resource_display:qe,next_turn(){G.replaceChildren(),S===L.length-1?(S=0,O=(()=>{switch(O){case $.development.name:return q.length=0,L.forEach(()=>q.push([])),$.movement_planning.name;case $.movement_planning.name:return $.movement_execution.name;default:return Y+=1,$.development.name}})()):S+=1,ne()},run:ne};function ne(){pe.textContent=$[O].end_turn_btn_label,Ke.textContent=$[O].call_to_action,Qe.textContent=L[S].name,document.body.dataset.current_phase=$[O].name,document.documentElement.style.setProperty("--active-player-color",`var(--player-${S+1}`),O===$.land_grab.name&&(R.classList.add("hidden"),W.classList.remove("hidden")),O===$.development.name?(R.classList.add("hidden"),W.classList.add("hidden"),$e=P(L[S].cells,L[S].tax_rate),z.classList.add("hidden"),Le(P(L[S].cells,L[S].tax_rate),L[S].tax_rate),V.classList.remove("content-hidden"),qe()):V.classList.add("content-hidden")}function qe(){V.replaceChildren(...Object.entries(L[S].resources).map(([e,t])=>Object.assign(document.createElement("div"),{textContent:`${e}: ${t}`})))}function vt(){if(f.players.length===0){localStorage.removeItem("wargame-savegame");return}localStorage.setItem("wargame-savegame",JSON.stringify({round:f.round,current_phase:f.current_phase,current_player_id:f.current_player_id,players:f.players.map(({name:e,type:t})=>({name:e,type:t})),board:[...f.board.values()].map(({cx:e,cy:t,x:r,y:o,q:s,r:a,s:c,biome:{name:l},elevation:u,humidity:i,temperature:y,owner_id:v,resources:p})=>({cx:e,cy:t,x:r,y:o,q:s,r:a,s:c,biome_name:l,elevation:u,humidity:i,temperature:y,owner_id:v,resources:p}))}))}function wt(e,t){const r=JSON.parse(t);Object.assign(e,{round:r.round,current_phase:r.current_phase,current_player_id:r.current_player_id,players:r.players.map(({name:o,type:s},a)=>Z(a,o,s)),board:nt(r.board,e.board)}),e.players.forEach((o,s)=>{o.cells=[...e.board.values()].filter(a=>a.owner_id===s)})}window.addEventListener("DOMContentLoaded",()=>{const e=localStorage.getItem("wargame-savegame"),t=e!==null;k.dataset.priorSave=t,k.showModal(),t?wt(f,e):f.board=ot(w,f.board);const r=JSON.parse(localStorage.getItem("wargame-planned-moves")),o=[...f.board.values()];r.forEach(s=>{q.push(s.map(({origin:a,target:c,units:l})=>({origin:o.find(({cx:u,cy:i})=>u===a.cx&&i===a.cy),target:o.find(({cx:u,cy:i})=>u===c.cx&&i===c.cy),units:l})))}),q.forEach(s=>s.forEach(a=>{a.arrow=Se(a)}))},{once:!0});document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&vt()});k.addEventListener("cancel",ae);document.addEventListener("submit",ae);Xe.addEventListener("submit",e=>{e.submitter.id==="continue-btn"?k.dataset.priorSave==="true"&&k.close():e.submitter.id==="new-game-btn"&&(k.dataset.priorSave==="true"&&(Object.assign(f,{round:0,current_phase:$.land_grab.name,current_player_id:0}),f.board=ge(f.board),f.clear_players(),q.length=0,_e.replaceChildren()),Array.from({length:2},(t,r)=>Ee(r+1)),k.classList.add("game-config"))});k.addEventListener("close",()=>{k.dataset.priorSave==="false"&&f.players.length===0&&(f.players=Array.from({length:2},(e,t)=>Z(t,`Player ${t+1}`,"human"))),f.run()});Ve.addEventListener("click",()=>{f.board=ge(f.board)});pe.addEventListener("click",gt(f));re.addEventListener("submit",()=>{const e=new Set,t=[...re.querySelectorAll(".player-name-input")];if(t.reduce((r,{value:o})=>(r[o]=o in r?r[o]+1:1,r[o]>1&&e.add(o),r),{}),e.size>0){t.forEach(r=>{e.has(r.value)&&r.classList.add("invalid")});return}f.players=Array.from(T,(r,o)=>{const s=r.querySelector(".player-name-input").value,a=r.querySelector(".player-type-select-radio:checked").value;return Z(o,s,a)}),k.close()});He.addEventListener("click",()=>{T.length!==5&&Ee(T.length+1)});fe.addEventListener("click",({target:e})=>{e.closest(".delete-player-btn")&&T.length!==2&&(e.closest(".player-config").remove(),[...T].forEach((t,r)=>{r=r+1,Object.assign(t.querySelector(".player-name-input"),{name:`player-${r}-name`,value:`Player ${r}`}),t.querySelectorAll(".player-type-select-radio").forEach(o=>{o.name=`player-${r}-type`})}))});Q.addEventListener("click",({target:e})=>{const t=e.closest(".cell-wrapper");if(!t)return;const r=Q.querySelector(".clicked"),o=f.board.get(t);r&&(r.classList.remove("clicked"),G.replaceChildren(),r===t)||(t.classList.add("clicked"),bt(o),$[f.current_phase].handle_click_on_cell(o,f))});Ge.addEventListener("input",yt(f));U.addEventListener("close",ht(f));U.addEventListener("submit",()=>{U.close()});document.querySelector("h1").addEventListener("dblclick",()=>{document.body.classList.toggle("debug")});Ye.addEventListener("click",()=>{document.body.classList.toggle("use-offset-coords")});function bt(e){We.textContent=JSON.stringify(e,(t,r)=>t==="neighbors"?void 0:r,4)}
