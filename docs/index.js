(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))o(a);new MutationObserver(a=>{for(const s of a)if(s.type==="childList")for(const i of s.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&o(i)}).observe(document,{childList:!0,subtree:!0});function r(a){const s={};return a.integrity&&(s.integrity=a.integrity),a.referrerPolicy&&(s.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?s.credentials="include":a.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(a){if(a.ep)return;a.ep=!0;const s=r(a);fetch(a.href,s)}})();const Ie=""+new URL("service-worker.js",import.meta.url).href;window.navigator.serviceWorker.register(Ie).catch(console.error);let D;ee(),document.addEventListener("visibilitychange",()=>{document.hidden?Oe():ee()});async function ee(){var e,t;D=await((t=(e=navigator.wakeLock)==null?void 0:e.request)==null?void 0:t.call(e,"screen"))}async function Oe(){D&&(await D.release(),D=void 0)}const b={width:30,height:24};function Y(e){return e%2===0}function Be(e,t,r){return e>=t&&e<=r}function Ce(e,t=0,r=e.length){return e[F(r,t)]}function F(e,t=0){return Math.trunc(Math.random()*(e-t)+t)}function se(e){return Object.freeze(Object.assign(Object.create(null),e))}function ae(e){e.preventDefault()}function ie(e){e.forEach(t=>{t.neighbors=Me(t,e,b)})}function Me({q:e,r:t,s:r,x:o,y:a},s,i){const d=[{q:1,r:0,s:-1},{q:1,r:-1,s:0},{q:0,r:1,s:-1},{q:0,r:-1,s:1},{q:-1,r:0,s:1},{q:-1,r:1,s:0}].map(l=>s.find(y=>y.q===e+l.q&&y.r===t+l.r&&y.s===r+l.s)).filter(Boolean);return o===0&&(d.push(s.find(l=>a===l.y&&l.x===i.width-1)),Y(a)&&d.push(...[a<i.height-1?s.find(l=>a+1===l.y&&l.x===i.width-1):null,a>0?s.find(l=>a-1===l.y&&l.x===i.width-1):null].filter(Boolean))),o===i.width-1&&(d.push(s.find(l=>a===l.y&&l.x===0)),Y(a)||d.push(...[a<i.height-1?s.find(l=>a+1===l.y&&l.x===0):null,a>0?s.find(l=>a-1===l.y&&l.x===0):null].filter(Boolean))),d}const h={freezing:"freezing",cold:"cold",temperate:"temperate",warm:"warm",hot:"hot"};function ce(e){e.forEach(t=>{const r=Math.random(),o=-1,a=Be(r,.3,.7)?0:1*(-1*+(r<.3)),s=(i=>i<0?0:i>b.height-1?b.height-1:i)(t.y+a+o);t.temperature=Ne(s)})}function Ne(e){switch(e){case 0:case 1:case b.height-2:case b.height-1:return h.freezing;case 2:case 3:case b.height-4:case b.height-3:return h.cold;case 4:case 5:case b.height-6:case b.height-5:return h.temperate;case 6:case 7:case 8:case b.height-9:case b.height-8:case b.height-7:return h.warm;default:return h.hot}}function ze(e){switch(e){case h.hot:return h.warm;case h.warm:return h.temperate;case h.temperate:return h.cold;default:return h.freezing}}function Ae(e){switch(e){case h.freezing:return h.cold;case h.cold:return h.temperate;case h.temperate:return h.warm;default:return h.hot}}const te=new Set([0,1,2,b.height-1,b.height-2,b.height-3]);function le(e){const o=e.length/2.5;let a=0;for(;a<o;){const s=F(13,4),i={x:F(b.width),y:F(b.height-3,3)},c=e.find(({x:y,y:v})=>y===i.x&&v===i.y),d=new Set(c.neighbors.filter(({y})=>!te.has(y))),l=new Set;a+=s,re(c),l.add(c);for(let y=0;y<s;y+=1){const v=Ce([...d]);re(v),l.add(v),d.delete(v),v.neighbors.filter(p=>!l.has(p)).filter(({y:p})=>!te.has(p)).forEach(p=>d.add(p))}}e.filter(s=>s.elevation>0).forEach(s=>{const i=s.neighbors.filter(d=>d.elevation>0).length;if(i>=3)return;const c=Math.random();(i===2&&c>.7||i===1&&c<.7)&&Pe(s)})}function re(e){e.elevation+=1,e.elevation>1&&(e.temperature=ze(e.temperature))}function Pe(e){e.elevation=Math.max(0,e.elevation-1),e.elevation>0&&(e.temperature=Ae(e.temperature))}const m={arid:"arid",dry:"dry",moderate:"moderate",moist:"moist",wet:"wet"};function xe(e){switch(e){case m.arid:return m.dry;case m.dry:return m.moderate;case m.moderate:return m.moist;default:return m.wet}}function de(e){e.filter(t=>t.elevation>0).forEach(t=>{t.neighbors.filter(({biome:r})=>r===u.sea).forEach(()=>{t.humidity=xe(t.humidity)})})}const n=se({people:"people",gold:"gold",cloth:"cloth",wood:"wood",stone:"stone",iron:"iron",food:"food",alcohol:"alcohol"}),Re=se({[n.people]:5,[n.gold]:5,[n.cloth]:25,[n.wood]:25,[n.stone]:25,[n.iron]:0,[n.food]:50,[n.alcohol]:5});function P(e,t=1){const r={[n.people]:0,[n.gold]:0,[n.cloth]:0,[n.wood]:0,[n.stone]:0,[n.iron]:0,[n.food]:0,[n.alcohol]:0};let o=0;return e.forEach(a=>{o+=a.resources.people,Object.entries(a.biome.resource_production).forEach(([s,i])=>{r[s]+=i}),[...a.structures.entries()].forEach(([s,i])=>{s.output.forEach(({resource_name:c,amount:d})=>{r[c]+=d*i})});for(let s=0;s<Math.floor(a.resources.people/2);s+=1){const i=Math.random();i<.3?r[n.people]+=2:i<.8&&(r[n.people]+=1)}}),r[n.gold]=o*t,r}const u={sea:new E("sea",{[n.food]:1}),mountain:new E("mountain",{[n.wood]:2,[n.stone]:5,[n.food]:3}),high_mountain:new E("high_mountain",{[n.stone]:5}),ice:new E("ice",{[n.food]:2}),tundra:new E("tundra",{[n.cloth]:1,[n.wood]:2,[n.stone]:1,[n.food]:5}),grassland:new E("grassland",{[n.cloth]:3,[n.wood]:2,[n.stone]:2,[n.food]:5}),savanna:new E("savanna",{[n.cloth]:5,[n.wood]:5,[n.stone]:3,[n.food]:6}),boreal_forest:new E("boreal_forest",{[n.cloth]:4,[n.wood]:10,[n.stone]:3,[n.food]:5}),forest:new E("forest",{[n.cloth]:2,[n.wood]:10,[n.stone]:2,[n.food]:5}),tropical_rainforest:new E("tropical_rainforest",{[n.cloth]:3,[n.wood]:7,[n.stone]:1,[n.food]:5}),cold_swamp:new E("cold_swamp",{[n.cloth]:1,[n.wood]:2,[n.stone]:1,[n.food]:2}),swamp:new E("swamp",{[n.cloth]:1,[n.wood]:1,[n.stone]:0,[n.food]:3}),tropical_swamp:new E("tropical_swamp",{[n.cloth]:1,[n.wood]:3,[n.stone]:1,[n.food]:3}),desert:new E("desert",{[n.cloth]:1,[n.wood]:0,[n.stone]:2,[n.food]:1}),extreme_desert:new E("extreme_desert",{[n.cloth]:0,[n.wood]:0,[n.stone]:1,[n.food]:0})},Te={[h.freezing]:{[m.arid]:u.tundra,[m.dry]:u.tundra,[m.moderate]:u.tundra,[m.moist]:u.boreal_forest,[m.wet]:u.boreal_forest},[h.cold]:{[m.arid]:u.tundra,[m.dry]:u.tundra,[m.moderate]:u.boreal_forest,[m.moist]:u.boreal_forest,[m.wet]:u.boreal_forest},[h.temperate]:{[m.arid]:u.tundra,[m.dry]:u.forest,[m.moderate]:u.forest,[m.moist]:u.forest,[m.wet]:u.swamp},[h.warm]:{[m.arid]:u.desert,[m.dry]:u.grassland,[m.moderate]:u.savanna,[m.moist]:u.forest,[m.wet]:u.tropical_swamp},[h.hot]:{[m.arid]:u.extreme_desert,[m.dry]:u.desert,[m.moderate]:u.grassland,[m.moist]:u.savanna,[m.wet]:u.tropical_rainforest}};function E(e="",t={},r=1,o=1){return{name:e,resource_production:Object.assign({[n.gold]:0,[n.cloth]:0,[n.wood]:0,[n.stone]:0,[n.iron]:0,[n.food]:0,[n.alcohol]:0},t),movement_speed:r,pleasantness:o}}function ue(e){e.forEach(t=>{t.biome=De(t)})}function me(e){e.filter(({elevation:t})=>t===0).forEach(t=>{t.biome=Ue(t)})}function Ue(e,t=b.height){const r=Math.random();return[0,t-1].includes(e.y)?r<=.1?u.sea:u.ice:[1,t-2].includes(e.y)?r<=.75?u.sea:u.ice:[2,t-3].includes(e.y)?r<=.9?u.sea:u.ice:u.sea}function De(e){return e.biome?e.biome:e.elevation>1?e.elevation>2?u.high_mountain:u.mountain:Te[e.temperature][e.humidity]}const Fe=document.getElementById("add-player-btn"),K=document.getElementById("board"),Q=document.getElementById("bottom-bar"),x=document.getElementById("cell-info"),Je=document.getElementById("cell-debug-info"),z=document.getElementById("cell-production-forecast"),He=document.getElementById("toggle-coord-system-btn"),ne=document.getElementById("config-game-form"),V=document.getElementById("defs"),pe=document.getElementById("end-turn-btn"),H=document.getElementById("general-info"),J=document.getElementById("overall-production-forecast"),We=document.getElementById("phase-label"),R=document.getElementsByClassName("player-config"),Ye=document.getElementById("player-name"),_e=document.getElementById("player-setup"),Ke=document.getElementById("reroll-map-btn"),Qe=document.getElementById("side-bar");document.getElementById("round-info");const G=document.getElementById("selection-highlight"),Ve=document.getElementById("start-game-form"),k=document.getElementById("start-game-overlay"),fe=document.getElementById("movement-arrows"),T=document.getElementById("troop-select"),Ge=T.querySelector("input"),Xe=V.querySelector(".cell-wrapper"),Ze=V.querySelector(".movement-indicator"),je=document.createElementNS("http://www.w3.org/2000/svg","path"),et=V.querySelector(".player-border"),tt=document.getElementById("player-config-tmpl").content,rt=document.getElementById("structure-builder-tmpl").content,X={tent:C("Tent",[g(n.wood,1),g(n.cloth,3)],[],0,{on(e){e.housing_capacity+=5},off(e){e.housing_capacity-=5}},[]),textile_factory:C("Textile Factory",[g(n.wood,15),g(n.stone,15)],[g(n.cloth,5)]),lumber_mill:C("Lumber Mill",[g(n.wood,15),g(n.stone,15)],[g(n.wood,5)]),quarry:C("Quarry",[g(n.wood,15),g(n.stone,15)],[g(n.stone,5)]),forge:C("Forge",[g(n.wood,5),g(n.stone,5)],[g(n.iron,1)]),farm:C("Farm",[g(n.wood,5),g(n.stone,5)],[g(n.food,5)]),distillery:C("Distillery",[g(n.wood,5),g(n.stone,5)],[g(n.alcohol,1)])};function C(e="Pretty Structure",t=[g(n.wood,5)],r=[g(n.wood,1)],o=1,a={on(d){d.foo+=5},off(d){d.foo-=5}},s=[u.swamp],i=[g(n.wood,1)],c=1){return{display_name:e,construction_cost:t,space_requirement:c,unsupported_biomes:s,effects:a,output:r,input:i,required_workers:o}}function g(e=n.wood,t=1){return{resource_name:e,amount:t}}function ye(e,t,r,o,a,s,i){const c=nt(e,t,r,o,a,s,i),d=c.querySelector(".population-size");let l=null,y=-1,v=0;return{cx:e,cy:t,x:r,y:o,q:a,r:s,s:i,neighbors:[],cell:c,elevation:0,humidity:m.arid,temperature:h.freezing,structures:new Map(Object.values(X).map(p=>[p,0])),resources:{get[n.people](){return v},set[n.people](p){v=p,d.textContent=v>0?v:""},[n.gold]:0,[n.cloth]:0,[n.wood]:0,[n.stone]:0,[n.iron]:0,[n.food]:0,[n.alcohol]:0},get biome(){return l},set biome(p){l!==null&&c.classList.remove(l.name),p!==null&&c.classList.add(p.name),l=p},get owner_id(){return y},set owner_id(p){y=p,p!==-1&&(c.dataset.owner_id=p)},developable_land:0}}function nt(e,t,r,o,a,s,i){const c=Xe.cloneNode(!0);return c.setAttribute("transform",`translate(${e}, ${t})`),c.querySelector(".q-coord").textContent=a,c.querySelector(".r-coord").textContent=s,c.querySelector(".s-coord").textContent=i,c.querySelector(".offset-coords").textContent=`${r}, ${o}`,K.prepend(c),c}function he(e){const t=[...e.values()];return t.forEach(r=>Object.assign(r,{biome:null,elevation:0,humidity:m.arid,temperature:h.freezing,resources:Object.keys(r.resources).reduce((o,a)=>(o[a]=0,o),r.resources),owner_id:-1})),ce(t),le(t),me(t),de(t),ue(t),e}function ot(e,t){const r=e.map(({cx:o,cy:a,x:s,y:i,q:c,r:d,s:l,biome_name:y,elevation:v,humidity:p,temperature:B,owner_id:f,resources:A})=>{const M=ye(o,a,s,i,c,d,l);return Object.assign(M,{biome:u[y],elevation:v,humidity:p,temperature:B,owner_id:f}),Object.entries(A).forEach(([qe,ke])=>{M.resources[qe]=ke}),M});return ie(r),ge(r,t)}function st(e,t){const r=at(e);return ie(r),ce(r),le(r),me(r),de(r),ue(r),ge(r,t)}function ge(e,t){return e.reduce((r,o)=>(r.set(o.cell,o),r),t)}function at({height:e,width:t}){const r=[];for(let o=0;o<e;o+=1){const a=+!Y(o);for(let s=0;s<t;s+=1){const i=s-(o-(o&1))/2;r.push(ye(s*6+a*3,o*4.5,s,o,i,o,-i-o))}}return r}const ve=.5,I=ve*.5;function be(e,t,r){const o=[];e.reduce((s,i)=>{const c=i.neighbors.filter(f=>!e.includes(f)),d=it(i),l=ct(i),y=mt(i),v=dt(i),p=ut(i),B=lt(i);return c.find(f=>f.r===i.r&&f.s===i.s+1)&&s.push(`M${v}L${B}`),c.find(f=>f.q===i.q&&f.s===i.s+1)&&s.push(`M${B}L${d}`),c.find(f=>f.s===i.s&&f.r===i.r-1)&&s.push(`M${d}L${p}`),c.find(f=>f.r===i.r&&f.s===i.s-1)&&s.push(`M${p}L${y}`),c.find(f=>f.q===i.q&&f.s===i.s-1)&&s.push(`M${y}L${l}`),c.find(f=>f.s===i.s&&f.r===i.r+1)&&s.push(`M${l}L${v}`),s},o);const a=je.cloneNode(!0);a.setAttribute("d",o.join("")),a.setAttribute("stroke",t),a.setAttribute("stroke-width",ve),r.append(a)}function it(e){return`${e.cx+3} ${e.cy+I}`}function ct(e){return`${e.cx+3} ${e.cy+6-I}`}function lt(e){return`${e.cx+I} ${e.cy+1.5+I*.5}`}function dt(e){return`${e.cx+I} ${e.cy+4.5-I*.5}`}function ut(e){return`${e.cx+6-I} ${e.cy+1.5+I*.5}`}function mt(e){return`${e.cx+6-I} ${e.cy+4.5-I*.5}`}const pt={human:"human",ai:"ai"};function we(e){const t=tt.cloneNode(!0);Object.assign(t.querySelector(".player-name-input"),{name:`player-${e}-name`,value:`Player ${e}`}),t.querySelectorAll(".player-type-select-radio").forEach(r=>{r.name=`player-${e}-type`}),_e.append(t)}function Z(e,t="Player Name",r=pt.ai){const o=[],a=et.cloneNode(!0);return document.getElementById("player-borders").append(a),{name:t,type:r,get resources(){return o.reduce((s,{resources:i})=>(Object.entries(i).forEach(([c,d])=>{s[c]+=d}),s),{[n.people]:0,[n.gold]:0,[n.cloth]:0,[n.wood]:0,[n.stone]:0,[n.iron]:0,[n.food]:0,[n.alcohol]:0})},border_path_container:a,get cells(){return o},set cells(s){o.push(...s),be(o,`var(--player-${e+1})`,a)},destroy(){o.length=0,a.remove()}}}function Ee(e,t){J.querySelector("ul").replaceChildren(...j(e)),J.querySelector("input").value=t,J.classList.remove("hidden")}function _t(e,t){z.querySelector("ul").replaceChildren(...j(e)),z.querySelector("fieldset").replaceChildren(...t),z.classList.remove("hidden")}function ft(e,{wood:t,stone:r,cloth:o,food:a}){const s=Object.values(X).filter(i=>!i.unsupported_biomes.includes(e.biome)).map(({display_name:i})=>`<li>${i}</li>`).join("");x.innerHTML=`
        <h2>Cell Info</h2>
        <div>Biome: ${e.biome.name}</div>
        <div>Movement modifier: ${e.biome.movement_speed}</div>
        <div>Pleasantness: ${e.biome.pleasantness}</div>
        ...
        <h3>Production</h3>
        <div>Wood: ${t}</div>
        <div>Stone: ${r}</div>
        <div>Cloth: ${o}</div>
        <div>Food: ${a}</div>
        <h3>Supported structures</h3>
        <ul>${s}</ul>
    `,x.classList.remove("hidden")}function j(e){return Object.entries(e).map(([t,r])=>Object.assign(document.createElement("li"),{textContent:`${t}: ${r}`}))}function yt(e){return Object.entries(X).filter(([,t])=>!t.unsupported_biomes.includes(e.biome)).map(([t,r])=>{const o=rt.cloneNode(!0).lastElementChild,a=o.querySelector(".label-text"),s=o.querySelector(".structure-count");return o.dataset.structure_name=t,a.textContent=`${r.display_name}: `,s.textContent=e.structures.get(r),o.addEventListener("click",({target:i})=>{const c=i.closest("button");if(c===null)return;const d=c.classList.contains("construct-structure-btn"),l=r.construction_cost;let y=e.structures.get(r);if(d){if(e.developable_land<r.space_requirement||l.some(({resource_name:p,amount:B})=>B>_.active_player.resources[p]))return;y+=1,l.forEach(({resource_name:p,amount:B})=>{let f=B;for(const A of _.active_player.cells){const M=A.resources[p];if(M<f){f-=M,A.resources[p]=0;continue}else A.resources[p]-=f,f=0;if(f===0)break}}),e.developable_land-=r.space_requirement}else{if(y===0)return;y-=1,l.forEach(({resource_name:v,amount:p})=>{e.resources[v]+=p}),e.developable_land+=r.space_requirement}e.structures.set(r,y),s.textContent=y,z.querySelector("ul").replaceChildren(...j(P([e],_.active_player.tax_rate))),_.update_resource_display()}),o})}function ht(e){return({target:t})=>{const r=Number(t.value);t.name==="tax_rate"&&(e.active_player.tax_rate=r)}}const q=[];document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&localStorage.setItem("wargame-planned-moves",JSON.stringify(q.map(e=>e.map(({origin:t,target:r,units:o})=>({origin:{cx:t.cx,cy:t.cy},target:{cx:r.cx,cy:r.cy},units:o})))))});let w=null,N=null;const $={land_grab:U("land_grab","Pick your origin","Confirm choice",e=>{e.owner_id===-1&&e.biome!==u.sea?(w=e,be([...e.neighbors,e],"white",G),H.classList.add("hidden"),ft(e,e.biome.resource_production)):(x.classList.add("hidden"),H.classList.remove("hidden"))}),development:U("development","Distribute your wealth",void 0,(e,t)=>{e.owner_id===t.current_player_id?(w=e,J.classList.add("hidden"),_t(P([e],t.active_player.tax_rate),yt(e))):(z.classList.add("hidden"),Ee(P(t.active_player.cells,t.active_player.tax_rate),t.active_player.tax_rate))}),movement_planning:U("movement_planning","Make your moves",void 0,(e,t)=>{if(w===null){const r=q[t.current_player_id].find(({target:o})=>o===e);e.owner_id===t.current_player_id&&e.resources[n.people]>1||(r==null?void 0:r.units)>1?w=e:e.cell.classList.remove("clicked");return}if(w===e){w=null;return}e.neighbors.includes(w)&&(N=e,T.showModal())}),movement_execution:U("movement_execution","See what you have done")};function gt(e){return()=>{const t=Number(Ge.value),r=q[e.current_player_id].findIndex(({origin:o,target:a})=>o===w&&a===N);if(N.cell.classList.remove("clicked"),Number.isNaN(t)||t===0){if(w=null,N=null,r>-1){const[{arrow:o}]=q[e.current_player_id].splice(r,1);o.remove()}return}if(r>-1)q[e.current_player_id][r].units=t;else{const o={origin:w,target:N,units:t},a=Le(o);o.arrow=a,w=null,N=null,q[e.current_player_id].push(o)}}}function Le({origin:e,target:t,units:r}){const a={x:e.cx+3,y:e.cy+3},s={x:t.cx+3,y:t.cy+3},i={x:(s.x+a.x)*.5,y:(s.y+a.y)*.5},c=Ze.cloneNode(!0),d=c.lastElementChild;return c.firstElementChild.setAttribute("d",`M${a.x} ${a.y}L${s.x} ${s.y}`),d.textContent=r,d.setAttribute("x",i.x),d.setAttribute("y",i.y),fe.append(c),c}function vt(e){return()=>{if(e.current_phase===$.land_grab.name){if(w===null)return;Object.entries(Re).forEach(([t,r])=>{w.resources[t]=r}),w.owner_id=e.current_player_id,e.active_player.cells=[w],w.cell.classList.remove("clicked"),w=null}e.next_turn()}}function U(e="round_phase",t=e,r="End turn",o=(a,s)=>{}){return{name:e,call_to_action:t,end_turn_btn_label:r,handle_click_on_cell:o}}const L=[];let W=0,O=$.land_grab.name,S=0,Se=null;const _={board:new Map,get round(){return W},set round(e){W=e},get active_player(){return L[S]},get players(){return L},set players(e){L.push(...e)},get current_player_id(){return S},set current_player_id(e){S=e},get current_player_total_production(){return Se},clear_players(){L.forEach(e=>e.destroy()),L.length=0},get current_phase(){return O},set current_phase(e){O=e},update_resource_display:$e,next_turn(){G.replaceChildren(),S===L.length-1?(S=0,O=(()=>{switch(O){case $.development.name:return q.length=0,L.forEach(()=>q.push([])),$.movement_planning.name;case $.movement_planning.name:return $.movement_execution.name;default:return W+=1,$.development.name}})()):S+=1,oe()},run:oe};function oe(){pe.textContent=$[O].end_turn_btn_label,We.textContent=$[O].call_to_action,Ye.textContent=L[S].name,document.body.dataset.current_phase=$[O].name,document.documentElement.style.setProperty("--active-player-color",`var(--player-${S+1}`),O===$.land_grab.name&&(x.classList.add("hidden"),H.classList.remove("hidden")),O===$.development.name?(x.classList.add("hidden"),H.classList.add("hidden"),Se=P(L[S].cells,L[S].tax_rate),z.classList.add("hidden"),Ee(P(L[S].cells,L[S].tax_rate),L[S].tax_rate),Q.classList.remove("content-hidden"),$e()):Q.classList.add("content-hidden")}function $e(){Q.replaceChildren(...Object.entries(L[S].resources).map(([e,t])=>Object.assign(document.createElement("div"),{textContent:`${e}: ${t}`})))}function bt(){if(_.players.length===0){localStorage.removeItem("wargame-savegame");return}localStorage.setItem("wargame-savegame",JSON.stringify({round:_.round,current_phase:_.current_phase,current_player_id:_.current_player_id,players:_.players.map(({name:e,type:t})=>({name:e,type:t})),board:[..._.board.values()].map(({cx:e,cy:t,x:r,y:o,q:a,r:s,s:i,biome:{name:c},elevation:d,humidity:l,temperature:y,owner_id:v,resources:p})=>({cx:e,cy:t,x:r,y:o,q:a,r:s,s:i,biome_name:c,elevation:d,humidity:l,temperature:y,owner_id:v,resources:p}))}))}function wt(e,t){const r=JSON.parse(t);Object.assign(e,{round:r.round,current_phase:r.current_phase,current_player_id:r.current_player_id,players:r.players.map(({name:o,type:a},s)=>Z(s,o,a)),board:ot(r.board,e.board)}),e.players.forEach((o,a)=>{o.cells=[...e.board.values()].filter(s=>s.owner_id===a)})}window.addEventListener("DOMContentLoaded",()=>{const e=localStorage.getItem("wargame-savegame"),t=e!==null;k.dataset.priorSave=t,k.showModal(),t?wt(_,e):_.board=st(b,_.board);const r=JSON.parse(localStorage.getItem("wargame-planned-moves")),o=[..._.board.values()];r.forEach(a=>{q.push(a.map(({origin:s,target:i,units:c})=>({origin:o.find(({cx:d,cy:l})=>d===s.cx&&l===s.cy),target:o.find(({cx:d,cy:l})=>d===i.cx&&l===i.cy),units:c})))}),q.forEach(a=>a.forEach(s=>{s.arrow=Le(s)}))},{once:!0});document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&bt()});k.addEventListener("cancel",ae);document.addEventListener("submit",ae);Ve.addEventListener("submit",e=>{e.submitter.id==="continue-btn"?k.dataset.priorSave==="true"&&k.close():e.submitter.id==="new-game-btn"&&(k.dataset.priorSave==="true"&&(Object.assign(_,{round:0,current_phase:$.land_grab.name,current_player_id:0}),_.board=he(_.board),_.clear_players(),q.length=0,fe.replaceChildren()),Array.from({length:2},(t,r)=>we(r+1)),k.classList.add("game-config"))});k.addEventListener("close",()=>{k.dataset.priorSave==="false"&&_.players.length===0&&(_.players=Array.from({length:2},(e,t)=>Z(t,`Player ${t+1}`,"human"))),_.run()});Ke.addEventListener("click",()=>{_.board=he(_.board)});pe.addEventListener("click",vt(_));ne.addEventListener("submit",()=>{const e=new Set,t=[...ne.querySelectorAll(".player-name-input")];if(t.reduce((r,{value:o})=>(r[o]=o in r?r[o]+1:1,r[o]>1&&e.add(o),r),{}),e.size>0){t.forEach(r=>{e.has(r.value)&&r.classList.add("invalid")});return}_.players=Array.from(R,(r,o)=>{const a=r.querySelector(".player-name-input").value,s=r.querySelector(".player-type-select-radio:checked").value;return Z(o,a,s)}),k.close()});Fe.addEventListener("click",()=>{R.length!==5&&we(R.length+1)});_e.addEventListener("click",({target:e})=>{e.closest(".delete-player-btn")&&R.length!==2&&(e.closest(".player-config").remove(),[...R].forEach((t,r)=>{r=r+1,Object.assign(t.querySelector(".player-name-input"),{name:`player-${r}-name`,value:`Player ${r}`}),t.querySelectorAll(".player-type-select-radio").forEach(o=>{o.name=`player-${r}-type`})}))});K.addEventListener("click",({target:e})=>{const t=e.closest(".cell-wrapper");if(!t)return;const r=K.querySelector(".clicked"),o=_.board.get(t);r&&(r.classList.remove("clicked"),G.replaceChildren(),r===t)||(t.classList.add("clicked"),Et(o),$[_.current_phase].handle_click_on_cell(o,_))});Qe.addEventListener("input",ht(_));T.addEventListener("close",gt(_));T.addEventListener("submit",()=>{T.close()});document.querySelector("h1").addEventListener("dblclick",()=>{document.body.classList.toggle("debug")});He.addEventListener("click",()=>{document.body.classList.toggle("use-offset-coords")});function Et(e){Je.textContent=JSON.stringify(e,(t,r)=>t==="neighbors"?void 0:r,4)}
