(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))o(a);new MutationObserver(a=>{for(const r of a)if(r.type==="childList")for(const s of r.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&o(s)}).observe(document,{childList:!0,subtree:!0});function n(a){const r={};return a.integrity&&(r.integrity=a.integrity),a.referrerPolicy&&(r.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?r.credentials="include":a.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(a){if(a.ep)return;a.ep=!0;const r=n(a);fetch(a.href,r)}})();const Ye=""+new URL("service-worker.js",import.meta.url).href;window.navigator.serviceWorker.register(Ye).catch(console.error);let te;be(),document.addEventListener("visibilitychange",()=>{document.hidden?Ke():be()});async function be(){var e,t;te=await((t=(e=navigator.wakeLock)==null?void 0:e.request)==null?void 0:t.call(e,"screen"))}async function Ke(){te&&(await te.release(),te=void 0)}const Qe=document.getElementById("add-player-btn"),M=document.getElementById("board"),Q=document.getElementById("board-size-select"),Ie=document.getElementById("bottom-bar"),X=document.getElementById("cell-info"),U=document.getElementById("cell-production-forecast"),Ve=document.getElementById("config-game-form"),_e=document.getElementById("defs"),V=document.getElementById("end-turn-btn"),re=document.getElementById("general-info"),ne=document.getElementById("total-production-forecast"),ze=document.getElementById("phase-label"),F=document.getElementsByClassName("player-config"),Ee=document.getElementById("player-name"),xe=document.getElementById("player-setup"),Ze=document.getElementById("reroll-map-btn"),Ge=document.getElementById("side-bar");document.getElementById("round-info");const Z=document.getElementById("season-of-move-select"),me=document.getElementById("selection-highlight"),Xe=document.getElementById("start-game-form"),x=document.getElementById("main-overlay"),Be=document.getElementById("movement-arrows"),N=document.getElementById("movement-config"),oe=N.querySelector('[name="troop-strength"]'),$e=N.querySelector('[name="troop-strength-value"]'),je=N.querySelector('[name="min-troop-strength-value"]'),et=N.querySelector('[name="max-troop-strength-value"]'),se=N.querySelector('[name="settle-cell-toggle"]'),tt=document.getElementById("player-borders"),nt=document.getElementById("encampments"),Ce=document.getElementById("burger-menu-btn"),rt=document.getElementById("zoom-btns");function le(e){return e%2===0}function ot(e,t,n){return e>=t&&e<=n}function Me(e,t=0,n=e.length){return e[H(n,t)]}function H(e,t=0){return Math.trunc(Math.random()*(e-t)+t)}function j(e){return Object.freeze(Object.assign(Object.create(null),e))}function pe(e){return Object.entries(e).map(([t,n])=>Object.assign(document.createElement("li"),{textContent:`${t}: ${n}`}))}function st(e){return Object.seal(Object.assign(Object.create(null),e))}const $={board:"wargame-board",board_dimensions:"wargame-board-dimensions",game:"wargame-savegame",move_queue:"wargame-planned-moves",players:"wargame-players"},v=st({width:0,height:0}),T={s:{width:30,height:24,cell_count:720,viewBox:"0 0 185 110"},m:{width:60,height:48,cell_count:2880,viewBox:"0 0 370 220"},l:{width:90,height:72,cell_count:6480,viewBox:"0 0 740 440"}};function Ne({width:e,height:t}){return{width:e,height:t}}function at({board:e},t){return()=>{const n=Q.value;Object.assign(v,Ne(T[n])),M.setAttribute("viewBox",T[n].viewBox),t(e,v)}}function it(){const e=JSON.parse(localStorage.getItem($.board_dimensions));if(e===null){const t=Q.value;Object.assign(v,Ne(T[t]))}else Object.assign(v,e),Q.value=Object.keys(T).find(t=>T[t].width===v.width);M.setAttribute("viewBox",T[Q.value].viewBox)}function ct(){localStorage.setItem($.board_dimensions,JSON.stringify(v))}const i=j({people:"people",gold:"gold",wood:"wood",stone:"stone",iron:"iron",food:"food",alcohol:"alcohol",coal:"coal"}),lt=j({[i.people]:5,[i.gold]:5,[i.wood]:25,[i.stone]:25,[i.iron]:0,[i.food]:50,[i.alcohol]:5,[i.coal]:5});function ae(e,t=1){const n={[i.gold]:0,[i.wood]:0,[i.stone]:0,[i.iron]:0,[i.food]:0,[i.alcohol]:0,[i.coal]:0};let o=0;return e.forEach(a=>{o+=a.resources.people,Object.entries(a.biome.resource_production).forEach(([r,s])=>{n[r]+=s}),[...a.structures.entries()].forEach(([r,s])=>{r.output.forEach(({resource_name:l,amount:c})=>{n[l]+=c*s})})}),n[i.gold]=o*t,n}function ut(e){let t=0;if(e.resources.people===1)Math.random()<.05&&(t=1);else{const n=Math.trunc(e.resources.people/2);for(let o=0;o<n;o+=1){const a=Math.random();a<.1?t+=2:a<.5&&(t+=1)}}e.resources[i.people]+=t}function dt(e){e.forEach(({cells:t,encampments:n,tax_rate:o})=>{const{total_population:a,total_required_workers:r}=[...t].reduce((c,u)=>(c.total_population+=u.resources[i.people],c.total_required_workers+=[...u.structures.entries()].reduce((_,[f,g])=>_+f.required_workers*g,0),c),{total_population:0,total_required_workers:0}),s=Math.min(1,a/r);let l=[...n.values()].reduce((c,u)=>c+u,a);t.forEach(c=>{Object.entries(c.biome.resource_production).forEach(([u,_])=>{c.resources[u]+=_}),[...c.structures.entries()].forEach(([u,_])=>u.output.forEach(({resource_name:f,amount:g})=>{c.resources[f]+=Math.trunc(g*_*s)})),c.resources[i.gold]+=c.resources[i.people]*o,l>0&&(l>=c.resources[i.food]?(l-=c.resources[i.food],c.resources[i.food]=0):(c.resources[i.food]-=l,l=0)),ut(c)})})}const b=j({freezing:"freezing",cold:"cold",temperate:"temperate",warm:"warm",hot:"hot"});function _t(e){e.forEach(t=>{const n=Math.random(),o=-1,a=ot(n,.3,.7)?0:1*(-1*+(n<.3)),r=(s=>s<0?0:s>v.height-1?v.height-1:s)(t.y+a+o);t.temperature=pt(r)})}function mt(e){switch(e){case b.hot:return b.warm;case b.warm:return b.temperate;case b.temperate:return b.cold;default:return b.freezing}}function pt(e){switch(e){case 0:case 1:case v.height-2:case v.height-1:return b.freezing;case 2:case 3:case v.height-4:case v.height-3:return b.cold;case 4:case 5:case v.height-6:case v.height-5:return b.temperate;case 6:case 7:case 8:case v.height-9:case v.height-8:case v.height-7:return b.warm;default:return b.hot}}function ft(e){switch(e){case b.freezing:return b.cold;case b.cold:return b.temperate;case b.temperate:return b.warm;default:return b.hot}}const y=j({arid:"arid",dry:"dry",moderate:"moderate",moist:"moist",wet:"wet"});function gt(e){e.filter(t=>t.elevation>0).forEach(t=>{t.neighbors.filter(n=>n.elevation===0).forEach(n=>{n.cell.classList.add("shore"),t.humidity=yt(t.humidity)})})}function yt(e){switch(e){case y.arid:return y.dry;case y.dry:return y.moderate;case y.moderate:return y.moist;default:return y.wet}}const p={sea:L("sea",{[i.food]:1}),mountain:L("mountain",{[i.wood]:2,[i.stone]:5,[i.food]:3}),high_mountain:L("high_mountain",{[i.stone]:5}),ice:L("ice",{[i.food]:2}),tundra:L("tundra",{[i.wood]:2,[i.stone]:1,[i.food]:5}),grassland:L("grassland",{[i.wood]:2,[i.stone]:2,[i.food]:5}),savanna:L("savanna",{[i.wood]:5,[i.stone]:3,[i.food]:6}),boreal_forest:L("boreal_forest",{[i.wood]:10,[i.stone]:3,[i.food]:5}),forest:L("forest",{[i.wood]:10,[i.stone]:2,[i.food]:5}),tropical_rainforest:L("tropical_rainforest",{[i.wood]:7,[i.stone]:1,[i.food]:5}),cold_swamp:L("cold_swamp",{[i.wood]:2,[i.stone]:1,[i.food]:2}),swamp:L("swamp",{[i.wood]:1,[i.stone]:0,[i.food]:3}),tropical_swamp:L("tropical_swamp",{[i.wood]:3,[i.stone]:1,[i.food]:3}),desert:L("desert",{[i.wood]:0,[i.stone]:2,[i.food]:1}),extreme_desert:L("extreme_desert",{[i.wood]:0,[i.stone]:1,[i.food]:0})},ht={[b.freezing]:{[y.arid]:p.tundra,[y.dry]:p.tundra,[y.moderate]:p.tundra,[y.moist]:p.boreal_forest,[y.wet]:p.boreal_forest},[b.cold]:{[y.arid]:p.tundra,[y.dry]:p.tundra,[y.moderate]:p.boreal_forest,[y.moist]:p.boreal_forest,[y.wet]:p.boreal_forest},[b.temperate]:{[y.arid]:p.tundra,[y.dry]:p.forest,[y.moderate]:p.forest,[y.moist]:p.forest,[y.wet]:p.swamp},[b.warm]:{[y.arid]:p.desert,[y.dry]:p.grassland,[y.moderate]:p.savanna,[y.moist]:p.forest,[y.wet]:p.tropical_swamp},[b.hot]:{[y.arid]:p.extreme_desert,[y.dry]:p.desert,[y.moderate]:p.grassland,[y.moist]:p.savanna,[y.wet]:p.tropical_rainforest}};function vt(e){e.forEach(t=>{t.biome||(t.biome=t.elevation>1?t.elevation>2?p.high_mountain:p.mountain:ht[t.temperature][t.humidity])})}function L(e="sea",t={}){return{name:e,resource_production:Object.assign({[i.wood]:0,[i.stone]:0,[i.food]:0},t)}}function wt(e){e.filter(({elevation:t})=>t===0).forEach(t=>{t.biome=bt(t)})}function bt(e,t=v.height){const n=Math.random();return[0,t-1].includes(e.y)?n<=.1?p.sea:p.ice:[1,t-2].includes(e.y)?n<=.75?p.sea:p.ice:[2,t-3].includes(e.y)?n<=.9?p.sea:p.ice:p.sea}const Se=new Set([0,1,2,v.height-1,v.height-2,v.height-3]);function ke(e){e.elevation+=1,e.elevation>1&&(e.temperature=mt(e.temperature))}function Et(e){const o=e.length/2.5;let a=0;for(;a<o;){const r=H(13,4),s={x:H(v.width),y:H(v.height-3,3)},l=e.find(({x:_,y:f})=>_===s.x&&f===s.y),c=new Set(l.neighbors.filter(({y:_})=>!Se.has(_))),u=new Set;a+=r,ke(l),u.add(l);for(let _=0;_<r;_+=1){const f=Me([...c]);ke(f),u.add(f),c.delete(f),f.neighbors.filter(g=>!u.has(g)).filter(({y:g})=>!Se.has(g)).forEach(g=>c.add(g))}}e.filter(r=>r.elevation>0).forEach(r=>{const s=r.neighbors.filter(c=>c.elevation>0).length;if(s>=3)return;const l=Math.random();(s===2&&l>.7||s===1&&l<.7)&&St(r)})}function St(e){e.elevation=Math.max(0,e.elevation-1),e.elevation>0&&(e.temperature=ft(e.temperature))}const kt=[{q:1,r:0,s:-1},{q:1,r:-1,s:0},{q:0,r:1,s:-1},{q:0,r:-1,s:1},{q:-1,r:0,s:1},{q:-1,r:1,s:0}];function Ae(e=[]){e.forEach(t=>{t.neighbors=Lt(t,e,v)})}function Lt({q:e,r:t,s:n,x:o,y:a},r,s){const l=kt.map(c=>r.find(u=>u.q===e+c.q&&u.r===t+c.r&&u.s===n+c.s)).filter(Boolean);return o===0&&(l.push(r.find(c=>a===c.y&&c.x===s.width-1)),le(a)&&l.push(...[a<s.height-1?r.find(c=>a+1===c.y&&c.x===s.width-1):null,a>0?r.find(c=>a-1===c.y&&c.x===s.width-1):null].filter(Boolean))),o===s.width-1&&(l.push(r.find(c=>a===c.y&&c.x===0)),le(a)||l.push(...[a<s.height-1?r.find(c=>a+1===c.y&&c.x===0):null,a>0?r.find(c=>a-1===c.y&&c.x===0):null].filter(Boolean))),l}const qt=_e.querySelector(".cell-wrapper"),Ot=_e.querySelector(".movement-indicator"),Le=_e.querySelector(".player-border"),It=document.getElementById("player-config-tmpl").content,zt=document.getElementById("structure-builder-tmpl").content,fe={house:P("House",[S(i.wood,1)],[],0,{on(e){e.housing_capacity+=5},off(e){e.housing_capacity-=5}},new Set),lumber_mill:P("Lumber Mill",[S(i.wood,15),S(i.stone,15)],[S(i.wood,5)]),quarry:P("Quarry",[S(i.wood,15),S(i.stone,15)],[S(i.stone,5)]),mine:P("Mine",[S(i.wood,5),S(i.stone,5)],[S(i.coal,5)]),forge:P("Forge",[S(i.wood,5),S(i.stone,5)],[S(i.iron,1)]),farm:P("Farm",[S(i.wood,5),S(i.stone,5)],[S(i.food,5)]),distillery:P("Distillery",[S(i.wood,5),S(i.stone,5)],[S(i.alcohol,1)])};function P(e="Pretty Structure",t=[S(i.wood,5)],n=[S(i.wood,1)],o=1,a={on(c){c.foo+=5},off(c){c.foo-=5}},r=new Set([p.swamp]),s=[S(i.wood,1)],l=1){return{display_name:e,construction_cost:t,space_requirement:l,unsupported_biomes:r,effects:a,output:n,input:s,required_workers:o}}function S(e=i.wood,t=1){return{resource_name:e,amount:t}}const A=0;function K(e,t,{color:n="white",stroked_outline:o=!1}={}){if(e.size===0)return;const a=[...e].reduce((r,s)=>{const l=s.neighbors.filter(m=>!e.has(m)),c=Ct(s),u=Pt(s),_=Nt(s),f=$t(s),g=At(s),d=Mt(s);return l.find(m=>m.r===s.r&&m.s===s.s+1)&&r.push([_,d]),l.find(m=>m.q===s.q&&m.s===s.s+1)&&r.push([d,f]),l.find(m=>m.s===s.s&&m.r===s.r-1)&&r.push([f,g]),l.find(m=>m.r===s.r&&m.s===s.s-1)&&r.push([g,u]),l.find(m=>m.q===s.q&&m.s===s.s-1)&&r.push([u,c]),l.find(m=>m.s===s.s&&m.r===s.r+1)&&r.push([c,_]),r},[]);t.setAttribute("d",xt(Bt(a))),t.setAttribute("stroke-width","0.5"),t.setAttribute("stroke",n),o&&t.setAttribute("stroke-dasharray","1")}function xt(e){return`M${e.map(({x:n,y:o})=>`${n} ${o}`).join("L")}Z`}function Bt(e){const t=e.reduce((s,l)=>{for(const c of l){const u=G(c);s.has(u)?s.get(u).push(l):s.set(u,[l])}return s},new Map),n=new Set,o=[],[a]=e;let r=a[1];for(o.push(a[0]),n.add(ce(a));n.size<e.length;){const s=G(r),l=t.get(s).find(c=>!n.has(ce(c)));o.push(r),n.add(ce(l)),r=G(l[0])===s?l[1]:l[0]}return o}function G({x:e,y:t}){return`${e} ${t}`}function ce([e,t]){return[G(e),G(t)].sort().join("|")}function W(e,t){return{x:e,y:t}}function $t(e){return W(e.cx+3,e.cy+A)}function Ct(e){return W(e.cx+3,e.cy+6-A)}function Mt(e){return W(e.cx+A,e.cy+1.5+A*.5)}function Nt(e){return W(e.cx+A,e.cy+4.5-A*.5)}function At(e){return W(e.cx+6-A,e.cy+1.5+A*.5)}function Pt(e){return W(e.cx+6-A,e.cy+4.5-A*.5)}let J=null;function Rt(e){!e.has_owner&&e.biome!==p.sea?(J=e,K(new Set([...e.neighbors,e]),me),re.classList.add("hidden"),Tt(e)):(X.classList.add("hidden"),re.classList.remove("hidden"))}function Jt(e){return J===null?!1:(Object.entries(lt).forEach(([t,n])=>{J.resources[t]=n}),e.active_player.add_cell(J),J.cell.classList.remove("clicked"),J=null,!0)}function Tt(e){const{wood:t,stone:n,food:o}=e.biome.resource_production,a=Object.values(fe).filter(r=>!r.unsupported_biomes.has(e.biome)).map(({display_name:r})=>`<li>${r}</li>`).join("");X.innerHTML=`
        <h2>Cell Info</h2>
        <ul>
            <li>Biome: ${e.biome.name}</li>
            <li>...</li>
        </ul>
        <h3>Production</h3>
        <ul>
            <li>Wood: ${t}</li>
            <li>Stone: ${n}</li>
            <li>Food: ${o}</li>
        </ul>
        <h3>Supported structures</h3>
        <ul>${a}</ul>
    `,X.classList.remove("hidden")}function Ut(e,t){return Object.entries(fe).filter(([,n])=>!n.unsupported_biomes.has(e.biome)).map(([n,o])=>{const a=zt.cloneNode(!0).lastElementChild,r=a.querySelector(".label-text"),s=a.querySelector(".structure-count");return a.dataset.structure_name=n,r.textContent=`${o.display_name}: `,s.textContent=e.structures.get(o).toString(),a.addEventListener("click",({target:l})=>{if(!(l instanceof Element))return;const c=l.closest("button");if(c===null)return;const u=c.classList.contains("construct-structure-btn"),_=o.construction_cost;let f=e.structures.get(o);if(u){if(e.developable_land<o.space_requirement||_.some(({resource_name:d,amount:m})=>m>t.active_player.resources[d]))return;f+=1,_.forEach(({resource_name:d,amount:m})=>{let I=m;for(const B of t.active_player.cells){const we=B.resources[d];if(we<I){I-=we,B.resources[d]=0;continue}else B.resources[d]-=I,I=0;if(I===0)break}}),e.developable_land-=o.space_requirement}else{if(f===0)return;f-=1,_.forEach(({resource_name:g,amount:d})=>{e.resources[g]+=d}),e.developable_land+=o.space_requirement}e.structures.set(o,f),s.textContent=f.toString(),U.querySelector("ul").replaceChildren(...pe(ae(new Set([e]),t.active_player.tax_rate))),t.update_resource_display()}),a})}function Pe(e,t){ne.querySelector("ul").replaceChildren(...pe(e)),ne.querySelector("input").value=t.toString(),ne.classList.remove("hidden")}function Ht(e,t){e.owner_id===t.current_player_id?(ne.classList.add("hidden"),Dt(ae(new Set([e]),t.active_player.tax_rate),Ut(e,t))):(U.classList.add("hidden"),Pe(ae(t.active_player.cells,t.active_player.tax_rate),t.active_player.tax_rate))}function Dt(e,t){U.querySelector("ul").replaceChildren(...pe(e)),U.querySelector("fieldset").replaceChildren(...t),U.classList.remove("hidden")}const q=[];function Ft(){q.length=0,Be.replaceChildren()}function Wt(e,t,n,o){const r={x:e.cx+3,y:e.cy+3},s={x:t.cx+3,y:t.cy+3},l=`M${r.x} ${r.y}A 3 3 0 0 0 ${s.x} ${s.y}`,c=Ot.cloneNode(!0),u=c.lastElementChild.lastElementChild;return c.firstElementChild.setAttribute("d",l),c.dataset.owner_id=o.toString(),u.setAttribute("path",l),u.textContent=n.toString(),Be.append(c),c}function Re(e,t,n,o,a,r="unspecified"){const s=Wt(t,n,o,e);let l=o;return{player_id:e,origin:t,target:n,season:a,get units(){return l},set units(c){l=c,s.lastElementChild.lastElementChild.textContent=c.toString()},type:r,arrow:s}}function Yt(e){const t=JSON.parse(localStorage.getItem($.move_queue)),n=[...e.board.values()];q.push(...t.map(({player_id:o,origin:a,target:r,units:s,season:l})=>Re(o,n.find(({cx:c,cy:u})=>c===a.cx&&u===a.cy),n.find(({cx:c,cy:u})=>c===r.cx&&u===r.cy),s,l)))}function Kt(){localStorage.setItem($.move_queue,JSON.stringify(q.map(({player_id:e,origin:t,target:n,units:o,season:a})=>({player_id:e,origin:{cx:t.cx,cy:t.cy},target:{cx:n.cx,cy:n.cy},units:o,season:a}))))}const k=j({spring:"spring",summer:"summer",autumn:"autumn",winter:"winter"});function Qt(e){switch(e){case k.spring:return k.summer;case k.summer:return k.autumn;case k.autumn:return k.winter;default:return k.spring}}function ie(e,t){return!(e===t||e===k.winter||e===k.summer&&t===k.spring||e===k.autumn&&t!==k.winter)}let E=null,C=null;function Vt(e,t){if(E===null){Xt(e,t);return}if(e.cell.classList.remove("clicked"),E===e){E=null;return}if(!e.neighbors.includes(E))return;C=e;const n=q.find(({player_id:s,origin:l,target:c})=>s===t.current_player_id&&l===E&&c===C),o=E.owner_id===t.current_player_id,a=C.owner_id===t.current_player_id,r={settle_cell:!1,season:k.spring};if(Object.values(k).forEach(s=>{Z.querySelector(`input[value="${s}"]`).disabled=!1}),Z.inert=!1,se.inert=a||C.biome===p.sea,n?Zt(n,t,o,r):Gt(t,o,r),r.max_value<=0){C=null;return}Z.querySelector(`input[value="${r.season}"]`).checked=!0,Object.assign(oe,{value:r.current_value,min:r.min_value,max:r.max_value}),$e.value=r.current_value.toString(),je.value=r.min_value.toString(),et.value=r.max_value.toString(),se.checked=r.settle_cell,N.showModal()}function Zt(e,t,n,o){const a=q.filter(({player_id:r})=>r===t.current_player_id);o.settle_cell=e.type==="settle",o.current_value=e.units,o.season=e.season,o.min_value=a.filter(({season:r,origin:s})=>ie(e.season,r)&&e.target===s).reduce((r,{season:s,origin:l,units:c})=>(D(a,l,s,l.owner_id===t.current_player_id?l.resources[i.people]:0)-e.units<c&&(r+=c),r),0),Z.inert=!0,se.inert=!0,n?o.max_value=D(a,E,o.season,E.resources[i.people])-1+o.current_value:o.max_value=D(a,E,o.season,t.active_player.get_encampment(E)||0)-Number(o.settle_cell)+o.current_value}function Gt(e,t,n){const o=q.filter(({player_id:a})=>a===e.current_player_id);if(n.current_value=0,n.min_value=0,t)n.max_value=D(o,E,n.season,E.resources[i.people])-1;else{const a=o.filter(({target:r})=>r===E);if(a.length>0){const r=a.reduce((l,{season:c})=>(ie(c,l)&&(l=c),l),k.winter),s=o.some(({target:l,type:c,season:u})=>l===E&&u===r&&c==="settle");if(r===k.winter){C=null;return}Object.values(k).filter(l=>l===r||ie(l,r)).forEach(l=>{Z.querySelector(`input[value="${l}"]`).disabled=!0}),n.season=Qt(r),n.max_value=D(o,E,n.season,e.active_player.get_encampment(E)||0)-Number(s);return}n.season=k.spring,n.max_value=D(o,E,n.season,e.active_player.get_encampment(E)||0)}}function Xt(e,t){const n=q.filter(({player_id:l})=>l===t.current_player_id),o=e.owner_id===t.current_player_id&&e.resources[i.people]>1,a=n.find(({origin:l})=>l===e),r=n.find(({target:l,season:c})=>l===e&&c!=="winter"),s=t.active_player.encampments.has(e);o||a||r||s?E=e:e.cell.classList.remove("clicked")}function D(e,t,n,o=0){return e.filter(({origin:a,target:r,season:s})=>(a===t||r===t)&&(s===n||ie(s,n))).reduce((a,r)=>(t===r.target?a+=r.units:a-=r.units,a),o)}function jt(e){return()=>{const t=N.querySelector('[name="season-of-move"]:checked').value,n=Number(oe.value),o=se.checked,a=q.findIndex(({player_id:r,origin:s,target:l})=>r===e.current_player_id&&s===E&&l===C);if(Number.isNaN(n)||n<=0){if(E=null,C=null,a>-1){const[{arrow:r}]=q.splice(a,1);r.remove()}return}if(a>-1){const r=q[a];r.units=n}else q.push(Re(e.current_player_id,E,C,n,t,o?"settle":"unspecified"));E=null,C=null}}const w={land_grab:Y("land_grab","Pick your origin","Confirm choice",Rt),development:Y("development","Pick one of your cells and develop it",void 0,Ht),movement_planning:Y("movement_planning","Make your moves",void 0,Vt),movement_execution:Y("movement_execution","","Start Movement Phase"),game_over:Y("game_over","","Pick your origin")};function en(e){return()=>{if(!(e.current_phase===w.land_grab.name&&!Jt(e))){if(e.current_phase===w.movement_execution.name){const{done:t}=e.moves.next();if(!t)return}e.next_turn()}}}function Y(e="round_phase",t="",n="End turn",o=(a,r)=>{}){return{name:e,call_to_action:t,end_turn_btn_label:n,handle_click_on_cell:o}}function Je(e,t,n,o,a,r,s){const l=tn(e,t),c=l.querySelector(".population-size");let u=null,_=b.freezing,f=-1,g=0;return{cx:e,cy:t,x:n,y:o,q:a,r,s,get has_owner(){return f!==-1},neighbors:[],cell:l,elevation:0,humidity:y.arid,get temperature(){return _},set temperature(d){_=d,l.dataset.temperature=d},structures:new Map(Object.values(fe).map(d=>[d,0])),pop_size_display:c,resources:{get[i.people](){return g},set[i.people](d){g=d,c.textContent=g>0?g.toString():""},[i.gold]:0,[i.wood]:0,[i.stone]:0,[i.iron]:0,[i.food]:0,[i.alcohol]:0,[i.coal]:0},get biome(){return u},set biome(d){u!==null&&l.classList.remove(u.name),d!==null&&l.classList.add(d.name),u=d},get owner_id(){return f},set owner_id(d){f=d,l.dataset.owner_id=d===-1?"":d.toString()},developable_land:10}}function tn(e,t){const n=qt.cloneNode(!0);return n.setAttribute("transform",`translate(${e}, ${t})`),M.prepend(n),n}function nn(e){return({target:t})=>{if(!(t instanceof Element))return;const n=t.closest(".cell-wrapper");if(n===null)return;const o=M.querySelector(".clicked"),a=e.board.get(n);o&&(o.classList.remove("clicked"),me.replaceChildren()),o!==n&&n.classList.add("clicked"),w[e.current_phase].handle_click_on_cell(a,e)}}const ge=6,rn=ge*.5,on=ge*.75;function Te(e,t){e.forEach(n=>{t.set(n.cell,n)})}function sn({height:e,width:t}){const n=[];for(let o=0;o<e;o+=1){const a=+!le(o);for(let r=0;r<t;r+=1){const s=r-(o-(o&1))*.5;n.push(Je(r*ge+a*rn,o*on,r,o,s,o,-s-o))}}return n}function Ue(e,t){const n=sn(t);Ae(n),_t(n),Et(n),wt(n),gt(n),vt(n),Te(n,e)}function an(e=[],t){const n=e.map(({cx:o,cy:a,x:r,y:s,q:l,r:c,s:u,biome_name:_,elevation:f,humidity:g,temperature:d,owner_id:m,resources:I})=>{const B=Je(o,a,r,s,l,c,u);return Object.assign(B,{biome:p[_],elevation:f,humidity:g,resources:Object.assign(B.resources,I),temperature:d,owner_id:m})});Ae(n),n.filter(o=>o.elevation===0&&o.neighbors.some(a=>a.elevation>0)).forEach(o=>o.cell.classList.add("shore")),Te(n,t)}function ye(e,t){e.clear(),M.replaceChildren(M.lastElementChild),Ue(e,t)}const he=new Map;function cn(){localStorage.setItem($.board,JSON.stringify([...he.values()].map(({cx:e,cy:t,x:n,y:o,q:a,r,s,biome:{name:l},elevation:c,humidity:u,temperature:_,owner_id:f,resources:g})=>({cx:e,cy:t,x:n,y:o,q:a,r,s,biome_name:l,elevation:c,humidity:u,temperature:_,owner_id:f,resources:g}))))}function ln(){const e=JSON.parse(localStorage.getItem($.board));an(e,he)}const un={ai:"ai"},O=[],dn=2,_n=5;function mn(){F.length!==_n&&He(F.length+1)}function ue(e){if(!O.some(o=>o.name===e))return e;const n=/^(?<name>.+)_(?<id>\d+)$/.exec(e);return ue(n===null?`${e}_2`:`${n.groups.name}_${(Number(n.groups.id)||0)+1}`)}function pn({target:e}){!(e instanceof Element)||e.closest(".delete-player-btn")===null||F.length===dn||(e.closest(".player-config").remove(),[...F].forEach((t,n)=>{n=n+1,Object.assign(t.querySelector(".player-name-input"),{name:`player-${n}-name`,value:`Player ${n}`}),t.querySelectorAll(".player-type-select-radio").forEach(o=>{o.name=`player-${n}-type`})}))}function ve(e,t="Player Name",n=un.ai,o=[],a=[]){const r=new Set(o),s=Le.cloneNode(!0),l=Le.cloneNode(!0),c=new Map,_=`var(--player-${e+1})`;tt.append(s),nt.append(l),K(r,s,{color:_}),a.forEach(([d,m])=>f(d,m));function f(d,m){if(c.set(d,m),d.cell.classList.contains("contested"))return;if(d.has_owner){d.cell.classList.add("contested");return}const I=O.find(B=>B.id!==e&&B.encampments.has(d));if(I){d.cell.classList.add("contested"),d.pop_size_display.textContent="",I.outline_encampments();return}g(),d.pop_size_display.textContent=m.toString()}function g(){K(new Set([...c.keys()].filter(({cell:d})=>!d.classList.contains("contested"))),l,{color:_,stroked_outline:!0})}return{id:e,name:ue(t),type:n,tax_rate:1,get resources(){return[...r].reduce((d,{resources:m})=>(Object.entries(m).forEach(([I,B])=>{d[I]+=B}),d),{[i.people]:0,[i.gold]:0,[i.wood]:0,[i.stone]:0,[i.iron]:0,[i.food]:0,[i.alcohol]:0,[i.coal]:0})},border_path_container:s,get cells(){return r},add_cell(d){d.owner_id=e,r.add(d),K(r,s,{color:_})},delete_cell(d){r.delete(d),d.owner_id=-1,K(r,s,{color:_})},get encampments(){return c},get_encampment(d){return c.get(d)},add_encampment:f,delete_encampment(d){c.delete(d),g(),d.owner_id===-1&&O.every(m=>!m.encampments.has(d))&&(d.pop_size_display.textContent="")},outline_encampments:g,destroy(){r.clear(),c.clear(),s.remove(),l.remove()}}}function He(e){const t=It.cloneNode(!0);Object.assign(t.querySelector(".player-name-input"),{name:`player-${e}-name`,value:`Player ${e}`}),t.querySelectorAll(".player-type-select-radio").forEach(n=>{n.name=`player-${e}-type`}),xe.append(t)}function fn(e){const t=JSON.parse(localStorage.getItem($.players)),n=[...e.board.values()];O.push(...t.map(({name:o,type:a,encampments:r},s)=>ve(s,o,a,n.filter(l=>l.owner_id===s),r.map(({cx:l,cy:c,units:u})=>[n.find(_=>_.cx===l&&_.cy===c),u]))))}function gn(){localStorage.setItem($.players,JSON.stringify(O.map(({name:e,type:t,encampments:n})=>({name:e,type:t,encampments:[...n.entries()].map(([{cx:o,cy:a},r])=>({cx:o,cy:a,units:r}))}))))}function*yn(e){var t;for(const n in k){const o=q.filter(s=>n===s.season).filter(s=>{const l=vn(s,e);return l||qe(s,q),l});if(o.length===0)continue;const a=new Set,r=new Map;ze.textContent=`Move(s) in ${n}`,V.textContent="Show next move";for(const s of o)s.origin.cell.classList.add("clicked"),s.arrow.style.display="initial",a.add(s.target),yield"init_move",s.type==="settle"&&r.set(s.target,r.has(s.target)?r.get(s.target).add(s.player_id):new Set([s.player_id])),hn(s,e),qe(s,q),s.origin.cell.classList.remove("clicked");V.textContent="Make these moves",yield"moves_laid_out";for(const s of a){const l=wn(s,e.players);if(l.length===1){const{player_id:c,unit_count:u}=l[0];(t=r.get(s))!=null&&t.has(c)&&De(e.players[c],s,u);continue}V.textContent="Start battle",yield"battle_awaits",bn(s,l,e.players,r.get(s))}}}function De(e,t,n){e.delete_encampment(t),e.add_cell(t),t.resources[i.people]=n}function hn(e,t){if(e.player_id===e.origin.owner_id)e.origin.resources[i.people]-=e.units;else{const n=t.players[e.player_id],o=n.get_encampment(e.origin)-e.units;o===0?n.delete_encampment(e.origin):n.add_encampment(e.origin,o)}if(e.player_id===e.target.owner_id)e.target.resources[i.people]+=e.units;else{const n=t.players[e.player_id],o=(n.get_encampment(e.target)||0)+e.units;n.add_encampment(e.target,o)}}function vn(e,t){const n=e.origin.owner_id===e.player_id?e.origin.resources[i.people]-1:t.players[e.player_id].encampments.get(e.origin);return e.units<=n}function qe(e,t){const n=t.findIndex(o=>o===e);n<0||(t[n].arrow.remove(),t.splice(n,1))}function wn(e,t){return t.reduce((n,o,a)=>(o.encampments.has(e)?n.push({player_id:a,unit_count:o.encampments.get(e)}):a===e.owner_id&&n.push({player_id:e.owner_id,unit_count:e.resources[i.people],is_owner:!0}),n),[])}function bn(e,t,n,o){for(;t.length>1;){const l=[],c=new Set;t.forEach((u,_)=>{const f=new Set([_]);let g;t.forEach((d,m)=>{f.has(m)||(f.add(m),g=H(g===void 0?u.unit_count:u.unit_count-g),l.push({target_id:m,attack_strength:g}))})});for(const{target_id:u,attack_strength:_}of l)t[u].unit_count-=_,t[u].unit_count<=0&&c.add(u);if(c.size===t.length){c.forEach(u=>n[t[u].player_id].delete_encampment(e)),t=[Object.assign(Me(t),{unit_count:1})];break}[...c].sort((u,_)=>_-u).forEach(u=>{n[t[u].player_id].delete_encampment(e),t.splice(u,1)})}e.cell.classList.remove("contested");const{player_id:a,unit_count:r}=t[0],s=n[a];if(e.owner_id===a){e.resources[i.people]=r;return}e.has_owner&&(n[e.owner_id].delete_cell(e),e.resources[i.people]=0),o!=null&&o.has(a)?De(s,e,r):s.add_encampment(e,r)}let ee=0,z=w.land_grab.name,R=0,de=null,Fe;const h={board:he,get moves(){return Fe},get round(){return ee},set round(e){ee=e},get active_player(){return O[R]},get players(){return O},set players(e){O.push(...e)},get current_player_id(){return R},set current_player_id(e){R=e},get current_player_total_production(){return de},clear_players(){O.forEach(e=>e.destroy()),O.length=0},get current_phase(){return z},set current_phase(e){z=e},update_resource_display:We,next_turn(){if(me.setAttribute("d",""),R===O.length-1){if(R=0,z=qn(),z===w.development.name){if(ee>0){const e=On();if(e===null){dt(O);return}z=w.game_over.name,document.body.dataset.current_phase=w.game_over.name,document.getElementById("winner-name").textContent=e.name,x.showModal(),Ce.click()}ee+=1}}else R+=1;Oe()},run:Oe};function Oe(){switch(V.textContent=w[z].end_turn_btn_label,ze.textContent=w[z].call_to_action,Ee.classList.toggle("hidden",z===w.movement_execution.name),Ie.classList.toggle("content-hidden",z===w.development.name),document.body.dataset.current_phase=w[z].name,document.documentElement.style.setProperty("--active-player-color",`var(--player-${R+1}`),Ee.textContent=h.active_player.name,z){case w.land_grab.name:X.classList.add("hidden"),re.classList.remove("hidden");break;case w.development.name:de=ae(h.active_player.cells,h.active_player.tax_rate),Pe(de,h.active_player.tax_rate),We(),U.classList.add("hidden"),X.classList.add("hidden"),re.classList.add("hidden");break;case w.movement_execution.name:Fe=yn(h)}}function En(e){const{round:t,current_phase:n,current_player_id:o}=JSON.parse(e);Object.assign(h,{round:t,current_phase:n,current_player_id:o})}function Sn(){const e=localStorage.getItem($.game),t=e!==null;x.dataset.gameIsRunning=t.toString(),it(),t?(En(e),ln(),fn(h),Yt(h),h.run()):(Ue(h.board,v),x.showModal())}function kn(){document.visibilityState==="hidden"&&(h.players.length===0||h.current_phase===w.game_over.name?Ln():(In(),gn(),Kt(),cn(),ct()))}function Ln(){Object.values($).forEach(e=>localStorage.removeItem(e))}function qn(){switch(z){case w.development.name:return w.movement_planning.name;case w.movement_planning.name:return w.movement_execution.name;default:case w.movement_execution.name:return w.development.name}}function On(){const e=O.filter(({cells:t,encampments:n})=>n.size>0||t.size>0);return e.length===1?e[0]:null}function In(){localStorage.setItem($.game,JSON.stringify({round:h.round,current_phase:h.current_phase,current_player_id:h.current_player_id}))}function We(){Ie.replaceChildren(...Object.entries(h.active_player.resources).map(([e,t])=>Object.assign(document.createElement("div"),{title:e,innerHTML:`<svg class="icon"><use href="#${e}"></use></svg>
                        <span>${t}</span>`})))}function zn({target:e}){if(!(e instanceof Element))return;const t=e.closest("button");if(t===null)return;const n=Number(M.dataset.zoom_level);if(t.id==="zoom-in"){if(n===3)return;M.dataset.zoom_level=(n+1).toString()}else{if(n===-1)return;M.dataset.zoom_level=(n-1).toString()}}function xn(){h.players.length===0&&(h.players=Array.from({length:2},(e,t)=>ve(t,`Player ${t+1}`,"human"))),x.classList.remove("game-config"),h.run()}function Bn({submitter:e}){if(e.id==="continue-btn"){if(x.dataset.gameIsRunning!=="true")return;x.close();return}if(e.id==="new-game-btn"){if(x.dataset.gameIsRunning==="true"||h.current_phase===w.game_over.name){Object.assign(h,{round:0,current_phase:w.land_grab.name,current_player_id:0}),ye(h.board,v),Ft(),h.clear_players();for(const t of[...F])t.remove()}Array.from({length:2},(t,n)=>He(n+1)),x.classList.add("game-config")}}function $n(){x.dataset.gameIsRunning=(h.current_phase!==w.game_over.name&&h.players.length>0).toString(),x.showModal()}function Cn(){Array.from(F,(e,t)=>{const n=e.querySelector(".player-name-input").value,o=e.querySelector(".player-type-select-radio:checked").value;h.players.push(ve(t,n,o))}),x.close()}window.addEventListener("DOMContentLoaded",Sn,{once:!0});document.addEventListener("visibilitychange",kn);document.addEventListener("submit",e=>e.preventDefault());rt.addEventListener("click",zn);Q.addEventListener("change",at(h,ye));oe.addEventListener("input",()=>{$e.value=oe.value});Ce.addEventListener("click",$n);Xe.addEventListener("submit",Bn);Ve.addEventListener("submit",Cn);x.addEventListener("close",xn);Ze.addEventListener("click",()=>ye(h.board,v));Qe.addEventListener("click",mn);V.addEventListener("click",en(h));xe.addEventListener("click",pn);M.addEventListener("click",nn(h));Ge.addEventListener("input",({target:e})=>{e instanceof HTMLInputElement&&e.name==="tax_rate"&&(h.active_player.tax_rate=Number(e.value))});N.addEventListener("close",jt(h));N.addEventListener("submit",()=>N.close());
