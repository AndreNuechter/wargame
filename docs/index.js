(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))a(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const c of o.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&a(c)}).observe(document,{childList:!0,subtree:!0});function r(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function a(s){if(s.ep)return;s.ep=!0;const o=r(s);fetch(s.href,o)}})();const Ue=""+new URL("service-worker.js",import.meta.url).href;window.navigator.serviceWorker.register(Ue).catch(console.error);let W;ie(),document.addEventListener("visibilitychange",()=>{document.hidden?Je():ie()});async function ie(){var e,t;W=await((t=(e=navigator.wakeLock)==null?void 0:e.request)==null?void 0:t.call(e,"screen"))}async function Je(){W&&(await W.release(),W=void 0)}const b={width:30,height:24};function j(e){return e%2===0}function De(e,t,r){return e>=t&&e<=r}function Fe(e,t=0,r=e.length){return e[Y(r,t)]}function Y(e,t=0){return Math.trunc(Math.random()*(e-t)+t)}function pe(e){return Object.freeze(Object.assign(Object.create(null),e))}function He(e){e.preventDefault()}function fe(e){e.forEach(t=>{t.neighbors=We(t,e,b)})}function We({q:e,r:t,s:r,x:a,y:s},o,c){const d=[{q:1,r:0,s:-1},{q:1,r:-1,s:0},{q:0,r:1,s:-1},{q:0,r:-1,s:1},{q:-1,r:0,s:1},{q:-1,r:1,s:0}].map(l=>o.find(_=>_.q===e+l.q&&_.r===t+l.r&&_.s===r+l.s)).filter(Boolean);return a===0&&(d.push(o.find(l=>s===l.y&&l.x===c.width-1)),j(s)&&d.push(...[s<c.height-1?o.find(l=>s+1===l.y&&l.x===c.width-1):null,s>0?o.find(l=>s-1===l.y&&l.x===c.width-1):null].filter(Boolean))),a===c.width-1&&(d.push(o.find(l=>s===l.y&&l.x===0)),j(s)||d.push(...[s<c.height-1?o.find(l=>s+1===l.y&&l.x===0):null,s>0?o.find(l=>s-1===l.y&&l.x===0):null].filter(Boolean))),d}const g={freezing:"freezing",cold:"cold",temperate:"temperate",warm:"warm",hot:"hot"};function ye(e){e.forEach(t=>{const r=Math.random(),a=-1,s=De(r,.3,.7)?0:1*(-1*+(r<.3)),o=(c=>c<0?0:c>b.height-1?b.height-1:c)(t.y+s+a);t.temperature=Ye(o)})}function Ye(e){switch(e){case 0:case 1:case b.height-2:case b.height-1:return g.freezing;case 2:case 3:case b.height-4:case b.height-3:return g.cold;case 4:case 5:case b.height-6:case b.height-5:return g.temperate;case 6:case 7:case 8:case b.height-9:case b.height-8:case b.height-7:return g.warm;default:return g.hot}}function Ke(e){switch(e){case g.hot:return g.warm;case g.warm:return g.temperate;case g.temperate:return g.cold;default:return g.freezing}}function Qe(e){switch(e){case g.freezing:return g.cold;case g.cold:return g.temperate;case g.temperate:return g.warm;default:return g.hot}}const le=new Set([0,1,2,b.height-1,b.height-2,b.height-3]);function he(e){const a=e.length/2.5;let s=0;for(;s<a;){const o=Y(13,4),c={x:Y(b.width),y:Y(b.height-3,3)},i=e.find(({x:_,y:f})=>_===c.x&&f===c.y),d=new Set(i.neighbors.filter(({y:_})=>!le.has(_))),l=new Set;s+=o,ue(i),l.add(i);for(let _=0;_<o;_+=1){const f=Fe([...d]);ue(f),l.add(f),d.delete(f),f.neighbors.filter(u=>!l.has(u)).filter(({y:u})=>!le.has(u)).forEach(u=>d.add(u))}}e.filter(o=>o.elevation>0).forEach(o=>{const c=o.neighbors.filter(d=>d.elevation>0).length;if(c>=3)return;const i=Math.random();(c===2&&i>.7||c===1&&i<.7)&&Ve(o)})}function ue(e){e.elevation+=1,e.elevation>1&&(e.temperature=Ke(e.temperature))}function Ve(e){e.elevation=Math.max(0,e.elevation-1),e.elevation>0&&(e.temperature=Qe(e.temperature))}const p={arid:"arid",dry:"dry",moderate:"moderate",moist:"moist",wet:"wet"};function Ge(e){switch(e){case p.arid:return p.dry;case p.dry:return p.moderate;case p.moderate:return p.moist;default:return p.wet}}function ge(e){e.filter(t=>t.elevation>0).forEach(t=>{t.neighbors.filter(({biome:r})=>r===m.sea).forEach(()=>{t.humidity=Ge(t.humidity)})})}const n=pe({people:"people",gold:"gold",cloth:"cloth",wood:"wood",stone:"stone",iron:"iron",food:"food",alcohol:"alcohol"}),Xe=pe({[n.people]:5,[n.gold]:5,[n.cloth]:25,[n.wood]:25,[n.stone]:25,[n.iron]:0,[n.food]:50,[n.alcohol]:5});function J(e,t=1){const r={[n.people]:0,[n.gold]:0,[n.cloth]:0,[n.wood]:0,[n.stone]:0,[n.iron]:0,[n.food]:0,[n.alcohol]:0};let a=0;return e.forEach(s=>{a+=s.resources.people,Object.entries(s.biome.resource_production).forEach(([o,c])=>{r[o]+=c}),[...s.structures.entries()].forEach(([o,c])=>{o.output.forEach(({resource_name:i,amount:d})=>{r[i]+=d*c})});for(let o=0;o<Math.floor(s.resources.people/2);o+=1){const c=Math.random();c<.3?r[n.people]+=2:c<.8&&(r[n.people]+=1)}}),r[n.gold]=a*t,r}const m={sea:new L("sea",{[n.food]:1}),mountain:new L("mountain",{[n.wood]:2,[n.stone]:5,[n.food]:3}),high_mountain:new L("high_mountain",{[n.stone]:5}),ice:new L("ice",{[n.food]:2}),tundra:new L("tundra",{[n.cloth]:1,[n.wood]:2,[n.stone]:1,[n.food]:5}),grassland:new L("grassland",{[n.cloth]:3,[n.wood]:2,[n.stone]:2,[n.food]:5}),savanna:new L("savanna",{[n.cloth]:5,[n.wood]:5,[n.stone]:3,[n.food]:6}),boreal_forest:new L("boreal_forest",{[n.cloth]:4,[n.wood]:10,[n.stone]:3,[n.food]:5}),forest:new L("forest",{[n.cloth]:2,[n.wood]:10,[n.stone]:2,[n.food]:5}),tropical_rainforest:new L("tropical_rainforest",{[n.cloth]:3,[n.wood]:7,[n.stone]:1,[n.food]:5}),cold_swamp:new L("cold_swamp",{[n.cloth]:1,[n.wood]:2,[n.stone]:1,[n.food]:2}),swamp:new L("swamp",{[n.cloth]:1,[n.wood]:1,[n.stone]:0,[n.food]:3}),tropical_swamp:new L("tropical_swamp",{[n.cloth]:1,[n.wood]:3,[n.stone]:1,[n.food]:3}),desert:new L("desert",{[n.cloth]:1,[n.wood]:0,[n.stone]:2,[n.food]:1}),extreme_desert:new L("extreme_desert",{[n.cloth]:0,[n.wood]:0,[n.stone]:1,[n.food]:0})},Ze={[g.freezing]:{[p.arid]:m.tundra,[p.dry]:m.tundra,[p.moderate]:m.tundra,[p.moist]:m.boreal_forest,[p.wet]:m.boreal_forest},[g.cold]:{[p.arid]:m.tundra,[p.dry]:m.tundra,[p.moderate]:m.boreal_forest,[p.moist]:m.boreal_forest,[p.wet]:m.boreal_forest},[g.temperate]:{[p.arid]:m.tundra,[p.dry]:m.forest,[p.moderate]:m.forest,[p.moist]:m.forest,[p.wet]:m.swamp},[g.warm]:{[p.arid]:m.desert,[p.dry]:m.grassland,[p.moderate]:m.savanna,[p.moist]:m.forest,[p.wet]:m.tropical_swamp},[g.hot]:{[p.arid]:m.extreme_desert,[p.dry]:m.desert,[p.moderate]:m.grassland,[p.moist]:m.savanna,[p.wet]:m.tropical_rainforest}};function L(e="",t={},r=1,a=1){return{name:e,resource_production:Object.assign({[n.gold]:0,[n.cloth]:0,[n.wood]:0,[n.stone]:0,[n.iron]:0,[n.food]:0,[n.alcohol]:0},t),movement_speed:r,pleasantness:a}}function ve(e){e.forEach(t=>{t.biome=et(t)})}function we(e){e.filter(({elevation:t})=>t===0).forEach(t=>{t.biome=je(t)})}function je(e,t=b.height){const r=Math.random();return[0,t-1].includes(e.y)?r<=.1?m.sea:m.ice:[1,t-2].includes(e.y)?r<=.75?m.sea:m.ice:[2,t-3].includes(e.y)?r<=.9?m.sea:m.ice:m.sea}function et(e){return e.biome?e.biome:e.elevation>1?e.elevation>2?m.high_mountain:m.mountain:Ze[e.temperature][e.humidity]}const tt=document.getElementById("add-player-btn"),ee=document.getElementById("board"),te=document.getElementById("bottom-bar"),D=document.getElementById("cell-info"),rt=document.getElementById("cell-debug-info"),x=document.getElementById("cell-production-forecast"),nt=document.getElementById("toggle-coord-system-btn"),de=document.getElementById("config-game-form"),re=document.getElementById("defs"),be=document.getElementById("end-turn-btn"),G=document.getElementById("general-info"),K=document.getElementById("overall-production-forecast"),ot=document.getElementById("phase-label"),F=document.getElementsByClassName("player-config"),st=document.getElementById("player-name"),Ee=document.getElementById("player-setup"),at=document.getElementById("reroll-map-btn"),ct=document.getElementById("side-bar");document.getElementById("round-info");const T=document.getElementById("season-of-move-select"),ne=document.getElementById("selection-highlight"),it=document.getElementById("start-game-form"),M=document.getElementById("start-game-overlay"),Se=document.getElementById("movement-arrows"),I=document.getElementById("movement-config"),X=I.querySelector('[name="troop-strength"]'),Le=I.querySelector('[name="troop-strength-value"]'),lt=I.querySelector('[name="min-troop-strength-value"]'),ut=I.querySelector('[name="max-troop-strength-value"]'),Q=I.querySelector('[name="settle-cell-toggle"]'),dt=re.querySelector(".cell-wrapper"),_t=re.querySelector(".movement-indicator"),mt=document.createElementNS("http://www.w3.org/2000/svg","path"),pt=re.querySelector(".player-border"),ft=document.getElementById("player-config-tmpl").content,yt=document.getElementById("structure-builder-tmpl").content,oe={tent:z("Tent",[v(n.wood,1),v(n.cloth,3)],[],0,{on(e){e.housing_capacity+=5},off(e){e.housing_capacity-=5}},[]),textile_factory:z("Textile Factory",[v(n.wood,15),v(n.stone,15)],[v(n.cloth,5)]),lumber_mill:z("Lumber Mill",[v(n.wood,15),v(n.stone,15)],[v(n.wood,5)]),quarry:z("Quarry",[v(n.wood,15),v(n.stone,15)],[v(n.stone,5)]),forge:z("Forge",[v(n.wood,5),v(n.stone,5)],[v(n.iron,1)]),farm:z("Farm",[v(n.wood,5),v(n.stone,5)],[v(n.food,5)]),distillery:z("Distillery",[v(n.wood,5),v(n.stone,5)],[v(n.alcohol,1)])};function z(e="Pretty Structure",t=[v(n.wood,5)],r=[v(n.wood,1)],a=1,s={on(d){d.foo+=5},off(d){d.foo-=5}},o=[m.swamp],c=[v(n.wood,1)],i=1){return{display_name:e,construction_cost:t,space_requirement:i,unsupported_biomes:o,effects:s,output:r,input:c,required_workers:a}}function v(e=n.wood,t=1){return{resource_name:e,amount:t}}function $e(e,t,r,a,s,o,c){const i=ht(e,t,r,a,s,o,c),d=i.querySelector(".population-size");let l=null,_=-1,f=0;return{cx:e,cy:t,x:r,y:a,q:s,r:o,s:c,neighbors:[],cell:i,elevation:0,humidity:p.arid,temperature:g.freezing,structures:new Map(Object.values(oe).map(u=>[u,0])),resources:{get[n.people](){return f},set[n.people](u){f=u,d.textContent=f>0?f:""},[n.gold]:0,[n.cloth]:0,[n.wood]:0,[n.stone]:0,[n.iron]:0,[n.food]:0,[n.alcohol]:0},get biome(){return l},set biome(u){l!==null&&i.classList.remove(l.name),u!==null&&i.classList.add(u.name),l=u},get owner_id(){return _},set owner_id(u){_=u,u!==-1&&(i.dataset.owner_id=u)},developable_land:10}}function ht(e,t,r,a,s,o,c){const i=dt.cloneNode(!0);return i.setAttribute("transform",`translate(${e}, ${t})`),i.querySelector(".q-coord").textContent=s,i.querySelector(".r-coord").textContent=o,i.querySelector(".s-coord").textContent=c,i.querySelector(".offset-coords").textContent=`${r}, ${a}`,ee.prepend(i),i}function qe(e){const t=[...e.values()];return t.forEach(r=>Object.assign(r,{biome:null,elevation:0,humidity:p.arid,temperature:g.freezing,resources:Object.keys(r.resources).reduce((a,s)=>(a[s]=0,a),r.resources),owner_id:-1})),ye(t),he(t),we(t),ge(t),ve(t),e}function gt(e,t){const r=e.map(({cx:a,cy:s,x:o,y:c,q:i,r:d,s:l,biome_name:_,elevation:f,humidity:u,temperature:S,owner_id:y,resources:R})=>{const P=$e(a,s,o,c,i,d,l);return Object.assign(P,{biome:m[_],elevation:f,humidity:u,temperature:S,owner_id:y}),Object.entries(R).forEach(([Re,Te])=>{P.resources[Re]=Te}),P});return fe(r),ke(r,t)}function vt(e,t){const r=wt(e);return fe(r),ye(r),he(r),we(r),ge(r),ve(r),ke(r,t)}function ke(e,t){return e.reduce((r,a)=>(r.set(a.cell,a),r),t)}function wt({height:e,width:t}){const r=[];for(let a=0;a<e;a+=1){const s=+!j(a);for(let o=0;o<t;o+=1){const c=o-(a-(a&1))/2;r.push($e(o*6+s*3,a*4.5,o,a,c,a,-c-a))}}return r}const Oe=.5,C=Oe*.5;function Ie(e,t,r){const a=[];e.reduce((o,c)=>{const i=c.neighbors.filter(y=>!e.includes(y)),d=bt(c),l=Et(c),_=qt(c),f=Lt(c),u=$t(c),S=St(c);return i.find(y=>y.r===c.r&&y.s===c.s+1)&&o.push(`M${f}L${S}`),i.find(y=>y.q===c.q&&y.s===c.s+1)&&o.push(`M${S}L${d}`),i.find(y=>y.s===c.s&&y.r===c.r-1)&&o.push(`M${d}L${u}`),i.find(y=>y.r===c.r&&y.s===c.s-1)&&o.push(`M${u}L${_}`),i.find(y=>y.q===c.q&&y.s===c.s-1)&&o.push(`M${_}L${l}`),i.find(y=>y.s===c.s&&y.r===c.r+1)&&o.push(`M${l}L${f}`),o},a);const s=mt.cloneNode(!0);s.setAttribute("d",a.join("")),s.setAttribute("stroke",t),s.setAttribute("stroke-width",Oe),r.append(s)}function bt(e){return`${e.cx+3} ${e.cy+C}`}function Et(e){return`${e.cx+3} ${e.cy+6-C}`}function St(e){return`${e.cx+C} ${e.cy+1.5+C*.5}`}function Lt(e){return`${e.cx+C} ${e.cy+4.5-C*.5}`}function $t(e){return`${e.cx+6-C} ${e.cy+1.5+C*.5}`}function qt(e){return`${e.cx+6-C} ${e.cy+4.5-C*.5}`}const kt={human:"human",ai:"ai"};function Ce(e){const t=ft.cloneNode(!0);Object.assign(t.querySelector(".player-name-input"),{name:`player-${e}-name`,value:`Player ${e}`}),t.querySelectorAll(".player-type-select-radio").forEach(r=>{r.name=`player-${e}-type`}),Ee.append(t)}function se(e,t="Player Name",r=kt.ai){const a=[],s=pt.cloneNode(!0);return document.getElementById("player-borders").append(s),{name:t,type:r,tax_rate:1,get resources(){return a.reduce((o,{resources:c})=>(Object.entries(c).forEach(([i,d])=>{o[i]+=d}),o),{[n.people]:0,[n.gold]:0,[n.cloth]:0,[n.wood]:0,[n.stone]:0,[n.iron]:0,[n.food]:0,[n.alcohol]:0})},border_path_container:s,get cells(){return a},set cells(o){a.push(...o),Ie(a,`var(--player-${e+1})`,s)},encampments:new Map,destroy(){a.length=0,s.remove()}}}function Be(e,t){K.querySelector("ul").replaceChildren(...ae(e)),K.querySelector("input").value=t,K.classList.remove("hidden")}function Ot(e,t){x.querySelector("ul").replaceChildren(...ae(e)),x.querySelector("fieldset").replaceChildren(...t),x.classList.remove("hidden")}function It(e,{wood:t,stone:r,cloth:a,food:s}){const o=Object.values(oe).filter(c=>!c.unsupported_biomes.includes(e.biome)).map(({display_name:c})=>`<li>${c}</li>`).join("");D.innerHTML=`
        <h2>Cell Info</h2>
        <div>Biome: ${e.biome.name}</div>
        <div>Movement modifier: ${e.biome.movement_speed}</div>
        <div>Pleasantness: ${e.biome.pleasantness}</div>
        ...
        <h3>Production</h3>
        <div>Wood: ${t}</div>
        <div>Stone: ${r}</div>
        <div>Cloth: ${a}</div>
        <div>Food: ${s}</div>
        <h3>Supported structures</h3>
        <ul>${o}</ul>
    `,D.classList.remove("hidden")}function ae(e){return Object.entries(e).map(([t,r])=>Object.assign(document.createElement("li"),{textContent:`${t}: ${r}`}))}function Ct(e){return Object.entries(oe).filter(([,t])=>!t.unsupported_biomes.includes(e.biome)).map(([t,r])=>{const a=yt.cloneNode(!0).lastElementChild,s=a.querySelector(".label-text"),o=a.querySelector(".structure-count");return a.dataset.structure_name=t,s.textContent=`${r.display_name}: `,o.textContent=e.structures.get(r),a.addEventListener("click",({target:c})=>{const i=c.closest("button");if(i===null)return;const d=i.classList.contains("construct-structure-btn"),l=r.construction_cost;let _=e.structures.get(r);if(d){if(e.developable_land<r.space_requirement||l.some(({resource_name:u,amount:S})=>S>h.active_player.resources[u]))return;_+=1,l.forEach(({resource_name:u,amount:S})=>{let y=S;for(const R of h.active_player.cells){const P=R.resources[u];if(P<y){y-=P,R.resources[u]=0;continue}else R.resources[u]-=y,y=0;if(y===0)break}}),e.developable_land-=r.space_requirement}else{if(_===0)return;_-=1,l.forEach(({resource_name:f,amount:u})=>{e.resources[f]+=u}),e.developable_land+=r.space_requirement}e.structures.set(r,_),o.textContent=_,x.querySelector("ul").replaceChildren(...ae(J([e],h.active_player.tax_rate))),h.update_resource_display()}),a})}function Bt(e){return({target:t})=>{const r=Number(t.value);t.name==="tax_rate"&&(e.active_player.tax_rate=r)}}let A=null;function Nt(e){e.owner_id===-1&&e.biome!==m.sea?(A=e,Ie([...e.neighbors,e],"white",ne),G.classList.add("hidden"),It(e,e.biome.resource_production)):(D.classList.add("hidden"),G.classList.remove("hidden"))}function Mt(e){A!==null&&(Object.entries(Xe).forEach(([t,r])=>{A.resources[t]=r}),A.owner_id=e.current_player_id,e.active_player.cells=[A],A.cell.classList.remove("clicked"),A=null)}function zt(e,t){e.owner_id===t.current_player_id?(K.classList.add("hidden"),Ot(J([e],t.active_player.tax_rate),Ct(e))):(x.classList.add("hidden"),Be(J(t.active_player.cells,t.active_player.tax_rate),t.active_player.tax_rate))}const E=[],Ne="wargame-planned-moves";function At(){localStorage.setItem(Ne,JSON.stringify(E.map(e=>e.map(({origin:t,target:r,units:a,season:s})=>({origin:{cx:t.cx,cy:t.cy},target:{cx:r.cx,cy:r.cy},units:a,season:s})))))}function Pt(e){const t=JSON.parse(localStorage.getItem(Ne)),r=[...e.board.values()];t.forEach(a=>{E.push(a.map(({origin:s,target:o,units:c,season:i})=>Me(r.find(({cx:d,cy:l})=>d===s.cx&&l===s.cy),r.find(({cx:d,cy:l})=>d===o.cx&&l===o.cy),c,i)))})}function Me(e,t,r,a,s){const o=xt(e,t,r);return{season:a,origin:e,target:t,units:r,type:s,arrow:o}}function xt(e,t,r){const s={x:e.cx+3,y:e.cy+3},o={x:t.cx+3,y:t.cy+3},c=`M${s.x} ${s.y}A 3 3 0 0 0 ${o.x} ${o.y}`,i=_t.cloneNode(!0),d=i.lastElementChild.lastElementChild;return i.firstElementChild.setAttribute("d",c),d.setAttribute("path",c),d.textContent=r,Se.append(i),i}function ze(){E.length=0,Se.replaceChildren()}const $={spring:"spring",summer:"summer",autumn:"autumn",winter:"winter"};function Rt(e){switch(e){case $.spring:return $.summer;case $.summer:return $.autumn;case $.autumn:return $.winter}}function V(e,t){return!(t===e||e===$.winter||e===$.summer&&t===$.spring||e===$.autumn&&t!==$.winter)}let w=null,B=null;function Tt(e,t){if(w===null){Ut(e,t);return}if(e.cell.classList.remove("clicked"),w===e){w=null;return}if(!e.neighbors.includes(w))return;B=e;const r=E[t.current_player_id].find(({origin:_,target:f})=>_===w&&f===B),a=w.owner_id===t.current_player_id,s=B.owner_id===t.current_player_id;let o,c,i,d=!1,l=$.spring;if(Object.values($).forEach(_=>{T.querySelector(`input[value="${_}"]`).disabled=!1}),T.inert=!1,Q.inert=s,r)d=r.type==="settle",o=r.units,l=r.season,i=E[t.current_player_id].filter(({season:_,origin:f})=>V(r.season,_)&&r.target===f).reduce((_,{season:f,origin:u,units:S})=>(U(E[t.current_player_id],u,f,u.owner_id===t.current_player_id?u.resources[n.people]:0)-r.units<S&&(_+=S),_),0),T.inert=!0,Q.inert=!0,a?c=U(E[t.current_player_id],w,l,w.resources[n.people])-1+o:c=U(E[t.current_player_id],w,l)-Number(d)+o;else if(o=0,i=0,a)c=U(E[t.current_player_id],w,l,w.resources[n.people])-1;else{const _=E[t.current_player_id].filter(({target:u})=>u===w).reduce((u,{season:S})=>((u===""||V(S,u))&&(u=S),u),""),f=!!E[t.current_player_id].find(({target:u,type:S,season:y})=>u===w&&y===_&&S==="settle");if(_===$.winter){B=null;return}Object.values($).filter(u=>u===_||V(u,_)).forEach(u=>{T.querySelector(`input[value="${u}"]`).disabled=!0}),l=Rt(_),c=U(E[t.current_player_id],w,l)-Number(f)}if(c<=0){B=null;return}T.querySelector(`input[value="${l}"]`).checked=!0,Object.assign(X,{value:o,min:i,max:c}),Le.value=o,lt.value=i,ut.value=c,Q.checked=d,I.showModal()}function Ut(e,t){const r=e.owner_id===t.current_player_id&&e.resources[n.people]>1,a=E[t.current_player_id].find(({origin:c})=>c===e),s=E[t.current_player_id].find(({target:c,season:i})=>c===e&&i!=="winter"),o=t.active_player.encampments.has(e);r||a||s||o?w=e:e.cell.classList.remove("clicked")}function U(e,t,r,a=0){return e.filter(({origin:s,target:o,season:c})=>(s===t||o===t)&&(c===r||V(c,r))).reduce((s,o)=>(t===o.target?s+=o.units:s-=o.units,s),a)}function Jt(e){return()=>{const t=I.querySelector('[name="season-of-move"]:checked').value,r=Number(X.value),a=Q.checked,s=E[e.current_player_id].findIndex(({origin:o,target:c})=>o===w&&c===B);if(Number.isNaN(r)||r<=0){if(w=null,B=null,s>-1){const[{arrow:o}]=E[e.current_player_id].splice(s,1);o.remove()}return}if(s>-1){const o=E[e.current_player_id][s];o.units=r,o.arrow.lastElementChild.lastElementChild.textContent=r}else E[e.current_player_id].push(Me(w,B,r,t,a?"settle":"unspecified"));w=null,B=null}}const O={land_grab:H("land_grab","Pick your origin","Confirm choice",Nt),development:H("development","Distribute your wealth",void 0,zt),movement_planning:H("movement_planning","Make your moves",void 0,Tt),movement_execution:H("movement_execution","See what you have done")};function Dt(e){return()=>{e.current_phase===O.land_grab.name&&Mt(e),e.next_turn()}}function H(e="round_phase",t=e,r="End turn",a=(s,o)=>{}){return{name:e,call_to_action:t,end_turn_btn_label:r,handle_click_on_cell:a}}const ce=new Map,Ae="wargame-board";function Ft(){localStorage.setItem(Ae,JSON.stringify([...ce.values()].map(({cx:e,cy:t,x:r,y:a,q:s,r:o,s:c,biome:{name:i},elevation:d,humidity:l,temperature:_,owner_id:f,resources:u})=>({cx:e,cy:t,x:r,y:a,q:s,r:o,s:c,biome_name:i,elevation:d,humidity:l,temperature:_,owner_id:f,resources:u}))))}function Ht(e){const t=JSON.parse(localStorage.getItem(Ae));gt(t,ce),e.players.forEach((r,a)=>{r.cells=[...e.board.values()].filter(s=>s.owner_id===a)})}const q=[];let Z=0,N=O.land_grab.name,k=0,Pe=null;const h={board:ce,get round(){return Z},set round(e){Z=e},get active_player(){return q[k]},get players(){return q},set players(e){q.push(...e)},get current_player_id(){return k},set current_player_id(e){k=e},get current_player_total_production(){return Pe},clear_players(){q.forEach(e=>e.destroy()),q.length=0},get current_phase(){return N},set current_phase(e){N=e},update_resource_display:xe,next_turn(){ne.replaceChildren(),k===q.length-1?(k=0,N=(()=>{switch(N){case O.development.name:return ze(),q.forEach(()=>E.push([])),O.movement_planning.name;case O.movement_planning.name:return O.movement_execution.name;default:return Z+=1,O.development.name}})()):k+=1,_e()},run:_e};function _e(){be.textContent=O[N].end_turn_btn_label,ot.textContent=O[N].call_to_action,st.textContent=q[k].name,document.body.dataset.current_phase=O[N].name,document.documentElement.style.setProperty("--active-player-color",`var(--player-${k+1}`),N===O.land_grab.name&&(D.classList.add("hidden"),G.classList.remove("hidden")),N===O.development.name?(D.classList.add("hidden"),G.classList.add("hidden"),Pe=J(q[k].cells,q[k].tax_rate),x.classList.add("hidden"),Be(J(q[k].cells,q[k].tax_rate),q[k].tax_rate),te.classList.remove("content-hidden"),xe()):te.classList.add("content-hidden")}function xe(){te.replaceChildren(...Object.entries(q[k].resources).map(([e,t])=>Object.assign(document.createElement("div"),{textContent:`${e}: ${t}`})))}const me="wargame-savegame";function Wt(){if(h.players.length===0){localStorage.removeItem(me);return}localStorage.setItem(me,JSON.stringify({round:h.round,current_phase:h.current_phase,current_player_id:h.current_player_id,players:h.players.map(({name:e,type:t})=>({name:e,type:t}))}))}function Yt(e,t){const r=JSON.parse(t);Object.assign(e,{round:r.round,current_phase:r.current_phase,current_player_id:r.current_player_id,players:r.players.map(({name:a,type:s},o)=>se(o,a,s))})}window.addEventListener("DOMContentLoaded",()=>{const e=localStorage.getItem("wargame-savegame"),t=e!==null;M.dataset.priorSave=t,M.showModal(),t?(Yt(h,e),Ht(h)):vt(b,h.board),Pt(h)},{once:!0});document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&(Wt(),Ft(),At())});document.addEventListener("submit",He);X.addEventListener("input",()=>{Le.value=X.value});it.addEventListener("submit",e=>{e.submitter.id==="continue-btn"?M.dataset.priorSave==="true"&&M.close():e.submitter.id==="new-game-btn"&&(M.dataset.priorSave==="true"&&(Object.assign(h,{round:0,current_phase:O.land_grab.name,current_player_id:0}),qe(h.board),h.clear_players(),ze()),Array.from({length:2},(t,r)=>Ce(r+1)),M.classList.add("game-config"))});M.addEventListener("close",()=>{h.players.length===0&&(h.players=Array.from({length:2},(e,t)=>se(t,`Player ${t+1}`,"human"))),h.run()});at.addEventListener("click",()=>qe(h.board));be.addEventListener("click",Dt(h));de.addEventListener("submit",()=>{const e=new Set,t=[...de.querySelectorAll(".player-name-input")];if(t.reduce((r,{value:a})=>(r[a]=a in r?r[a]+1:1,r[a]>1&&e.add(a),r),{}),e.size>0){t.forEach(r=>{e.has(r.value)&&r.classList.add("invalid")});return}h.players=Array.from(F,(r,a)=>{const s=r.querySelector(".player-name-input").value,o=r.querySelector(".player-type-select-radio:checked").value;return se(a,s,o)}),M.close()});tt.addEventListener("click",()=>{F.length!==5&&Ce(F.length+1)});Ee.addEventListener("click",({target:e})=>{e.closest(".delete-player-btn")&&F.length!==2&&(e.closest(".player-config").remove(),[...F].forEach((t,r)=>{r=r+1,Object.assign(t.querySelector(".player-name-input"),{name:`player-${r}-name`,value:`Player ${r}`}),t.querySelectorAll(".player-type-select-radio").forEach(a=>{a.name=`player-${r}-type`})}))});ee.addEventListener("click",({target:e})=>{const t=e.closest(".cell-wrapper");if(!t)return;const r=ee.querySelector(".clicked"),a=h.board.get(t);r&&(r.classList.remove("clicked"),ne.replaceChildren()),r!==t&&t.classList.add("clicked"),Kt(a),O[h.current_phase].handle_click_on_cell(a,h)});ct.addEventListener("input",Bt(h));I.addEventListener("close",Jt(h));I.addEventListener("submit",()=>I.close());document.querySelector("h1").addEventListener("dblclick",()=>document.body.classList.toggle("debug"));nt.addEventListener("click",()=>document.body.classList.toggle("use-offset-coords"));function Kt(e){rt.textContent=JSON.stringify(e,(t,r)=>t==="neighbors"?void 0:r,4)}
