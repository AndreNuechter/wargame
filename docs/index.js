(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const i of r.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&o(i)}).observe(document,{childList:!0,subtree:!0});function n(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(s){if(s.ep)return;s.ep=!0;const r=n(s);fetch(s.href,r)}})();const We=""+new URL("service-worker.js",import.meta.url).href;window.navigator.serviceWorker.register(We).catch(console.error);let K;de(),document.addEventListener("visibilitychange",()=>{document.hidden?Ye():de()});async function de(){var e,t;K=await((t=(e=navigator.wakeLock)==null?void 0:e.request)==null?void 0:t.call(e,"screen"))}async function Ye(){K&&(await K.release(),K=void 0)}const w={width:30,height:24};function ne(e){return e%2===0}function Ke(e,t,n){return e>=t&&e<=n}function ge(e,t=0,n=e.length){return e[P(n,t)]}function P(e,t=0){return Math.trunc(Math.random()*(e-t)+t)}function ve(e){return Object.freeze(Object.assign(Object.create(null),e))}function Qe(e){e.preventDefault()}function we(e){e.forEach(t=>{t.neighbors=Ve(t,e,w)})}function Ve({q:e,r:t,s:n,x:o,y:s},r,i){const l=[{q:1,r:0,s:-1},{q:1,r:-1,s:0},{q:0,r:1,s:-1},{q:0,r:-1,s:1},{q:-1,r:0,s:1},{q:-1,r:1,s:0}].map(u=>r.find(m=>m.q===e+u.q&&m.r===t+u.r&&m.s===n+u.s)).filter(Boolean);return o===0&&(l.push(r.find(u=>s===u.y&&u.x===i.width-1)),ne(s)&&l.push(...[s<i.height-1?r.find(u=>s+1===u.y&&u.x===i.width-1):null,s>0?r.find(u=>s-1===u.y&&u.x===i.width-1):null].filter(Boolean))),o===i.width-1&&(l.push(r.find(u=>s===u.y&&u.x===0)),ne(s)||l.push(...[s<i.height-1?r.find(u=>s+1===u.y&&u.x===0):null,s>0?r.find(u=>s-1===u.y&&u.x===0):null].filter(Boolean))),l}const g={freezing:"freezing",cold:"cold",temperate:"temperate",warm:"warm",hot:"hot"};function be(e){e.forEach(t=>{const n=Math.random(),o=-1,s=Ke(n,.3,.7)?0:1*(-1*+(n<.3)),r=(i=>i<0?0:i>w.height-1?w.height-1:i)(t.y+s+o);t.temperature=Ge(r)})}function Ge(e){switch(e){case 0:case 1:case w.height-2:case w.height-1:return g.freezing;case 2:case 3:case w.height-4:case w.height-3:return g.cold;case 4:case 5:case w.height-6:case w.height-5:return g.temperate;case 6:case 7:case 8:case w.height-9:case w.height-8:case w.height-7:return g.warm;default:return g.hot}}function Xe(e){switch(e){case g.hot:return g.warm;case g.warm:return g.temperate;case g.temperate:return g.cold;default:return g.freezing}}function Ze(e){switch(e){case g.freezing:return g.cold;case g.cold:return g.temperate;case g.temperate:return g.warm;default:return g.hot}}const _e=new Set([0,1,2,w.height-1,w.height-2,w.height-3]);function Ee(e){const o=e.length/2.5;let s=0;for(;s<o;){const r=P(13,4),i={x:P(w.width),y:P(w.height-3,3)},c=e.find(({x:m,y:h})=>m===i.x&&h===i.y),l=new Set(c.neighbors.filter(({y:m})=>!_e.has(m))),u=new Set;s+=r,pe(c),u.add(c);for(let m=0;m<r;m+=1){const h=ge([...l]);pe(h),u.add(h),l.delete(h),h.neighbors.filter(p=>!u.has(p)).filter(({y:p})=>!_e.has(p)).forEach(p=>l.add(p))}}e.filter(r=>r.elevation>0).forEach(r=>{const i=r.neighbors.filter(l=>l.elevation>0).length;if(i>=3)return;const c=Math.random();(i===2&&c>.7||i===1&&c<.7)&&je(r)})}function pe(e){e.elevation+=1,e.elevation>1&&(e.temperature=Xe(e.temperature))}function je(e){e.elevation=Math.max(0,e.elevation-1),e.elevation>0&&(e.temperature=Ze(e.temperature))}const _={arid:"arid",dry:"dry",moderate:"moderate",moist:"moist",wet:"wet"};function et(e){switch(e){case _.arid:return _.dry;case _.dry:return _.moderate;case _.moderate:return _.moist;default:return _.wet}}function Se(e){e.filter(t=>t.elevation>0).forEach(t=>{t.neighbors.filter(({biome:n})=>n===d.sea).forEach(()=>{t.humidity=et(t.humidity)})})}const a=ve({people:"people",gold:"gold",cloth:"cloth",wood:"wood",stone:"stone",iron:"iron",food:"food",alcohol:"alcohol"}),tt=ve({[a.people]:5,[a.gold]:5,[a.cloth]:25,[a.wood]:25,[a.stone]:25,[a.iron]:0,[a.food]:50,[a.alcohol]:5});function F(e,t=1){const n={[a.people]:0,[a.gold]:0,[a.cloth]:0,[a.wood]:0,[a.stone]:0,[a.iron]:0,[a.food]:0,[a.alcohol]:0};let o=0;return e.forEach(s=>{o+=s.resources.people,Object.entries(s.biome.resource_production).forEach(([r,i])=>{n[r]+=i}),[...s.structures.entries()].forEach(([r,i])=>{r.output.forEach(({resource_name:c,amount:l})=>{n[c]+=l*i})});for(let r=0;r<Math.floor(s.resources.people/2);r+=1){const i=Math.random();i<.3?n[a.people]+=2:i<.8&&(n[a.people]+=1)}}),n[a.gold]=o*t,n}const d={sea:new L("sea",{[a.food]:1}),mountain:new L("mountain",{[a.wood]:2,[a.stone]:5,[a.food]:3}),high_mountain:new L("high_mountain",{[a.stone]:5}),ice:new L("ice",{[a.food]:2}),tundra:new L("tundra",{[a.cloth]:1,[a.wood]:2,[a.stone]:1,[a.food]:5}),grassland:new L("grassland",{[a.cloth]:3,[a.wood]:2,[a.stone]:2,[a.food]:5}),savanna:new L("savanna",{[a.cloth]:5,[a.wood]:5,[a.stone]:3,[a.food]:6}),boreal_forest:new L("boreal_forest",{[a.cloth]:4,[a.wood]:10,[a.stone]:3,[a.food]:5}),forest:new L("forest",{[a.cloth]:2,[a.wood]:10,[a.stone]:2,[a.food]:5}),tropical_rainforest:new L("tropical_rainforest",{[a.cloth]:3,[a.wood]:7,[a.stone]:1,[a.food]:5}),cold_swamp:new L("cold_swamp",{[a.cloth]:1,[a.wood]:2,[a.stone]:1,[a.food]:2}),swamp:new L("swamp",{[a.cloth]:1,[a.wood]:1,[a.stone]:0,[a.food]:3}),tropical_swamp:new L("tropical_swamp",{[a.cloth]:1,[a.wood]:3,[a.stone]:1,[a.food]:3}),desert:new L("desert",{[a.cloth]:1,[a.wood]:0,[a.stone]:2,[a.food]:1}),extreme_desert:new L("extreme_desert",{[a.cloth]:0,[a.wood]:0,[a.stone]:1,[a.food]:0})},nt={[g.freezing]:{[_.arid]:d.tundra,[_.dry]:d.tundra,[_.moderate]:d.tundra,[_.moist]:d.boreal_forest,[_.wet]:d.boreal_forest},[g.cold]:{[_.arid]:d.tundra,[_.dry]:d.tundra,[_.moderate]:d.boreal_forest,[_.moist]:d.boreal_forest,[_.wet]:d.boreal_forest},[g.temperate]:{[_.arid]:d.tundra,[_.dry]:d.forest,[_.moderate]:d.forest,[_.moist]:d.forest,[_.wet]:d.swamp},[g.warm]:{[_.arid]:d.desert,[_.dry]:d.grassland,[_.moderate]:d.savanna,[_.moist]:d.forest,[_.wet]:d.tropical_swamp},[g.hot]:{[_.arid]:d.extreme_desert,[_.dry]:d.desert,[_.moderate]:d.grassland,[_.moist]:d.savanna,[_.wet]:d.tropical_rainforest}};function L(e="",t={},n=1,o=1){return{name:e,resource_production:Object.assign({[a.gold]:0,[a.cloth]:0,[a.wood]:0,[a.stone]:0,[a.iron]:0,[a.food]:0,[a.alcohol]:0},t),movement_speed:n,pleasantness:o}}function Le(e){e.forEach(t=>{t.biome=ot(t)})}function $e(e){e.filter(({elevation:t})=>t===0).forEach(t=>{t.biome=rt(t)})}function rt(e,t=w.height){const n=Math.random();return[0,t-1].includes(e.y)?n<=.1?d.sea:d.ice:[1,t-2].includes(e.y)?n<=.75?d.sea:d.ice:[2,t-3].includes(e.y)?n<=.9?d.sea:d.ice:d.sea}function ot(e){return e.biome?e.biome:e.elevation>1?e.elevation>2?d.high_mountain:d.mountain:nt[e.temperature][e.humidity]}const st=document.getElementById("add-player-btn"),re=document.getElementById("board"),oe=document.getElementById("bottom-bar"),H=document.getElementById("cell-info"),at=document.getElementById("cell-debug-info"),R=document.getElementById("cell-production-forecast"),it=document.getElementById("toggle-coord-system-btn"),me=document.getElementById("config-game-form"),se=document.getElementById("defs"),U=document.getElementById("end-turn-btn"),G=document.getElementById("general-info"),Q=document.getElementById("overall-production-forecast"),ke=document.getElementById("phase-label"),W=document.getElementsByClassName("player-config"),ee=document.getElementById("player-name"),qe=document.getElementById("player-setup"),ct=document.getElementById("reroll-map-btn"),lt=document.getElementById("side-bar");document.getElementById("round-info");const J=document.getElementById("season-of-move-select"),ae=document.getElementById("selection-highlight"),ut=document.getElementById("start-game-form"),N=document.getElementById("start-game-overlay"),Oe=document.getElementById("movement-arrows"),I=document.getElementById("movement-config"),X=I.querySelector('[name="troop-strength"]'),Ce=I.querySelector('[name="troop-strength-value"]'),dt=I.querySelector('[name="min-troop-strength-value"]'),_t=I.querySelector('[name="max-troop-strength-value"]'),Z=I.querySelector('[name="settle-cell-toggle"]'),pt=se.querySelector(".cell-wrapper"),mt=se.querySelector(".movement-indicator"),ft=document.createElementNS("http://www.w3.org/2000/svg","path"),yt=se.querySelector(".player-border"),ht=document.getElementById("player-config-tmpl").content,gt=document.getElementById("structure-builder-tmpl").content,ie={tent:x("Tent",[v(a.wood,1),v(a.cloth,3)],[],0,{on(e){e.housing_capacity+=5},off(e){e.housing_capacity-=5}},[]),textile_factory:x("Textile Factory",[v(a.wood,15),v(a.stone,15)],[v(a.cloth,5)]),lumber_mill:x("Lumber Mill",[v(a.wood,15),v(a.stone,15)],[v(a.wood,5)]),quarry:x("Quarry",[v(a.wood,15),v(a.stone,15)],[v(a.stone,5)]),forge:x("Forge",[v(a.wood,5),v(a.stone,5)],[v(a.iron,1)]),farm:x("Farm",[v(a.wood,5),v(a.stone,5)],[v(a.food,5)]),distillery:x("Distillery",[v(a.wood,5),v(a.stone,5)],[v(a.alcohol,1)])};function x(e="Pretty Structure",t=[v(a.wood,5)],n=[v(a.wood,1)],o=1,s={on(l){l.foo+=5},off(l){l.foo-=5}},r=[d.swamp],i=[v(a.wood,1)],c=1){return{display_name:e,construction_cost:t,space_requirement:c,unsupported_biomes:r,effects:s,output:n,input:i,required_workers:o}}function v(e=a.wood,t=1){return{resource_name:e,amount:t}}function Ie(e,t,n,o,s,r,i){const c=vt(e,t,n,o,s,r,i),l=c.querySelector(".population-size");let u=null,m=-1,h=0;return{cx:e,cy:t,x:n,y:o,q:s,r,s:i,neighbors:[],cell:c,elevation:0,humidity:_.arid,temperature:g.freezing,structures:new Map(Object.values(ie).map(p=>[p,0])),resources:{get[a.people](){return h},set[a.people](p){h=p,l.textContent=h>0?h:""},[a.gold]:0,[a.cloth]:0,[a.wood]:0,[a.stone]:0,[a.iron]:0,[a.food]:0,[a.alcohol]:0},get biome(){return u},set biome(p){u!==null&&c.classList.remove(u.name),p!==null&&c.classList.add(p.name),u=p},get owner_id(){return m},set owner_id(p){m=p,p!==-1&&(c.dataset.owner_id=p)},developable_land:10}}function vt(e,t,n,o,s,r,i){const c=pt.cloneNode(!0);return c.setAttribute("transform",`translate(${e}, ${t})`),c.querySelector(".q-coord").textContent=s,c.querySelector(".r-coord").textContent=r,c.querySelector(".s-coord").textContent=i,c.querySelector(".offset-coords").textContent=`${n}, ${o}`,re.prepend(c),c}function Be(e){const t=[...e.values()];return t.forEach(n=>Object.assign(n,{biome:null,elevation:0,humidity:_.arid,temperature:g.freezing,resources:Object.keys(n.resources).reduce((o,s)=>(o[s]=0,o),n.resources),owner_id:-1})),be(t),Ee(t),$e(t),Se(t),Le(t),e}function wt(e,t){const n=e.map(({cx:o,cy:s,x:r,y:i,q:c,r:l,s:u,biome_name:m,elevation:h,humidity:p,temperature:O,owner_id:y,resources:T})=>{const A=Ie(o,s,r,i,c,l,u);return Object.assign(A,{biome:d[m],elevation:h,humidity:p,temperature:O,owner_id:y}),Object.entries(T).forEach(([Fe,He])=>{A.resources[Fe]=He}),A});return we(n),Me(n,t)}function bt(e,t){const n=Et(e);return we(n),be(n),Ee(n),$e(n),Se(n),Le(n),Me(n,t)}function Me(e,t){return e.reduce((n,o)=>(n.set(o.cell,o),n),t)}function Et({height:e,width:t}){const n=[];for(let o=0;o<e;o+=1){const s=+!ne(o);for(let r=0;r<t;r+=1){const i=r-(o-(o&1))/2;n.push(Ie(r*6+s*3,o*4.5,r,o,i,o,-i-o))}}return n}const Ne=.5,B=Ne*.5;function V(e,t,n){const o=[];e.reduce((r,i)=>{const c=i.neighbors.filter(y=>!e.includes(y)),l=St(i),u=Lt(i),m=Ot(i),h=kt(i),p=qt(i),O=$t(i);return c.find(y=>y.r===i.r&&y.s===i.s+1)&&r.push(`M${h}L${O}`),c.find(y=>y.q===i.q&&y.s===i.s+1)&&r.push(`M${O}L${l}`),c.find(y=>y.s===i.s&&y.r===i.r-1)&&r.push(`M${l}L${p}`),c.find(y=>y.r===i.r&&y.s===i.s-1)&&r.push(`M${p}L${m}`),c.find(y=>y.q===i.q&&y.s===i.s-1)&&r.push(`M${m}L${u}`),c.find(y=>y.s===i.s&&y.r===i.r+1)&&r.push(`M${u}L${h}`),r},o);const s=ft.cloneNode(!0);s.setAttribute("d",o.join("")),s.setAttribute("stroke",t),s.setAttribute("stroke-width",Ne),n.append(s)}function St(e){return`${e.cx+3} ${e.cy+B}`}function Lt(e){return`${e.cx+3} ${e.cy+6-B}`}function $t(e){return`${e.cx+B} ${e.cy+1.5+B*.5}`}function kt(e){return`${e.cx+B} ${e.cy+4.5-B*.5}`}function qt(e){return`${e.cx+6-B} ${e.cy+1.5+B*.5}`}function Ot(e){return`${e.cx+6-B} ${e.cy+4.5-B*.5}`}const Ct={human:"human",ai:"ai"};function xe(e){const t=ht.cloneNode(!0);Object.assign(t.querySelector(".player-name-input"),{name:`player-${e}-name`,value:`Player ${e}`}),t.querySelectorAll(".player-type-select-radio").forEach(n=>{n.name=`player-${e}-type`}),qe.append(t)}function ce(e,t="Player Name",n=Ct.ai){const o=new Set,s=yt.cloneNode(!0);return document.getElementById("player-borders").append(s),{name:t,type:n,tax_rate:1,get resources(){return[...o].reduce((r,{resources:i})=>(Object.entries(i).forEach(([c,l])=>{r[c]+=l}),r),{[a.people]:0,[a.gold]:0,[a.cloth]:0,[a.wood]:0,[a.stone]:0,[a.iron]:0,[a.food]:0,[a.alcohol]:0})},border_path_container:s,get cells(){return o},set cells(r){r.forEach(i=>o.add(i)),V([...o],`var(--player-${e+1})`,s)},add_cell(r){o.add(r),V([...o],`var(--player-${e+1})`,s)},delete_cell(r){o.delete(r),V([...o],`var(--player-${e+1})`,s)},encampments:new Map,destroy(){o.clear(),s.remove()}}}function ze(e,t){Q.querySelector("ul").replaceChildren(...le(e)),Q.querySelector("input").value=t,Q.classList.remove("hidden")}function It(e,t){R.querySelector("ul").replaceChildren(...le(e)),R.querySelector("fieldset").replaceChildren(...t),R.classList.remove("hidden")}function Bt(e,{wood:t,stone:n,cloth:o,food:s}){const r=Object.values(ie).filter(i=>!i.unsupported_biomes.includes(e.biome)).map(({display_name:i})=>`<li>${i}</li>`).join("");H.innerHTML=`
        <h2>Cell Info</h2>
        <div>Biome: ${e.biome.name}</div>
        <div>Movement modifier: ${e.biome.movement_speed}</div>
        <div>Pleasantness: ${e.biome.pleasantness}</div>
        ...
        <h3>Production</h3>
        <div>Wood: ${t}</div>
        <div>Stone: ${n}</div>
        <div>Cloth: ${o}</div>
        <div>Food: ${s}</div>
        <h3>Supported structures</h3>
        <ul>${r}</ul>
    `,H.classList.remove("hidden")}function le(e){return Object.entries(e).map(([t,n])=>Object.assign(document.createElement("li"),{textContent:`${t}: ${n}`}))}function Mt(e){return Object.entries(ie).filter(([,t])=>!t.unsupported_biomes.includes(e.biome)).map(([t,n])=>{const o=gt.cloneNode(!0).lastElementChild,s=o.querySelector(".label-text"),r=o.querySelector(".structure-count");return o.dataset.structure_name=t,s.textContent=`${n.display_name}: `,r.textContent=e.structures.get(n),o.addEventListener("click",({target:i})=>{const c=i.closest("button");if(c===null)return;const l=c.classList.contains("construct-structure-btn"),u=n.construction_cost;let m=e.structures.get(n);if(l){if(e.developable_land<n.space_requirement||u.some(({resource_name:p,amount:O})=>O>f.active_player.resources[p]))return;m+=1,u.forEach(({resource_name:p,amount:O})=>{let y=O;for(const T of f.active_player.cells){const A=T.resources[p];if(A<y){y-=A,T.resources[p]=0;continue}else T.resources[p]-=y,y=0;if(y===0)break}}),e.developable_land-=n.space_requirement}else{if(m===0)return;m-=1,u.forEach(({resource_name:h,amount:p})=>{e.resources[h]+=p}),e.developable_land+=n.space_requirement}e.structures.set(n,m),r.textContent=m,R.querySelector("ul").replaceChildren(...le(F([e],f.active_player.tax_rate))),f.update_resource_display()}),o})}function Nt(e){return({target:t})=>{const n=Number(t.value);t.name==="tax_rate"&&(e.active_player.tax_rate=n)}}const q=[],Ae="wargame-planned-moves";function xt(){localStorage.setItem(Ae,JSON.stringify(q.map(({player_id:e,origin:t,target:n,units:o,season:s})=>({player_id:e,origin:{cx:t.cx,cy:t.cy},target:{cx:n.cx,cy:n.cy},units:o,season:s}))))}function zt(e){const t=JSON.parse(localStorage.getItem(Ae)),n=[...e.board.values()];q.push(...t.map(({player_id:o,origin:s,target:r,units:i,season:c})=>Pe(o,n.find(({cx:l,cy:u})=>l===s.cx&&u===s.cy),n.find(({cx:l,cy:u})=>l===r.cx&&u===r.cy),i,c)))}function Pe(e,t,n,o,s,r){const i=At(t,n,o);return{player_id:e,origin:t,target:n,season:s,units:o,type:r,arrow:i}}function At(e,t,n){const s={x:e.cx+3,y:e.cy+3},r={x:t.cx+3,y:t.cy+3},i=`M${s.x} ${s.y}A 3 3 0 0 0 ${r.x} ${r.y}`,c=mt.cloneNode(!0),l=c.lastElementChild.lastElementChild;return c.firstElementChild.setAttribute("d",i),l.setAttribute("path",i),l.textContent=n,Oe.append(c),c}function Re(){q.length=0,Oe.replaceChildren()}const ue=new Map,Te="wargame-board";function Pt(){localStorage.setItem(Te,JSON.stringify([...ue.values()].map(({cx:e,cy:t,x:n,y:o,q:s,r,s:i,biome:{name:c},elevation:l,humidity:u,temperature:m,owner_id:h,resources:p})=>({cx:e,cy:t,x:n,y:o,q:s,r,s:i,biome_name:c,elevation:l,humidity:u,temperature:m,owner_id:h,resources:p}))))}function Rt(e){const t=JSON.parse(localStorage.getItem(Te));wt(t,ue),e.players.forEach((n,o)=>{n.cells=[...e.board.values()].filter(s=>s.owner_id===o)})}let z=null;function Tt(e){e.owner_id===-1&&e.biome!==d.sea?(z=e,V([...e.neighbors,e],"white",ae),G.classList.add("hidden"),Bt(e,e.biome.resource_production)):(H.classList.add("hidden"),G.classList.remove("hidden"))}function Ut(e){z!==null&&(Object.entries(tt).forEach(([t,n])=>{z.resources[t]=n}),z.owner_id=e.current_player_id,e.active_player.add_cell(z),z.cell.classList.remove("clicked"),z=null)}function Jt(e,t){e.owner_id===t.current_player_id?(Q.classList.add("hidden"),It(F([e],t.active_player.tax_rate),Mt(e))):(R.classList.add("hidden"),ze(F(t.active_player.cells,t.active_player.tax_rate),t.active_player.tax_rate))}const E={spring:"spring",summer:"summer",autumn:"autumn",winter:"winter"};function Dt(e){switch(e){case E.spring:return E.summer;case E.summer:return E.autumn;case E.autumn:return E.winter}}function j(e,t){return!(e===t||e===E.winter||e===E.summer&&t===E.spring||e===E.autumn&&t!==E.winter)}let b=null,M=null;function Ft(e,t){if(b===null){Yt(e,t);return}if(e.cell.classList.remove("clicked"),b===e){b=null;return}if(!e.neighbors.includes(b))return;M=e;const n=q.find(({player_id:i,origin:c,target:l})=>i===t.current_player_id&&c===b&&l===M),o=b.owner_id===t.current_player_id,s=M.owner_id===t.current_player_id,r={settle_cell:!1,season:E.spring};if(Object.values(E).forEach(i=>{J.querySelector(`input[value="${i}"]`).disabled=!1}),J.inert=!1,Z.inert=s,n?Ht(n,t,o,r):Wt(t,o,r),r.max_value<=0){M=null;return}J.querySelector(`input[value="${r.season}"]`).checked=!0,Object.assign(X,{value:r.current_value,min:r.min_value,max:r.max_value}),Ce.value=r.current_value,dt.value=r.min_value,_t.value=r.max_value,Z.checked=r.settle_cell,I.showModal()}function Ht(e,t,n,o){const s=q.filter(({player_id:r})=>r===t.current_player_id);o.settle_cell=e.type==="settle",o.current_value=e.units,o.season=e.season,o.min_value=s.filter(({season:r,origin:i})=>j(e.season,r)&&e.target===i).reduce((r,{season:i,origin:c,units:l})=>(D(s,c,i,c.owner_id===t.current_player_id?c.resources[a.people]:0)-e.units<l&&(r+=l),r),0),J.inert=!0,Z.inert=!0,n?o.max_value=D(s,b,o.season,b.resources[a.people])-1+o.current_value:o.max_value=D(s,b,o.season)-Number(o.settle_cell)+o.current_value}function Wt(e,t,n){const o=q.filter(({player_id:s})=>s===e.current_player_id);if(n.current_value=0,n.min_value=0,t)n.max_value=D(o,b,n.season,b.resources[a.people])-1;else{const s=o.filter(({target:i})=>i===b).reduce((i,{season:c})=>((i===""||j(c,i))&&(i=c),i),""),r=!!o.find(({target:i,type:c,season:l})=>i===b&&l===s&&c==="settle");if(s===E.winter){M=null;return}Object.values(E).filter(i=>i===s||j(i,s)).forEach(i=>{J.querySelector(`input[value="${i}"]`).disabled=!0}),n.season=Dt(s),n.max_value=D(o,b,n.season)-Number(r)}}function Yt(e,t){const n=q.filter(({player_id:c})=>c===t.current_player_id),o=e.owner_id===t.current_player_id&&e.resources[a.people]>1,s=n.find(({origin:c})=>c===e),r=n.find(({target:c,season:l})=>c===e&&l!=="winter"),i=t.active_player.encampments.has(e);o||s||r||i?b=e:e.cell.classList.remove("clicked")}function D(e,t,n,o=0){return e.filter(({origin:s,target:r,season:i})=>(s===t||r===t)&&(i===n||j(i,n))).reduce((s,r)=>(t===r.target?s+=r.units:s-=r.units,s),o)}function Kt(e){return()=>{const t=I.querySelector('[name="season-of-move"]:checked').value,n=Number(X.value),o=Z.checked,s=q.findIndex(({player_id:r,origin:i,target:c})=>r===e.current_player_id&&i===b&&c===M);if(Number.isNaN(n)||n<=0){if(b=null,M=null,s>-1){const[{arrow:r}]=q.splice(s,1);r.remove()}return}if(s>-1){const r=q[s];r.units=n,r.arrow.lastElementChild.lastElementChild.textContent=n.toString()}else q.push(Pe(e.current_player_id,b,M,n,t,o?"settle":"unspecified"));b=null,M=null}}const S={land_grab:Y("land_grab","Pick your origin","Confirm choice",Tt),development:Y("development","Distribute your wealth",void 0,Jt),movement_planning:Y("movement_planning","Make your moves",void 0,Ft),movement_execution:Y("movement_execution","","Start Movement Phase")};function Qt(e){return()=>{if(e.current_phase===S.land_grab.name)Ut(e);else if(e.current_phase===S.movement_execution.name){const{value:t,done:n}=e.moves.next();if(console.log(t),!n)return}e.next_turn()}}function Y(e="round_phase",t="",n="End turn",o=(s,r)=>{}){return{name:e,call_to_action:t,end_turn_btn_label:n,handle_click_on_cell:o}}function*Vt(e){for(const t in E){const n=q.filter(r=>t===r.season).filter(r=>{const i=Xt(r,e);return i||fe(r,q),i});if(n.length===0)continue;const o=new Set,s=new Map;ke.textContent=`Move(s) in ${t}`,U.textContent="Show next move";for(const r of n)r.origin.cell.classList.add("clicked"),r.arrow.style.display="initial",o.add(r.target),yield"init_move",r.type==="settle"&&s.set(r.target,s.has(r.target)?s.get(r.target).add(r.player_id):new Set([r.player_id])),Gt(r,e),fe(r,q);U.textContent="Make these moves",yield"moves_laid_out";for(const r of o){const i=Zt(r,e.players);i.length!==1&&(U.textContent="Start battle",yield"battle_awaits",jt(r,i,e.players,s.get(r)))}}}function Gt(e,t){if(e.player_id===e.origin.owner_id)e.origin.resources[a.people]-=e.units;else{const n=t.players[e.player_id].encampments,o=n.get(e.origin)-e.units;o===0?n.delete(e.origin):n.set(e.origin,o)}if(e.player_id===e.target.owner_id)e.target.resources[a.people]+=e.units;else{const n=t.players[e.player_id].encampments,o=(n.get(e.target)||0)+e.units;n.set(e.target,o)}}function Xt(e={},t){const n=e.origin.owner_id===e.player_id?e.origin.resources[a.people]-1:t.players[e.player_id].encampments.get(e.origin);return e.units<=n}function fe(e,t=[]){const n=t.findIndex(o=>o===e);n<0||(t[n].arrow.remove(),t.splice(n,1))}function Zt(e,t){return t.reduce((n,o,s)=>(o.encampments.has(e)?n.push({player_id:s,units:o.encampments.get(e)}):s===e.owner_id&&n.push({player_id:e.owner_id,units:e.resources[a.people],is_owner:!0}),n),[])}function jt(e,t,n,o){for(;t.length>1;){const i=[],c=new Set;t.forEach((l,u)=>{const m=new Set([u]);let h;t.forEach((p,O)=>{m.has(O)||(m.add(O),h=P(h===void 0?l.units:l.units-h),i.push({target_id:O,attack_strength:h}))})});for(const{target_id:l,attack_strength:u}of i)t[l].units-=u,t[l].units<=0&&c.add(l);if(c.size===t.length){t=[Object.assign(ge(t),{units:1})];break}[...c].sort((l,u)=>u-l).forEach(l=>t.splice(l,1))}const{player_id:s,units:r}=t[0];if(e.owner_id===s){e.resources[a.people]=r;return}e.owner_id!==-1&&(n[e.owner_id].delete_cell(e),e.owner_id=-1,e.resources[a.people]=0),o!=null&&o.has(s)?(n[s].encampments.delete(e),n[s].add_cell(e),e.owner_id=s,e.resources[a.people]=r):n[s].encampments.set(e,r)}const k=[];let te=0,C=S.land_grab.name,$=0,Ue=null,Je;const f={board:ue,get moves(){return Je},get round(){return te},set round(e){te=e},get active_player(){return k[$]},get players(){return k},set players(e){k.push(...e)},get current_player_id(){return $},set current_player_id(e){$=e},get current_player_total_production(){return Ue},clear_players(){k.forEach(e=>e.destroy()),k.length=0},get current_phase(){return C},set current_phase(e){C=e},update_resource_display:De,next_turn(){ae.replaceChildren(),$===k.length-1?($=0,C=(()=>{switch(C){case S.development.name:return Re(),S.movement_planning.name;case S.movement_planning.name:return $=k.length-1,S.movement_execution.name;default:return te+=1,S.development.name}})()):$+=1,ye()},run:ye};function ye(){U.textContent=S[C].end_turn_btn_label,ke.textContent=S[C].call_to_action,ee.classList.remove("hidden"),ee.textContent=k[$].name,document.body.dataset.current_phase=S[C].name,document.documentElement.style.setProperty("--active-player-color",`var(--player-${$+1}`),oe.classList.add("content-hidden"),C===S.land_grab.name?(H.classList.add("hidden"),G.classList.remove("hidden")):C===S.development.name?(H.classList.add("hidden"),G.classList.add("hidden"),Ue=F(k[$].cells,k[$].tax_rate),R.classList.add("hidden"),ze(F(k[$].cells,k[$].tax_rate),k[$].tax_rate),oe.classList.remove("content-hidden"),De()):C===S.movement_execution.name&&(Je=Vt(f),ee.classList.add("hidden"))}function De(){oe.replaceChildren(...Object.entries(k[$].resources).map(([e,t])=>Object.assign(document.createElement("div"),{textContent:`${e}: ${t}`})))}const he="wargame-savegame";function en(){if(f.players.length===0){localStorage.removeItem(he);return}localStorage.setItem(he,JSON.stringify({round:f.round,current_phase:f.current_phase,current_player_id:f.current_player_id,players:f.players.map(({name:e,type:t})=>({name:e,type:t}))}))}function tn(e,t){const n=JSON.parse(t);Object.assign(e,{round:n.round,current_phase:n.current_phase,current_player_id:n.current_player_id,players:n.players.map(({name:o,type:s},r)=>ce(r,o,s))})}window.addEventListener("DOMContentLoaded",()=>{const e=localStorage.getItem("wargame-savegame"),t=e!==null;N.dataset.priorSave=t.toString(),N.showModal(),t?(tn(f,e),Rt(f)):bt(w,f.board),zt(f)},{once:!0});document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&(en(),Pt(),xt())});document.addEventListener("submit",Qe);X.addEventListener("input",()=>{Ce.value=X.value});ut.addEventListener("submit",e=>{e.submitter.id==="continue-btn"?N.dataset.priorSave==="true"&&N.close():e.submitter.id==="new-game-btn"&&(N.dataset.priorSave==="true"&&(Object.assign(f,{round:0,current_phase:S.land_grab.name,current_player_id:0}),Be(f.board),f.clear_players(),Re()),Array.from({length:2},(t,n)=>xe(n+1)),N.classList.add("game-config"))});N.addEventListener("close",()=>{f.players.length===0&&(f.players=Array.from({length:2},(e,t)=>ce(t,`Player ${t+1}`,"human"))),f.run()});ct.addEventListener("click",()=>Be(f.board));U.addEventListener("click",Qt(f));me.addEventListener("submit",()=>{const e=new Set,t=[...me.querySelectorAll(".player-name-input")];if(t.reduce((n,{value:o})=>(n[o]=o in n?n[o]+1:1,n[o]>1&&e.add(o),n),{}),e.size>0){t.forEach(n=>{e.has(n.value)&&n.classList.add("invalid")});return}f.players=Array.from(W,(n,o)=>{const s=n.querySelector(".player-name-input").value,r=n.querySelector(".player-type-select-radio:checked").value;return ce(o,s,r)}),N.close()});st.addEventListener("click",()=>{W.length!==5&&xe(W.length+1)});qe.addEventListener("click",({target:e})=>{e.closest(".delete-player-btn")&&W.length!==2&&(e.closest(".player-config").remove(),[...W].forEach((t,n)=>{n=n+1,Object.assign(t.querySelector(".player-name-input"),{name:`player-${n}-name`,value:`Player ${n}`}),t.querySelectorAll(".player-type-select-radio").forEach(o=>{o.name=`player-${n}-type`})}))});re.addEventListener("click",({target:e})=>{const t=e.closest(".cell-wrapper");if(!t)return;const n=re.querySelector(".clicked"),o=f.board.get(t);n&&(n.classList.remove("clicked"),ae.replaceChildren()),n!==t&&t.classList.add("clicked"),nn(o),S[f.current_phase].handle_click_on_cell(o,f)});lt.addEventListener("input",Nt(f));I.addEventListener("close",Kt(f));I.addEventListener("submit",()=>I.close());document.querySelector("h1").addEventListener("dblclick",()=>document.body.classList.toggle("debug"));it.addEventListener("click",()=>document.body.classList.toggle("use-offset-coords"));function nn(e){at.textContent=JSON.stringify(e,(t,n)=>t==="neighbors"?void 0:n,4)}
