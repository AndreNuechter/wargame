(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))s(a);new MutationObserver(a=>{for(const r of a)if(r.type==="childList")for(const i of r.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function n(a){const r={};return a.integrity&&(r.integrity=a.integrity),a.referrerPolicy&&(r.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?r.credentials="include":a.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(a){if(a.ep)return;a.ep=!0;const r=n(a);fetch(a.href,r)}})();const We=""+new URL("service-worker.js",import.meta.url).href;window.navigator.serviceWorker.register(We).catch(console.error);let Y;de(),document.addEventListener("visibilitychange",()=>{document.hidden?Ye():de()});async function de(){var e,t;Y=await((t=(e=navigator.wakeLock)==null?void 0:e.request)==null?void 0:t.call(e,"screen"))}async function Ye(){Y&&(await Y.release(),Y=void 0)}const w={width:30,height:24};function ne(e){return e%2===0}function Ke(e,t,n){return e>=t&&e<=n}function Qe(e,t=0,n=e.length){return e[K(n,t)]}function K(e,t=0){return Math.trunc(Math.random()*(e-t)+t)}function ge(e){return Object.freeze(Object.assign(Object.create(null),e))}function Ve(e){e.preventDefault()}function ve(e){e.forEach(t=>{t.neighbors=Ge(t,e,w)})}function Ge({q:e,r:t,s:n,x:s,y:a},r,i){const c=[{q:1,r:0,s:-1},{q:1,r:-1,s:0},{q:0,r:1,s:-1},{q:0,r:-1,s:1},{q:-1,r:0,s:1},{q:-1,r:1,s:0}].map(u=>r.find(y=>y.q===e+u.q&&y.r===t+u.r&&y.s===n+u.s)).filter(Boolean);return s===0&&(c.push(r.find(u=>a===u.y&&u.x===i.width-1)),ne(a)&&c.push(...[a<i.height-1?r.find(u=>a+1===u.y&&u.x===i.width-1):null,a>0?r.find(u=>a-1===u.y&&u.x===i.width-1):null].filter(Boolean))),s===i.width-1&&(c.push(r.find(u=>a===u.y&&u.x===0)),ne(a)||c.push(...[a<i.height-1?r.find(u=>a+1===u.y&&u.x===0):null,a>0?r.find(u=>a-1===u.y&&u.x===0):null].filter(Boolean))),c}const h={freezing:"freezing",cold:"cold",temperate:"temperate",warm:"warm",hot:"hot"};function we(e){e.forEach(t=>{const n=Math.random(),s=-1,a=Ke(n,.3,.7)?0:1*(-1*+(n<.3)),r=(i=>i<0?0:i>w.height-1?w.height-1:i)(t.y+a+s);t.temperature=Xe(r)})}function Xe(e){switch(e){case 0:case 1:case w.height-2:case w.height-1:return h.freezing;case 2:case 3:case w.height-4:case w.height-3:return h.cold;case 4:case 5:case w.height-6:case w.height-5:return h.temperate;case 6:case 7:case 8:case w.height-9:case w.height-8:case w.height-7:return h.warm;default:return h.hot}}function Ze(e){switch(e){case h.hot:return h.warm;case h.warm:return h.temperate;case h.temperate:return h.cold;default:return h.freezing}}function je(e){switch(e){case h.freezing:return h.cold;case h.cold:return h.temperate;case h.temperate:return h.warm;default:return h.hot}}const _e=new Set([0,1,2,w.height-1,w.height-2,w.height-3]);function be(e){const s=e.length/2.5;let a=0;for(;a<s;){const r=K(13,4),i={x:K(w.width),y:K(w.height-3,3)},l=e.find(({x:y,y:v})=>y===i.x&&v===i.y),c=new Set(l.neighbors.filter(({y})=>!_e.has(y))),u=new Set;a+=r,me(l),u.add(l);for(let y=0;y<r;y+=1){const v=Qe([...c]);me(v),u.add(v),c.delete(v),v.neighbors.filter(m=>!u.has(m)).filter(({y:m})=>!_e.has(m)).forEach(m=>c.add(m))}}e.filter(r=>r.elevation>0).forEach(r=>{const i=r.neighbors.filter(c=>c.elevation>0).length;if(i>=3)return;const l=Math.random();(i===2&&l>.7||i===1&&l<.7)&&et(r)})}function me(e){e.elevation+=1,e.elevation>1&&(e.temperature=Ze(e.temperature))}function et(e){e.elevation=Math.max(0,e.elevation-1),e.elevation>0&&(e.temperature=je(e.temperature))}const _={arid:"arid",dry:"dry",moderate:"moderate",moist:"moist",wet:"wet"};function tt(e){switch(e){case _.arid:return _.dry;case _.dry:return _.moderate;case _.moderate:return _.moist;default:return _.wet}}function Ee(e){e.filter(t=>t.elevation>0).forEach(t=>{t.neighbors.filter(({biome:n})=>n===d.sea).forEach(()=>{t.humidity=tt(t.humidity)})})}const o=ge({people:"people",gold:"gold",cloth:"cloth",wood:"wood",stone:"stone",iron:"iron",food:"food",alcohol:"alcohol"}),nt=ge({[o.people]:5,[o.gold]:5,[o.cloth]:25,[o.wood]:25,[o.stone]:25,[o.iron]:0,[o.food]:50,[o.alcohol]:5});function J(e,t=1){const n={[o.people]:0,[o.gold]:0,[o.cloth]:0,[o.wood]:0,[o.stone]:0,[o.iron]:0,[o.food]:0,[o.alcohol]:0};let s=0;return e.forEach(a=>{s+=a.resources.people,Object.entries(a.biome.resource_production).forEach(([r,i])=>{n[r]+=i}),[...a.structures.entries()].forEach(([r,i])=>{r.output.forEach(({resource_name:l,amount:c})=>{n[l]+=c*i})});for(let r=0;r<Math.floor(a.resources.people/2);r+=1){const i=Math.random();i<.3?n[o.people]+=2:i<.8&&(n[o.people]+=1)}}),n[o.gold]=s*t,n}const d={sea:new L("sea",{[o.food]:1}),mountain:new L("mountain",{[o.wood]:2,[o.stone]:5,[o.food]:3}),high_mountain:new L("high_mountain",{[o.stone]:5}),ice:new L("ice",{[o.food]:2}),tundra:new L("tundra",{[o.cloth]:1,[o.wood]:2,[o.stone]:1,[o.food]:5}),grassland:new L("grassland",{[o.cloth]:3,[o.wood]:2,[o.stone]:2,[o.food]:5}),savanna:new L("savanna",{[o.cloth]:5,[o.wood]:5,[o.stone]:3,[o.food]:6}),boreal_forest:new L("boreal_forest",{[o.cloth]:4,[o.wood]:10,[o.stone]:3,[o.food]:5}),forest:new L("forest",{[o.cloth]:2,[o.wood]:10,[o.stone]:2,[o.food]:5}),tropical_rainforest:new L("tropical_rainforest",{[o.cloth]:3,[o.wood]:7,[o.stone]:1,[o.food]:5}),cold_swamp:new L("cold_swamp",{[o.cloth]:1,[o.wood]:2,[o.stone]:1,[o.food]:2}),swamp:new L("swamp",{[o.cloth]:1,[o.wood]:1,[o.stone]:0,[o.food]:3}),tropical_swamp:new L("tropical_swamp",{[o.cloth]:1,[o.wood]:3,[o.stone]:1,[o.food]:3}),desert:new L("desert",{[o.cloth]:1,[o.wood]:0,[o.stone]:2,[o.food]:1}),extreme_desert:new L("extreme_desert",{[o.cloth]:0,[o.wood]:0,[o.stone]:1,[o.food]:0})},rt={[h.freezing]:{[_.arid]:d.tundra,[_.dry]:d.tundra,[_.moderate]:d.tundra,[_.moist]:d.boreal_forest,[_.wet]:d.boreal_forest},[h.cold]:{[_.arid]:d.tundra,[_.dry]:d.tundra,[_.moderate]:d.boreal_forest,[_.moist]:d.boreal_forest,[_.wet]:d.boreal_forest},[h.temperate]:{[_.arid]:d.tundra,[_.dry]:d.forest,[_.moderate]:d.forest,[_.moist]:d.forest,[_.wet]:d.swamp},[h.warm]:{[_.arid]:d.desert,[_.dry]:d.grassland,[_.moderate]:d.savanna,[_.moist]:d.forest,[_.wet]:d.tropical_swamp},[h.hot]:{[_.arid]:d.extreme_desert,[_.dry]:d.desert,[_.moderate]:d.grassland,[_.moist]:d.savanna,[_.wet]:d.tropical_rainforest}};function L(e="",t={},n=1,s=1){return{name:e,resource_production:Object.assign({[o.gold]:0,[o.cloth]:0,[o.wood]:0,[o.stone]:0,[o.iron]:0,[o.food]:0,[o.alcohol]:0},t),movement_speed:n,pleasantness:s}}function Se(e){e.forEach(t=>{t.biome=st(t)})}function Le(e){e.filter(({elevation:t})=>t===0).forEach(t=>{t.biome=ot(t)})}function ot(e,t=w.height){const n=Math.random();return[0,t-1].includes(e.y)?n<=.1?d.sea:d.ice:[1,t-2].includes(e.y)?n<=.75?d.sea:d.ice:[2,t-3].includes(e.y)?n<=.9?d.sea:d.ice:d.sea}function st(e){return e.biome?e.biome:e.elevation>1?e.elevation>2?d.high_mountain:d.mountain:rt[e.temperature][e.humidity]}const at=document.getElementById("add-player-btn"),re=document.getElementById("board"),oe=document.getElementById("bottom-bar"),D=document.getElementById("cell-info"),it=document.getElementById("cell-debug-info"),P=document.getElementById("cell-production-forecast"),lt=document.getElementById("toggle-coord-system-btn"),pe=document.getElementById("config-game-form"),se=document.getElementById("defs"),$e=document.getElementById("end-turn-btn"),V=document.getElementById("general-info"),Q=document.getElementById("overall-production-forecast"),ke=document.getElementById("phase-label"),F=document.getElementsByClassName("player-config"),j=document.getElementById("player-name"),qe=document.getElementById("player-setup"),ct=document.getElementById("reroll-map-btn"),ut=document.getElementById("side-bar");document.getElementById("round-info");const R=document.getElementById("season-of-move-select"),ae=document.getElementById("selection-highlight"),dt=document.getElementById("start-game-form"),N=document.getElementById("start-game-overlay"),Oe=document.getElementById("movement-arrows"),I=document.getElementById("movement-config"),G=I.querySelector('[name="troop-strength"]'),Ie=I.querySelector('[name="troop-strength-value"]'),_t=I.querySelector('[name="min-troop-strength-value"]'),mt=I.querySelector('[name="max-troop-strength-value"]'),X=I.querySelector('[name="settle-cell-toggle"]'),pt=se.querySelector(".cell-wrapper"),ft=se.querySelector(".movement-indicator"),yt=document.createElementNS("http://www.w3.org/2000/svg","path"),ht=se.querySelector(".player-border"),gt=document.getElementById("player-config-tmpl").content,vt=document.getElementById("structure-builder-tmpl").content,ie={tent:x("Tent",[g(o.wood,1),g(o.cloth,3)],[],0,{on(e){e.housing_capacity+=5},off(e){e.housing_capacity-=5}},[]),textile_factory:x("Textile Factory",[g(o.wood,15),g(o.stone,15)],[g(o.cloth,5)]),lumber_mill:x("Lumber Mill",[g(o.wood,15),g(o.stone,15)],[g(o.wood,5)]),quarry:x("Quarry",[g(o.wood,15),g(o.stone,15)],[g(o.stone,5)]),forge:x("Forge",[g(o.wood,5),g(o.stone,5)],[g(o.iron,1)]),farm:x("Farm",[g(o.wood,5),g(o.stone,5)],[g(o.food,5)]),distillery:x("Distillery",[g(o.wood,5),g(o.stone,5)],[g(o.alcohol,1)])};function x(e="Pretty Structure",t=[g(o.wood,5)],n=[g(o.wood,1)],s=1,a={on(c){c.foo+=5},off(c){c.foo-=5}},r=[d.swamp],i=[g(o.wood,1)],l=1){return{display_name:e,construction_cost:t,space_requirement:l,unsupported_biomes:r,effects:a,output:n,input:i,required_workers:s}}function g(e=o.wood,t=1){return{resource_name:e,amount:t}}function Ce(e,t,n,s,a,r,i){const l=wt(e,t,n,s,a,r,i),c=l.querySelector(".population-size");let u=null,y=-1,v=0;return{cx:e,cy:t,x:n,y:s,q:a,r,s:i,neighbors:[],cell:l,elevation:0,humidity:_.arid,temperature:h.freezing,structures:new Map(Object.values(ie).map(m=>[m,0])),resources:{get[o.people](){return v},set[o.people](m){v=m,c.textContent=v>0?v:""},[o.gold]:0,[o.cloth]:0,[o.wood]:0,[o.stone]:0,[o.iron]:0,[o.food]:0,[o.alcohol]:0},get biome(){return u},set biome(m){u!==null&&l.classList.remove(u.name),m!==null&&l.classList.add(m.name),u=m},get owner_id(){return y},set owner_id(m){y=m,m!==-1&&(l.dataset.owner_id=m)},developable_land:10}}function wt(e,t,n,s,a,r,i){const l=pt.cloneNode(!0);return l.setAttribute("transform",`translate(${e}, ${t})`),l.querySelector(".q-coord").textContent=a,l.querySelector(".r-coord").textContent=r,l.querySelector(".s-coord").textContent=i,l.querySelector(".offset-coords").textContent=`${n}, ${s}`,re.prepend(l),l}function Be(e){const t=[...e.values()];return t.forEach(n=>Object.assign(n,{biome:null,elevation:0,humidity:_.arid,temperature:h.freezing,resources:Object.keys(n.resources).reduce((s,a)=>(s[a]=0,s),n.resources),owner_id:-1})),we(t),be(t),Le(t),Ee(t),Se(t),e}function bt(e,t){const n=e.map(({cx:s,cy:a,x:r,y:i,q:l,r:c,s:u,biome_name:y,elevation:v,humidity:m,temperature:M,owner_id:f,resources:T})=>{const A=Ce(s,a,r,i,l,c,u);return Object.assign(A,{biome:d[y],elevation:v,humidity:m,temperature:M,owner_id:f}),Object.entries(T).forEach(([Fe,He])=>{A.resources[Fe]=He}),A});return ve(n),Me(n,t)}function Et(e,t){const n=St(e);return ve(n),we(n),be(n),Le(n),Ee(n),Se(n),Me(n,t)}function Me(e,t){return e.reduce((n,s)=>(n.set(s.cell,s),n),t)}function St({height:e,width:t}){const n=[];for(let s=0;s<e;s+=1){const a=+!ne(s);for(let r=0;r<t;r+=1){const i=r-(s-(s&1))/2;n.push(Ce(r*6+a*3,s*4.5,r,s,i,s,-i-s))}}return n}const Ne=.5,C=Ne*.5;function xe(e,t,n){const s=[];e.reduce((r,i)=>{const l=i.neighbors.filter(f=>!e.includes(f)),c=Lt(i),u=$t(i),y=It(i),v=qt(i),m=Ot(i),M=kt(i);return l.find(f=>f.r===i.r&&f.s===i.s+1)&&r.push(`M${v}L${M}`),l.find(f=>f.q===i.q&&f.s===i.s+1)&&r.push(`M${M}L${c}`),l.find(f=>f.s===i.s&&f.r===i.r-1)&&r.push(`M${c}L${m}`),l.find(f=>f.r===i.r&&f.s===i.s-1)&&r.push(`M${m}L${y}`),l.find(f=>f.q===i.q&&f.s===i.s-1)&&r.push(`M${y}L${u}`),l.find(f=>f.s===i.s&&f.r===i.r+1)&&r.push(`M${u}L${v}`),r},s);const a=yt.cloneNode(!0);a.setAttribute("d",s.join("")),a.setAttribute("stroke",t),a.setAttribute("stroke-width",Ne),n.append(a)}function Lt(e){return`${e.cx+3} ${e.cy+C}`}function $t(e){return`${e.cx+3} ${e.cy+6-C}`}function kt(e){return`${e.cx+C} ${e.cy+1.5+C*.5}`}function qt(e){return`${e.cx+C} ${e.cy+4.5-C*.5}`}function Ot(e){return`${e.cx+6-C} ${e.cy+1.5+C*.5}`}function It(e){return`${e.cx+6-C} ${e.cy+4.5-C*.5}`}const Ct={human:"human",ai:"ai"};function ze(e){const t=gt.cloneNode(!0);Object.assign(t.querySelector(".player-name-input"),{name:`player-${e}-name`,value:`Player ${e}`}),t.querySelectorAll(".player-type-select-radio").forEach(n=>{n.name=`player-${e}-type`}),qe.append(t)}function le(e,t="Player Name",n=Ct.ai){const s=[],a=ht.cloneNode(!0);return document.getElementById("player-borders").append(a),{name:t,type:n,tax_rate:1,get resources(){return s.reduce((r,{resources:i})=>(Object.entries(i).forEach(([l,c])=>{r[l]+=c}),r),{[o.people]:0,[o.gold]:0,[o.cloth]:0,[o.wood]:0,[o.stone]:0,[o.iron]:0,[o.food]:0,[o.alcohol]:0})},border_path_container:a,get cells(){return s},set cells(r){s.push(...r),xe(s,`var(--player-${e+1})`,a)},encampments:new Map,destroy(){s.length=0,a.remove()}}}function Ae(e,t){Q.querySelector("ul").replaceChildren(...ce(e)),Q.querySelector("input").value=t,Q.classList.remove("hidden")}function Bt(e,t){P.querySelector("ul").replaceChildren(...ce(e)),P.querySelector("fieldset").replaceChildren(...t),P.classList.remove("hidden")}function Mt(e,{wood:t,stone:n,cloth:s,food:a}){const r=Object.values(ie).filter(i=>!i.unsupported_biomes.includes(e.biome)).map(({display_name:i})=>`<li>${i}</li>`).join("");D.innerHTML=`
        <h2>Cell Info</h2>
        <div>Biome: ${e.biome.name}</div>
        <div>Movement modifier: ${e.biome.movement_speed}</div>
        <div>Pleasantness: ${e.biome.pleasantness}</div>
        ...
        <h3>Production</h3>
        <div>Wood: ${t}</div>
        <div>Stone: ${n}</div>
        <div>Cloth: ${s}</div>
        <div>Food: ${a}</div>
        <h3>Supported structures</h3>
        <ul>${r}</ul>
    `,D.classList.remove("hidden")}function ce(e){return Object.entries(e).map(([t,n])=>Object.assign(document.createElement("li"),{textContent:`${t}: ${n}`}))}function Nt(e){return Object.entries(ie).filter(([,t])=>!t.unsupported_biomes.includes(e.biome)).map(([t,n])=>{const s=vt.cloneNode(!0).lastElementChild,a=s.querySelector(".label-text"),r=s.querySelector(".structure-count");return s.dataset.structure_name=t,a.textContent=`${n.display_name}: `,r.textContent=e.structures.get(n),s.addEventListener("click",({target:i})=>{const l=i.closest("button");if(l===null)return;const c=l.classList.contains("construct-structure-btn"),u=n.construction_cost;let y=e.structures.get(n);if(c){if(e.developable_land<n.space_requirement||u.some(({resource_name:m,amount:M})=>M>p.active_player.resources[m]))return;y+=1,u.forEach(({resource_name:m,amount:M})=>{let f=M;for(const T of p.active_player.cells){const A=T.resources[m];if(A<f){f-=A,T.resources[m]=0;continue}else T.resources[m]-=f,f=0;if(f===0)break}}),e.developable_land-=n.space_requirement}else{if(y===0)return;y-=1,u.forEach(({resource_name:v,amount:m})=>{e.resources[v]+=m}),e.developable_land+=n.space_requirement}e.structures.set(n,y),r.textContent=y,P.querySelector("ul").replaceChildren(...ce(J([e],p.active_player.tax_rate))),p.update_resource_display()}),s})}function xt(e){return({target:t})=>{const n=Number(t.value);t.name==="tax_rate"&&(e.active_player.tax_rate=n)}}const q=[],Pe="wargame-planned-moves";function zt(){localStorage.setItem(Pe,JSON.stringify(q.map(({player_id:e,origin:t,target:n,units:s,season:a})=>({player_id:e,origin:{cx:t.cx,cy:t.cy},target:{cx:n.cx,cy:n.cy},units:s,season:a}))))}function At(e){const t=JSON.parse(localStorage.getItem(Pe)),n=[...e.board.values()];q.push(...t.map(({player_id:s,origin:a,target:r,units:i,season:l})=>Te(s,n.find(({cx:c,cy:u})=>c===a.cx&&u===a.cy),n.find(({cx:c,cy:u})=>c===r.cx&&u===r.cy),i,l)))}function Te(e,t,n,s,a,r){const i=Pt(t,n,s);return{player_id:e,origin:t,target:n,season:a,units:s,type:r,arrow:i}}function Pt(e,t,n){const a={x:e.cx+3,y:e.cy+3},r={x:t.cx+3,y:t.cy+3},i=`M${a.x} ${a.y}A 3 3 0 0 0 ${r.x} ${r.y}`,l=ft.cloneNode(!0),c=l.lastElementChild.lastElementChild;return l.firstElementChild.setAttribute("d",i),c.setAttribute("path",i),c.textContent=n,Oe.append(l),l}function Re(){q.length=0,Oe.replaceChildren()}const ue=new Map,Ue="wargame-board";function Tt(){localStorage.setItem(Ue,JSON.stringify([...ue.values()].map(({cx:e,cy:t,x:n,y:s,q:a,r,s:i,biome:{name:l},elevation:c,humidity:u,temperature:y,owner_id:v,resources:m})=>({cx:e,cy:t,x:n,y:s,q:a,r,s:i,biome_name:l,elevation:c,humidity:u,temperature:y,owner_id:v,resources:m}))))}function Rt(e){const t=JSON.parse(localStorage.getItem(Ue));bt(t,ue),e.players.forEach((n,s)=>{n.cells=[...e.board.values()].filter(a=>a.owner_id===s)})}let z=null;function Ut(e){e.owner_id===-1&&e.biome!==d.sea?(z=e,xe([...e.neighbors,e],"white",ae),V.classList.add("hidden"),Mt(e,e.biome.resource_production)):(D.classList.add("hidden"),V.classList.remove("hidden"))}function Jt(e){z!==null&&(Object.entries(nt).forEach(([t,n])=>{z.resources[t]=n}),z.owner_id=e.current_player_id,e.active_player.cells=[z],z.cell.classList.remove("clicked"),z=null)}function Dt(e,t){e.owner_id===t.current_player_id?(Q.classList.add("hidden"),Bt(J([e],t.active_player.tax_rate),Nt(e))):(P.classList.add("hidden"),Ae(J(t.active_player.cells,t.active_player.tax_rate),t.active_player.tax_rate))}const E={spring:"spring",summer:"summer",autumn:"autumn",winter:"winter"};function Ft(e){switch(e){case E.spring:return E.summer;case E.summer:return E.autumn;case E.autumn:return E.winter}}function Z(e,t){return!(e===t||e===E.winter||e===E.summer&&t===E.spring||e===E.autumn&&t!==E.winter)}let b=null,B=null;function Ht(e,t){if(b===null){Kt(e,t);return}if(e.cell.classList.remove("clicked"),b===e){b=null;return}if(!e.neighbors.includes(b))return;B=e;const n=q.find(({player_id:i,origin:l,target:c})=>i===t.current_player_id&&l===b&&c===B),s=b.owner_id===t.current_player_id,a=B.owner_id===t.current_player_id,r={settle_cell:!1,season:E.spring};if(Object.values(E).forEach(i=>{R.querySelector(`input[value="${i}"]`).disabled=!1}),R.inert=!1,X.inert=a,n?Wt(n,t,s,r):Yt(t,s,r),r.max_value<=0){B=null;return}R.querySelector(`input[value="${r.season}"]`).checked=!0,Object.assign(G,{value:r.current_value,min:r.min_value,max:r.max_value}),Ie.value=r.current_value,_t.value=r.min_value,mt.value=r.max_value,X.checked=r.settle_cell,I.showModal()}function Wt(e,t,n,s){const a=q.filter(({player_id:r})=>r===t.current_player_id);s.settle_cell=e.type==="settle",s.current_value=e.units,s.season=e.season,s.min_value=a.filter(({season:r,origin:i})=>Z(e.season,r)&&e.target===i).reduce((r,{season:i,origin:l,units:c})=>(U(a,l,i,l.owner_id===t.current_player_id?l.resources[o.people]:0)-e.units<c&&(r+=c),r),0),R.inert=!0,X.inert=!0,n?s.max_value=U(a,b,s.season,b.resources[o.people])-1+s.current_value:s.max_value=U(a,b,s.season)-Number(s.settle_cell)+s.current_value}function Yt(e,t,n){const s=q.filter(({player_id:a})=>a===e.current_player_id);if(n.current_value=0,n.min_value=0,t)n.max_value=U(s,b,n.season,b.resources[o.people])-1;else{const a=s.filter(({target:i})=>i===b).reduce((i,{season:l})=>((i===""||Z(l,i))&&(i=l),i),""),r=!!s.find(({target:i,type:l,season:c})=>i===b&&c===a&&l==="settle");if(a===E.winter){B=null;return}Object.values(E).filter(i=>i===a||Z(i,a)).forEach(i=>{R.querySelector(`input[value="${i}"]`).disabled=!0}),n.season=Ft(a),n.max_value=U(s,b,n.season)-Number(r)}}function Kt(e,t){const n=q.filter(({player_id:l})=>l===t.current_player_id),s=e.owner_id===t.current_player_id&&e.resources[o.people]>1,a=n.find(({origin:l})=>l===e),r=n.find(({target:l,season:c})=>l===e&&c!=="winter"),i=t.active_player.encampments.has(e);s||a||r||i?b=e:e.cell.classList.remove("clicked")}function U(e,t,n,s=0){return e.filter(({origin:a,target:r,season:i})=>(a===t||r===t)&&(i===n||Z(i,n))).reduce((a,r)=>(t===r.target?a+=r.units:a-=r.units,a),s)}function Qt(e){return()=>{const t=I.querySelector('[name="season-of-move"]:checked').value,n=Number(G.value),s=X.checked,a=q.findIndex(({player_id:r,origin:i,target:l})=>r===e.current_player_id&&i===b&&l===B);if(Number.isNaN(n)||n<=0){if(b=null,B=null,a>-1){const[{arrow:r}]=q.splice(a,1);r.remove()}return}if(a>-1){const r=q[a];r.units=n,r.arrow.lastElementChild.lastElementChild.textContent=n}else q.push(Te(e.current_player_id,b,B,n,t,s?"settle":"unspecified"));b=null,B=null}}const S={land_grab:W("land_grab","Pick your origin","Confirm choice",Ut),development:W("development","Distribute your wealth",void 0,Dt),movement_planning:W("movement_planning","Make your moves",void 0,Ht),movement_execution:W("movement_execution","","Start Movement Phase")};let H="";function Vt(e){return()=>{if(e.current_phase===S.land_grab.name)Jt(e);else if(e.current_phase===S.movement_execution.name&&H===""){const{value:t,done:n}=e.moves.next();if(console.log(t),H=t,H==="init_move"&&setTimeout(()=>{e.moves.next(),H=""},500),!n)return}e.next_turn()}}function W(e="round_phase",t="",n="End turn",s=(a,r)=>{}){return{name:e,call_to_action:t,end_turn_btn_label:n,handle_click_on_cell:s}}function*Gt(e){for(const t in E){const n=q.filter(r=>t===r.season);ke.textContent=`Move(s) in ${t}`;const s=new Map,a=new Set;for(const r of n){if(!Xt(r,e)){console.log("impossible"),ee(r,q),ee(r,n);continue}yield"init_move",r.arrow.style.display="initial",s.has(r.target)?s.get(r.target).has(r.player_id)||(s.get(r.target).add(r.player_id),a.add(r.target)):s.set(r.target,new Set([r.player_id]))}yield"moves_laid_out";for(const r of n)r.player_id===r.target.owner_id?r.target.resources[o.people]+=r.units:e.players[r.player_id].encampments.set(r.target,e.players[r.player_id].encampments.get(r.target)||0+r.units),ee(r,q);for(const r of a)yield"battle_awaits"}}function Xt(e={},t){const n=e.origin.owner_id===e.player_id?e.origin.resources[o.people]-1:t.players[e.player_id].encampments.get(e.origin);return e.units<=n}function ee(e,t=[]){const n=t.findIndex(s=>s===e);n<0||(t[n].arrow.remove(),t.splice(n,1))}const k=[];let te=0,O=S.land_grab.name,$=0,Je=null,fe;const p={board:ue,get moves(){return fe},get round(){return te},set round(e){te=e},get active_player(){return k[$]},get players(){return k},set players(e){k.push(...e)},get current_player_id(){return $},set current_player_id(e){$=e},get current_player_total_production(){return Je},clear_players(){k.forEach(e=>e.destroy()),k.length=0},get current_phase(){return O},set current_phase(e){O=e},update_resource_display:De,next_turn(){ae.replaceChildren(),$===k.length-1?($=0,O=(()=>{switch(O){case S.development.name:return Re(),S.movement_planning.name;case S.movement_planning.name:return fe=Gt(p),$=k.length-1,S.movement_execution.name;default:return te+=1,S.development.name}})()):$+=1,ye()},run:ye};function ye(){$e.textContent=S[O].end_turn_btn_label,ke.textContent=S[O].call_to_action,j.classList.remove("hidden"),j.textContent=k[$].name,document.body.dataset.current_phase=S[O].name,document.documentElement.style.setProperty("--active-player-color",`var(--player-${$+1}`),oe.classList.add("content-hidden"),O===S.land_grab.name?(D.classList.add("hidden"),V.classList.remove("hidden")):O===S.development.name?(D.classList.add("hidden"),V.classList.add("hidden"),Je=J(k[$].cells,k[$].tax_rate),P.classList.add("hidden"),Ae(J(k[$].cells,k[$].tax_rate),k[$].tax_rate),oe.classList.remove("content-hidden"),De()):O===S.movement_execution.name&&j.classList.add("hidden")}function De(){oe.replaceChildren(...Object.entries(k[$].resources).map(([e,t])=>Object.assign(document.createElement("div"),{textContent:`${e}: ${t}`})))}const he="wargame-savegame";function Zt(){if(p.players.length===0){localStorage.removeItem(he);return}localStorage.setItem(he,JSON.stringify({round:p.round,current_phase:p.current_phase,current_player_id:p.current_player_id,players:p.players.map(({name:e,type:t})=>({name:e,type:t}))}))}function jt(e,t){const n=JSON.parse(t);Object.assign(e,{round:n.round,current_phase:n.current_phase,current_player_id:n.current_player_id,players:n.players.map(({name:s,type:a},r)=>le(r,s,a))})}window.addEventListener("DOMContentLoaded",()=>{const e=localStorage.getItem("wargame-savegame"),t=e!==null;N.dataset.priorSave=t,N.showModal(),t?(jt(p,e),Rt(p)):Et(w,p.board),At(p)},{once:!0});document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&(Zt(),Tt(),zt())});document.addEventListener("submit",Ve);G.addEventListener("input",()=>{Ie.value=G.value});dt.addEventListener("submit",e=>{e.submitter.id==="continue-btn"?N.dataset.priorSave==="true"&&N.close():e.submitter.id==="new-game-btn"&&(N.dataset.priorSave==="true"&&(Object.assign(p,{round:0,current_phase:S.land_grab.name,current_player_id:0}),Be(p.board),p.clear_players(),Re()),Array.from({length:2},(t,n)=>ze(n+1)),N.classList.add("game-config"))});N.addEventListener("close",()=>{p.players.length===0&&(p.players=Array.from({length:2},(e,t)=>le(t,`Player ${t+1}`,"human"))),p.run()});ct.addEventListener("click",()=>Be(p.board));$e.addEventListener("click",Vt(p));pe.addEventListener("submit",()=>{const e=new Set,t=[...pe.querySelectorAll(".player-name-input")];if(t.reduce((n,{value:s})=>(n[s]=s in n?n[s]+1:1,n[s]>1&&e.add(s),n),{}),e.size>0){t.forEach(n=>{e.has(n.value)&&n.classList.add("invalid")});return}p.players=Array.from(F,(n,s)=>{const a=n.querySelector(".player-name-input").value,r=n.querySelector(".player-type-select-radio:checked").value;return le(s,a,r)}),N.close()});at.addEventListener("click",()=>{F.length!==5&&ze(F.length+1)});qe.addEventListener("click",({target:e})=>{e.closest(".delete-player-btn")&&F.length!==2&&(e.closest(".player-config").remove(),[...F].forEach((t,n)=>{n=n+1,Object.assign(t.querySelector(".player-name-input"),{name:`player-${n}-name`,value:`Player ${n}`}),t.querySelectorAll(".player-type-select-radio").forEach(s=>{s.name=`player-${n}-type`})}))});re.addEventListener("click",({target:e})=>{const t=e.closest(".cell-wrapper");if(!t)return;const n=re.querySelector(".clicked"),s=p.board.get(t);n&&(n.classList.remove("clicked"),ae.replaceChildren()),n!==t&&t.classList.add("clicked"),en(s),S[p.current_phase].handle_click_on_cell(s,p)});ut.addEventListener("input",xt(p));I.addEventListener("close",Qt(p));I.addEventListener("submit",()=>I.close());document.querySelector("h1").addEventListener("dblclick",()=>document.body.classList.toggle("debug"));lt.addEventListener("click",()=>document.body.classList.toggle("use-offset-coords"));function en(e){it.textContent=JSON.stringify(e,(t,n)=>t==="neighbors"?void 0:n,4)}
